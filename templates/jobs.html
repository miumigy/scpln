{% extends "base.html" %}
{% block content %}
<section>
  <h2>Jobs</h2>
  <form method="get" action="/ui/jobs" style="display:flex; gap:8px; align-items:center; margin:8px 0;">
    <label>Status
      <select name="status">
        <option value="" {% if not status %}selected{% endif %}>(all)</option>
        {% for s in ["queued","running","succeeded","failed"] %}
        <option value="{{ s }}" {% if status == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit" class="secondary">Apply</button>
  </form>
  {% if rows %}
  <table role="grid">
    <thead>
      <tr>
        <th>job_id</th>
        <th>type</th>
        <th>status</th>
        <th>submitted_at</th>
        <th>started_at</th>
        <th>finished_at</th>
        <th>run_id</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td class="mono truncate" title="{{ r.job_id }}">{{ r.job_id }}</td>
        <td>{{ r.type }}</td>
        <td>{{ r.status }}</td>
        <td>{{ r.submitted_at }}</td>
        <td>{{ r.started_at or '' }}</td>
        <td>{{ r.finished_at or '' }}</td>
        <td class="mono truncate" title="{{ r.run_id }}">{{ r.run_id or '' }}</td>
        <td><a role="button" href="/ui/jobs/{{ r.job_id }}">Detail</a></td>
        <td>
          {% if r.status == 'failed' %}
          <button class="secondary" onclick="retryJob('{{ r.job_id }}')">Retry</button>
          {% elif r.status == 'queued' %}
          <button class="secondary" onclick="cancelJob('{{ r.job_id }}')">Cancel</button>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No jobs.</p>
  {% endif %}
  <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
    {% set prev = (offset - limit) if (offset - limit) > 0 else 0 %}
    {% set next = (offset + limit) if (offset + limit) < total else offset %}
    <a role="button" class="secondary" href="/ui/jobs?status={{ status }}&offset={{ prev }}&limit={{ limit }}">Prev</a>
    <a role="button" class="secondary" href="/ui/jobs?status={{ status }}&offset={{ next }}&limit={{ limit }}">Next</a>
    <span class="mono">{{ offset + 1 if total else 0 }}-{{ (offset + limit) if (offset + limit) < total else total }} / {{ total }}</span>
  </div>
</section>
{% endblock %}
{% block scripts %}
<script>
async function retryJob(id){
  if(!confirm('Retry this job?')) return;
  try{
    const res = await fetch(`/jobs/${id}/retry`, {method:'POST', headers:{'Content-Type':'application/json'}});
    if(!res.ok) throw new Error('HTTP '+res.status);
    location.reload();
  }catch(e){ alert('Retry failed'); }
}
async function cancelJob(id){
  if(!confirm('Cancel this job?')) return;
  try{
    const res = await fetch(`/jobs/${id}/cancel`, {method:'POST'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    location.reload();
  }catch(e){ alert('Cancel failed'); }
}
</script>
{% endblock %}
