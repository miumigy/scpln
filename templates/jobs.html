{% extends "base.html" %}
{% block content %}
<section>
  <h2>Jobs</h2>
  <details open>
    <summary>Create Aggregate Job</summary>
    <form id="agg-form" onsubmit="return submitAggregateJob(event)" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:8px; align-items:end; margin:8px 0;">
      <label>run_id
        <input type="text" id="agg-run-id" required placeholder="<run_id>" />
      </label>
      <label>dataset
        <select id="agg-dataset">
          <option value="pl" selected>pl</option>
          <option value="results">results</option>
          <option value="trace">trace</option>
        </select>
      </label>
      <label>bucket
        <select id="agg-bucket">
          <option value="day">day</option>
          <option value="week" selected>week</option>
          <option value="month">month</option>
        </select>
      </label>
      <label>group_keys (comma)
        <input type="text" id="agg-group-keys" placeholder="node,item" list="agg-group-keys-list" />
      </label>
      <label>sum_fields (comma)
        <input type="text" id="agg-sum-fields" placeholder="qty,revenue" list="agg-sum-fields-list" />
      </label>
      <datalist id="agg-group-keys-list"></datalist>
      <datalist id="agg-sum-fields-list"></datalist>
      <label>product_level
        <input type="text" id="agg-product-level" placeholder="category" />
      </label>
      <label>location_level
        <input type="text" id="agg-location-level" placeholder="region" />
      </label>
      <label style="grid-column: 1 / -1;">product_map (JSON)
        <textarea id="agg-product-map" rows="3" placeholder='{"SKU1":{"category":"C1"}}' style="width:100%;"></textarea>
      </label>
      <label style="grid-column: 1 / -1;">location_map (JSON)
        <textarea id="agg-location-map" rows="3" placeholder='{"S1":{"region":"R1"}}' style="width:100%;"></textarea>
      </label>
      <div style="grid-column: 1 / -1; display:flex; gap:8px;">
        <button type="button" class="secondary" onclick="formatAggJson()" aria-label="JSONを整形">Format JSON</button>
      </div>
      <label>date_field
        <input type="text" id="agg-date-field" placeholder="date" />
      </label>
      <label>tz
        <input type="text" id="agg-tz" placeholder="Asia/Tokyo" />
      </label>
      <label>calendar_mode
        <select id="agg-calendar-mode">
          <option value="">(none)</option>
          <option value="iso_week">iso_week</option>
        </select>
      </label>
      <div>
        <button type="submit" aria-label="ジョブをキューに投入">Enqueue</button>
      </div>
    </form>
    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:4px 0 12px;">
      <label>Preset name
        <input type="text" id="agg-preset-name" placeholder="my-preset" />
      </label>
      <button type="button" class="secondary" onclick="saveAggPreset()" aria-label="プリセットを保存">Save preset</button>
      <label>Presets
        <select id="agg-preset-select"></select>
      </label>
      <button type="button" class="secondary" onclick="applyAggPreset()">Apply</button>
      <button type="button" class="secondary" onclick="deleteAggPreset()">Delete</button>
    </div>
  </details>
  <form method="get" action="/ui/jobs" style="display:flex; gap:8px; align-items:center; margin:8px 0;">
    <label>Status
      <select name="status">
        <option value="" {% if not status %}selected{% endif %}>(all)</option>
        {% for s in ["queued","running","succeeded","failed"] %}
        <option value="{{ s }}" {% if status == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit" class="secondary">Apply</button>
  </form>
  {% if rows %}
  <table role="grid">
    <thead>
      <tr>
        <th>job_id</th>
        <th>type</th>
        <th>status</th>
        <th>submitted_at</th>
        <th>started_at</th>
        <th>finished_at</th>
        <th>run_id / output</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td class="mono truncate" title="{{ r.job_id }}">{{ r.job_id }}</td>
        <td>{{ r.type }}</td>
        <td>{{ r.status }}</td>
        <td class="ts-ms" data-ms="{{ r.submitted_at }}">{{ r.submitted_at }}</td>
        <td class="ts-ms" data-ms="{{ r.started_at or '' }}">{{ r.started_at or '' }}</td>
        <td class="ts-ms" data-ms="{{ r.finished_at or '' }}">{{ r.finished_at or '' }}</td>
        <td class="mono truncate" title="{{ r.run_id or r.out_dir or '' }}">
          {% if r.run_id %}
            {{ r.run_id }}
          {% elif r.type == 'planning' and r.out_dir %}
            <a href="/ui/planning?dir={{ r.out_dir }}">{{ r.out_dir }}</a>
          {% else %}
            
          {% endif %}
        </td>
        <td>
          {% if r.job_id %}
          <a role="button" href="/ui/jobs/{{ r.job_id }}">Detail</a>
          {% else %}-{% endif %}
        </td>
        <td>
          {% if r.status == 'failed' %}
          <button class="secondary" onclick="retryJob('{{ r.job_id }}')">Retry</button>
          {% elif r.status == 'queued' %}
          <button class="secondary" onclick="cancelJob('{{ r.job_id }}')">Cancel</button>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No jobs.</p>
  {% endif %}
  <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
    {% set prev = (offset - limit) if (offset - limit) > 0 else 0 %}
    {% set next = (offset + limit) if (offset + limit) < total else offset %}
    <a role="button" class="secondary" href="/ui/jobs?status={{ status }}&offset={{ prev }}&limit={{ limit }}">Prev</a>
    <a role="button" class="secondary" href="/ui/jobs?status={{ status }}&offset={{ next }}&limit={{ limit }}">Next</a>
    <span class="mono">{{ offset + 1 if total else 0 }}-{{ (offset + limit) if (offset + limit) < total else total }} / {{ total }}</span>
  </div>
</section>
{% endblock %}
{% block scripts %}
<script>
// JSTフォーマット（ms epoch → YYYY/MM/DD HH:mm:ss）
function fmtJst(ms){
  var n = Number(ms);
  if (!Number.isFinite(n)) return '';
  var t = new Date(n + 9*3600*1000);
  var y = t.getUTCFullYear();
  var mo = String(t.getUTCMonth()+1).padStart(2,'0');
  var d = String(t.getUTCDate()).padStart(2,'0');
  var h = String(t.getUTCHours()).padStart(2,'0');
  var mi = String(t.getUTCMinutes()).padStart(2,'0');
  var s = String(t.getUTCSeconds()).padStart(2,'0');
  return y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s;
}
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('td.ts-ms').forEach(function(td){
    var ms = td.getAttribute('data-ms');
    var txt = fmtJst(ms);
    if (txt) td.textContent = txt;
  });
});

async function submitAggregateJob(e){
  e.preventDefault();
  const run_id = document.getElementById('agg-run-id').value.trim();
  const dataset = document.getElementById('agg-dataset').value;
  const bucket = document.getElementById('agg-bucket').value;
  const group_keys = (document.getElementById('agg-group-keys').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const sum_fields = (document.getElementById('agg-sum-fields').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const product_level = document.getElementById('agg-product-level').value.trim() || undefined;
  const location_level = document.getElementById('agg-location-level').value.trim() || undefined;
  const date_field = document.getElementById('agg-date-field').value.trim() || undefined;
  const tz = document.getElementById('agg-tz').value.trim() || undefined;
  const calendar_mode = document.getElementById('agg-calendar-mode').value || undefined;
  const week_start_offset = document.getElementById('agg-week-start') ? document.getElementById('agg-week-start').value.trim() : '';
  const month_len = document.getElementById('agg-month-len') ? document.getElementById('agg-month-len').value.trim() : '';
  const product_map_txt = document.getElementById('agg-product-map') ? document.getElementById('agg-product-map').value.trim() : '';
  const location_map_txt = document.getElementById('agg-location-map') ? document.getElementById('agg-location-map').value.trim() : '';
  if(!run_id){ alert('run_id is required'); return false; }
  const body = { run_id, dataset, bucket };
  if(group_keys.length) body.group_keys = group_keys;
  if(sum_fields.length) body.sum_fields = sum_fields;
  if(product_level) body.product_level = product_level;
  if(location_level) body.location_level = location_level;
  if(date_field) body.date_field = date_field;
  if(tz) body.tz = tz;
  if(calendar_mode) body.calendar_mode = calendar_mode;
  if(week_start_offset !== '') body.week_start_offset = Number(week_start_offset);
  if(month_len !== '') body.month_len = Number(month_len);
  if(product_map_txt){
    try { body.product_map = JSON.parse(product_map_txt); } catch(e){ alert('product_map JSON が不正です'); return false; }
  }
  if(location_map_txt){
    try { body.location_map = JSON.parse(location_map_txt); } catch(e){ alert('location_map JSON が不正です'); return false; }
  }
  try{
    const res = await fetch('/jobs/aggregate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const js = await res.json();
    try{ _updateAggSuggestionsFromCurrent(); }catch{}
    alert('Enqueued aggregate job: '+ js.job_id);
    location.href = '/ui/jobs';
  }catch(err){
    console.error(err);
    alert('Failed to enqueue aggregate job');
  }
  return false;
}
function _readAggForm(){
  const obj = {
    run_id: document.getElementById('agg-run-id').value.trim(),
    dataset: document.getElementById('agg-dataset').value,
    bucket: document.getElementById('agg-bucket').value,
    group_keys: (document.getElementById('agg-group-keys').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    sum_fields: (document.getElementById('agg-sum-fields').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    product_level: document.getElementById('agg-product-level').value.trim(),
    location_level: document.getElementById('agg-location-level').value.trim(),
    date_field: document.getElementById('agg-date-field').value.trim(),
    tz: document.getElementById('agg-tz').value.trim(),
    calendar_mode: document.getElementById('agg-calendar-mode').value,
    week_start_offset: document.getElementById('agg-week-start') ? document.getElementById('agg-week-start').value.trim(): '',
    month_len: document.getElementById('agg-month-len') ? document.getElementById('agg-month-len').value.trim(): '',
  };
  return obj;
}
function _writeAggForm(p){
  const set = (id,val)=>{ const el=document.getElementById(id); if(!el) return; if(el.tagName==='SELECT'){ el.value=val||''; } else { el.value=val||''; } };
  set('agg-run-id', p.run_id);
  set('agg-dataset', p.dataset);
  set('agg-bucket', p.bucket);
  set('agg-group-keys', (p.group_keys||[]).join(','));
  set('agg-sum-fields', (p.sum_fields||[]).join(','));
  set('agg-product-level', p.product_level);
  set('agg-location-level', p.location_level);
  set('agg-date-field', p.date_field);
  set('agg-tz', p.tz);
  set('agg-calendar-mode', p.calendar_mode);
  set('agg-week-start', p.week_start_offset);
  set('agg-month-len', p.month_len);
}
function _loadAggPresets(){
  try{
    const raw = localStorage.getItem('agg_presets')||'{}';
    const list = JSON.parse(raw);
    const sel = document.getElementById('agg-preset-select');
    if (!sel) return;
    sel.innerHTML='';
    Object.keys(list).sort().forEach(name=>{
      const opt=document.createElement('option');
      opt.value=name; opt.textContent=name; sel.appendChild(opt);
    });
  }catch{}
}
function saveAggPreset(){
  const name = (document.getElementById('agg-preset-name').value||'').trim();
  if(!name){ alert('Preset name is required'); return; }
  const p = _readAggForm();
  try{
    const raw = localStorage.getItem('agg_presets')||'{}';
    const list = JSON.parse(raw);
    list[name] = p;
    localStorage.setItem('agg_presets', JSON.stringify(list));
    _loadAggPresets();
    alert('Saved preset: '+name);
  }catch{ alert('Failed to save preset'); }
}
function applyAggPreset(){
  const sel = document.getElementById('agg-preset-select');
  const name = sel && sel.value;
  if(!name) { alert('Select a preset'); return; }
  try{
    const raw = localStorage.getItem('agg_presets')||'{}';
    const list = JSON.parse(raw);
    const p = list[name];
    if(!p){ alert('Preset not found'); return; }
    _writeAggForm(p);
  }catch{ alert('Failed to apply preset'); }
}
function deleteAggPreset(){
  const sel = document.getElementById('agg-preset-select');
  const name = sel && sel.value;
  if(!name) { alert('Select a preset'); return; }
  if(!confirm('Delete preset '+name+'?')) return;
  try{
    const raw = localStorage.getItem('agg_presets')||'{}';
    const list = JSON.parse(raw);
    delete list[name];
    localStorage.setItem('agg_presets', JSON.stringify(list));
    _loadAggPresets();
  }catch{ alert('Failed to delete preset'); }
}
function exportAggPresets(){
  try{
    const raw = localStorage.getItem('agg_presets')||'{}';
    const blob = new Blob([raw], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'agg_presets.json';
    a.click();
    URL.revokeObjectURL(a.href);
  }catch{ alert('Failed to export'); }
}
function importAggPresets(ev){
  const input = ev && ev.target;
  if(!input || !input.files || !input.files.length) return;
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const text = String(reader.result||'{}');
      const incoming = JSON.parse(text);
      const cur = JSON.parse(localStorage.getItem('agg_presets')||'{}');
      const merged = {...cur, ...incoming};
      localStorage.setItem('agg_presets', JSON.stringify(merged));
      _loadAggPresets();
      alert('Imported presets: '+Object.keys(incoming).length);
      input.value = '';
    }catch{ alert('Failed to import'); }
  };
  reader.readAsText(file);
}
function formatAggJson(){
  const ids = ['agg-product-map','agg-location-map'];
  for (const id of ids){
    const el = document.getElementById(id);
    if (!el) continue;
    const txt = (el.value||'').trim();
    if (!txt) continue;
    try { const obj = JSON.parse(txt); el.value = JSON.stringify(obj, null, 2);} catch(e){ alert(id+': JSONが不正です'); return; }
  }
}
function _loadAggSuggestions(){
  try{
    const g = JSON.parse(localStorage.getItem('agg_group_keys_suggestions')||'[]');
    const s = JSON.parse(localStorage.getItem('agg_sum_fields_suggestions')||'[]');
    const gl = document.getElementById('agg-group-keys-list');
    const sl = document.getElementById('agg-sum-fields-list');
    if (gl){ gl.innerHTML=''; g.forEach(v=>{ const o=document.createElement('option'); o.value=v; gl.appendChild(o); }); }
    if (sl){ sl.innerHTML=''; s.forEach(v=>{ const o=document.createElement('option'); o.value=v; sl.appendChild(o); }); }
  }catch{}
}
function _updateAggSuggestionsFromCurrent(){
  try{
    const tokenize = (v)=> Array.from(new Set((v||'').split(',').map(x=>x.trim()).filter(Boolean)));
    const gcur = tokenize(document.getElementById('agg-group-keys').value);
    const scur = tokenize(document.getElementById('agg-sum-fields').value);
    const gold = JSON.parse(localStorage.getItem('agg_group_keys_suggestions')||'[]');
    const sold = JSON.parse(localStorage.getItem('agg_sum_fields_suggestions')||'[]');
    const gset = Array.from(new Set([...gold, ...gcur])).slice(0, 20);
    const sset = Array.from(new Set([...sold, ...scur])).slice(0, 20);
    localStorage.setItem('agg_group_keys_suggestions', JSON.stringify(gset));
    localStorage.setItem('agg_sum_fields_suggestions', JSON.stringify(sset));
    _loadAggSuggestions();
  }catch{}
}
async function _seedAggSuggestionsFromLatestRun(){
  try{
    const q = new URLSearchParams({ detail: 'true', limit: '1', sort: 'started_at', order: 'desc' });
    const res = await fetch('/runs?'+q.toString());
    if(!res.ok) return;
    const js = await res.json();
    const rows = js && js.runs || [];
    if(!rows.length) return;
    const r = rows[0];
    const sampleArr = (r.daily_profit_loss && r.daily_profit_loss[0]) ? r.daily_profit_loss : ((r.results && r.results[0]) ? r.results : []);
    if(!sampleArr || !sampleArr[0]) return;
    const sample = sampleArr[0];
    const gCandidates = ['node','item','product','location'];
    const g = gCandidates.filter(k => Object.prototype.hasOwnProperty.call(sample, k));
    const numericKeys = Object.keys(sample).filter(k => typeof sample[k] === 'number' && !g.includes(k) && k !== 'period');
    const gold = JSON.parse(localStorage.getItem('agg_group_keys_suggestions')||'[]');
    const sold = JSON.parse(localStorage.getItem('agg_sum_fields_suggestions')||'[]');
    const gset = Array.from(new Set([...gold, ...g])).slice(0, 20);
    const sset = Array.from(new Set([...sold, ...numericKeys])).slice(0, 20);
    localStorage.setItem('agg_group_keys_suggestions', JSON.stringify(gset));
    localStorage.setItem('agg_sum_fields_suggestions', JSON.stringify(sset));
    _loadAggSuggestions();
  }catch{}
}
(function(){ _loadAggPresets(); _loadAggSuggestions(); _seedAggSuggestionsFromLatestRun(); })();
function _headers(){ try{ const k=localStorage.getItem('api_key')||''; return k? {'X-API-Key':k} : {}; }catch(e){ return {}; } }
async function retryJob(id){
  if(!confirm('Retry this job?')) return;
  try{
    const h = Object.assign({'Content-Type':'application/json'}, _headers());
    const res = await fetch(`/jobs/${id}/retry`, {method:'POST', headers: h});
    if(!res.ok) throw new Error('HTTP '+res.status);
    location.reload();
  }catch(e){ alert('Retry failed'); }
}
async function cancelJob(id){
  if(!confirm('Cancel this job?')) return;
  try{
    const res = await fetch(`/jobs/${id}/cancel`, {method:'POST', headers: _headers()});
    if(!res.ok) throw new Error('HTTP '+res.status);
    location.reload();
  }catch(e){ alert('Cancel failed'); }
}
</script>
{% endblock %}
