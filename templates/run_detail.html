{% extends "base.html" %}
{% block page_header %}
  <h2>Run Detail</h2>
  <p class="mono">{{ run_id }}</p>
{% endblock %}
{% block content %}
<article class="page-section">
  <header style="margin-bottom:1rem;">
    <div id="meta-badges" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
  </header>

  <section>
    <h3>Config</h3>
    <table>
      <tbody>
        <tr><th class="mono">config_id</th><td class="mono">{{ config_id or '' }}</td></tr>
        <tr><th class="mono">config_version_id</th>
          <td class="mono">
            {% if config_version_id %}
              <a href="/ui/configs/canonical/{{ config_version_id }}">{{ config_version_id }}</a>
            {% else %}-{% endif %}
          </td>
        </tr>
        <tr><th class="mono">plan_version_id</th>
          <td class="mono">
            {% if plan_version_id %}
              <a href="/ui/plans/{{ plan_version_id }}">{{ plan_version_id }}</a>
            {% else %}-{% endif %}
          </td>
        </tr>
        <tr><th class="mono">plan_job_id</th>
          <td class="mono">
            {% if plan_job_id %}
              <a href="/ui/jobs/{{ plan_job_id }}">{{ plan_job_id }}</a>
            {% else %}-{% endif %}
          </td>
        </tr>
        <tr><th class="mono">scenario_id</th>
          <td class="mono">
            {% if scenario_id %}
              <a href="/ui/scenarios?highlight={{ scenario_id }}">{{ scenario_id }}</a>
            {% else %}-{% endif %}
          </td>
        </tr>
        <tr><th class="mono">config_json</th><td><pre class="mono" style="max-height:240px; overflow:auto;">{{ config_json_str }}</pre></td></tr>
        <tr><th class="mono">raw</th><td><a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/config.json">/runs/{{ run_id }}/config.json</a></td></tr>
      </tbody>
    </table>
  </section>

  <section>
    <h3>Plan KPI Summary</h3>
    {% if plan_kpi_summary %}
    <table>
      <tbody>
        {% for k, v in plan_kpi_summary.items() %}
        <tr><th class="mono">{{ k }}</th><td>{{ "%.3f"|format(v) if v is not none else '' }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No plan KPI summary available.</p>
    {% endif %}
  </section>

  <section>
    <h3>Summary</h3>
    {% if summary %}
    <table id="summary-table">
      <tbody>
        {% for k, v in summary.items() %}
        <tr><th class="mono">{{ k }}</th><td>{{ v }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No summary.</p>
    {% endif %}
  </section>

  <section>
    <h3>Approval Request</h3>
    <p>Edit and copy the approval template, or store notes for later reference.</p>
    <textarea id="approval-note" rows="5" style="width:100%;"></textarea>
    <div style="margin-top:6px; display:flex; gap:8px;">
      <button id="copy-approval" type="button" class="secondary">Copy template</button>
      <button id="save-note" type="button">Save note</button>
      <button id="compare-baseline" type="button" class="secondary">Compare with baseline</button>
    </div>
  </section>

  <section>
    <h3>Artifacts</h3>
    <ul>
      <li>results: {{ counts.results_len }}</li>
      <li>daily_profit_loss: {{ counts.pl_len }}</li>
      <li>cost_trace: {{ counts.trace_len }}</li>
      <li style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span class="mono">CSV:</span>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/results.csv">results.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/pl.csv">pl.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/summary.csv">summary.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/trace.csv">trace.csv</a>
      </li>
    </ul>
  </section>

  <section>
    <h3>Planning</h3>
    <p>Create a new plan version using this runâ€™s <code>scenario_id</code> and <code>config_json</code> when available.</p>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <button id="create-plan" type="button">Create plan from this run</button>
      <a class="secondary" href="/ui/plans" target="_blank" rel="noopener">Open Planning Hub</a>
    </div>
    {% if matching_plans and matching_plans|length > 0 %}
    <details class="gap-top-sm" open>
      <summary>Plans generated from this configuration</summary>
      <table>
        <thead><tr><th>version_id</th><th>status</th><th>created_at</th></tr></thead>
        <tbody>
          {% for p in matching_plans %}
          <tr>
            <td class="mono"><a href="/ui/plans/{{ p.version_id }}">{{ p.version_id }}</a></td>
            <td>{{ p.status or '' }}</td>
            <td class="mono">{{ p.created_at_str or p.created_at or '' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </details>
    {% endif %}
  </section>

  <footer>
    <a role="button" id="back-link" href="{{ back_href }}">{{ back_label }}</a>
    <div style="float:right; display:flex; gap:6px; flex-wrap:wrap;">
      <button id="approve-run" type="button" data-action="approve">Approve</button>
      <button id="promote-baseline" type="button" data-action="promote">Promote baseline</button>
      <button id="archive-run" type="button" class="secondary" data-action="archive">Archive</button>
      <button id="unarchive-run" type="button" class="secondary" data-action="unarchive">Unarchive</button>
      <button id="delete-run" class="contrast">Delete</button>
    </div>
  </footer>
</article>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const runId = {{ run_id|tojson|safe }};
  const btn = document.createElement('button');
  btn.textContent = 'Refresh summary from API';
  btn.type = 'button';
  const header = document.querySelector('article header');
  if (header) header.appendChild(btn);
  const badges = document.getElementById('meta-badges');
  const approveBtn = document.getElementById('approve-run');
  const promoteBtn = document.getElementById('promote-baseline');
  const archBtn = document.getElementById('archive-run');
  const unarchBtn = document.getElementById('unarchive-run');
  const createPlanBtn = document.getElementById('create-plan');
  const configVersionId = {{ config_version_id|tojson|safe }};

  async function refresh() {
    try {
      const res = await fetch(`/runs/${runId}?detail=false`, { headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const tbody = document.getElementById('summary-table').querySelector('tbody');
      if (!tbody) return;
      const s = data.summary || {};
      tbody.innerHTML = Object.keys(s).map(k => `<tr><th class="mono">${k}</th><td>${s[k]}</td></tr>`).join('');
    } catch (e) {
      console.error(e); alert('Failed to refresh from API');
    }
  }
  btn.addEventListener('click', refresh);
  const delBtn = document.getElementById('delete-run');
  const noteEl = document.getElementById('approval-note');
  const copyBtn = document.getElementById('copy-approval');
  const saveNoteBtn = document.getElementById('save-note');
  const cmpBaseBtn = document.getElementById('compare-baseline');
  async function del() {
    if (!confirm('Delete this run? This action cannot be undone.')) return;
    try {
      const res = await fetch(`/runs/${runId}`, { method: 'DELETE', headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      alert('Run deleted.');
      location.href = '/ui/runs';
    } catch (e) { console.error(e); alert('Failed to delete run.'); }
  }
  if (delBtn) delBtn.addEventListener('click', del);
  function withActionHeaders(action){
    const h = getHeaders();
    // Provide default roles to avoid 403 when RBAC is enabled
    const role = (h['X-Role']||'').trim().toLowerCase();
    if (!role){
      if (action === 'approve' || action === 'promote') h['X-Role'] = 'approver';
      else if (action === 'archive') h['X-Role'] = 'planner';
    }
    if (!h['X-User'] || !String(h['X-User']).trim()) h['X-User'] = 'ui@local';
    return h;
  }

  async function act(url, action){
    try {
      const h = withActionHeaders(action);
      // Fallback for environments without fetch support
      if (typeof window.fetch === 'function'){
        const res = await fetch(url, { method: 'POST', headers: h });
        if (!res.ok){
          let body = '';
          try { body = await res.text(); } catch {}
          throw new Error(`HTTP ${res.status} ${body||''}`);
        }
      } else {
        await new Promise(function(resolve, reject){
          try {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, true);
            try { for (var k in h){ if (Object.prototype.hasOwnProperty.call(h,k)) xhr.setRequestHeader(k, h[k]); } } catch(e){}
            xhr.onreadystatechange = function(){ if (xhr.readyState === 4){ if (xhr.status >=200 && xhr.status <300) resolve(); else reject(new Error('HTTP '+xhr.status+' '+(xhr.responseText||''))); } };
            xhr.send();
          } catch(e){ reject(e); }
        });
      }
      await loadMeta();
      banner('Action completed.');
    } catch (e) { console.error(e); alert('Action failed\n'+(e && e.message ? e.message : '')); }
  }
  if (approveBtn) approveBtn.addEventListener('click', () => act(`/runs/${runId}/approve`, 'approve'));
  if (promoteBtn) promoteBtn.addEventListener('click', () => act(`/runs/${runId}/promote-baseline`, 'promote'));
  if (archBtn) archBtn.addEventListener('click', () => act(`/runs/${runId}/archive`, 'archive'));
  if (unarchBtn) unarchBtn.addEventListener('click', () => act(`/runs/${runId}/unarchive`, 'archive'));

  // Event delegation fallback
  document.addEventListener('click', function(ev){
    var t = ev.target || ev.srcElement;
    if (!t || !t.getAttribute) return;
    var a = t.getAttribute('data-action');
    if (!a) return;
    if (a === 'approve') act(`/runs/${runId}/approve`, 'approve');
    else if (a === 'promote') act(`/runs/${runId}/promote-baseline`, 'promote');
    else if (a === 'archive') act(`/runs/${runId}/archive`, 'archive');
    else if (a === 'unarchive') act(`/runs/${runId}/unarchive`, 'archive');
  });

  function tsId(){
    const t = new Date();
    const pad=n=>String(n).padStart(2,'0');
    return t.getFullYear()+pad(t.getMonth()+1)+pad(t.getDate())+pad(t.getHours())+pad(t.getMinutes())+pad(t.getSeconds());
  }
  function getRunsPrefs(){ try { return JSON.parse(localStorage.getItem('runs_prefs')||'{}') } catch { return {} } }
  function versionFromRun(runId){
    const s = getRunsPrefs();
    const prefix = (s.plan_version_prefix ?? 'run-');
    const withTs = (typeof s.plan_version_ts === 'boolean') ? s.plan_version_ts : true;
    let base = '';
    try { const p = String(runId||'').replace(/[^a-zA-Z0-9]/g,''); base = prefix + p.slice(0,8); } catch { base = prefix + 'run'; }
    return withTs ? (base + '-' + tsId()) : base;
  }

  async function createPlanFromRun(){
    try {
      var sidCell = document.querySelector('table tbody tr:nth-child(2) td');
      const sidTxt = sidCell ? (sidCell.textContent||'') : '';
      const scenarioId = parseInt(sidTxt, 10);
      // Read config_json from the table if present
      let cfg = null;
      try {
        var pre = document.querySelector('table pre.mono');
        if (pre && pre.textContent) cfg = JSON.parse(pre.textContent);
      } catch(e) { cfg = null; }
      const payload = {
        base_scenario_id: Number.isFinite(scenarioId) ? scenarioId : undefined,
        version_id: versionFromRun(runId),
        // Copy matching keys when possible; API fills remaining defaults
        weeks: (cfg && typeof cfg.weeks !== 'undefined') ? cfg.weeks : undefined,
        lt_unit: (cfg && cfg.lt_unit) || undefined,
        cutover_date: (cfg && cfg.cutover_date) || undefined,
        recon_window_days: (cfg && typeof cfg.recon_window_days !== 'undefined') ? cfg.recon_window_days : undefined,
        anchor_policy: (cfg && cfg.anchor_policy) || undefined,
        tol_abs: (cfg && typeof cfg.tol_abs !== 'undefined') ? cfg.tol_abs : undefined,
        tol_rel: (cfg && typeof cfg.tol_rel !== 'undefined') ? cfg.tol_rel : undefined,
        calendar_mode: (cfg && cfg.calendar_mode) || undefined,
        carryover: (cfg && cfg.carryover) || undefined,
        carryover_split: (cfg && typeof cfg.carryover_split !== 'undefined') ? cfg.carryover_split : undefined,
        apply_adjusted: (cfg && !!cfg.apply_adjusted) || false,
        source_run_id: runId,
        note: `created from run ${runId}`
      };
      if (configVersionId) payload.config_version_id = configVersionId;
      const headers = { ...getHeaders(), 'Content-Type':'application/json' };
      const res = await fetch('/plans/integrated/run', { method:'POST', headers, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      if (data && data.version_id){ window.location.href = '/ui/plans/' + data.version_id; }
      else { alert('Plan creation failed (missing version_id).'); }
    } catch(e) {
      console.error('createPlanFromRun failed', e);
      alert('Plan creation failed.');
    }
  }
  if (createPlanBtn) createPlanBtn.addEventListener('click', createPlanFromRun);

  async function loadMeta(){
    try {
      var m = null;
      if (typeof window.fetch === 'function'){
        const res = await fetch(`/runs/${runId}/meta`, { headers: getHeaders() });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        m = await res.json();
      } else {
        m = await new Promise(function(resolve, reject){
          try {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', `/runs/${runId}/meta`, true);
            var h = getHeaders();
            try { for (var k in h){ if (Object.prototype.hasOwnProperty.call(h,k)) xhr.setRequestHeader(k, h[k]); } } catch(e){}
            xhr.onreadystatechange = function(){ if (xhr.readyState === 4){ if (xhr.status >=200 && xhr.status <300){ try { resolve(JSON.parse(xhr.responseText||'{}')); } catch(e){ resolve({}); } } else { reject(new Error('HTTP '+xhr.status)); } } };
            xhr.send();
          } catch(e){ reject(e); }
        });
      }
      if (badges) {
        badges.innerHTML = '';
        if (m.baseline) badges.innerHTML += '<span class="secondary">BASELINE</span>';
        if (m.approved_at) badges.innerHTML += '<span class="secondary">APPROVED</span>';
        if (m.archived) badges.innerHTML += '<span class="secondary">ARCHIVED</span>';
      }
    } catch (e) { console.warn('meta load failed', e); }
  }
  function banner(msg){
    const d = document.createElement('div');
    d.textContent = msg;
    d.style.background = '#e7f5ff';
    d.style.padding = '6px 8px';
    d.style.margin = '6px 0';
    d.setAttribute('role','status');
    (document.querySelector('article')||document.body).prepend(d);
    setTimeout(()=> d.remove(), 2000);
  }
  loadMeta();

  function getHeaders(){
    const h = {};
    try { const k = localStorage.getItem('api_key') || ''; if (k) h['X-API-Key'] = k; } catch {}
    try { const u = localStorage.getItem('user_email') || ''; if (u) h['X-User'] = u; } catch {}
    try { const r = localStorage.getItem('user_role') || ''; if (r) h['X-Role'] = r; } catch {}
    return h;
  }

  function downloadCsv(ev) {
    ev.preventDefault();
    const el = ev.target;
    const url = el.getAttribute('data-url');
    if (!url) return;
    const headers = getHeaders();
    fetch(url, { headers })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const disposition = res.headers.get('content-disposition');
        let filename = url.split('/').pop();
        if (disposition && disposition.includes('attachment')) {
          const m = disposition.match(/filename="?([^;"]+)"?/);
          if (m && m[1]) filename = m[1];
        }
        return res.blob().then(blob => ({ blob, filename }));
      })
      .then(({ blob, filename }) => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      })
      .catch(e => {
        console.error('Download failed', e);
        alert('Download failed. Check API key or server status.');
      });
  }

  document.body.addEventListener('click', ev => {
    if (ev.target.classList.contains('download-csv')) {
      downloadCsv(ev);
    }
  });

  function fillTemplate(){
    try {
      const sTbl = document.getElementById('summary-table');
      const rows = sTbl ? Array.from(sTbl.querySelectorAll('tbody tr')) : [];
      const sum = {};
      rows.forEach(r => {
        const k = r.querySelector('th')?.textContent || '';
        const v = r.querySelector('td')?.textContent || '';
        if (k) sum[k] = v;
      });
      const url = location.origin + '/ui/runs/' + runId;
      const scenario = document.querySelector('table tbody tr:nth-child(2) td')?.textContent || '';
      const lines = [
        `Approval request: Run ${runId}`,
        `- URL: ${url}`,
        `- scenario_id: ${scenario}`,
        `- fill_rate: ${sum.fill_rate || ''}`,
        `- profit_total: ${sum.profit_total || ''}`,
        `- Notes: (add details as needed)`
      ];
      noteEl.value = lines.join('\n');
    } catch {}
  }
  fillTemplate();
  if (copyBtn) copyBtn.addEventListener('click', function(){ try { navigator.clipboard.writeText(noteEl.value||''); alert('Copied.'); } catch (e) { alert('Copy failed.'); } });
  if (saveNoteBtn) saveNoteBtn.addEventListener('click', async function(){
    try {
      const res = await fetch(`/runs/${runId}/note`, { method:'POST', headers: { ...getHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ note: noteEl.value||'' }) });
      if (!res.ok) throw new Error('HTTP '+res.status);
      banner('Note saved.');
    } catch(e){ console.error(e); alert('Failed to save note.'); }
  });

  async function openCompareWithBaseline(){
    try {
      const sidTxt = document.querySelector('table tbody tr:nth-child(2) td')?.textContent||'';
      const sid = parseInt(sidTxt, 10);
      if (!sid){ alert('scenario_id is missing.'); return; }
      const r = await fetch(`/runs/baseline?scenario_id=${sid}`, { headers: getHeaders() });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const js = await r.json();
      const base = js.run_id;
      if (!base){ alert('Baseline not found.'); return; }
      const q = new URLSearchParams({ run_ids: `${base},${runId}`, base_id: base });
      location.href = '/ui/compare/show?' + q.toString();
    } catch(e){ console.error(e); alert('Failed to generate comparison link.'); }
  }
  if (cmpBaseBtn) cmpBaseBtn.addEventListener('click', openCompareWithBaseline);

})();
</script>
{% endblock %}
  // Back link is rendered server-side using template context (from_jobs/back_href)
