{% extends "base.html" %}
{% block page_header %}
  <h2>Run Detail</h2>
  <p class="mono">{{ run_id }}</p>
{% endblock %}
{% block content %}
<article class="page-section">
  <header style="margin-bottom:1rem;">
    <div id="meta-badges" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
  </header>

  <section>
    <h3>Plan Creation</h3>
    <table id="plan-creation-table">
      <tbody>
        <tr data-key="config_version_id"><th class="mono">config_version_id</th>
          <td class="mono">
            {% if config_version_id %}
              <a href="/ui/configs/canonical/{{ config_version_id }}">{{ config_version_id }}</a>
            {% else %}-{% endif %}
          </td>
        </tr>
        <tr data-key="plan_version_id"><th class="mono">plan_version_id</th>
          <td class="mono">
            {% if plan_version_id %}
              <a href="/ui/plans/{{ plan_version_id }}">{{ plan_version_id }}</a>
            {% else %}-{% endif %}
          </td>
        </tr>
        <tr data-key="scenario_id"><th class="mono">scenario_id</th>
          <td class="mono">
            {% if scenario_id %}
              <a href="/ui/scenarios?highlight={{ scenario_id }}">{{ scenario_id }}</a>
            {% else %}-{% endif %}
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <section>
    <h3>Plan KPI Summary</h3>
    {% if plan_kpi_summary %}
    <table>
      <tbody>
        {% for k, v in plan_kpi_summary.items() %}
        <tr><th class="mono">{{ k }}</th><td>{{ "%.3f"|format(v) if v is not none else '' }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No plan KPI summary available.</p>
    {% endif %}
  </section>

  <section>
    <h3>Run Result Summary</h3>
    {% if summary %}
    <table id="summary-table">
      <tbody>
        {% for k, v in summary.items() %}
        {% if k != '_plan_version_id' %}
        <tr><th class="mono">{{ k }}</th><td>{{ v }}</td></tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No summary.</p>
    {% endif %}
  </section>

  <section>
    <h3>Approval Request</h3>
    <p>Edit and copy the approval template, or store notes for later reference.</p>
    <textarea id="approval-note" rows="5" style="width:100%;"></textarea>
    <div style="margin-top:6px; display:flex; gap:8px;">
      <button id="copy-approval" type="button" class="secondary">Copy template</button>
      <button id="save-note" type="button">Save note</button>
    </div>
  </section>

  <section>
    <h3>Artifacts</h3>
    <ul>
      <li>results: {{ counts.results_len }}</li>
      <li>daily_profit_loss: {{ counts.pl_len }}</li>
      <li>cost_trace: {{ counts.trace_len }}</li>
      <li style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span class="mono">CSV:</span>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/results.csv">results.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/pl.csv">pl.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/summary.csv">summary.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/trace.csv">trace.csv</a>
      </li>
    </ul>
  </section>

  <footer>
    <a role="button" id="back-link" href="{{ back_href }}">{{ back_label }}</a>
    <div style="float:right; display:flex; gap:6px; flex-wrap:wrap;">
      <button id="approve-run" type="button" data-action="approve">Approve</button>
      <button id="promote-baseline" type="button" data-action="promote">Promote baseline</button>
      <button id="archive-run" type="button" class="secondary" data-action="archive">Archive</button>
      <button id="unarchive-run" type="button" class="secondary" data-action="unarchive">Unarchive</button>
      <button id="delete-run" class="contrast">Delete</button>
    </div>
  </footer>
</article>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const runId = {{ run_id|tojson|safe }};
  const btn = document.createElement('button');
  btn.textContent = 'Refresh summary from API';
  btn.type = 'button';
  const header = document.querySelector('article header');
  if (header) header.appendChild(btn);
  const badges = document.getElementById('meta-badges');
  const approveBtn = document.getElementById('approve-run');
  const promoteBtn = document.getElementById('promote-baseline');
  const archBtn = document.getElementById('archive-run');
  const unarchBtn = document.getElementById('unarchive-run');
  const actionButtons = [approveBtn, promoteBtn, archBtn, unarchBtn];

  function setActionButtonsDisabled(reason){
    actionButtons.forEach(function(btn){
      if (!btn) return;
      if (reason){
        btn.disabled = true;
        btn.setAttribute('title', reason);
        btn.setAttribute('aria-disabled', 'true');
      } else {
        btn.disabled = false;
        btn.removeAttribute('title');
        btn.removeAttribute('aria-disabled');
      }
    });
  }

  async function refresh() {
    try {
      const res = await fetch(`/runs/${runId}?detail=false`, { headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const tbody = document.getElementById('summary-table').querySelector('tbody');
      if (!tbody) return;
      const s = data.summary || {};
      tbody.innerHTML = Object.keys(s).map(k => `<tr><th class="mono">${k}</th><td>${s[k]}</td></tr>`).join('');
    } catch (e) {
      console.error(e); alert('Failed to refresh from API');
    }
  }
  btn.addEventListener('click', refresh);
  const delBtn = document.getElementById('delete-run');
  const noteEl = document.getElementById('approval-note');
  const copyBtn = document.getElementById('copy-approval');
  const saveNoteBtn = document.getElementById('save-note');
  const planCreationTable = document.getElementById('plan-creation-table');
  async function del() {
    if (!confirm('Delete this run? This action cannot be undone.')) return;
    try {
      const res = await fetch(`/runs/${runId}`, { method: 'DELETE', headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      alert('Run deleted.');
      location.href = '/ui/runs';
    } catch (e) { console.error(e); alert('Failed to delete run.'); }
  }
  if (delBtn) delBtn.addEventListener('click', del);
  function withActionHeaders(action){
    const h = getHeaders();
    // Provide default roles to avoid 403 when RBAC is enabled
    const role = (h['X-Role']||'').trim().toLowerCase();
    if (!role){
      if (action === 'approve' || action === 'promote') h['X-Role'] = 'approver';
      else if (action === 'archive') h['X-Role'] = 'planner';
      else if (action === 'note') h['X-Role'] = 'planner';
    }
    if (!h['X-User'] || !String(h['X-User']).trim()) h['X-User'] = 'ui@local';
    return h;
  }

  async function act(url, action){
    try {
      const h = withActionHeaders(action);
      // Fallback for environments without fetch support
      if (typeof window.fetch === 'function'){
        const res = await fetch(url, { method: 'POST', headers: h });
        if (!res.ok){
          let body = '';
          try { body = await res.text(); } catch {}
          throw new Error(`HTTP ${res.status} ${body||''}`);
        }
      } else {
        await new Promise(function(resolve, reject){
          try {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, true);
            try { for (var k in h){ if (Object.prototype.hasOwnProperty.call(h,k)) xhr.setRequestHeader(k, h[k]); } } catch(e){}
            xhr.onreadystatechange = function(){ if (xhr.readyState === 4){ if (xhr.status >=200 && xhr.status <300) resolve(); else reject(new Error('HTTP '+xhr.status+' '+(xhr.responseText||''))); } };
            xhr.send();
          } catch(e){ reject(e); }
        });
      }
      await loadMeta();
      banner('Action completed.');
    } catch (e) { console.error(e); alert('Action failed\n'+(e && e.message ? e.message : '')); }
  }
  if (approveBtn) approveBtn.addEventListener('click', () => act(`/runs/${runId}/approve`, 'approve'));
  if (promoteBtn) promoteBtn.addEventListener('click', () => act(`/runs/${runId}/promote-baseline`, 'promote'));
  if (archBtn) archBtn.addEventListener('click', () => act(`/runs/${runId}/archive`, 'archive'));
  if (unarchBtn) unarchBtn.addEventListener('click', () => act(`/runs/${runId}/unarchive`, 'archive'));

  // Event delegation fallback
  document.addEventListener('click', function(ev){
    var t = ev.target || ev.srcElement;
    if (!t || !t.getAttribute) return;
    var a = t.getAttribute('data-action');
    if (!a) return;
    if (a === 'approve') act(`/runs/${runId}/approve`, 'approve');
    else if (a === 'promote') act(`/runs/${runId}/promote-baseline`, 'promote');
    else if (a === 'archive') act(`/runs/${runId}/archive`, 'archive');
    else if (a === 'unarchive') act(`/runs/${runId}/unarchive`, 'archive');
  });

  async function loadMeta(){
    try {
      var m = null;
      if (typeof window.fetch === 'function'){
        const res = await fetch(`/runs/${runId}/meta`, { headers: getHeaders() });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        m = await res.json();
      } else {
        m = await new Promise(function(resolve, reject){
          try {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', `/runs/${runId}/meta`, true);
            var h = getHeaders();
            try { for (var k in h){ if (Object.prototype.hasOwnProperty.call(h,k)) xhr.setRequestHeader(k, h[k]); } } catch(e){}
            xhr.onreadystatechange = function(){ if (xhr.readyState === 4){ if (xhr.status >=200 && xhr.status <300){ try { resolve(JSON.parse(xhr.responseText||'{}')); } catch(e){ resolve({}); } } else { reject(new Error('HTTP '+xhr.status)); } } };
            xhr.send();
          } catch(e){ reject(e); }
        });
      }
      if (badges) {
        badges.innerHTML = '';
        if (m.baseline) badges.innerHTML += '<span class="secondary">BASELINE</span>';
        if (m.approved_at) badges.innerHTML += '<span class="secondary">APPROVED</span>';
        if (m.archived) badges.innerHTML += '<span class="secondary">ARCHIVED</span>';
      }
      setActionButtonsDisabled(null);
    } catch (e) {
      console.warn('meta load failed', e);
      setActionButtonsDisabled('Runメタ情報を取得できませんでした。マイグレーション適用後に再試行してください。');
      banner('Runメタ情報を取得できませんでした。承認・ベースライン操作は無効化されています。', 'error');
    }
  }
  function banner(msg, tone){
    const d = document.createElement('div');
    d.textContent = msg;
    d.style.background = tone === 'error' ? '#ffe3e3' : '#e7f5ff';
    d.style.padding = '6px 8px';
    d.style.margin = '6px 0';
    d.setAttribute('role','status');
    (document.querySelector('article')||document.body).prepend(d);
    setTimeout(()=> d.remove(), 2000);
  }
  setActionButtonsDisabled('Runメタ情報を取得中です…');
  loadMeta();

  function getHeaders(){
    const h = {};
    try { const k = localStorage.getItem('api_key') || ''; if (k) h['X-API-Key'] = k; } catch {}
    try { const u = localStorage.getItem('user_email') || ''; if (u) h['X-User'] = u; } catch {}
    try { const r = localStorage.getItem('user_role') || ''; if (r) h['X-Role'] = r; } catch {}
    return h;
  }

  function downloadCsv(ev) {
    ev.preventDefault();
    const el = ev.target;
    const url = el.getAttribute('data-url');
    if (!url) return;
    const headers = getHeaders();
    fetch(url, { headers })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const disposition = res.headers.get('content-disposition');
        let filename = url.split('/').pop();
        if (disposition && disposition.includes('attachment')) {
          const m = disposition.match(/filename="?([^;"]+)"?/);
          if (m && m[1]) filename = m[1];
        }
        return res.blob().then(blob => ({ blob, filename }));
      })
      .then(({ blob, filename }) => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      })
      .catch(e => {
        console.error('Download failed', e);
        alert('Download failed. Check API key or server status.');
      });
  }

  document.body.addEventListener('click', ev => {
    if (ev.target.classList.contains('download-csv')) {
      downloadCsv(ev);
    }
  });

  function getPlanCreationValue(key){
    if (!planCreationTable) return '';
    try {
      const row = planCreationTable.querySelector(`tr[data-key="${key}"]`);
      if (!row) return '';
      const cell = row.querySelector('td');
      return cell ? cell.textContent.trim() : '';
    } catch (e) {
      return '';
    }
  }

  function fillTemplate(){
    try {
      const sTbl = document.getElementById('summary-table');
      const rows = sTbl ? Array.from(sTbl.querySelectorAll('tbody tr')) : [];
      const sum = {};
      rows.forEach(r => {
        const k = r.querySelector('th')?.textContent || '';
        const v = r.querySelector('td')?.textContent || '';
        if (k) sum[k] = v;
      });
      const url = location.origin + '/ui/runs/' + runId;
      const planVersionId = getPlanCreationValue('plan_version_id');
      const lines = [
        `Approval request: Run ${runId}`,
        `- URL: ${url}`,
        `- plan_version_id: ${planVersionId}`,
        `- fill_rate: ${sum.fill_rate || ''}`,
        `- profit_total: ${sum.profit_total || ''}`,
        `- Notes: (add details as needed)`
      ];
      if (noteEl) noteEl.value = lines.join('\n');
    } catch {}
  }
  fillTemplate();
  if (copyBtn) copyBtn.addEventListener('click', function(){ try { navigator.clipboard.writeText(noteEl.value||''); alert('Copied.'); } catch (e) { alert('Copy failed.'); } });
  if (saveNoteBtn) saveNoteBtn.addEventListener('click', async function(){
    try {
      const headers = withActionHeaders('note');
      headers['Content-Type'] = 'application/json';
      const payload = { note: noteEl ? (noteEl.value || '') : '' };
      const res = await fetch(`/runs/${runId}/note`, { method:'POST', headers, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('HTTP '+res.status);
      banner('Note saved.');
    } catch(e){ console.error(e); alert('Failed to save note.'); }
  });

})();
</script>
{% endblock %}
  // Back link is rendered server-side using template context (from_jobs/back_href)
