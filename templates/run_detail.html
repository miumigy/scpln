{% extends "base.html" %}
{% block content %}
<article>
  <header>
    <h2>Run Detail</h2>
    <p class="mono">{{ run_id }}</p>
  </header>

  <section>
    <h3>Summary</h3>
    {% if summary %}
    <table>
      <tbody>
        {% for k, v in summary.items() %}
        <tr><th class="mono">{{ k }}</th><td>{{ v }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No summary.</p>
    {% endif %}
  </section>

  <section>
    <h3>Artifacts</h3>
    <ul>
      <li>results: {{ counts.results_len }}</li>
      <li>daily_profit_loss: {{ counts.pl_len }}</li>
      <li>cost_trace: {{ counts.trace_len }}</li>
      <li style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span class="mono">CSV:</span>
        <a role="button" class="secondary" href="/runs/{{ run_id }}/results.csv">results.csv</a>
        <a role="button" class="secondary" href="/runs/{{ run_id }}/pl.csv">pl.csv</a>
        <a role="button" class="secondary" href="/runs/{{ run_id }}/summary.csv">summary.csv</a>
        <a role="button" class="secondary" href="/runs/{{ run_id }}/trace.csv">trace.csv</a>
      </li>
    </ul>
  </section>

  <footer>
    <a role="button" href="/ui/runs">‚Üê Back to runs</a>
  </footer>
</article>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const runId = {{ run_id|tojson|safe }};
  const btn = document.createElement('button');
  btn.textContent = 'Refresh summary from API';
  btn.type = 'button';
  const header = document.querySelector('article header');
  if (header) header.appendChild(btn);

  async function refresh() {
    try {
      const res = await fetch(`/runs/${runId}?detail=false`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const tbody = document.querySelector('section table tbody');
      if (!tbody) return;
      const s = data.summary || {};
      tbody.innerHTML = Object.keys(s).map(k => `<tr><th class="mono">${k}</th><td>${s[k]}</td></tr>`).join('');
    } catch (e) {
      console.error(e); alert('Failed to refresh from API');
    }
  }
  btn.addEventListener('click', refresh);
})();
</script>
{% endblock %}
