{% extends "base.html" %}
{% block head %}
  <style>
    .run-detail__header {
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: space-between;
    }
    .run-detail__header > * {
      flex: 0 0 auto;
    }
    .run-detail__badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      flex: 1 1 auto;
    }
    .run-detail__csv-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .run-detail__note {
      width: 100%;
      max-width: 100%;
    }
    .run-detail__note-actions {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .run-detail__artifact {
      margin-top: 1.25rem;
    }
    .run-detail__artifact-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .run-detail__artifact-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .run-detail__artifact-table {
      overflow: auto;
      border: 1px solid var(--surface-border);
      border-radius: 12px;
      background: #f8fafc;
      padding: 0.75rem;
    }
    .run-detail__artifact-table .placeholder {
      margin: 0;
      color: #61748f;
    }
    .run-detail__footer {
      margin-top: 2rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
    }
    .run-detail__footer-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    @media (max-width: 768px) {
      .run-detail__header {
        flex-direction: column;
        align-items: stretch;
      }
      .run-detail__header > * {
        width: 100%;
      }
      .run-detail__header button {
        width: 100%;
      }
      .run-detail__note-actions button {
        width: 100%;
      }
      .run-detail__artifact-toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      .run-detail__artifact-toolbar button,
      .run-detail__artifact-toolbar a[role="button"],
      .run-detail__artifact-toolbar select {
        width: 100%;
      }
      .run-detail__artifact-actions {
        width: 100%;
      }
      .run-detail__artifact-actions button,
      .run-detail__artifact-actions a[role="button"] {
        width: 100%;
      }
      .run-detail__footer {
        flex-direction: column;
        align-items: stretch;
      }
      .run-detail__footer-actions {
        width: 100%;
      }
      .run-detail__footer-actions button {
        width: 100%;
      }
    }
  </style>
{% endblock %}
{% block page_header %}
  <h2>Run Detail</h2>
  <p class="mono">{{ run_id }}</p>
{% endblock %}
{% block content %}
<article class="page-section run-detail">
  <header class="run-detail__header">
    <div id="meta-badges" class="run-detail__badges"></div>
  </header>

  <section>
    <h3>Plan Creation</h3>
    <table id="plan-creation-table">
      <tbody>
        <tr data-key="config_version_id"><th class="mono">config_version_id</th>
          <td class="mono">
            {% if config_version_id %}
              <a href="/ui/configs/canonical/{{ config_version_id }}">{{ config_version_id }}</a>
            {% else %}-{% endif %}
          </td>
        </tr>
        <tr data-key="plan_version_id"><th class="mono">plan_version_id</th>
          <td class="mono">
            {% if plan_version_id %}
              <a href="/ui/plans/{{ plan_version_id }}">{{ plan_version_id }}</a>
            {% else %}-{% endif %}
          </td>
        </tr>
        <tr data-key="scenario_id"><th class="mono">scenario_id</th>
          <td class="mono">
            {% if scenario_id %}
              <a href="/ui/scenarios?highlight={{ scenario_id }}">{{ scenario_id }}</a>
            {% else %}-{% endif %}
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <section>
    <h3>Plan KPI Summary</h3>
    {% if plan_kpi_summary %}
    <table>
      <tbody>
        {% for k, v in plan_kpi_summary.items() %}
        {% set formatted = v|fmt_metric(k) %}
        <tr><th class="mono">{{ k }}</th><td>{{ formatted if formatted != '' else (v if v is not none else '') }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No plan KPI summary available.</p>
    {% endif %}
  </section>

  <section>
    <h3>Run Result Summary</h3>
    {% if summary %}
    <table id="summary-table">
      <tbody>
        {% for k, v in summary.items() %}
        {% if k != '_plan_version_id' %}
        {% set fmt_val = v|fmt_metric(k) %}
        <tr><th class="mono">{{ k }}</th><td>{{ fmt_val if fmt_val != '' else v }}</td></tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No summary.</p>
    {% endif %}
  </section>

  <section>
    <h3>Approval Request</h3>
    <p>Edit and copy the approval template, or store notes for later reference.</p>
    <textarea id="approval-note" class="run-detail__note" rows="5"></textarea>
    <div class="run-detail__note-actions">
      <button id="copy-approval" type="button" class="secondary">Copy template</button>
      <button id="save-note" type="button">Save note</button>
    </div>
  </section>

  <section>
    <h3>Artifacts</h3>
    <ul>
      <li>results: {{ counts.results_len|fmt_number }}</li>
      <li>daily_profit_loss: {{ counts.pl_len|fmt_number }}</li>
      <li>cost_trace: {{ counts.trace_len|fmt_number }}</li>
      <li class="run-detail__csv-links">
        <span class="mono">CSV:</span>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/results.csv">results.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/pl.csv">pl.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/summary.csv">summary.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/trace.csv">trace.csv</a>
      </li>
    </ul>
  </section>

  <section>
    <h3>Artifact Tables</h3>
    <p style="margin-bottom:12px;">Preview artifact data inline (first 200 rows per table). Use CSV download for complete export.</p>

    <div class="artifact-preview run-detail__artifact" data-artifact="results">
      <div class="run-detail__artifact-toolbar">
        <strong class="mono">results</strong>
        <span>Rows: <span class="mono" id="artifact-count-results">{{ counts.results_len|fmt_number }}</span></span>
        <div class="run-detail__artifact-actions">
          <button type="button" class="secondary artifact-load" data-action="artifact-load" data-artifact="results">Load table</button>
          <button type="button" class="secondary artifact-more" data-action="artifact-more" data-artifact="results" hidden>Show more</button>
          <button type="button" class="secondary artifact-reset" data-action="artifact-reset" data-artifact="results" hidden>Collapse</button>
        </div>
        <span class="mono artifact-status" data-artifact="results" aria-live="polite"></span>
      </div>
      <div class="artifact-table-container run-detail__artifact-table" id="artifact-table-results" data-placeholder="Load the table to inspect results inline.">
        <p class="placeholder">Load the table to inspect results inline.</p>
      </div>
    </div>

    <div class="artifact-preview run-detail__artifact" data-artifact="daily_profit_loss">
      <div class="run-detail__artifact-toolbar">
        <strong class="mono">daily_profit_loss</strong>
        <span>Rows: <span class="mono" id="artifact-count-daily_profit_loss">{{ counts.pl_len|fmt_number }}</span></span>
        <div class="run-detail__artifact-actions">
          <button type="button" class="secondary artifact-load" data-action="artifact-load" data-artifact="daily_profit_loss">Load table</button>
          <button type="button" class="secondary artifact-more" data-action="artifact-more" data-artifact="daily_profit_loss" hidden>Show more</button>
          <button type="button" class="secondary artifact-reset" data-action="artifact-reset" data-artifact="daily_profit_loss" hidden>Collapse</button>
        </div>
        <span class="mono artifact-status" data-artifact="daily_profit_loss" aria-live="polite"></span>
      </div>
      <div class="artifact-table-container run-detail__artifact-table" id="artifact-table-daily_profit_loss" data-placeholder="Load the table to inspect daily profit/loss rows inline.">
        <p class="placeholder">Load the table to inspect daily profit/loss rows inline.</p>
      </div>
    </div>

    <div class="artifact-preview run-detail__artifact" data-artifact="cost_trace">
      <div class="run-detail__artifact-toolbar">
        <strong class="mono">cost_trace</strong>
        <span>Rows: <span class="mono" id="artifact-count-cost_trace">{{ counts.trace_len|fmt_number }}</span></span>
        <div class="run-detail__artifact-actions">
          <button type="button" class="secondary artifact-load" data-action="artifact-load" data-artifact="cost_trace">Load table</button>
          <button type="button" class="secondary artifact-more" data-action="artifact-more" data-artifact="cost_trace" hidden>Show more</button>
          <button type="button" class="secondary artifact-reset" data-action="artifact-reset" data-artifact="cost_trace" hidden>Collapse</button>
        </div>
        <span class="mono artifact-status" data-artifact="cost_trace" aria-live="polite"></span>
      </div>
      <div class="artifact-table-container run-detail__artifact-table" id="artifact-table-cost_trace" data-placeholder="Load the table to inspect cost trace entries inline.">
        <p class="placeholder">Load the table to inspect cost trace entries inline.</p>
      </div>
    </div>
  </section>

  <footer class="run-detail__footer">
    <a role="button" id="back-link" href="{{ back_href }}">{{ back_label }}</a>
    <div class="run-detail__footer-actions">
      <button id="approve-run" type="button" data-action="approve">Approve</button>
      <button id="promote-baseline" type="button" data-action="promote">Promote baseline</button>
      <button id="archive-run" type="button" class="secondary" data-action="archive">Archive</button>
      <button id="unarchive-run" type="button" class="secondary" data-action="unarchive">Unarchive</button>
      <button id="delete-run" class="contrast">Delete</button>
    </div>
  </footer>
</article>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const runId = {{ run_id|tojson|safe }};
  const btn = document.createElement('button');
  btn.textContent = 'Refresh summary from API';
  btn.type = 'button';
  const header = document.querySelector('article header');
  if (header) header.appendChild(btn);
  const badges = document.getElementById('meta-badges');
  const approveBtn = document.getElementById('approve-run');
  const promoteBtn = document.getElementById('promote-baseline');
  const archBtn = document.getElementById('archive-run');
  const unarchBtn = document.getElementById('unarchive-run');
  const actionButtons = [approveBtn, promoteBtn, archBtn, unarchBtn];
  const ARTIFACT_LIMIT = 200;
  const ARTIFACT_PAGE_SIZE = 50;
  const artifactStates = {};
  let runDetailCache = null;

  function setActionButtonsDisabled(reason){
    actionButtons.forEach(function(btn){
      if (!btn) return;
      if (reason){
        btn.disabled = true;
        btn.setAttribute('title', reason);
        btn.setAttribute('aria-disabled', 'true');
      } else {
        btn.disabled = false;
        btn.removeAttribute('title');
        btn.removeAttribute('aria-disabled');
      }
    });
  }

  async function refresh() {
    try {
      const res = await fetch(`/runs/${runId}?detail=false`, { headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const tbody = document.getElementById('summary-table').querySelector('tbody');
      if (!tbody) return;
      const s = data.summary || {};
      tbody.innerHTML = Object.keys(s).map(k => `<tr><th class="mono">${k}</th><td>${s[k]}</td></tr>`).join('');
    } catch (e) {
      console.error(e); alert('Failed to refresh from API');
    }
  }
  btn.addEventListener('click', refresh);
  const delBtn = document.getElementById('delete-run');
  const noteEl = document.getElementById('approval-note');
  const copyBtn = document.getElementById('copy-approval');
  const saveNoteBtn = document.getElementById('save-note');
  const planCreationTable = document.getElementById('plan-creation-table');
  async function del() {
    if (!confirm('Delete this run? This action cannot be undone.')) return;
    try {
      const res = await fetch(`/runs/${runId}`, { method: 'DELETE', headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      alert('Run deleted.');
      location.href = '/ui/runs';
    } catch (e) { console.error(e); alert('Failed to delete run.'); }
  }
  if (delBtn) delBtn.addEventListener('click', del);
  function withActionHeaders(action){
    const h = getHeaders();
    // Provide default roles to avoid 403 when RBAC is enabled
    const role = (h['X-Role']||'').trim().toLowerCase();
    if (!role){
      if (action === 'approve' || action === 'promote') h['X-Role'] = 'approver';
      else if (action === 'archive') h['X-Role'] = 'planner';
      else if (action === 'note') h['X-Role'] = 'planner';
    }
    if (!h['X-User'] || !String(h['X-User']).trim()) h['X-User'] = 'ui@local';
    return h;
  }

  async function act(url, action){
    try {
      const h = withActionHeaders(action);
      // Fallback for environments without fetch support
      if (typeof window.fetch === 'function'){
        const res = await fetch(url, { method: 'POST', headers: h });
        if (!res.ok){
          let body = '';
          try { body = await res.text(); } catch {}
          throw new Error(`HTTP ${res.status} ${body||''}`);
        }
      } else {
        await new Promise(function(resolve, reject){
          try {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, true);
            try { for (var k in h){ if (Object.prototype.hasOwnProperty.call(h,k)) xhr.setRequestHeader(k, h[k]); } } catch(e){}
            xhr.onreadystatechange = function(){ if (xhr.readyState === 4){ if (xhr.status >=200 && xhr.status <300) resolve(); else reject(new Error('HTTP '+xhr.status+' '+(xhr.responseText||''))); } };
            xhr.send();
          } catch(e){ reject(e); }
        });
      }
      await loadMeta();
      banner('Action completed.');
    } catch (e) { console.error(e); alert('Action failed\n'+(e && e.message ? e.message : '')); }
  }
  if (approveBtn) approveBtn.addEventListener('click', () => act(`/runs/${runId}/approve`, 'approve'));
  if (promoteBtn) promoteBtn.addEventListener('click', () => act(`/runs/${runId}/promote-baseline`, 'promote'));
  if (archBtn) archBtn.addEventListener('click', () => act(`/runs/${runId}/archive`, 'archive'));
  if (unarchBtn) unarchBtn.addEventListener('click', () => act(`/runs/${runId}/unarchive`, 'archive'));

  // Event delegation fallback
  document.addEventListener('click', function(ev){
    var t = ev.target || ev.srcElement;
    if (!t || !t.getAttribute) return;
    var a = t.getAttribute('data-action');
    if (!a) return;
    if (a === 'approve') act(`/runs/${runId}/approve`, 'approve');
    else if (a === 'promote') act(`/runs/${runId}/promote-baseline`, 'promote');
    else if (a === 'archive') act(`/runs/${runId}/archive`, 'archive');
    else if (a === 'unarchive') act(`/runs/${runId}/unarchive`, 'archive');
  });

  async function loadMeta(){
    try {
      var m = null;
      if (typeof window.fetch === 'function'){
        const res = await fetch(`/runs/${runId}/meta`, { headers: getHeaders() });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        m = await res.json();
      } else {
        m = await new Promise(function(resolve, reject){
          try {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', `/runs/${runId}/meta`, true);
            var h = getHeaders();
            try { for (var k in h){ if (Object.prototype.hasOwnProperty.call(h,k)) xhr.setRequestHeader(k, h[k]); } } catch(e){}
            xhr.onreadystatechange = function(){ if (xhr.readyState === 4){ if (xhr.status >=200 && xhr.status <300){ try { resolve(JSON.parse(xhr.responseText||'{}')); } catch(e){ resolve({}); } } else { reject(new Error('HTTP '+xhr.status)); } } };
            xhr.send();
          } catch(e){ reject(e); }
        });
      }
      if (badges) {
        badges.innerHTML = '';
        if (m.baseline) badges.innerHTML += '<span class="secondary">BASELINE</span>';
        if (m.approved_at) badges.innerHTML += '<span class="secondary">APPROVED</span>';
        if (m.archived) badges.innerHTML += '<span class="secondary">ARCHIVED</span>';
      }
      setActionButtonsDisabled(null);
    } catch (e) {
      console.warn('meta load failed', e);
      setActionButtonsDisabled('Runメタ情報を取得できませんでした。マイグレーション適用後に再試行してください。');
      banner('Runメタ情報を取得できませんでした。承認・ベースライン操作は無効化されています。', 'error');
    }
  }
  function banner(msg, tone){
    const d = document.createElement('div');
    d.textContent = msg;
    d.style.background = tone === 'error' ? '#ffe3e3' : '#e7f5ff';
    d.style.padding = '6px 8px';
    d.style.margin = '6px 0';
    d.setAttribute('role','status');
    (document.querySelector('article')||document.body).prepend(d);
    setTimeout(()=> d.remove(), 2000);
  }
  setActionButtonsDisabled('Runメタ情報を取得中です…');
  loadMeta();

  function getHeaders(){
    const h = {};
    try { const k = localStorage.getItem('api_key') || ''; if (k) h['X-API-Key'] = k; } catch {}
    try { const u = localStorage.getItem('user_email') || ''; if (u) h['X-User'] = u; } catch {}
    try { const r = localStorage.getItem('user_role') || ''; if (r) h['X-Role'] = r; } catch {}
    return h;
  }

  function downloadCsv(ev) {
    ev.preventDefault();
    const el = ev.target && typeof ev.target.closest === 'function'
      ? ev.target.closest('.download-csv')
      : null;
    if (!el) return;
    const url = el.getAttribute('data-url');
    if (!url) return;
    const headers = getHeaders();
    fetch(url, { headers })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const disposition = res.headers.get('content-disposition');
        let filename = url.split('/').pop();
        if (disposition && disposition.includes('attachment')) {
          const m = disposition.match(/filename="?([^;"]+)"?/);
          if (m && m[1]) filename = m[1];
        }
        return res.blob().then(blob => ({ blob, filename }));
      })
      .then(({ blob, filename }) => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      })
      .catch(e => {
        console.error('Download failed', e);
        alert('Download failed. Check API key or server status.');
      });
  }

  document.body.addEventListener('click', ev => {
    const target = ev.target;
    const downloadLink =
      target && typeof target.closest === 'function'
        ? target.closest('.download-csv')
        : null;
    if (downloadLink) {
      downloadCsv(ev);
      return;
    }
    const btn =
      target && typeof target.closest === 'function'
        ? target.closest('button[data-action]')
        : null;
    if (!btn) return;
    const action = btn.getAttribute('data-action');
    const key = btn.getAttribute('data-artifact');
    if (!action || !key) return;
    if (action === 'artifact-load') {
      loadArtifact(key);
    } else if (action === 'artifact-more') {
      showMoreArtifact(key);
    } else if (action === 'artifact-reset') {
      resetArtifact(key);
    }
  });

  function ensureRunDetail() {
    if (runDetailCache) return Promise.resolve(runDetailCache);
    return fetch(`/runs/${runId}?detail=true`, { headers: getHeaders() }).then(
      res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json().then(data => {
          runDetailCache = data || {};
          return runDetailCache;
        });
      },
    );
  }

  function getArtifactElements(key) {
    return {
      container: document.getElementById(`artifact-table-${key}`),
      loadBtn: document.querySelector(
        `button[data-action="artifact-load"][data-artifact="${key}"]`,
      ),
      moreBtn: document.querySelector(
        `button[data-action="artifact-more"][data-artifact="${key}"]`,
      ),
      resetBtn: document.querySelector(
        `button[data-action="artifact-reset"][data-artifact="${key}"]`,
      ),
      statusEl: document.querySelector(
        `.artifact-status[data-artifact="${key}"]`,
      ),
    };
  }

  function updateArtifactStatus(key, text) {
    const { statusEl } = getArtifactElements(key);
    if (statusEl) statusEl.textContent = text || '';
  }

  function setArtifactLoading(key, loading) {
    const { loadBtn, moreBtn } = getArtifactElements(key);
    if (loadBtn) loadBtn.disabled = !!loading;
    if (moreBtn && loading) {
      moreBtn.disabled = true;
    } else if (moreBtn) {
      moreBtn.disabled = false;
    }
  }

  function flattenRow(row) {
    if (row && typeof row === 'object' && !Array.isArray(row)) {
      const out = {};
      (function walk(obj, prefix) {
        Object.keys(obj || {}).forEach(k => {
          const value = obj[k];
          const key = prefix ? `${prefix}.${k}` : k;
          if (value && typeof value === 'object' && !Array.isArray(value)) {
            walk(value, key);
          } else if (Array.isArray(value)) {
            try {
              out[key] = JSON.stringify(value);
            } catch (e) {
              out[key] = String(value);
            }
          } else {
            out[key] = value;
          }
        });
      })(row, '');
      return out;
    }
    return { value: row };
  }

  function deriveColumns(rows) {
    const cols = new Set();
    rows.forEach(r => {
      Object.keys(r || {}).forEach(key => cols.add(key));
    });
    if (!cols.size) return ['value'];
    return Array.from(cols).sort();
  }

  function escapeHtml(value) {
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function formatCell(value) {
    if (value === null || value === undefined) return '';
    if (typeof value === 'number') {
      if (!Number.isFinite(value)) return escapeHtml(value);
      return escapeHtml(value.toString());
    }
    if (typeof value === 'boolean') {
      return value ? 'true' : 'false';
    }
    return escapeHtml(value);
  }

  function renderArtifactTable(key) {
    const state = artifactStates[key];
    const { container, moreBtn, resetBtn, loadBtn } = getArtifactElements(key);
    if (!container) return;
    if (!state || !state.flatRows.length || !state.columns.length) {
      if (state) state.currentVisible = 0;
      const placeholder =
        container.getAttribute('data-placeholder') || 'No rows.';
      container.innerHTML = `<p class="placeholder">${escapeHtml(
        placeholder,
      )}</p>`;
      if (moreBtn) moreBtn.hidden = true;
      if (resetBtn) resetBtn.hidden = true;
      updateArtifactStatusFromState(key);
      return;
    }
    const maxRows = state.flatRows.length;
    const renderCount = Math.min(state.page * state.pageSize, maxRows);
    const columns = state.columns;
    const headerHtml = columns
      .map(c => `<th class="mono">${escapeHtml(c)}</th>`)
      .join('');
    const rowsSlice = state.flatRows.slice(0, renderCount);
    state.currentVisible = renderCount;
    const rowsHtml = rowsSlice
      .map(r => {
        const cells = columns
          .map(col => `<td>${formatCell(r[col])}</td>`)
          .join('');
        return `<tr>${cells}</tr>`;
      })
      .join('');
    const emptyRow = `<tr><td colspan="${
      columns.length || 1
    }" class="mono">No rows</td></tr>`;
    container.innerHTML = `<div class="artifact-table-scroll" style="max-height:420px; overflow:auto;"><table><thead><tr>${headerHtml}</tr></thead><tbody>${
      rowsHtml || emptyRow
    }</tbody></table></div>`;
    if (moreBtn) {
      const hasMore = renderCount < maxRows;
      moreBtn.hidden = !hasMore;
      moreBtn.disabled = !hasMore;
    }
    if (resetBtn) resetBtn.hidden = false;
    updateArtifactStatusFromState(key);
  }

  function updateArtifactStatusFromState(key) {
    const state = artifactStates[key];
    if (!state) {
      updateArtifactStatus(key, '');
      return;
    }
    const total =
      typeof state.total === 'number' ? state.total : state.flatRows.length;
    if (!state.flatRows.length) {
      if (total > 0) {
        updateArtifactStatus(
          key,
          `No preview rows available (source rows: ${total}).`,
        );
      } else {
        updateArtifactStatus(key, 'No rows available.');
      }
      return;
    }
    const visible = Math.min(
      state.currentVisible || 0,
      state.flatRows.length,
    );
    const previewMax = state.flatRows.length;
    if (!visible) {
      if (state.total > ARTIFACT_LIMIT) {
        updateArtifactStatus(
          key,
          `Preview limited to first ${previewMax} of ${total} rows.`,
        );
      } else {
        updateArtifactStatus(key, `Preview ready with ${previewMax} rows.`);
      }
      return;
    }
    if (state.total > ARTIFACT_LIMIT) {
      if (visible >= previewMax) {
        updateArtifactStatus(
          key,
          `Showing first ${previewMax} of ${total} rows (preview limit ${ARTIFACT_LIMIT}).`,
        );
      } else {
        updateArtifactStatus(
          key,
          `Showing ${visible} of ${previewMax} preview rows (total ${total}).`,
        );
      }
      return;
    }
    const effectiveTotal = total || previewMax;
    if (visible < effectiveTotal) {
      updateArtifactStatus(
        key,
        `Showing ${visible} of ${effectiveTotal} rows.`,
      );
    } else {
      updateArtifactStatus(key, `Showing ${visible} rows.`);
    }
  }

  async function loadArtifact(key) {
    const { container, moreBtn, resetBtn, loadBtn } = getArtifactElements(key);
    if (!container) return;
    setArtifactLoading(key, true);
    updateArtifactStatus(key, 'Loading…');
    try {
      const detail = await ensureRunDetail();
      const dataset = Array.isArray(detail[key]) ? detail[key] : [];
      if (!dataset.length) {
        artifactStates[key] = {
          flatRows: [],
          columns: [],
          page: 1,
          pageSize: ARTIFACT_PAGE_SIZE,
          total: 0,
        };
        renderArtifactTable(key);
        if (moreBtn) {
          moreBtn.hidden = true;
          moreBtn.disabled = false;
        }
        if (resetBtn) resetBtn.hidden = false;
        return;
      }
      const trimmed = dataset.slice(0, ARTIFACT_LIMIT);
      const flatRows = trimmed.map(flattenRow);
      const columns = deriveColumns(flatRows);
      artifactStates[key] = {
        flatRows,
        columns,
        page: 1,
        pageSize: ARTIFACT_PAGE_SIZE,
        total: dataset.length,
      };
      renderArtifactTable(key);
    } catch (err) {
      console.error('Artifact load failed', err);
      container.innerHTML =
        '<p class="placeholder">Failed to load artifact. Check API response.</p>';
      updateArtifactStatus(key, 'Failed to load artifact.');
    } finally {
      setArtifactLoading(key, false);
    }
  }

  function showMoreArtifact(key) {
    const state = artifactStates[key];
    if (!state) return;
    if (state.page * state.pageSize >= state.flatRows.length) return;
    state.page += 1;
    renderArtifactTable(key);
    updateArtifactStatusFromState(key);
  }

  function resetArtifact(key) {
    const { container, moreBtn, resetBtn, loadBtn } = getArtifactElements(key);
    if (container) {
      const placeholder =
        container.getAttribute('data-placeholder') || 'Table not loaded.';
      container.innerHTML = `<p class="placeholder">${escapeHtml(
        placeholder,
      )}</p>`;
    }
    if (moreBtn) {
      moreBtn.hidden = true;
      moreBtn.disabled = false;
    }
    if (resetBtn) resetBtn.hidden = true;
    if (loadBtn) {
      loadBtn.disabled = false;
      loadBtn.textContent = 'Load table';
    }
    updateArtifactStatus(key, '');
    delete artifactStates[key];
  }

  function getPlanCreationValue(key){
    if (!planCreationTable) return '';
    try {
      const row = planCreationTable.querySelector(`tr[data-key="${key}"]`);
      if (!row) return '';
      const cell = row.querySelector('td');
      return cell ? cell.textContent.trim() : '';
    } catch (e) {
      return '';
    }
  }

  function fillTemplate(){
    try {
      const sTbl = document.getElementById('summary-table');
      const rows = sTbl ? Array.from(sTbl.querySelectorAll('tbody tr')) : [];
      const sum = {};
      rows.forEach(r => {
        const k = r.querySelector('th')?.textContent || '';
        const v = r.querySelector('td')?.textContent || '';
        if (k) sum[k] = v;
      });
      const url = location.origin + '/ui/runs/' + runId;
      const planVersionId = getPlanCreationValue('plan_version_id');
      const lines = [
        `Approval request: Run ${runId}`,
        `- URL: ${url}`,
        `- plan_version_id: ${planVersionId}`,
        `- fill_rate: ${sum.fill_rate || ''}`,
        `- profit_total: ${sum.profit_total || ''}`,
        `- Notes: (add details as needed)`
      ];
      if (noteEl) noteEl.value = lines.join('\n');
    } catch {}
  }
  fillTemplate();
  if (copyBtn) copyBtn.addEventListener('click', function(){ try { navigator.clipboard.writeText(noteEl.value||''); alert('Copied.'); } catch (e) { alert('Copy failed.'); } });
  if (saveNoteBtn) saveNoteBtn.addEventListener('click', async function(){
    try {
      const headers = withActionHeaders('note');
      headers['Content-Type'] = 'application/json';
      const payload = { note: noteEl ? (noteEl.value || '') : '' };
      const res = await fetch(`/runs/${runId}/note`, { method:'POST', headers, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('HTTP '+res.status);
      banner('Note saved.');
    } catch(e){ console.error(e); alert('Failed to save note.'); }
  });

})();
</script>
{% endblock %}
  // Back link is rendered server-side using template context (from_jobs/back_href)
