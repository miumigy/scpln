{% extends "base.html" %}
{% block content %}
<article>
  <header>
    <h2>Run Detail</h2>
    <p class="mono">{{ run_id }}</p>
    <div id="meta-badges" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
  </header>

  <section>
    <h3>Config</h3>
    <table>
      <tbody>
        <tr><th class="mono">config_id</th><td class="mono">{{ config_id or '' }}</td></tr>
        <tr><th class="mono">scenario_id</th><td class="mono">{{ scenario_id or '' }}</td></tr>
        <tr><th class="mono">config_json</th><td><pre class="mono" style="max-height:240px; overflow:auto;">{{ config_json_str }}</pre></td></tr>
        <tr><th class="mono">raw</th><td><a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/config.json">/runs/{{ run_id }}/config.json</a></td></tr>
      </tbody>
    </table>
  </section>

  <section>
    <h3>Summary</h3>
    {% if summary %}
    <table id="summary-table">
      <tbody>
        {% for k, v in summary.items() %}
        <tr><th class="mono">{{ k }}</th><td>{{ v }}</td></tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No summary.</p>
    {% endif %}
  </section>

  <section>
    <h3>承認依頼</h3>
    <p>承認依頼用のテンプレートを編集してコピーできます。必要に応じてメモとして保存できます。</p>
    <textarea id="approval-note" rows="5" style="width:100%;"></textarea>
    <div style="margin-top:6px; display:flex; gap:8px;">
      <button id="copy-approval" type="button" class="secondary">テンプレをコピー</button>
      <button id="save-note" type="button">メモを保存</button>
      <button id="compare-baseline" type="button" class="secondary">Baselineと比較</button>
    </div>
  </section>

  <section>
    <h3>Artifacts</h3>
    <ul>
      <li>results: {{ counts.results_len }}</li>
      <li>daily_profit_loss: {{ counts.pl_len }}</li>
      <li>cost_trace: {{ counts.trace_len }}</li>
      <li style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span class="mono">CSV:</span>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/results.csv">results.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/pl.csv">pl.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/summary.csv">summary.csv</a>
        <a role="button" class="secondary download-csv" href="#" data-url="/runs/{{ run_id }}/trace.csv">trace.csv</a>
      </li>
    </ul>
  </section>

  <section>
    <h3>Planning</h3>
    <p>このRunの <code>scenario_id</code> と <code>config_json</code> を可能な範囲で引き継いで Plan バージョンを作成します。</p>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <button id="create-plan" type="button">このRunからPlanを作成</button>
      <a class="secondary" href="/ui/plans" target="_blank">Planning Hub を開く</a>
    </div>
  </section>

  <footer>
    <a role="button" href="/ui/runs">← Back to runs</a>
    <div style="float:right; display:flex; gap:6px; flex-wrap:wrap;">
      <button id="approve-run" type="button">Approve</button>
      <button id="promote-baseline" type="button">Promote baseline</button>
      <button id="archive-run" type="button" class="secondary">Archive</button>
      <button id="unarchive-run" type="button" class="secondary">Unarchive</button>
      <button id="delete-run" class="contrast">Delete</button>
    </div>
  </footer>
</article>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const runId = {{ run_id|tojson|safe }};
  const btn = document.createElement('button');
  btn.textContent = 'Refresh summary from API';
  btn.type = 'button';
  const header = document.querySelector('article header');
  if (header) header.appendChild(btn);
  const badges = document.getElementById('meta-badges');
  const approveBtn = document.getElementById('approve-run');
  const promoteBtn = document.getElementById('promote-baseline');
  const archBtn = document.getElementById('archive-run');
  const unarchBtn = document.getElementById('unarchive-run');
  const createPlanBtn = document.getElementById('create-plan');

  async function refresh() {
    try {
      const res = await fetch(`/runs/${runId}?detail=false`, { headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const tbody = document.getElementById('summary-table').querySelector('tbody');
      if (!tbody) return;
      const s = data.summary || {};
      tbody.innerHTML = Object.keys(s).map(k => `<tr><th class="mono">${k}</th><td>${s[k]}</td></tr>`).join('');
    } catch (e) {
      console.error(e); alert('Failed to refresh from API');
    }
  }
  btn.addEventListener('click', refresh);
  const delBtn = document.getElementById('delete-run');
  const noteEl = document.getElementById('approval-note');
  const copyBtn = document.getElementById('copy-approval');
  const saveNoteBtn = document.getElementById('save-note');
  const cmpBaseBtn = document.getElementById('compare-baseline');
  async function del() {
    if (!confirm('Delete this run? This action cannot be undone.')) return;
    try {
      const res = await fetch(`/runs/${runId}`, { method: 'DELETE', headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      alert('Run deleted.');
      location.href = '/ui/runs';
    } catch (e) { console.error(e); alert('Failed to delete run.'); }
  }
  if (delBtn) delBtn.addEventListener('click', del);
  async function act(url){
    try {
      const res = await fetch(url, { method: 'POST', headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      await loadMeta();
      banner('操作が完了しました');
    } catch (e) { console.error(e); alert('操作に失敗しました'); }
  }
  if (approveBtn) approveBtn.addEventListener('click', () => act(`/runs/${runId}/approve`));
  if (promoteBtn) promoteBtn.addEventListener('click', () => act(`/runs/${runId}/promote-baseline`));
  if (archBtn) archBtn.addEventListener('click', () => act(`/runs/${runId}/archive`));
  if (unarchBtn) unarchBtn.addEventListener('click', () => act(`/runs/${runId}/unarchive`));

  function tsId(){
    const t = new Date();
    const pad=n=>String(n).padStart(2,'0');
    return t.getFullYear()+pad(t.getMonth()+1)+pad(t.getDate())+pad(t.getHours())+pad(t.getMinutes())+pad(t.getSeconds());
  }
  function getRunsPrefs(){ try { return JSON.parse(localStorage.getItem('runs_prefs')||'{}') } catch { return {} } }
  function versionFromRun(runId){
    const s = getRunsPrefs();
    const prefix = (s.plan_version_prefix ?? 'run-');
    const withTs = (typeof s.plan_version_ts === 'boolean') ? s.plan_version_ts : true;
    let base = '';
    try { const p = String(runId||'').replace(/[^a-zA-Z0-9]/g,''); base = prefix + p.slice(0,8); } catch { base = prefix + 'run'; }
    return withTs ? (base + '-' + tsId()) : base;
  }

  async function createPlanFromRun(){
    try {
      const sidTxt = document.querySelector('table tbody tr:nth-child(2) td')?.textContent||'';
      const scenarioId = parseInt(sidTxt, 10);
      // config_json を画面から取得（存在しない/不正は無視）
      let cfg = null;
      try {
        const pre = document.querySelector('table pre.mono');
        if (pre && pre.textContent) cfg = JSON.parse(pre.textContent);
      } catch(e) { cfg = null; }
      const payload = {
        base_scenario_id: Number.isFinite(scenarioId) ? scenarioId : undefined,
        version_id: versionFromRun(runId),
        // 既存config_jsonに近いキーがあれば転記（なければ既定値はAPI側が補完）
        weeks: (cfg && typeof cfg.weeks !== 'undefined') ? cfg.weeks : undefined,
        lt_unit: (cfg && cfg.lt_unit) || undefined,
        cutover_date: (cfg && cfg.cutover_date) || undefined,
        recon_window_days: (cfg && typeof cfg.recon_window_days !== 'undefined') ? cfg.recon_window_days : undefined,
        anchor_policy: (cfg && cfg.anchor_policy) || undefined,
        tol_abs: (cfg && typeof cfg.tol_abs !== 'undefined') ? cfg.tol_abs : undefined,
        tol_rel: (cfg && typeof cfg.tol_rel !== 'undefined') ? cfg.tol_rel : undefined,
        calendar_mode: (cfg && cfg.calendar_mode) || undefined,
        carryover: (cfg && cfg.carryover) || undefined,
        carryover_split: (cfg && typeof cfg.carryover_split !== 'undefined') ? cfg.carryover_split : undefined,
        apply_adjusted: (cfg && !!cfg.apply_adjusted) || false,
        source_run_id: runId,
        note: `created from run ${runId}`
      };
      const headers = { ...getHeaders(), 'Content-Type':'application/json' };
      const res = await fetch('/plans/integrated/run', { method:'POST', headers, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      if (data && data.version_id){ window.location.href = '/ui/plans/' + data.version_id; }
      else { alert('Plan作成に失敗しました（version_idなし）'); }
    } catch(e) {
      console.error('createPlanFromRun failed', e);
      alert('Plan作成に失敗しました');
    }
  }
  if (createPlanBtn) createPlanBtn.addEventListener('click', createPlanFromRun);

  async function loadMeta(){
    try {
      const res = await fetch(`/runs/${runId}/meta`, { headers: getHeaders() });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const m = await res.json();
      if (badges) {
        badges.innerHTML = '';
        if (m.baseline) badges.innerHTML += '<span class="secondary">BASELINE</span>';
        if (m.approved_at) badges.innerHTML += '<span class="secondary">APPROVED</span>';
        if (m.archived) badges.innerHTML += '<span class="secondary">ARCHIVED</span>';
      }
    } catch (e) { console.warn('meta load failed', e); }
  }
  function banner(msg){
    const d = document.createElement('div');
    d.textContent = msg;
    d.style.background = '#e7f5ff';
    d.style.padding = '6px 8px';
    d.style.margin = '6px 0';
    d.setAttribute('role','status');
    (document.querySelector('article')||document.body).prepend(d);
    setTimeout(()=> d.remove(), 2000);
  }
  loadMeta();

  function getHeaders(){
    const h = {};
    try { const k = localStorage.getItem('api_key') || ''; if (k) h['X-API-Key'] = k; } catch {}
    try { const u = localStorage.getItem('user_email') || ''; if (u) h['X-User'] = u; } catch {}
    try { const r = localStorage.getItem('user_role') || ''; if (r) h['X-Role'] = r; } catch {}
    return h;
  }

  function downloadCsv(ev) {
    ev.preventDefault();
    const el = ev.target;
    const url = el.getAttribute('data-url');
    if (!url) return;
    const headers = getHeaders();
    fetch(url, { headers })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const disposition = res.headers.get('content-disposition');
        let filename = url.split('/').pop();
        if (disposition && disposition.includes('attachment')) {
          const m = disposition.match(/filename="?([^;"]+)"?/);
          if (m && m[1]) filename = m[1];
        }
        return res.blob().then(blob => ({ blob, filename }));
      })
      .then(({ blob, filename }) => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      })
      .catch(e => {
        console.error('Download failed', e);
        alert('Download failed. Check API key or server status.');
      });
  }

  document.body.addEventListener('click', ev => {
    if (ev.target.classList.contains('download-csv')) {
      downloadCsv(ev);
    }
  });

  function fillTemplate(){
    try {
      const sTbl = document.getElementById('summary-table');
      const rows = sTbl ? Array.from(sTbl.querySelectorAll('tbody tr')) : [];
      const sum = {};
      rows.forEach(r => { const k = r.querySelector('th')?.textContent||''; const v = r.querySelector('td')?.textContent||''; if (k) sum[k]=v; });
      const url = location.origin + '/ui/runs/' + runId;
      const lines = [
        `承認依頼: Run ${runId}`,
        `- URL: ${url}`,
        `- scenario_id: ${document.querySelector('table tbody tr:nth-child(2) td')?.textContent||''}`,
        `- fill_rate: ${sum.fill_rate||''}`,
        `- profit_total: ${sum.profit_total||''}`,
        `- 備考: （必要に応じて追記）`
      ];
      noteEl.value = lines.join('\n');
    } catch {}
  }
  fillTemplate();
  copyBtn?.addEventListener('click', () => { try { navigator.clipboard.writeText(noteEl.value||''); alert('コピーしました'); } catch { alert('コピーに失敗しました'); } });
  saveNoteBtn?.addEventListener('click', async () => {
    try {
      const res = await fetch(`/runs/${runId}/note`, { method:'POST', headers: { ...getHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify({ note: noteEl.value||'' }) });
      if (!res.ok) throw new Error('HTTP '+res.status);
      banner('メモを保存しました');
    } catch(e){ console.error(e); alert('保存に失敗しました'); }
  });

  async function openCompareWithBaseline(){
    try {
      const sidTxt = document.querySelector('table tbody tr:nth-child(2) td')?.textContent||'';
      const sid = parseInt(sidTxt, 10);
      if (!sid){ alert('scenario_id がありません'); return; }
      const r = await fetch(`/runs/baseline?scenario_id=${sid}`, { headers: getHeaders() });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const js = await r.json();
      const base = js.run_id;
      if (!base){ alert('ベースラインが見つかりません'); return; }
      const q = new URLSearchParams({ run_ids: `${base},${runId}`, base_id: base });
      location.href = '/ui/compare/show?' + q.toString();
    } catch(e){ console.error(e); alert('比較リンクの生成に失敗しました'); }
  }
  cmpBaseBtn?.addEventListener('click', openCompareWithBaseline);

})();
</script>
{% endblock %}
