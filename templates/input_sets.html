{% extends "base.html" %}

{% block page_header %}
  <h2>{{ subtitle }}</h2>
  <p>計画インプットセットの管理とバージョン管理を行います。</p>
{% endblock %}

{% block content %}
  <div class="page-section">
    <div class="stack justify-between gap-bottom-md">
      <h3>インプットセットのアップロード</h3>
      <a href="/ui/plans/input_sets/upload" role="button" class="btn-primary">新規セットをアップロード</a>
    </div>
    <p class="help-text">新しい計画インプットセットをCSVファイルでアップロードし、管理します。</p>
  </div>

  <div class="page-section">
    <h3>サンプルからロード</h3>
    <p class="help-text">定義済みのサンプルデータセットをロードして、すぐに計画を開始できます。</p>
    <form action="/ui/plans/input_sets/sample" method="post" class="stack align-end">
      <label for="sample_name">
        <span class="label-title">サンプル選択</span>
        <select name="sample_name" id="sample_name" required>
          <option value="">-- サンプルを選択 --</option>
          {% for sample in sample_input_sets or [] %}
            <option value="{{ sample.name }}">{{ sample.name }} ({{ sample.description }})</option>
          {% endfor %}
        </select>
      </label>
      <button type="submit" class="btn-primary">サンプルをロード</button>
    </form>
    {% if request.query_params.get("error") %}
      <p style="color: red;">エラー: {{ request.query_params.get("error") }}</p>
    {% endif %}
  </div>

  <div class="page-section">
    <div class="stack justify-between gap-bottom-md">
      <h3>既存のインプットセット</h3>
      <form action="/ui/plans/input_sets" method="get" class="stack gap-xs nowrap">
        <label for="status-filter" class="sr-only">ステータスでフィルタ</label>
        <select name="status" id="status-filter" onchange="this.form.submit()">
          {% for status_val, status_label in status_options %}
            <option value="{{ status_val }}" {% if status_val == selected_status %}selected{% endif %}>{{ status_label }}</option>
          {% endfor %}
        </select>
      </form>
    </div>

    {% if input_sets %}
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ラベル</th>
              <th>ステータス</th>
              <th>Configバージョン</th>
              <th>作成日時</th>
              <th>作成者</th>
              <th>アクション</th>
            </tr>
          </thead>
          <tbody>
            {% for input_set in input_sets %}
              <tr>
                <td><a href="/ui/plans/input_sets/{{ input_set.label }}">{{ input_set.label }}</a></td>
                <td><span class="pill">{{ input_set.status }}</span></td>
                <td><a href="/ui/configs/canonical/{{ input_set.config_version_id }}">{{ input_set.config_version_id }}</a></td>
                <td>{{ input_set.created_at | format_datetime }}</td>
                <td>{{ input_set.created_by }}</td>
                <td class="table-actions">
                  <a href="/ui/plans/input_sets/{{ input_set.label }}" role="button" class="secondary">詳細</a>
                  {% if input_set.status == 'draft' %}
                    <form action="/ui/plans/input_sets/{{ input_set.label }}/review" method="post">
                      <input type="hidden" name="action" value="approve">
                      <button type="submit" class="contrast">承認</button>
                    </form>
                  {% elif input_set.status == 'ready' %}
                    <form action="/ui/plans/input_sets/{{ input_set.label }}/review" method="post">
                      <input type="hidden" name="action" value="revert">
                      <button type="submit" class="secondary">ドラフトに戻す</button>
                    </form>
                  {% endif %}
                  <a href="/ui/plans/input_sets/{{ input_set.label }}/diff" role="button" class="secondary">差分</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>表示するインプットセットがありません。</p>
    {% endif %}
  </div>
{% endblock %}