{% extends "base.html" %}
{% block content %}
<section>
  <h2>Compare</h2>
  <details style="margin:6px 0;">
    <summary>Scenario presets</summary>
    <form method="get" action="/ui/compare/preset" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin-top:8px;">
      <label>Base scenario
        <input type="number" name="base_scenario" min="1" value="{{ base_scenario or '' }}" required style="width:8em;" />
      </label>
      <label>Target scenarios (comma)
        <input type="text" name="target_scenarios" value="{{ target_scenarios or '' }}" placeholder="202,203" style="min-width:16em;" />
      </label>
      <label>Limit per scenario
        <input type="number" name="limit" min="1" value="1" style="width:6em;" />
      </label>
      <button type="submit">Load latest runs</button>
    </form>
  </details>
  <form method="post" action="/ui/compare" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;">
    <label>Run IDs
      <input class="mono" type="text" name="run_ids" value="{{ run_ids_str }}" style="min-width:26em;" />
    </label>
    <label>Base
      <select name="base_id">
        {% for r in rows %}
        <option value="{{ r.run_id }}" {% if r.run_id == base_id %}selected{% endif %}>{{ r.run_id }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Threshold %
      <input type="number" step="0.01" name="threshold" value="{{ threshold if threshold is not none else '' }}" placeholder="e.g. 5" style="width:8em;" />
    </label>
    <fieldset style="border:0; padding:0 8px;">
      <legend>Keys</legend>
      <input type="hidden" name="keys" id="keys-input" value="{{ keys_str if keys_str is defined else '' }}" />
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        {% for k in keys %}
        <label style="display:inline-flex; gap:4px; align-items:center;">
          <input type="checkbox" class="kpi" value="{{ k }}" checked />{{ k }}
        </label>
        {% endfor %}
      </div>
    </fieldset>
    <button type="submit">Apply</button>
  </form>
  {% if rows %}
  <h3>Metrics</h3>
  <p>
    <a role="button" class="secondary" href="/ui/compare/metrics.csv?run_ids={{ run_ids_str }}{% if base_id %}&base_id={{ base_id }}{% endif %}">Download metrics.csv</a>
    <a role="button" class="secondary" href="/ui/compare/diffs.csv?run_ids={{ run_ids_str }}{% if base_id %}&base_id={{ base_id }}{% endif %}{% if threshold is not none %}&threshold={{ threshold }}{% endif %}">Download diffs.csv</a>
  </p>
  <table>
    <thead>
      <tr>
        <th>run_id</th>
        {% for k in keys %}<th>{{ k }}</th>{% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td class="mono truncate" title="{{ r.run_id }}">{{ r.run_id }}</td>
        {% for k in keys %}
        <td>{{ "%.4f"|format(r[k] or 0) }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if diffs %}
  <h3>Diffs (base = {{ diffs[0].base }}{% if threshold is not none %}, threshold = {{ '%.2f'|format(threshold) }}%{% endif %})</h3>
  <table>
    <thead>
      <tr>
        <th>target</th>
        {% for k in keys %}<th>{{ k }} (abs / %)</th>{% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for d in diffs %}
      <tr>
        <td class="mono">{{ d.target }}</td>
        {% for k in keys %}
          {% set v = d[k] %}
          {% set pct = v.pct %}
          {% set hit = (threshold is not none) and (pct is not none) and ((pct >= threshold) or (pct <= -threshold)) %}
          <td {% if hit %}style="background: #fff3cd;"{% endif %}>
            {{ "%.4f"|format(v.abs or 0) }} / {% if pct is not none %}{{ "%.2f"|format(pct) }}%{% else %}-{% endif %}
          </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  {% else %}
    <p>No rows.</p>
  {% endif %}
  <footer>
    <a role="button" href="/ui/runs">‚Üê Back to runs</a>
  </footer>
</section>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const form = document.querySelector('form[action="/ui/compare"]');
  if (!form) return;
  function syncKeys(){
    const boxes = Array.from(form.querySelectorAll('input.kpi'));
    const picked = boxes.filter(b => b.checked).map(b => b.value);
    form.querySelector('#keys-input').value = picked.join(',');
  }
  form.addEventListener('submit', syncKeys);
})();
</script>
{% endblock %}
