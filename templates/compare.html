{% extends "base.html" %}
{% block content %}
<section>
  <h2>Compare</h2>
  <form method="post" action="/ui/compare" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;">
    <label>Run IDs
      <input class="mono" type="text" name="run_ids" value="{{ run_ids_str }}" style="min-width:26em;" />
    </label>
    <label>Base
      <select name="base_id">
        {% for r in rows %}
        <option value="{{ r.run_id }}" {% if r.run_id == base_id %}selected{% endif %}>{{ r.run_id }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Threshold %
      <input type="number" step="0.01" name="threshold" value="{{ threshold if threshold is not none else '' }}" placeholder="e.g. 5" style="width:8em;" />
    </label>
    <button type="submit">Apply</button>
  </form>
  {% if rows %}
  <h3>Metrics</h3>
  <table>
    <thead>
      <tr>
        <th>run_id</th>
        {% for k in keys %}<th>{{ k }}</th>{% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td class="mono truncate" title="{{ r.run_id }}">{{ r.run_id }}</td>
        {% for k in keys %}
        <td>{{ "%.4f"|format(r[k] or 0) }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if diffs %}
  <h3>Diffs (base = {{ diffs[0].base }}{% if threshold is not none %}, threshold = {{ '%.2f'|format(threshold) }}%{% endif %})</h3>
  <table>
    <thead>
      <tr>
        <th>target</th>
        {% for k in keys %}<th>{{ k }} (abs / %)</th>{% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for d in diffs %}
      <tr>
        <td class="mono">{{ d.target }}</td>
        {% for k in keys %}
          {% set v = d[k] %}
          {% set pct = v.pct %}
          {% set hit = (threshold is not none) and (pct is not none) and ((pct >= threshold) or (pct <= -threshold)) %}
          <td {% if hit %}style="background: #fff3cd;"{% endif %}>
            {{ "%.4f"|format(v.abs or 0) }} / {% if pct is not none %}{{ "%.2f"|format(pct) }}%{% else %}-{% endif %}
          </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  {% else %}
    <p>No rows.</p>
  {% endif %}
  <footer>
    <a role="button" href="/ui/runs">‚Üê Back to runs</a>
  </footer>
</section>
{% endblock %}
