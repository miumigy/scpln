{% extends "base.html" %}
{% block page_header %}
  <h2>Job Detail</h2>
  <p class="mono">{{ job.job_id }}</p>
{% endblock %}
{% block content %}
<article class="page-section">
  <header style="margin-bottom:1rem;"></header>
  {% set plan_vid = job.plan_version_id or (result.version_id if result else None) %}
  {% set is_job_done = job.finished_at or job.status in ['succeeded', 'failed', 'cancelled'] %}
  <section>
    <table>
      <tbody>
        <tr><th>type</th><td>{{ job.type }}</td></tr>
        <tr><th>status</th><td>{{ job.status }}</td></tr>
        <tr><th>submitted_at</th><td class="ts-ms" data-ms="{{ job.submitted_at }}">{{ job.submitted_at }}</td></tr>
        <tr><th>started_at</th><td class="ts-ms" data-ms="{{ job.started_at or '' }}">{{ job.started_at or '' }}</td></tr>
        <tr><th>finished_at</th><td class="ts-ms" data-ms="{{ job.finished_at or '' }}">{{ job.finished_at or '' }}</td></tr>
        <tr><th>plan_version_id</th>
          <td class="mono">
            {% if plan_vid and is_job_done %}
              <a href="/ui/plans/{{ plan_vid }}">{{ plan_vid }}</a>
            {% elif plan_vid %}
              {{ plan_vid }}
            {% else %}-{% endif %}
          </td>
        </tr>
        <tr><th>run_id</th><td class="mono">{% if job.run_id %}<a href="/ui/runs/{{ job.run_id }}?from=jobs&back=/ui/jobs/{{ job.job_id }}">{{ job.run_id }}</a>{% endif %}</td></tr>
        <tr><th>error</th><td><pre>{{ job.error or '' }}</pre></td></tr>
      </tbody>
    </table>
    {% if job.type == 'aggregate' and job.status == 'succeeded' %}
    <p>
      <a role="button" class="secondary" href="/jobs/{{ job.job_id }}/result.json">result.json</a>
      <a role="button" class="secondary" href="/jobs/{{ job.job_id }}/result.csv">result.csv</a>
    </p>
    {% endif %}
  </section>
  <footer>
    <a role="button" href="/ui/jobs">‚Üê Back to jobs</a>
  </footer>
</article>
{% endblock %}
{% block scripts %}
<script>
function fmtJst(ms){
  var n = Number(ms);
  if (!Number.isFinite(n)) return '';
  if (n < 1e12) n = n * 1000;
  var t = new Date(n + 9*3600*1000);
  var y = t.getUTCFullYear();
  var mo = String(t.getUTCMonth()+1).padStart(2,'0');
  var d = String(t.getUTCDate()).padStart(2,'0');
  var h = String(t.getUTCHours()).padStart(2,'0');
  var mi = String(t.getUTCMinutes()).padStart(2,'0');
  var s = String(t.getUTCSeconds()).padStart(2,'0');
  return y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s+' JST';
}
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.ts-ms').forEach(function(el){
    var ms = el.getAttribute('data-ms');
    var txt = fmtJst(ms);
    if (txt) el.textContent = txt;
  });
});
</script>
{% endblock %}
