{% extends "base.html" %}
{% block content %}
<section>
  <h2>集約計画/詳細計画 パイプライン（UI検証）</h2>
  <form method="post" action="/planning/run" enctype="multipart/form-data">
    <details>
      <summary>CSVアップロード（任意）</summary>
      <div class="grid">
        <label>demand_family.csv<input type="file" name="demand_family" accept=".csv"></label>
        <label>capacity.csv<input type="file" name="capacity" accept=".csv"></label>
        <label>mix_share.csv<input type="file" name="mix_share" accept=".csv"></label>
      </div>
      <div class="grid">
        <label>item.csv<input type="file" name="item" accept=".csv"></label>
        <label>inventory.csv<input type="file" name="inventory" accept=".csv"></label>
        <label>open_po.csv<input type="file" name="open_po" accept=".csv"></label>
        <label>bom.csv<input type="file" name="bom" accept=".csv"></label>
      </div>
      <p class="mono">アップロードがある場合は `input_dir` よりアップロードを優先します。</p>
    </details>
    <div class="grid">
      <label>入力ディレクトリ
        <input type="text" name="input_dir" value="samples/planning">
      </label>
      <label>出力ディレクトリ（任意）
        <input type="text" name="out_dir" placeholder="out/ui_planning_...">
      </label>
    </div>
    <div class="grid">
      <label>週数
        <input type="number" name="weeks" min="1" value="4">
      </label>
      <label>丸め
        <select name="round_mode">
          <option value="none">none</option>
          <option value="int" selected>int</option>
          <option value="dec1">dec1</option>
          <option value="dec2">dec2</option>
        </select>
      </label>
      <label>LT単位
        <select name="lt_unit">
          <option value="day" selected>day</option>
          <option value="week">week</option>
        </select>
      </label>
      <label>version_id（任意）
        <input type="text" name="version_id" placeholder="例: ui-2025-09-01">
      </label>
      <label><input type="checkbox" name="apply_adjusted" value="1"> 調整後DETでMRP/CRPも再計算（検証）</label>
    </div>
    <details>
      <summary>高度設定（v2準備の受け口）</summary>
      <div class="grid">
        <label>cutover_date（予約）
          <input type="date" name="cutover_date" placeholder="YYYY-MM-DD">
        </label>
        <label>recon_window_days（予約）
          <input type="number" name="recon_window_days" min="0" placeholder="7">
        </label>
        <label>tol_abs（予約）
          <input type="number" name="tol_abs" min="0" step="0.000001" placeholder="例: 1e-6">
        </label>
        <label>tol_rel（予約）
          <input type="number" name="tol_rel" min="0" step="0.000001" placeholder="例: 0.001">
        </label>
        <label>max_adjust_ratio（予約）
          <input type="number" name="max_adjust_ratio" min="0" max="1" step="0.05" placeholder="例: 0.2">
        </label>
        <label>anchor_policy（予約）
          <select name="anchor_policy">
            <option value="">(未指定)</option>
            <option value="DET_near">DET_near</option>
            <option value="AGG_far">AGG_far</option>
            <option value="blend">blend</option>
          </select>
        </label>
        <label>calendar_mode（予約）
          <select name="calendar_mode">
            <option value="simple" selected>simple</option>
            <option value="iso">iso</option>
          </select>
        </label>
        <label>carryover（予約）
          <select name="carryover">
            <option value="none" selected>none</option>
            <option value="auto">auto</option>
            <option value="prev">prev</option>
            <option value="next">next</option>
          </select>
        </label>
      </div>
      <p class="mono">注: 現時点では version_id のみログ付与に使用し、他の設定はv2で有効化予定です。</p>
    </details>
    <button type="submit">パイプライン実行</button>
  </form>
</section>

<section>
  <form method="post" action="/planning/run_job">
    <div class="grid">
      <label>入力ディレクトリ<input type="text" name="input_dir" value="samples/planning"></label>
      <label>週数<input type="number" name="weeks" min="1" value="4"></label>
      <label>丸め
        <select name="round_mode">
          <option value="none">none</option>
          <option value="int" selected>int</option>
          <option value="dec1">dec1</option>
          <option value="dec2">dec2</option>
        </select>
      </label>
      <label>LT単位
        <select name="lt_unit">
          <option value="day" selected>day</option>
          <option value="week">week</option>
        </select>
      </label>
      <label>version_id（任意）<input type="text" name="version_id" placeholder="例: job-<id>"></label>
      <label>cutover_date（任意）<input type="date" name="cutover_date" placeholder="YYYY-MM-DD"></label>
      <label>recon_window_days（任意）<input type="number" name="recon_window_days" min="0" placeholder="7"></label>
      <label>anchor_policy（任意）
        <select name="anchor_policy">
          <option value="">(未指定)</option>
          <option value="DET_near">DET_near</option>
          <option value="AGG_far">AGG_far</option>
          <option value="blend">blend</option>
        </select>
      </label>
      <label>max_adjust_ratio（任意）
        <input type="number" name="max_adjust_ratio" min="0" max="1" step="0.05" placeholder="例: 0.2">
      </label>
      <label>tol_abs（任意）
        <input type="number" name="tol_abs" min="0" step="0.000001" placeholder="例: 1e-6">
      </label>
      <label>tol_rel（任意）
        <input type="number" name="tol_rel" min="0" step="0.000001" placeholder="例: 0.001">
      </label>
      <label>calendar_mode（任意）
        <select name="calendar_mode">
          <option value="simple" selected>simple</option>
          <option value="iso">iso</option>
        </select>
      </label>
      <label>carryover（任意）
        <select name="carryover">
          <option value="none" selected>none</option>
          <option value="auto">auto</option>
          <option value="prev">prev</option>
          <option value="next">next</option>
        </select>
      </label>
      <label>carryover_split（任意, next比率0..1）
        <input type="number" name="carryover_split" min="0" max="1" step="0.05" placeholder="例: 0.8">
      </label>
      <label><input type="checkbox" name="apply_adjusted" value="1"> 調整後DETでMRP/CRPも再計算（検証）</label>
    </div>
    <button type="submit" class="secondary">ジョブとして実行（/ui/jobsで監視）</button>
  </form>
</section>

{% if error %}
<article>
  <mark>エラー</mark>
  <pre class="mono">{{ error }}</pre>
{% endif %}

{% if out_dir %}
<section>
  <h3>出力（{{ out_dir }}）</h3>
  <details open>
    <summary>Aggregate（family×period）</summary>
    {% if aggregate and aggregate.rows %}
    <table>
      <thead><tr><th>period</th><th>family</th><th>demand</th><th>supply</th><th>backlog</th><th>capacity_total</th></tr></thead>
      <tbody>
        {% for r in aggregate.rows %}
        <tr>
          <td>{{ r.period }}</td><td>{{ r.family }}</td>
          <td class="mono">{{ r.demand }}</td>
          <td class="mono">{{ r.supply }}</td>
          <td class="mono">{{ r.backlog }}</td>
          <td class="mono">{{ r.capacity_total }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>データなし</p>
    {% endif %}
  </details>

  <details open>
    <summary>能力サマリ（weekly_summary）</summary>
    {% if plan and plan.weekly_summary %}
    <table>
      <thead><tr><th>week</th><th>capacity</th><th>original</th><th>adjusted</th><th>spill_in</th><th>spill_out</th></tr></thead>
      <tbody>
        {% for r in plan.weekly_summary %}
        <tr>
          <td>{{ r.week }}</td>
          <td class="mono">{{ r.capacity }}</td>
          <td class="mono">{{ r.original_load }}</td>
          <td class="mono">{{ r.adjusted_load }}</td>
          <td class="mono">{{ r.spill_in }}</td>
          <td class="mono">{{ r.spill_out }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}<p>データなし</p>{% endif %}
  </details>

  {% if plan_adj and plan_adj.weekly_summary %}
  <details open>
    <summary>能力サマリ（調整後・weekly_summary）</summary>
    <table>
      <thead><tr><th>week</th><th>capacity</th><th>original</th><th>adjusted</th><th>spill_in</th><th>spill_out</th></tr></thead>
      <tbody>
        {% for r in plan_adj.weekly_summary %}
        <tr>
          <td>{{ r.week }}</td>
          <td class="mono">{{ r.capacity }}</td>
          <td class="mono">{{ r.original_load }}</td>
          <td class="mono">{{ r.adjusted_load }}</td>
          <td class="mono">{{ r.spill_in }}</td>
          <td class="mono">{{ r.spill_out }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if report_adj_path %}
      <p class="mono">調整後レポート: <a href="/{{ report_adj_path }}" download>{{ report_adj_path }}</a></p>
    {% endif %}
  </details>
  {% endif %}

  <details open>
    <summary>整合ログ（AGG↔DET 差分）</summary>
    {% if recon and recon.deltas %}
      <p class="mono">tol_violations={{ recon.summary.tol_violations }} / rows={{ recon.summary.rows }}
        {% if recon.summary.boundary %}｜ boundary(period={{ recon.summary.boundary.period }}): violations={{ recon.summary.boundary.violations }}{% endif %}
        {% if recon_path %} ・ <a href="/{{ recon_path }}" download>reconciliation_log.json</a>{% endif %}
        {% set recon_before_csv = out_dir ~ '/reconciliation_before.csv' %}
        ｜ <a href="/{{ recon_before_csv }}" download>reconciliation_before.csv</a>
        {% set recon_viol_before_csv = out_dir ~ '/reconciliation_violations_before.csv' %}
        ｜ <a href="/{{ recon_viol_before_csv }}" download>violations_only.csv</a>
      </p>
      <div class="grid" style="align-items: end;">
        <label>tol_abs
          <input id="tolAbs" type="number" step="0.000001" value="{{ recon.tolerance.abs }}">
        </label>
        <label>tol_rel
          <input id="tolRel" type="number" step="0.000001" value="{{ recon.tolerance.rel }}">
        </label>
        <label><input type="checkbox" id="violOnly"> 違反のみ表示</label>
      </div>
      {% if recon.summary.boundary and recon.summary.boundary.top and recon.summary.boundary.top|length > 0 %}
      <details>
        <summary>境界期間の上位差分（最大10件）</summary>
        <table>
          <thead>
            <tr><th>period</th><th>family</th><th>Δdemand</th><th>Δsupply</th><th>Δbacklog</th><th>ok</th></tr>
          </thead>
          <tbody>
            {% for r in recon.summary.boundary.top %}
            <tr {% if not r.ok %}style="background:#fff5f5"{% endif %}>
              <td>{{ r.period }}</td>
              <td>{{ r.family }}</td>
              <td class="mono">{{ r.delta_demand }}</td>
              <td class="mono">{{ r.delta_supply }}</td>
              <td class="mono">{{ r.delta_backlog }}</td>
              <td class="mono">{{ r.ok }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </details>
      {% endif %}
      <table id="tblReconcile">
        <thead>
          <tr>
            <th>period</th><th>family</th>
            <th>Δdemand</th><th>Δsupply</th><th>Δbacklog</th><th>ok</th>
          </tr>
        </thead>
        <tbody>
          {% for r in recon.deltas[:50] %}
          <tr data-ok="{{ '1' if r.ok else '0' }}"
              data-reld="{{ r.rel_demand if r.rel_demand is defined else 0 }}"
              data-rels="{{ r.rel_supply if r.rel_supply is defined else 0 }}"
              data-relb="{{ r.rel_backlog if r.rel_backlog is defined else 0 }}">
            <td>{{ r.period }}</td>
            <td>{{ r.family }}</td>
            <td class="mono">{{ r.delta_demand }}</td>
            <td class="mono">{{ r.delta_supply }}</td>
            <td class="mono">{{ r.delta_backlog }}</td>
            <td class="mono">{{ r.ok }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <script>
      (function(){
        var cb = document.getElementById('violOnly');
        var tolAbs = document.getElementById('tolAbs');
        var tolRel = document.getElementById('tolRel');
        function parseNum(x){ var v = parseFloat(x); return isNaN(v) ? 0 : v; }
        function apply(){
          var only = cb && cb.checked;
          var ta = tolAbs ? Math.max(0, parseFloat(tolAbs.value)||0) : 0;
          var tr = tolRel ? Math.max(0, parseFloat(tolRel.value)||0) : 0;
          var rows = document.querySelectorAll('#tblReconcile tbody tr');
          rows.forEach(function(trEl){
            var tds = trEl.querySelectorAll('td');
            var d = Math.abs(parseNum(tds[2] && tds[2].textContent));
            var s = Math.abs(parseNum(tds[3] && tds[3].textContent));
            var b = Math.abs(parseNum(tds[4] && tds[4].textContent));
            var rd = Math.abs(parseNum(trEl.getAttribute('data-reld')||'0'));
            var rs = Math.abs(parseNum(trEl.getAttribute('data-rels')||'0'));
            var rb = Math.abs(parseNum(trEl.getAttribute('data-relb')||'0'));
            var okd = (d <= ta) || (rd <= tr);
            var oks = (s <= ta) || (rs <= tr);
            var okb = (b <= ta) || (rb <= tr);
            // cell highlight
            [okd,oks,okb].forEach(function(ok,i){
              var td = tds[2+i];
              if (!td) return;
              td.style.background = ok ? '' : '#fff0f0';
            });
            var rowOk = okd && oks && okb;
            trEl.setAttribute('data-ok', rowOk ? '1' : '0');
            trEl.style.display = (only && rowOk) ? 'none' : '';
          });
        }
        if (cb) cb.addEventListener('change', apply);
        if (tolAbs) tolAbs.addEventListener('change', apply);
        if (tolRel) tolRel.addEventListener('change', apply);
        // 初期適用
        apply();
      })();
      </script>
    {% else %}
      <p>データなし（パイプライン実行で生成）</p>
    {% endif %}
  </details>

  {% if recon_path and recon and recon.cutover and recon.cutover.anchor_policy and recon.cutover.cutover_date %}
  <details>
    <summary>整合ログ（調整後, anchor={{ recon.cutover.anchor_policy }}）</summary>
    {% set adj_path = recon_path.replace('reconciliation_log.json','reconciliation_log_adjusted.json') %}
    {% set adj_json_path = out_dir ~ '/reconciliation_log_adjusted.json' %}
    {% set recon_adj = None %}
    {% if adj_json_path %}
      {% set _ = namespace(val=None) %}
    {% endif %}
    <p class="mono">調整後の比較結果は `reconciliation_log_adjusted.json` をご確認ください（ダウンロード可能）。
      {% if adj_path %}<a href="/{{ adj_path }}" download>reconciliation_log_adjusted.json</a>{% endif %}
    </p>
    {% if recon and recon.summary and recon_adj and recon_adj.summary and recon.summary.boundary and recon_adj.summary.boundary %}
    <p class="mono">boundary violations: before={{ recon.summary.boundary.violations }} → after={{ recon_adj.summary.boundary.violations }}
      {% set b_before = recon.summary.boundary.max_abs_delta %}
      {% set b_after = recon_adj.summary.boundary.max_abs_delta %}
      ｜ max|Δ| (demand/supply/backlog):
      ({{ b_before.demand }}, {{ b_before.supply }}, {{ b_before.backlog }}) → ({{ b_after.demand }}, {{ b_after.supply }}, {{ b_after.backlog }})
    </p>
    {% endif %}
    {% if recon_summary %}
    <p class="mono">Σ|Δ|(all rows): before={{ recon_summary.before_total }} → after={{ recon_summary.after_total }} ({{ recon_summary.improvement_pct }}% 改善)
      {% if recon_adj_path %}｜ <a href="/{{ recon_adj_path }}" download>reconciliation_log_adjusted.json</a>{% endif %}
      {% if anchor_adj %}｜ <a href="/{{ out_dir }}/sku_week_adjusted.json" download>sku_week_adjusted.json</a>{% endif %}
    </p>
    {% endif %}

    {% if recon_compare %}
    <details>
      <summary>before/after 差分比較（上位20件）</summary>
      {% set recon_compare_csv = out_dir ~ '/reconciliation_compare.csv' %}
      <p class="mono"><a href="/{{ recon_compare_csv }}" download>reconciliation_compare.csv</a>
        {% set recon_viol_compare_csv = out_dir ~ '/reconciliation_violations_compare.csv' %}
        ｜ <a href="/{{ recon_viol_compare_csv }}" download>violations_only_compare.csv</a>
      </p>
      <div class="grid" style="align-items: end;">
        <label>tol_abs
          <input id="tolAbs2" type="number" step="0.000001" value="{{ recon.tolerance.abs }}">
        </label>
        <label>tol_rel
          <input id="tolRel2" type="number" step="0.000001" value="{{ recon.tolerance.rel }}">
        </label>
        <label><input type="checkbox" id="violOnly2"> 違反のみ表示（after基準）</label>
        <label>並び替え
          <select id="cmpSort">
            <option value="none" selected>なし</option>
            <option value="rel_desc_after">after 相対誤差 降順</option>
            <option value="rel_asc_after">after 相対誤差 昇順</option>
            <option value="abs_desc_after">after 絶対誤差 降順</option>
            <option value="abs_asc_after">after 絶対誤差 昇順</option>
            <option value="rel_desc_before">before 相対誤差 降順</option>
            <option value="rel_asc_before">before 相対誤差 昇順</option>
            <option value="abs_desc_before">before 絶対誤差 降順</option>
            <option value="abs_asc_before">before 絶対誤差 昇順</option>
          </select>
        </label>
      </div>
      <table id="tblCompare">
        <thead>
          <tr>
            <th>period</th><th>family</th>
            <th>Δdemand(before)</th><th>Δsupply(before)</th><th>Δbacklog(before)</th>
            <th>Δdemand(after)</th><th>Δsupply(after)</th><th>Δbacklog(after)</th>
          </tr>
        </thead>
        <tbody>
          {% for r in recon_compare %}
          <tr data-ok-after="{{ '1' if r.after.ok else '0' }}"
              data-reld-after="{{ r.after.rel_demand if r.after.rel_demand is defined else 0 }}"
              data-rels-after="{{ r.after.rel_supply if r.after.rel_supply is defined else 0 }}"
              data-relb-after="{{ r.after.rel_backlog if r.after.rel_backlog is defined else 0 }}">
            <td>{{ r.period }}</td>
            <td>{{ r.family }}</td>
            <td class="mono" {% if r.before.ok_demand is defined and not r.before.ok_demand %}style="background:#fff0f0"{% endif %}>{{ r.before.demand }}</td>
            <td class="mono" {% if r.before.ok_supply is defined and not r.before.ok_supply %}style="background:#fff0f0"{% endif %}>{{ r.before.supply }}</td>
            <td class="mono" {% if r.before.ok_backlog is defined and not r.before.ok_backlog %}style="background:#fff0f0"{% endif %}>{{ r.before.backlog }}</td>
            <td class="mono">{{ r.after.demand }}</td>
            <td class="mono">{{ r.after.supply }}</td>
            <td class="mono">{{ r.after.backlog }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <script>
      (function(){
        var cb = document.getElementById('violOnly2');
        var tolAbs = document.getElementById('tolAbs2');
        var tolRel = document.getElementById('tolRel2');
        var sel = document.getElementById('cmpSort');
        function parseNum(x){ var v = parseFloat(x); return isNaN(v) ? 0 : v; }
        function apply(){
          var only = cb && cb.checked;
          var ta = tolAbs ? Math.max(0, parseFloat(tolAbs.value)||0) : 0;
          var tr = tolRel ? Math.max(0, parseFloat(tolRel.value)||0) : 0;
          var table = document.getElementById('tblCompare');
          var rows = table ? table.querySelectorAll('tbody tr') : [];
          var arr = Array.from(rows);
          rows.forEach(function(trEl){
            var tds = trEl.querySelectorAll('td');
            var d = Math.abs(parseNum(tds[5] && tds[5].textContent));
            var s = Math.abs(parseNum(tds[6] && tds[6].textContent));
            var b = Math.abs(parseNum(tds[7] && tds[7].textContent));
            var rd = Math.abs(parseNum(trEl.getAttribute('data-reld-after')||'0'));
            var rs = Math.abs(parseNum(trEl.getAttribute('data-rels-after')||'0'));
            var rb = Math.abs(parseNum(trEl.getAttribute('data-relb-after')||'0'));
            var bd = Math.abs(parseNum(tds[2] && tds[2].textContent));
            var bs = Math.abs(parseNum(tds[3] && tds[3].textContent));
            var bb = Math.abs(parseNum(tds[4] && tds[4].textContent));
            var rdb = Math.abs(parseNum(trEl.getAttribute('data-reld-before')||'0'));
            var rsb = Math.abs(parseNum(trEl.getAttribute('data-rels-before')||'0'));
            var rbb = Math.abs(parseNum(trEl.getAttribute('data-relb-before')||'0'));
            var okd = (d <= ta) || (rd <= tr);
            var oks = (s <= ta) || (rs <= tr);
            var okb = (b <= ta) || (rb <= tr);
            // after cell highlight
            [okd,oks,okb].forEach(function(ok,i){
              var td = tds[5+i];
              if (!td) return;
              td.style.background = ok ? '' : '#fff0f0';
            });
            var rowOk = okd && oks && okb;
            trEl.style.display = (only && rowOk) ? 'none' : '';
            // store key for sort
            trEl.setAttribute('data-relmax-after', String(Math.max(rd, rs, rb)));
            trEl.setAttribute('data-absmax-after', String(Math.max(d, s, b)));
            trEl.setAttribute('data-relmax-before', String(Math.max(rdb, rsb, rbb)));
            trEl.setAttribute('data-absmax-before', String(Math.max(bd, bs, bb)));
          });
          // sort
          if (sel && sel.value && sel.value !== 'none' && table){
            var tb = table.querySelector('tbody');
            var sorted = arr.sort(function(a,b){
              function key(el){
                switch(sel.value){
                  case 'rel_desc_after': return parseNum(el.getAttribute('data-relmax-after')||'0');
                  case 'rel_asc_after': return parseNum(el.getAttribute('data-relmax-after')||'0');
                  case 'abs_desc_after': return parseNum(el.getAttribute('data-absmax-after')||'0');
                  case 'abs_asc_after': return parseNum(el.getAttribute('data-absmax-after')||'0');
                  case 'rel_desc_before': return parseNum(el.getAttribute('data-relmax-before')||'0');
                  case 'rel_asc_before': return parseNum(el.getAttribute('data-relmax-before')||'0');
                  case 'abs_desc_before': return parseNum(el.getAttribute('data-absmax-before')||'0');
                  case 'abs_asc_before': return parseNum(el.getAttribute('data-absmax-before')||'0');
                  default: return 0;
                }
              }
              var ka = key(a), kb = key(b);
              var desc = /desc/.test(sel.value);
              return desc ? (kb - ka) : (ka - kb);
            });
            sorted.forEach(function(trEl){ tb.appendChild(trEl); });
          }
        }
        if (cb) cb.addEventListener('change', apply);
        if (tolAbs) tolAbs.addEventListener('change', apply);
        if (tolRel) tolRel.addEventListener('change', apply);
        if (sel) sel.addEventListener('change', apply);
        apply();
      })();
      </script>
    </details>
    {% endif %}

    {% if anchor_adj and anchor_adj.carryover and anchor_adj.carryover|length > 0 %}
    <details>
      <summary>carryover ログ（隣接periodへの持ち越し）</summary>
      {% set carryover_csv = out_dir ~ '/carryover.csv' %}
      <p class="mono"><a href="/{{ carryover_csv }}" download>carryover.csv</a></p>
      <table>
        <thead><tr><th>family</th><th>from_period</th><th>to_period</th><th>Δdemand</th><th>Δsupply</th><th>Δbacklog</th></tr></thead>
        <tbody>
          {% for r in anchor_adj.carryover %}
          <tr>
            <td>{{ r.family }}</td>
            <td>{{ r.from_period }}</td>
            <td>{{ r.to_period }}</td>
            <td class="mono">{{ r.metrics.demand }}</td>
            <td class="mono">{{ r.metrics.supply }}</td>
            <td class="mono">{{ r.metrics.backlog }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </details>
    {% endif %}
  </details>
  {% endif %}

  <details>
    <summary>MRP分解（先頭50行）</summary>
    {% if mrp and mrp.rows %}
    <table>
      <thead><tr><th>item</th><th>week</th><th>gross</th><th>on_hand_start</th><th>sched_rcpt</th><th>net_req</th><th>PORcpt</th><th>POLrel</th></tr></thead>
      <tbody>
        {% for r in mrp.rows[:50] %}
        <tr>
          <td class="mono">{{ r.item }}</td>
          <td>{{ r.week }}</td>
          <td class="mono">{{ r.gross_req }}</td>
          <td class="mono">{{ r.on_hand_start }}</td>
          <td class="mono">{{ r.scheduled_receipts }}</td>
          <td class="mono">{{ r.net_req }}</td>
          <td class="mono">{{ r.planned_order_receipt }}</td>
          <td class="mono">{{ r.planned_order_release }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}<p>データなし</p>{% endif %}
  </details>

  {% if report_path %}
  <p><a href="/{{ report_path }}" download>report.csv をダウンロード</a></p>
  {% endif %}
</section>

<section>
  <h3>可視化</h3>
  <canvas id="chartCapacity" height="100"></canvas>
  <canvas id="chartService" height="100" style="margin-top:16px"></canvas>
  <canvas id="chartSkuWeek" height="120" style="margin-top:16px"></canvas>
</section>
{% endif %}
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    const plan = {{ plan | tojson | safe if plan else 'null' }};
    const sku = {{ sku | tojson | safe if sku else 'null' }};
    const recon = {{ recon | tojson | safe if recon else 'null' }};
    // reportPath はJSの文字列リテラルとして安全に埋め込む（&quot;等のHTMLエスケープを防止）
    const reportPath = {{ ('/' ~ report_path) | tojson | safe if report_path else 'null' }};
    function fallbackNote(){
      const msg = document.createElement('p');
      msg.className = 'mono';
      msg.textContent = '注: オフラインモード（簡易可視化）。Chart.js未ロードのため簡易描画で表示しています。';
      const h3 = Array.from(document.querySelectorAll('h3')).find(x=>x.textContent.includes('可視化'));
      if (h3 && h3.parentElement) h3.parentElement.insertBefore(msg, h3.nextSibling);
    }
    function drawBarsSimple(canvas, labels, series){
      if(!canvas || !labels || !labels.length) return;
      const ctx = canvas.getContext('2d');
      const W = canvas.width = canvas.clientWidth || 600;
      const H = canvas.height = canvas.clientHeight || 200;
      ctx.clearRect(0,0,W,H);
      const pad = 30; const innerW = W - pad*2; const innerH = H - pad*2;
      const n = labels.length; const barGap = 6; const setCount = series.length;
      const groupW = innerW / n; const barW = Math.max(2, (groupW - barGap*(setCount+1)) / Math.max(1,setCount));
      let maxV = 0; series.forEach(s=>s.data.forEach(v=>{ if(v>maxV) maxV=v; }));
      if(maxV<=0){ ctx.fillText('データなし', pad, H/2); return; }
      // axes
      ctx.strokeStyle = '#999'; ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();
      // bars
      const colors = ['#3b82f6','#f59e0b','#10b981','#ef4444','#8b5cf6'];
      labels.forEach((lb, i)=>{
        const x0 = pad + i*groupW + barGap;
        series.forEach((s, si)=>{
          const v = Number(s.data[i]||0); const h = innerH * (v/maxV);
          const x = x0 + si*(barW+barGap); const y = H-pad-h;
          ctx.fillStyle = s.color || colors[si%colors.length];
          ctx.fillRect(x, y, barW, h);
        });
      });
    }
    function drawLinesSimple(canvas, labels, series){
      if(!canvas || !labels || !labels.length) return;
      const ctx = canvas.getContext('2d');
      const W = canvas.width = canvas.clientWidth || 600;
      const H = canvas.height = canvas.clientHeight || 200;
      ctx.clearRect(0,0,W,H);
      const pad = 30; const innerW = W - pad*2; const innerH = H - pad*2;
      let maxV = 0; series.forEach(s=>s.data.forEach(v=>{ if(v>maxV) maxV=v; }));
      if(maxV<=0){ ctx.fillText('データなし', pad, H/2); return; }
      ctx.strokeStyle = '#999'; ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();
      const colors = ['#666','#2a7'];
      series.forEach((s, si)=>{
        ctx.strokeStyle = s.color || colors[si%colors.length];
        ctx.beginPath();
        labels.forEach((_, i)=>{
          const x = pad + innerW*(i/Math.max(1,labels.length-1));
          const y = H - pad - innerH*(Number(s.data[i]||0)/maxV);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
      });
    }
    function makeCapacityChart(){
      if(!plan || !plan.weekly_summary) return;
      const weeks = plan.weekly_summary.map(r=>r.week);
      const cap = plan.weekly_summary.map(r=>r.capacity);
      const adj = plan.weekly_summary.map(r=>r.adjusted_load);
      const ctx = document.getElementById('chartCapacity');
      if (typeof Chart !== 'undefined'){
        new Chart(ctx, {type:'bar', data:{labels:weeks, datasets:[
          {label:'capacity', data:cap, backgroundColor:'rgba(54, 162, 235, 0.5)'},
          {label:'adjusted_load', data:adj, backgroundColor:'rgba(255, 159, 64, 0.5)'}
        ]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
      } else {
        fallbackNote();
        drawBarsSimple(ctx, weeks, [
          {name:'capacity', data:cap, color:'#4e79a7'},
          {name:'adjusted_load', data:adj, color:'#f28e2b'}
        ]);
      }
    }
    async function makeServiceChart(){
      if(!reportPath) return;
      try{
        const res = await fetch(reportPath);
        const txt = await res.text();
        const lines = txt.trim().split(/\r?\n/).slice(1);
        const weeks=[], demand=[], supply=[];
        for(const line of lines){
          if(!line.startsWith('service,')) continue;
          const parts = line.split(',');
          weeks.push(parts[1]);
          demand.push(parseFloat(parts[parts.length-3]||'0'));
          supply.push(parseFloat(parts[parts.length-2]||'0'));
        }
        const ctx = document.getElementById('chartService');
        if (typeof Chart !== 'undefined'){
          new Chart(ctx, {type:'line', data:{labels:weeks, datasets:[
            {label:'demand(FG)', data:demand, borderColor:'#888', backgroundColor:'rgba(136,136,136,0.2)'},
            {label:'supply_plan(FG)', data:supply, borderColor:'#2a7', backgroundColor:'rgba(34,170,119,0.2)'}
          ]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
        } else {
          fallbackNote();
          drawLinesSimple(ctx, weeks, [
            {name:'demand', data:demand, color:'#666'},
            {name:'supply', data:supply, color:'#2a7'}
          ]);
        }
      }catch(e){ console.warn(e); }
    }
    function makeSkuWeekChart(){
      if(!sku || !sku.rows) return;
      // Derive weeks and skus
      const rows = sku.rows;
      const weeksSet = new Set();
      const skusSet = new Set();
      rows.forEach(r=>{ weeksSet.add(r.week); skusSet.add(r.sku); });
      const weeks = Array.from(weeksSet).sort();
      const skus = Array.from(skusSet).sort();
      // Build dataset for demand by SKU per week (stacked)
      const colors = ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc949','#af7aa1','#ff9da7','#9c755f','#bab0ab'];
      const datasets = skus.map((s, i)=>{
        const data = weeks.map(w=>{
          const rec = rows.find(r=>r.sku===s && r.week===w);
          return rec ? Number(rec.demand||0) : 0;
        });
        const c = colors[i % colors.length];
        return {label:s, data, backgroundColor:c, stack:'demand'};
      });
      const ctx = document.getElementById('chartSkuWeek');
      if (typeof Chart !== 'undefined'){
        new Chart(ctx, {type:'bar', data:{labels:weeks, datasets}, options:{responsive:true, scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}}}});
      } else {
        // 簡易: 週合計需要で棒グラフ
        fallbackNote();
        const totals = weeks.map((w)=> rows.filter(r=>r.week===w).reduce((a,b)=>a+Number(b.demand||0),0));
        drawBarsSimple(ctx, weeks, [{name:'demand_total', data:totals, color:'#4e79a7'}]);
      }
    }
    makeCapacityChart();
    makeServiceChart();
    makeSkuWeekChart();
  })();
</script>
{% endblock %}
