{% extends "base.html" %}
{% block content %}
<section>
  <h2>粗密計画パイプライン（UI検証）</h2>
  <form method="post" action="/planning/run">
    <details>
      <summary>CSVアップロード（任意）</summary>
      <div class="grid">
        <label>demand_family.csv<input type="file" name="demand_family" accept=".csv"></label>
        <label>capacity.csv<input type="file" name="capacity" accept=".csv"></label>
        <label>mix_share.csv<input type="file" name="mix_share" accept=".csv"></label>
      </div>
      <div class="grid">
        <label>item.csv<input type="file" name="item" accept=".csv"></label>
        <label>inventory.csv<input type="file" name="inventory" accept=".csv"></label>
        <label>open_po.csv<input type="file" name="open_po" accept=".csv"></label>
        <label>bom.csv<input type="file" name="bom" accept=".csv"></label>
      </div>
      <p class="mono">アップロードがある場合は `input_dir` よりアップロードを優先します。</p>
    </details>
    <div class="grid">
      <label>入力ディレクトリ
        <input type="text" name="input_dir" value="samples/planning">
      </label>
      <label>出力ディレクトリ（任意）
        <input type="text" name="out_dir" placeholder="out/ui_planning_...">
      </label>
    </div>
    <div class="grid">
      <label>週数
        <input type="number" name="weeks" min="1" value="4">
      </label>
      <label>丸め
        <select name="round_mode">
          <option value="none">none</option>
          <option value="int" selected>int</option>
          <option value="dec1">dec1</option>
          <option value="dec2">dec2</option>
        </select>
      </label>
      <label>LT単位
        <select name="lt_unit">
          <option value="day" selected>day</option>
          <option value="week">week</option>
        </select>
      </label>
    </div>
    <button type="submit">パイプライン実行</button>
  </form>
</section>

<section>
  <form method="post" action="/planning/run_job">
    <input type="hidden" name="input_dir" value="samples/planning" />
    <input type="hidden" name="weeks" value="4" />
    <input type="hidden" name="round_mode" value="int" />
    <input type="hidden" name="lt_unit" value="day" />
    <button type="submit" class="secondary">ジョブとして実行（/ui/jobsで監視）</button>
  </form>
</section>

{% if error %}
<article>
  <mark>エラー</mark>
  <pre class="mono">{{ error }}</pre>
{% endif %}

{% if out_dir %}
<section>
  <h3>出力（{{ out_dir }}）</h3>
  <details open>
    <summary>Aggregate（family×period）</summary>
    {% if aggregate and aggregate.rows %}
    <table>
      <thead><tr><th>period</th><th>family</th><th>demand</th><th>supply</th><th>backlog</th><th>capacity_total</th></tr></thead>
      <tbody>
        {% for r in aggregate.rows %}
        <tr>
          <td>{{ r.period }}</td><td>{{ r.family }}</td>
          <td class="mono">{{ r.demand }}</td>
          <td class="mono">{{ r.supply }}</td>
          <td class="mono">{{ r.backlog }}</td>
          <td class="mono">{{ r.capacity_total }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>データなし</p>
    {% endif %}
  </details>

  <details open>
    <summary>能力サマリ（weekly_summary）</summary>
    {% if plan and plan.weekly_summary %}
    <table>
      <thead><tr><th>week</th><th>capacity</th><th>original</th><th>adjusted</th><th>spill_in</th><th>spill_out</th></tr></thead>
      <tbody>
        {% for r in plan.weekly_summary %}
        <tr>
          <td>{{ r.week }}</td>
          <td class="mono">{{ r.capacity }}</td>
          <td class="mono">{{ r.original_load }}</td>
          <td class="mono">{{ r.adjusted_load }}</td>
          <td class="mono">{{ r.spill_in }}</td>
          <td class="mono">{{ r.spill_out }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}<p>データなし</p>{% endif %}
  </details>

  <details>
    <summary>MRP分解（先頭50行）</summary>
    {% if mrp and mrp.rows %}
    <table>
      <thead><tr><th>item</th><th>week</th><th>gross</th><th>on_hand_start</th><th>sched_rcpt</th><th>net_req</th><th>PORcpt</th><th>POLrel</th></tr></thead>
      <tbody>
        {% for r in mrp.rows[:50] %}
        <tr>
          <td class="mono">{{ r.item }}</td>
          <td>{{ r.week }}</td>
          <td class="mono">{{ r.gross_req }}</td>
          <td class="mono">{{ r.on_hand_start }}</td>
          <td class="mono">{{ r.scheduled_receipts }}</td>
          <td class="mono">{{ r.net_req }}</td>
          <td class="mono">{{ r.planned_order_receipt }}</td>
          <td class="mono">{{ r.planned_order_release }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}<p>データなし</p>{% endif %}
  </details>

  {% if report_path %}
  <p><a href="/{{ report_path }}" download>report.csv をダウンロード</a></p>
  {% endif %}
</section>

<section>
  <h3>可視化</h3>
  <canvas id="chartCapacity" height="100"></canvas>
  <canvas id="chartService" height="100" style="margin-top:16px"></canvas>
  <canvas id="chartSkuWeek" height="120" style="margin-top:16px"></canvas>
</section>
{% endif %}
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    const plan = {{ plan | tojson | safe if plan else 'null' }};
    const sku = {{ sku | tojson | safe if sku else 'null' }};
    const reportPath = {{ ('"/' ~ report_path ~ '"') if report_path else 'null' }};
    function makeCapacityChart(){
      if(!plan || !plan.weekly_summary) return;
      const weeks = plan.weekly_summary.map(r=>r.week);
      const cap = plan.weekly_summary.map(r=>r.capacity);
      const adj = plan.weekly_summary.map(r=>r.adjusted_load);
      const ctx = document.getElementById('chartCapacity');
      new Chart(ctx, {type:'bar', data:{labels:weeks, datasets:[
        {label:'capacity', data:cap, backgroundColor:'rgba(54, 162, 235, 0.5)'},
        {label:'adjusted_load', data:adj, backgroundColor:'rgba(255, 159, 64, 0.5)'}
      ]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
    }
    async function makeServiceChart(){
      if(!reportPath) return;
      try{
        const res = await fetch(reportPath);
        const txt = await res.text();
        const lines = txt.trim().split(/\r?\n/).slice(1);
        const weeks=[], demand=[], supply=[];
        for(const line of lines){
          if(!line.startsWith('service,')) continue;
          const parts = line.split(',');
          weeks.push(parts[1]);
          demand.push(parseFloat(parts[parts.length-3]||'0'));
          supply.push(parseFloat(parts[parts.length-2]||'0'));
        }
        const ctx = document.getElementById('chartService');
        new Chart(ctx, {type:'line', data:{labels:weeks, datasets:[
          {label:'demand(FG)', data:demand, borderColor:'#888', backgroundColor:'rgba(136,136,136,0.2)'},
          {label:'supply_plan(FG)', data:supply, borderColor:'#2a7', backgroundColor:'rgba(34,170,119,0.2)'}
        ]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
      }catch(e){ console.warn(e); }
    }
    function makeSkuWeekChart(){
      if(!sku || !sku.rows) return;
      // Derive weeks and skus
      const rows = sku.rows;
      const weeksSet = new Set();
      const skusSet = new Set();
      rows.forEach(r=>{ weeksSet.add(r.week); skusSet.add(r.sku); });
      const weeks = Array.from(weeksSet).sort();
      const skus = Array.from(skusSet).sort();
      // Build dataset for demand by SKU per week (stacked)
      const colors = ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc949','#af7aa1','#ff9da7','#9c755f','#bab0ab'];
      const datasets = skus.map((s, i)=>{
        const data = weeks.map(w=>{
          const rec = rows.find(r=>r.sku===s && r.week===w);
          return rec ? Number(rec.demand||0) : 0;
        });
        const c = colors[i % colors.length];
        return {label:s, data, backgroundColor:c, stack:'demand'};
      });
      const ctx = document.getElementById('chartSkuWeek');
      new Chart(ctx, {type:'bar', data:{labels:weeks, datasets}, options:{responsive:true, scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}}}});
    }
    makeCapacityChart();
    makeServiceChart();
    makeSkuWeekChart();
  })();
</script>
{% endblock %}
