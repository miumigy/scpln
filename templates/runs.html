{% extends "base.html" %}
{% block page_header %}
  <h2>Run History</h2>
  <p>Review orchestration results, inspect metrics, and create plan versions from past runs.</p>
{% endblock %}
{% block content %}
<section class="page-section">
  <div class="toolbar justify-end gap-bottom-sm">
    <button id="reload-btn" type="button" aria-label="Reload data from API">Refresh from API</button>
  </div>
  {% if rows %}
  <div class="table-wrapper">
    <table role="grid">
      <thead>
        <tr>
          <th scope="col">Select</th>
          <th scope="col">run_id</th>
          <th scope="col"><button type="button" class="link" id="th-sort-started" title="Sort by started_at" aria-label="Sort by start time">started_at (JST)</button></th>
          <th scope="col"><button type="button" class="link" id="th-sort-dur" title="Sort by duration_ms" aria-label="Sort by duration">dur(ms)</button></th>
          <th scope="col"><button type="button" class="link" id="th-sort-schema" title="Sort by schema_version" aria-label="Sort by schema version">schema</button></th>
          <th scope="col">config_id</th>
          <th scope="col">scenario_id</th>
          <th scope="col">fill_rate</th>
          <th scope="col">profit_total</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody id="runs-tbody">
        {% for r in rows %}
        <tr>
          <td><input class="pick" type="checkbox" value="{{ r.run_id }}" data-sid="{{ r.scenario_id or '' }}" /></td>
          <td class="mono truncate" title="{{ r.run_id }}">{{ r.run_id }}</td>
          <td class="ts-ms" data-ms="{{ r.started_at }}">{{ r.started_at_str or r.started_at }}</td>
          <td>{{ r.duration_ms }}</td>
          <td>{{ r.schema_version }}</td>
          <td>{{ r.config_id or '' }}</td>
          <td>{{ r.scenario_id or '' }}</td>
          <td>{{ "%.3f"|format(r.fill_rate or 0) }}</td>
          <td>{{ "%.2f"|format(r.profit_total or 0) }}</td>
          <td>
            <a role="button" href="/ui/runs/{{ r.run_id }}">Detail</a>
            <button type="button" class="secondary create-plan" data-run-id="{{ r.run_id }}" data-scenario-id="{{ r.scenario_id or '' }}" title="Create plan version from this run" aria-label="Create plan version from this run">Plan</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="pager" class="toolbar gap-top-sm">
    <button id="first-page" type="button" class="secondary" aria-label="Go to first page">First</button>
    <button id="prev-page" type="button" class="secondary" aria-label="Go to previous page">Prev</button>
    <button id="next-page" type="button" class="secondary" aria-label="Go to next page">Next</button>
    <button id="last-page" type="button" class="secondary" aria-label="Go to last page">Last</button>
    <span class="mono">Page</span>
    <input id="page-number" class="input-compact-sm" type="number" min="1" value="1" />
    <span class="mono">/ <span id="page-total">1</span></span>
    <label>Limit
      <select id="limit-select">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </label>
    <span id="pager-info" class="mono"></span>
  </div>
  <div id="bulk-actions" class="toolbar gap-top-sm">
    <button id="delete-selected" type="button" class="contrast" aria-label="Delete selected runs">Delete selected</button>
    <button id="plan-selected" type="button" aria-label="Create plans synchronously for selected runs">Plan selected</button>
    <button id="plan-selected-jobs" type="button" class="secondary" aria-label="Create plans as jobs for selected runs">Plan selected (jobs)</button>
    <span class="mono">|</span>
    <label>Version prefix
      <input id="ver-prefix" class="input-compact-md" type="text" placeholder="run-" />
    </label>
    <label><input id="ver-ts" type="checkbox" checked /> Timestamp</label>
  </div>
  <div id="bulk-result" class="gap-top-sm" style="display:none;"></div>
  <div id="filters" class="toolbar gap-top-sm">
    <label>Sort
      <select id="sort-select">
        <option value="started_at" selected>started_at</option>
        <option value="duration_ms">duration_ms</option>
        <option value="schema_version">schema_version</option>
      </select>
    </label>
    <label>Order
      <select id="order-select">
        <option value="desc" selected>desc</option>
        <option value="asc">asc</option>
      </select>
    </label>
    <label>Schema
      <input id="schema-filter" class="input-compact-sm" type="text" placeholder="1.0" />
    </label>
    <label>Config ID
      <input id="config-filter" class="input-compact-sm" type="number" min="1" />
    </label>
    <label>Scenario ID
      <input id="scenario-filter" class="input-compact-sm" type="number" min="1" />
    </label>
    <label><input id="hide-archived" type="checkbox" checked> Hide archived</label>
    <button id="apply-filter" type="button" class="secondary" aria-label="Apply filters">Apply</button>
    <button id="clear-filter" type="button" class="secondary" aria-label="Clear filters">Clear</button>
  </div>
  <div id="saved-views" class="toolbar gap-top-sm align-end">
    <label>Saved views
      <select id="views-select">
        <option value="">(select)</option>
      </select>
    </label>
    <button id="apply-view" type="button" class="secondary" aria-label="Apply saved view">Apply view</button>
    <button id="delete-view" type="button" aria-label="Delete saved view">Delete view</button>
    <label>Name
      <input id="view-name" type="text" placeholder="Current S&OP focus" />
    </label>
    <button id="save-view" type="button" aria-label="Save current filters as view">Save current as view</button>
    <button id="copy-link" type="button" class="secondary" aria-label="Copy permalink for current filters">Copy link</button>
    <span class="mono">|</span>
    <label>Server views
      <select id="views-select-server">
        <option value="">(select)</option>
      </select>
    </label>
    <button id="apply-view-server" type="button" class="secondary" aria-label="Apply shared server view">Apply server view</button>
    <label><input id="server-view-shared" type="checkbox"> shared</label>
    <label>Scope
      <select id="server-view-scope">
        <option value="private" selected>private</option>
        <option value="org">org</option>
        <option value="public">public</option>
      </select>
    </label>
    <label>Name
      <input id="view-name-server" type="text" placeholder="Shared view name" />
    </label>
    <button id="save-view-server" type="button" aria-label="Save current filters to server">Save to server</button>
  </div>
  {% else %}
  <p>No runs yet. Call <code>/simulation</code> to generate.</p>
  {% endif %}
</section>
<section class="page-section">
  <div class="section-header gap-bottom-sm">
    <h3>Compare Runs</h3>
    <p>Select one or more run IDs to compute comparative views.</p>
  </div>
  <form method="post" action="/ui/compare" id="compare-form">
    <label>Run IDs (comma-separated)
      <input id="run-ids" class="mono" type="text" name="run_ids" placeholder="id1,id2" required />
    </label>
    <small class="help-text">Use the buttons below to populate the field from your current selections.</small>
    <div class="toolbar gap-top-sm">
      <button id="use-selected" type="button" class="secondary" aria-label="Populate with selected runs">Use selected</button>
      <button type="submit" aria-label="Submit comparison">Compare</button>
      <button id="compare-selected" type="button" class="contrast" aria-label="Compare selected runs">Compare selected</button>
    </div>
  </form>
</section>
{% endblock %}

{% block scripts %}
<script src="/static/js/runs_ui.js"></script>
<script>
(function(){
  function fallbackFormat(scope){
    var root = scope || document;
    root.querySelectorAll('td.ts-ms').forEach(function(td){
      var raw = td.getAttribute('data-ms');
      var txt = '';
      if (raw) {
        var n = Number(raw);
        if (!Number.isFinite(n)) {
          var parsed = Date.parse(raw);
          if (Number.isFinite(parsed)) n = parsed;
        }
        if (Number.isFinite(n)) {
          if (n < 1e12) n = n * 1000;
          var t = new Date(n + 9*3600*1000);
          var y = t.getUTCFullYear();
          var mo = String(t.getUTCMonth()+1).padStart(2,'0');
          var d = String(t.getUTCDate()).padStart(2,'0');
          var h = String(t.getUTCHours()).padStart(2,'0');
          var mi = String(t.getUTCMinutes()).padStart(2,'0');
          var s = String(t.getUTCSeconds()).padStart(2,'0');
          txt = y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s+' JST';
        }
      }
      if (!txt) {
        txt = td.textContent || '';
      }
      if (txt) td.textContent = txt;
    });
  }

  var formatter = (window.RunsUI && typeof window.RunsUI.formatTimestamps === 'function')
    ? window.RunsUI.formatTimestamps
    : fallbackFormat;

  formatter(document);
  // Initialize metadata (total/offset/limit) from API when the page loads
  if (window.RunsUI && typeof window.RunsUI.init === 'function') {
    window.RunsUI.init();
  }
  // Local saved views
  function loadViews(){
    let views = [];
    try { views = JSON.parse(localStorage.getItem('runs_views')||'[]'); } catch {}
    const sel = document.getElementById('views-select');
    if (!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="">(select)</option>' + views.map((v,i)=>`<option value="${i}">${v.name}</option>`).join('');
    if (cur) sel.value = cur;
  }
  function getState(){ try { return JSON.parse(localStorage.getItem('runs_prefs')||'{}') } catch { return {} } }
  function setState(s){ try { localStorage.setItem('runs_prefs', JSON.stringify(s)); } catch {} }
  document.getElementById('save-view')?.addEventListener('click', function(){
    const name = (document.getElementById('view-name')?.value || '').trim();
    if (!name) { alert('Please enter a name.'); return; }
    const s = getState();
    const rec = { name, params: s };
    let views = [];
    try { views = JSON.parse(localStorage.getItem('runs_views')||'[]'); } catch {}
    views.push(rec);
    try { localStorage.setItem('runs_views', JSON.stringify(views)); } catch {}
    loadViews();
    alert('Saved.');
  });
  document.getElementById('apply-view')?.addEventListener('click', function(){
    const sel = document.getElementById('views-select');
    const idx = Number(sel?.value||'');
    let views = [];
    try { views = JSON.parse(localStorage.getItem('runs_views')||'[]'); } catch {}
    if (!Number.isFinite(idx) || idx<0 || idx>=views.length) { alert('Select a saved view.'); return; }
    const p = views[idx].params || {};
    const s = getState();
    const merged = { ...s, ...p };
    setState(merged);
    // No need to rehydrate the form; reload the page to apply stored preferences.
    location.href = '/ui/runs';
  });
  document.getElementById('delete-view')?.addEventListener('click', function(){
    const sel = document.getElementById('views-select');
    const idx = Number(sel?.value||'');
    let views = [];
    try { views = JSON.parse(localStorage.getItem('runs_views')||'[]'); } catch {}
    if (!Number.isFinite(idx) || idx<0 || idx>=views.length) { alert('Select a saved view.'); return; }
    views.splice(idx,1);
    try { localStorage.setItem('runs_views', JSON.stringify(views)); } catch {}
    loadViews();
  });
  document.getElementById('copy-link')?.addEventListener('click', function(){
    try { navigator.clipboard.writeText(location.href); alert('Copied URL.'); } catch { alert('Copy failed.'); }
  });
  loadViews();
  // Server-side views
  async function loadServerViews(){
    try {
      const res = await fetch('/views', { headers: getHeaders() });
      if (!res.ok) return;
      const js = await res.json();
      const sel = document.getElementById('views-select-server');
      if (!sel) return;
      const rows = js.views || [];
      sel.innerHTML = '<option value="">(select)</option>' + rows.map(v=>`<option value="${v.id}">${v.name}${v.shared?' (shared)':''}</option>`).join('');
      sel.setAttribute('data-views', JSON.stringify(rows));
    } catch {}
  }
  document.getElementById('apply-view-server')?.addEventListener('click', function(){
    const sel = document.getElementById('views-select-server');
    const id = Number(sel?.value||'');
    if (!Number.isFinite(id) || id<=0) { alert('Select a server view.'); return; }
    try {
      const rows = JSON.parse(sel.getAttribute('data-views')||'[]');
      const v = rows.find(x=>x.id===id);
      if (!v) { alert('View not found.'); return; }
      const merged = { ...getState(), ...(v.filters||{}) };
      setState(merged);
      location.href = '/ui/runs';
    } catch { alert('Failed to apply view.'); }
  });
  document.getElementById('save-view-server')?.addEventListener('click', async function(){
    const name = (document.getElementById('view-name-server')?.value||'').trim();
    if (!name) { alert('Please enter a name.'); return; }
    const shared = !!document.getElementById('server-view-shared')?.checked;
    const scope = (document.getElementById('server-view-scope')?.value||'private');
    const filters = getState();
    try {
      const res = await fetch('/views', { method:'POST', headers: { ...getHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ name, shared, scope, filters }) });
      if (!res.ok) throw new Error('HTTP '+res.status);
      await loadServerViews();
      alert('Saved to server.');
    } catch(e) { console.error(e); alert('Save failed.'); }
  });
  function getHeaders(){
    const h = {};
    try { const k = localStorage.getItem('api_key') || ''; if (k) h['X-API-Key'] = k; } catch {}
    try { const u = localStorage.getItem('user_email') || ''; if (u) h['X-User'] = u; } catch {}
    try { const r = localStorage.getItem('user_role') || ''; if (r) h['X-Role'] = r; } catch {}
    return h;
  }
  loadServerViews();

  function tsId(){
    const t = new Date();
    const pad=n=>String(n).padStart(2,'0');
    return t.getFullYear()+pad(t.getMonth()+1)+pad(t.getDate())+pad(t.getHours())+pad(t.getMinutes())+pad(t.getSeconds());
  }
  function getPrefs(){ try { return JSON.parse(localStorage.getItem('runs_prefs')||'{}') } catch { return {} } }
  function setPrefs(s){ try { localStorage.setItem('runs_prefs', JSON.stringify(s)); } catch {} }
  function versionFromRun(runId){
    const s = getPrefs();
    const prefix = (s.plan_version_prefix ?? 'run-');
    const withTs = (typeof s.plan_version_ts === 'boolean') ? s.plan_version_ts : true;
    let base = '';
    try { const p = String(runId||'').replace(/[^a-zA-Z0-9]/g,''); base = prefix + p.slice(0,8); } catch { base = prefix + 'run'; }
    return withTs ? (base + '-' + tsId()) : base;
  }

  // Run → Plan conversion (quick action)
  async function createPlan(runId, scenarioId){
    try {
      const headers = getHeaders();
      // Fetch config.json to reuse defaults when available
      let cfg = null;
      try {
        const r = await fetch(`/runs/${runId}/config.json`, { headers });
        if (r.ok) cfg = await r.json();
      } catch(e) { cfg = null; }
      const payload = {
        base_scenario_id: (scenarioId && !isNaN(Number(scenarioId))) ? Number(scenarioId) : undefined,
        version_id: versionFromRun(runId),
        weeks: (cfg && typeof cfg.weeks !== 'undefined') ? cfg.weeks : undefined,
        lt_unit: (cfg && cfg.lt_unit) || undefined,
        cutover_date: (cfg && cfg.cutover_date) || undefined,
        recon_window_days: (cfg && typeof cfg.recon_window_days !== 'undefined') ? cfg.recon_window_days : undefined,
        anchor_policy: (cfg && cfg.anchor_policy) || undefined,
        tol_abs: (cfg && typeof cfg.tol_abs !== 'undefined') ? cfg.tol_abs : undefined,
        tol_rel: (cfg && typeof cfg.tol_rel !== 'undefined') ? cfg.tol_rel : undefined,
        calendar_mode: (cfg && cfg.calendar_mode) || undefined,
        carryover: (cfg && cfg.carryover) || undefined,
        carryover_split: (cfg && typeof cfg.carryover_split !== 'undefined') ? cfg.carryover_split : undefined,
        apply_adjusted: (cfg && !!cfg.apply_adjusted) || false,
        source_run_id: runId,
        note: `created from run ${runId}`
      };
      const res = await fetch('/plans/integrated/run', { method:'POST', headers: { ...headers, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      if (data && data.version_id){ window.location.href = '/ui/plans/' + data.version_id; }
      else { alert('Plan creation failed (missing version_id).'); }
    } catch(e) { console.error(e); alert('Plan creation failed.'); }
  }
  // Run → Plan conversion (silent bulk helper)
  async function createPlanSilent(runId, scenarioId){
    try {
      const headers = getHeaders();
      let cfg = null;
      try { const r = await fetch(`/runs/${runId}/config.json`, { headers }); if (r.ok) cfg = await r.json(); } catch {}
      const payload = {
        base_scenario_id: (scenarioId && !isNaN(Number(scenarioId))) ? Number(scenarioId) : undefined,
        version_id: versionFromRun(runId),
        weeks: (cfg && typeof cfg.weeks !== 'undefined') ? cfg.weeks : undefined,
        lt_unit: (cfg && cfg.lt_unit) || undefined,
        cutover_date: (cfg && cfg.cutover_date) || undefined,
        recon_window_days: (cfg && typeof cfg.recon_window_days !== 'undefined') ? cfg.recon_window_days : undefined,
        anchor_policy: (cfg && cfg.anchor_policy) || undefined,
        tol_abs: (cfg && typeof cfg.tol_abs !== 'undefined') ? cfg.tol_abs : undefined,
        tol_rel: (cfg && typeof cfg.tol_rel !== 'undefined') ? cfg.tol_rel : undefined,
        calendar_mode: (cfg && cfg.calendar_mode) || undefined,
        carryover: (cfg && cfg.carryover) || undefined,
        carryover_split: (cfg && typeof cfg.carryover_split !== 'undefined') ? cfg.carryover_split : undefined,
        apply_adjusted: (cfg && !!cfg.apply_adjusted) || false,
        source_run_id: runId,
        note: `created from run ${runId}`
      };
      const res = await fetch('/plans/integrated/run', { method:'POST', headers: { ...headers, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!res.ok) {
        let msg = 'HTTP '+res.status;
        try { const tx = await res.text(); if (tx) msg = tx; } catch {}
        return { ok: false, run_id: runId, sid: (scenarioId||''), error: msg };
      }
      let data = null;
      try { data = await res.json(); } catch { data = null; }
      if (data && data.version_id) return { ok: true, run_id: runId, sid: (scenarioId||''), version_id: data.version_id };
      return { ok: false, run_id: runId, sid: (scenarioId||''), error: 'no version_id' };
    } catch(e) { console.error(e); return { ok: false, run_id: runId, sid: (scenarioId||''), error: String(e && e.message || e) }; }
  }
  document.body.addEventListener('click', function(ev){
    const el = ev.target;
    if (el && el.classList && el.classList.contains('create-plan')){
      const runId = el.getAttribute('data-run-id');
      const sid = el.getAttribute('data-scenario-id');
      createPlan(runId, sid);
    }
  });

  // Persist version controls
  (function initVersionControls(){
    const s = getPrefs();
    const prefixEl = document.getElementById('ver-prefix');
    const tsEl = document.getElementById('ver-ts');
    if (prefixEl) prefixEl.value = s.plan_version_prefix ?? 'run-';
    if (tsEl) tsEl.checked = (typeof s.plan_version_ts === 'boolean') ? s.plan_version_ts : true;
    prefixEl?.addEventListener('change', function(){ const st = getPrefs(); st.plan_version_prefix = prefixEl.value || 'run-'; setPrefs(st); });
    tsEl?.addEventListener('change', function(){ const st = getPrefs(); st.plan_version_ts = !!tsEl.checked; setPrefs(st); });
  })();

  // Bulk: synchronous plan creation
  async function planSelectedSync(){
    const picks = Array.from(document.querySelectorAll('input.pick:checked'));
    if (!picks.length){ alert('Select at least one run.'); return; }
    if (!confirm(`Create ${picks.length} plan version(s) sequentially?`)) return;
    const versions = [];
    const failures = [];
    const bySid = {};
    for (const el of picks){
      const rid = el.value;
      const sid = el.getAttribute('data-sid');
      const r = await createPlanSilent(rid, sid);
      if (r && r.ok) {
        versions.push(r.version_id);
        const key = String(r.sid||'');
        if (!bySid[key]) bySid[key] = [];
        bySid[key].push(r.version_id);
      } else {
        failures.push({ run_id: rid, error: r && r.error ? r.error : 'unknown' });
      }
    }
    const box = document.getElementById('bulk-result');
    if (box){
      box.style.display = '';
      if (versions.length){
        const groups = Object.keys(bySid).map(sid => {
          const lst = bySid[sid] || [];
          const head = `<div><strong>scenario_id=${sid||'(none)'}:</strong> ${lst.length} created</div>`;
          const body = `<div>${lst.map(v=>`<a href=\"/ui/plans/${v}\">${v}</a>`).join('<span class=\"mono\"> | </span>')}</div>`;
          return head + body;
        }).join('<hr style=\"border:none;border-top:1px solid #eee; margin:6px 0;\"/>');
        box.innerHTML = '<div style="background:#e7f5ff;padding:6px 8px;">'+
          `<strong>Plan creation complete:</strong> ${versions.length}`+
          (failures.length? (` <small class=\"mono\">| failed: ${failures.length}</small>`) : '') +
        '</div>'+
        '<div style="padding:6px 8px;">'+groups+'</div>'+
        (failures.length? ('<div style="background:#fff8e1;padding:6px 8px; margin-top:6px;">'+
          failures.slice(0,10).map(f=>`<div class=\"mono\">${f.run_id}: ${f.error.replaceAll('<','&lt;')}</div>`).join('')+
          (failures.length>10? `<div class=\"mono\">... and ${failures.length-10} more</div>`:'' )+
        '</div>') : '');
        setTimeout(()=>{ window.location.href = '/ui/plans'; }, 1200);
      } else {
        box.innerHTML = '<div style="background:#fff0f0;padding:6px 8px;">Plan creation failed'+
          (failures.length? ('<br/>'+failures.slice(0,10).map(f=>`<div class=\"mono\">${f.run_id}: ${f.error.replaceAll('<','&lt;')}</div>`).join('')):'')+
        '</div>';
      }
    }
  }
  document.getElementById('plan-selected')?.addEventListener('click', planSelectedSync);

  // Bulk: enqueue plan creation jobs (async)
  async function planSelectedJobs(){
    const picks = Array.from(document.querySelectorAll('input.pick:checked'));
    if (!picks.length){ alert('Select at least one run.'); return; }
    if (!confirm(`Enqueue ${picks.length} plan creation job(s)? Monitor progress in /ui/jobs.`)) return;
    const headers = getHeaders();
    let ok = 0, ng = 0;
    const failures = [];
    for (const el of picks){
      const runId = el.value;
      const sid = el.getAttribute('data-sid');
      let cfg = null;
      try { const r = await fetch(`/runs/${runId}/config.json`, { headers }); if (r.ok) cfg = await r.json(); } catch {}
      const body = {
        pipeline: 'integrated',
        async: true,
        options: {
          version_id: versionFromRun(runId),
          base_scenario_id: (sid && !isNaN(Number(sid))) ? Number(sid) : undefined,
          source_run_id: runId,
          input_dir: (cfg && cfg.input_dir) || 'samples/planning',
          weeks: (cfg && typeof cfg.weeks !== 'undefined') ? cfg.weeks : 4,
          lt_unit: (cfg && cfg.lt_unit) || 'day',
          cutover_date: (cfg && cfg.cutover_date) || undefined,
          recon_window_days: (cfg && typeof cfg.recon_window_days !== 'undefined') ? cfg.recon_window_days : undefined,
          anchor_policy: (cfg && cfg.anchor_policy) || undefined,
          tol_abs: (cfg && typeof cfg.tol_abs !== 'undefined') ? cfg.tol_abs : undefined,
          tol_rel: (cfg && typeof cfg.tol_rel !== 'undefined') ? cfg.tol_rel : undefined,
          calendar_mode: (cfg && cfg.calendar_mode) || undefined,
          carryover: (cfg && cfg.carryover) || undefined,
          carryover_split: (cfg && typeof cfg.carryover_split !== 'undefined') ? cfg.carryover_split : undefined,
          apply_adjusted: (cfg && !!cfg.apply_adjusted) || false
        }
      };
      try {
        const res = await fetch('/runs', { method:'POST', headers: { ...headers, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (res.ok) {
          try { const js = await res.json(); if (!(js && js.status === 'queued')) { failures.push({ run_id: runId, error: 'unexpected response' }); ng++; } else { ok++; } }
          catch { ok++; }
        } else {
          let msg = 'HTTP '+res.status;
          try { msg = await res.text(); } catch {}
          failures.push({ run_id: runId, error: msg });
          ng++;
        }
      } catch(e) { failures.push({ run_id: runId, error: String(e && e.message || e) }); ng++; }
    }
    const box = document.getElementById('bulk-result');
    if (box){
      box.style.display = '';
      box.innerHTML = '<div style="background:#e7f5ff;padding:6px 8px;">'+
        `<strong>Job enqueue summary:</strong> success=${ok}, failed=${ng}`+
      '</div>'+
      (failures.length? ('<div style="background:#fff8e1;padding:6px 8px; margin-top:6px;">'+
        failures.slice(0,10).map(f=>`<div class=\"mono\">${f.run_id}: ${f.error && String(f.error).replaceAll('<','&lt;')}</div>`).join('')+
        (failures.length>10? `<div class=\"mono\">... and ${failures.length-10} more</div>`:'' )+
      '</div>') : '');
    }
    setTimeout(()=>{ window.location.href = '/ui/jobs'; }, 1200);
  }
  document.getElementById('plan-selected-jobs')?.addEventListener('click', planSelectedJobs);
})();
</script>
{% endblock %}
