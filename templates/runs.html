{% extends "base.html" %}
{% block page_header %}
  <h2>Run History</h2>
  <p>Review orchestration results, inspect metrics, and create plan versions from past runs.</p>
{% endblock %}
{% block content %}
<section class="page-section">
  <div class="toolbar justify-end gap-bottom-sm">
    <button id="reload-btn" type="button" aria-label="Reload data from API">Refresh from API</button>
  </div>
  {% if rows %}
  <div class="table-wrapper">
    <table role="grid">
      <thead>
        <tr>
          <th scope="col">Select</th>
          <th scope="col">run_id</th>
          <th scope="col"><button type="button" class="link" id="th-sort-started" title="Sort by started_at" aria-label="Sort by start time">started_at (JST)</button></th>
          <th scope="col"><button type="button" class="link" id="th-sort-dur" title="Sort by duration_ms" aria-label="Sort by duration">dur(ms)</button></th>
          <th scope="col"><button type="button" class="link" id="th-sort-schema" title="Sort by schema_version" aria-label="Sort by schema version">schema</button></th>
          <th scope="col">config_version_id</th>
          <th scope="col">plan_version_id</th>
          <th scope="col">scenario_id</th>
          <th scope="col">fill_rate</th>
          <th scope="col">profit_total</th>
        </tr>
      </thead>
      <tbody id="runs-tbody">
        {% for r in rows %}
        <tr>
          <td><input class="pick" type="checkbox" value="{{ r.run_id }}" data-sid="{{ r.scenario_id or '' }}" /></td>
          <td class="mono truncate" title="{{ r.run_id }}"><a href="/ui/runs/{{ r.run_id }}">{{ r.run_id }}</a></td>
          <td class="ts-ms" data-ms="{{ r.started_at }}">{{ r.started_at_str or r.started_at }}</td>
          <td>{{ r.duration_ms|fmt_number }}</td>
          <td>{{ r.schema_version }}</td>
          <td class="mono">{% if r.config_version_id %}<a href="/ui/configs/canonical/{{ r.config_version_id }}">{{ r.config_version_id }}</a>{% else %}-{% endif %}</td>
          <td class="mono">{% if r.plan_version_id %}<a href="/ui/plans/{{ r.plan_version_id }}">{{ r.plan_version_id }}</a>{% else %}-{% endif %}</td>
          <td class="mono">{% if r.scenario_id %}<a href="/ui/scenarios?highlight={{ r.scenario_id }}">{{ r.scenario_id }}</a>{% else %}-{% endif %}</td>
          <td>{{ (r.fill_rate if r.fill_rate is not none else 0)|fmt_percent }}</td>
          <td>{{ (r.profit_total if r.profit_total is not none else 0)|fmt_number }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="pager" class="toolbar gap-top-sm">
    <button id="first-page" type="button" class="secondary" aria-label="Go to first page">First</button>
    <button id="prev-page" type="button" class="secondary" aria-label="Go to previous page">Prev</button>
    <button id="next-page" type="button" class="secondary" aria-label="Go to next page">Next</button>
    <button id="last-page" type="button" class="secondary" aria-label="Go to last page">Last</button>
    <span class="mono">Page</span>
    <input id="page-number" class="input-compact-sm" type="number" min="1" value="1" />
    <span class="mono">/ <span id="page-total">1</span></span>
    <label>Limit
      <select id="limit-select">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </label>
    <span id="pager-info" class="mono"></span>
  </div>
  <div id="bulk-actions" class="toolbar gap-top-sm">
    <button id="delete-selected" type="button" class="contrast" aria-label="Delete selected runs">Delete selected</button>
  </div>
  <div id="filters" class="toolbar gap-top-sm">
    <label>Sort
      <select id="sort-select">
        <option value="started_at" selected>started_at</option>
        <option value="duration_ms">duration_ms</option>
        <option value="schema_version">schema_version</option>
      </select>
    </label>
    <label>Order
      <select id="order-select">
        <option value="desc" selected>desc</option>
        <option value="asc">asc</option>
      </select>
    </label>
    <label>Schema
      <input id="schema-filter" class="input-compact-sm" type="text" placeholder="1.0" />
    </label>
    <label>Config ID
      <input id="config-filter" class="input-compact-sm" type="number" min="1" />
    </label>
    <label>Config Version
      <input id="config-version-filter" class="input-compact-sm" type="number" min="1" />
    </label>
    <label>Scenario ID
      <input id="scenario-filter" class="input-compact-sm" type="number" min="1" />
    </label>
    <label><input id="hide-archived" type="checkbox" checked> Hide archived</label>
    <button id="apply-filter" type="button" class="secondary" aria-label="Apply filters">Apply</button>
    <button id="clear-filter" type="button" class="secondary" aria-label="Clear filters">Clear</button>
  </div>
  <div id="saved-views" class="toolbar gap-top-sm align-end">
    <label>Saved views
      <select id="views-select">
        <option value="">(select)</option>
      </select>
    </label>
    <button id="apply-view" type="button" class="secondary" aria-label="Apply saved view">Apply view</button>
    <button id="delete-view" type="button" aria-label="Delete saved view">Delete view</button>
    <label>Name
      <input id="view-name" type="text" placeholder="Current S&OP focus" />
    </label>
    <button id="save-view" type="button" aria-label="Save current filters as view">Save current as view</button>
    <button id="copy-link" type="button" class="secondary" aria-label="Copy permalink for current filters">Copy link</button>
    <span class="mono">|</span>
    <label>Server views
      <select id="views-select-server">
        <option value="">(select)</option>
      </select>
    </label>
    <button id="apply-view-server" type="button" class="secondary" aria-label="Apply shared server view">Apply server view</button>
    <label><input id="server-view-shared" type="checkbox"> shared</label>
    <label>Scope
      <select id="server-view-scope">
        <option value="private" selected>private</option>
        <option value="org">org</option>
        <option value="public">public</option>
      </select>
    </label>
    <label>Name
      <input id="view-name-server" type="text" placeholder="Shared view name" />
    </label>
    <button id="save-view-server" type="button" aria-label="Save current filters to server">Save to server</button>
  </div>
  {% else %}
  <p>No runs yet. Call <code>/simulation</code> to generate.</p>
  {% endif %}
</section>
<section class="page-section">
  <div class="section-header gap-bottom-sm">
    <h3>Compare Runs</h3>
    <p>Select one or more run IDs to compute comparative views.</p>
  </div>
  <form method="post" action="/ui/compare" id="compare-form">
    <label>Run IDs (comma-separated)
      <input id="run-ids" class="mono" type="text" name="run_ids" placeholder="id1,id2" required />
    </label>
    <small class="help-text">Use the buttons below to populate the field from your current selections.</small>
    <div class="toolbar gap-top-sm">
      <button id="use-selected" type="button" class="secondary" aria-label="Populate with selected runs">Use selected</button>
      <button type="submit" aria-label="Submit comparison">Compare</button>
      <button id="compare-selected" type="button" class="contrast" aria-label="Compare selected runs">Compare selected</button>
    </div>
  </form>
</section>
{% endblock %}

{% block scripts %}
<script src="/static/js/runs_ui.js"></script>
<script>
(function(){
  function fallbackFormat(scope){
    var root = scope || document;
    root.querySelectorAll('td.ts-ms').forEach(function(td){
      var raw = td.getAttribute('data-ms');
      var txt = '';
      if (raw) {
        var n = Number(raw);
        if (!Number.isFinite(n)) {
          var parsed = Date.parse(raw);
          if (Number.isFinite(parsed)) n = parsed;
        }
        if (Number.isFinite(n)) {
          if (n < 1e12) n = n * 1000;
          var t = new Date(n + 9*3600*1000);
          var y = t.getUTCFullYear();
          var mo = String(t.getUTCMonth()+1).padStart(2,'0');
          var d = String(t.getUTCDate()).padStart(2,'0');
          var h = String(t.getUTCHours()).padStart(2,'0');
          var mi = String(t.getUTCMinutes()).padStart(2,'0');
          var s = String(t.getUTCSeconds()).padStart(2,'0');
          txt = y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s+' JST';
        }
      }
      if (!txt) {
        txt = td.textContent || '';
      }
      if (txt) td.textContent = txt;
    });
  }

  var formatter = (window.RunsUI && typeof window.RunsUI.formatTimestamps === 'function')
    ? window.RunsUI.formatTimestamps
    : fallbackFormat;

  formatter(document);
  // Initialize metadata (total/offset/limit) from API when the page loads
  if (window.RunsUI && typeof window.RunsUI.init === 'function') {
    window.RunsUI.init();
  }
  // Local saved views
  function loadViews(){
    let views = [];
    try { views = JSON.parse(localStorage.getItem('runs_views')||'[]'); } catch {}
    const sel = document.getElementById('views-select');
    if (!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="">(select)</option>' + views.map((v,i)=>`<option value="${i}">${v.name}</option>`).join('');
    if (cur) sel.value = cur;
  }
  function getState(){ try { return JSON.parse(localStorage.getItem('runs_prefs')||'{}') } catch { return {} } }
  function setState(s){ try { localStorage.setItem('runs_prefs', JSON.stringify(s)); } catch {} }
  document.getElementById('save-view')?.addEventListener('click', function(){
    const name = (document.getElementById('view-name')?.value || '').trim();
    if (!name) { alert('Please enter a name.'); return; }
    const s = getState();
    const rec = { name, params: s };
    let views = [];
    try { views = JSON.parse(localStorage.getItem('runs_views')||'[]'); } catch {}
    views.push(rec);
    try { localStorage.setItem('runs_views', JSON.stringify(views)); } catch {}
    loadViews();
    alert('Saved.');
  });
  document.getElementById('apply-view')?.addEventListener('click', function(){
    const sel = document.getElementById('views-select');
    const idx = Number(sel?.value||'');
    let views = [];
    try { views = JSON.parse(localStorage.getItem('runs_views')||'[]'); } catch {}
    if (!Number.isFinite(idx) || idx<0 || idx>=views.length) { alert('Select a saved view.'); return; }
    const p = views[idx].params || {};
    const s = getState();
    const merged = { ...s, ...p };
    setState(merged);
    // No need to rehydrate the form; reload the page to apply stored preferences.
    location.href = '/ui/runs';
  });
  document.getElementById('delete-view')?.addEventListener('click', function(){
    const sel = document.getElementById('views-select');
    const idx = Number(sel?.value||'');
    let views = [];
    try { views = JSON.parse(localStorage.getItem('runs_views')||'[]'); } catch {}
    if (!Number.isFinite(idx) || idx<0 || idx>=views.length) { alert('Select a saved view.'); return; }
    views.splice(idx,1);
    try { localStorage.setItem('runs_views', JSON.stringify(views)); } catch {}
    loadViews();
  });
  document.getElementById('copy-link')?.addEventListener('click', function(){
    try { navigator.clipboard.writeText(location.href); alert('Copied URL.'); } catch { alert('Copy failed.'); }
  });
  loadViews();
  // Server-side views
  async function loadServerViews(){
    try {
      const res = await fetch('/views', { headers: getHeaders() });
      if (!res.ok) return;
      const js = await res.json();
      const sel = document.getElementById('views-select-server');
      if (!sel) return;
      const rows = js.views || [];
      sel.innerHTML = '<option value="">(select)</option>' + rows.map(v=>`<option value="${v.id}">${v.name}${v.shared?' (shared)':''}</option>`).join('');
      sel.setAttribute('data-views', JSON.stringify(rows));
    } catch {}
  }
  document.getElementById('apply-view-server')?.addEventListener('click', function(){
    const sel = document.getElementById('views-select-server');
    const id = Number(sel?.value||'');
    if (!Number.isFinite(id) || id<=0) { alert('Select a server view.'); return; }
    try {
      const rows = JSON.parse(sel.getAttribute('data-views')||'[]');
      const v = rows.find(x=>x.id===id);
      if (!v) { alert('View not found.'); return; }
      const merged = { ...getState(), ...(v.filters||{}) };
      setState(merged);
      location.href = '/ui/runs';
    } catch { alert('Failed to apply view.'); }
  });
  document.getElementById('save-view-server')?.addEventListener('click', async function(){
    const name = (document.getElementById('view-name-server')?.value||'').trim();
    if (!name) { alert('Please enter a name.'); return; }
    const shared = !!document.getElementById('server-view-shared')?.checked;
    const scope = (document.getElementById('server-view-scope')?.value||'private');
    const filters = getState();
    try {
      const res = await fetch('/views', { method:'POST', headers: { ...getHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ name, shared, scope, filters }) });
      if (!res.ok) throw new Error('HTTP '+res.status);
      await loadServerViews();
      alert('Saved to server.');
    } catch(e) { console.error(e); alert('Save failed.'); }
  });
  function getHeaders(){
    const h = {};
    try { const k = localStorage.getItem('api_key') || ''; if (k) h['X-API-Key'] = k; } catch {}
    try { const u = localStorage.getItem('user_email') || ''; if (u) h['X-User'] = u; } catch {}
    try { const r = localStorage.getItem('user_role') || ''; if (r) h['X-Role'] = r; } catch {}
    return h;
  }
  loadServerViews();

})();
</script>
{% endblock %}
