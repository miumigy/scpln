{% extends "base.html" %}
{% block content %}
<section>
  <h2>Runs</h2>
  <p>
    <button id="reload-btn" type="button">Refresh from API</button>
  </p>
  {% if rows %}
  <table role="grid">
    <thead>
      <tr>
        <th></th>
        <th>run_id</th>
        <th>started_at</th>
        <th>dur(ms)</th>
        <th>schema</th>
        <th>fill_rate</th>
        <th>profit_total</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="runs-tbody">
      {% for r in rows %}
      <tr>
        <td><input class="pick" type="checkbox" value="{{ r.run_id }}" /></td>
        <td class="mono truncate" title="{{ r.run_id }}">{{ r.run_id }}</td>
        <td class="ts-ms" data-ms="{{ r.started_at }}">{{ r.started_at_str or r.started_at }}</td>
        <td>{{ r.duration_ms }}</td>
        <td>{{ r.schema_version }}</td>
        <td>{{ "%.3f"|format(r.fill_rate or 0) }}</td>
        <td>{{ "%.2f"|format(r.profit_total or 0) }}</td>
        <td>
          <a role="button" href="/ui/runs/{{ r.run_id }}">Detail</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>まだランはありません。/simulation を叩いて生成してください。</p>
  {% endif %}
</section>
<section>
  <h3>Compare</h3>
  <form method="post" action="/ui/compare" id="compare-form">
    <label>Run IDs (comma-separated)
      <input id="run-ids" class="mono" type="text" name="run_ids" placeholder="id1,id2" required />
    </label>
    <small>上のチェックボックス選択を反映するには「Use selected」を押下</small>
    <button id="use-selected" type="button" class="secondary">Use selected</button>
    <button type="submit">Compare</button>
  </form>
  </section>
{% endblock %}

{% block scripts %}
<script src="/static/js/runs_ui.js"></script>
<script>
(function(){
  function fmtJst(ms){
    var n = Number(ms);
    if (!Number.isFinite(n)) return '';
    var t = new Date(n + 9*3600*1000);
    var y = t.getUTCFullYear();
    var mo = String(t.getUTCMonth()+1).padStart(2,'0');
    var d = String(t.getUTCDate()).padStart(2,'0');
    var h = String(t.getUTCHours()).padStart(2,'0');
    var mi = String(t.getUTCMinutes()).padStart(2,'0');
    var s = String(t.getUTCSeconds()).padStart(2,'0');
    return y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s;
  }
  document.querySelectorAll('td.ts-ms').forEach(function(td){
    var ms = td.getAttribute('data-ms');
    var txt = fmtJst(ms);
    if (txt) td.textContent = txt;
  });
})();
</script>
{% endblock %}
