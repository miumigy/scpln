{% extends "base.html" %}
{% block content %}
<section>
  <h2>Runs</h2>
  <p>
    <button id="reload-btn" type="button" aria-label="APIから再読み込み">Refresh from API</button>
  </p>
  {% if rows %}
  <table role="grid">
    <thead>
      <tr>
        <th></th>
        <th>run_id</th>
        <th><button type="button" class="link" id="th-sort-started" title="Sort by started_at" aria-label="開始時刻で並び替え">started_at</button></th>
        <th><button type="button" class="link" id="th-sort-dur" title="Sort by duration_ms" aria-label="所要時間で並び替え">dur(ms)</button></th>
        <th><button type="button" class="link" id="th-sort-schema" title="Sort by schema_version" aria-label="スキーマで並び替え">schema</button></th>
        <th>config_id</th>
        <th>scenario_id</th>
        <th>fill_rate</th>
        <th>profit_total</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="runs-tbody">
      {% for r in rows %}
      <tr>
        <td><input class="pick" type="checkbox" value="{{ r.run_id }}" /></td>
        <td class="mono truncate" title="{{ r.run_id }}">{{ r.run_id }}</td>
        <td class="ts-ms" data-ms="{{ r.started_at }}">{{ r.started_at_str or r.started_at }}</td>
        <td>{{ r.duration_ms }}</td>
        <td>{{ r.schema_version }}</td>
        <td>{{ r.config_id or '' }}</td>
        <td>{{ r.scenario_id or '' }}</td>
        <td>{{ "%.3f"|format(r.fill_rate or 0) }}</td>
        <td>{{ "%.2f"|format(r.profit_total or 0) }}</td>
        <td>
          <a role="button" href="/ui/runs/{{ r.run_id }}">Detail</a>
          
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div id="pager" style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <button id="first-page" type="button" class="secondary" aria-label="最初のページへ">First</button>
    <button id="prev-page" type="button" class="secondary" aria-label="前のページへ">Prev</button>
    <button id="next-page" type="button" class="secondary" aria-label="次のページへ">Next</button>
    <button id="last-page" type="button" class="secondary" aria-label="最後のページへ">Last</button>
    <span class="mono">Page</span>
    <input id="page-number" type="number" min="1" value="1" style="width:5em" />
    <span class="mono">/ <span id="page-total">1</span></span>
    <label>Limit
      <select id="limit-select">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </label>
    <span id="pager-info" class="mono"></span>
  </div>
  <div id="bulk-actions" style="margin-top:8px; display:flex; gap:8px; align-items:center;">
    <button id="delete-selected" type="button" class="contrast" aria-label="選択したランを削除">Delete selected</button>
  </div>
  <div id="filters" style="margin-top:8px; display:flex; gap:8px; align-items:center;">
    <label>Sort
      <select id="sort-select">
        <option value="started_at" selected>started_at</option>
        <option value="duration_ms">duration_ms</option>
        <option value="schema_version">schema_version</option>
      </select>
    </label>
    <label>Order
      <select id="order-select">
        <option value="desc" selected>desc</option>
        <option value="asc">asc</option>
      </select>
    </label>
    <label>Schema
      <input id="schema-filter" type="text" placeholder="1.0" size="6" />
    </label>
    <label>Config ID
      <input id="config-filter" type="number" placeholder="" min="1" style="width:7em" />
    </label>
    <label>Scenario ID
      <input id="scenario-filter" type="number" placeholder="" min="1" style="width:7em" />
    </label>
    <button id="apply-filter" type="button" class="secondary" aria-label="フィルタを適用">Apply</button>
    <button id="clear-filter" type="button" class="secondary" aria-label="フィルタをクリア">Clear</button>
  </div>
  {% else %}
    <p>まだランはありません。/simulation を叩いて生成してください。</p>
  {% endif %}
</section>
<section>
  <h3>Compare</h3>
  <form method="post" action="/ui/compare" id="compare-form">
    <label>Run IDs (comma-separated)
      <input id="run-ids" class="mono" type="text" name="run_ids" placeholder="id1,id2" required />
    </label>
    <small>上のチェックボックス選択を反映するには「Use selected」を押下</small>
    <button id="use-selected" type="button" class="secondary" aria-label="選択したランを使用">Use selected</button>
    <button type="submit" aria-label="比較を実行">Compare</button>
    <button id="compare-selected" type="button" class="contrast" aria-label="選択したランを比較">Compare selected</button>
  </form>
  </section>
{% endblock %}

{% block scripts %}
<script src="/static/js/runs_ui.js"></script>
<script>
(function(){
  function fmtJst(ms){
    var n = Number(ms);
    if (!Number.isFinite(n)) return '';
    var t = new Date(n + 9*3600*1000);
    var y = t.getUTCFullYear();
    var mo = String(t.getUTCMonth()+1).padStart(2,'0');
    var d = String(t.getUTCDate()).padStart(2,'0');
    var h = String(t.getUTCHours()).padStart(2,'0');
    var mi = String(t.getUTCMinutes()).padStart(2,'0');
    var s = String(t.getUTCSeconds()).padStart(2,'0');
    return y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s;
  }
  document.querySelectorAll('td.ts-ms').forEach(function(td){
    var ms = td.getAttribute('data-ms');
    var txt = fmtJst(ms);
    if (txt) td.textContent = txt;
  });
  // 初期ロード時にAPIからメタ情報(total/offset/limit)を取得してページャを更新
  if (window.RunsUI && typeof window.RunsUI.init === 'function') {
    window.RunsUI.init();
  }
})();
</script>
{% endblock %}
