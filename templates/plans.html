{% extends "base.html" %}
{% block content %}
<section>
  <h2>プランバージョン一覧</h2>
  <details open>
    <summary>新規Plan作成（統合Run）</summary>
    <form method="post" action="/ui/plans/run">
      <div class="grid" style="align-items:end;">
        <label>input_dir<input type="text" name="input_dir" value="samples/planning"></label>
        <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
        <label>lt_unit
          <select name="lt_unit">
            <option value="day" selected>day</option>
            <option value="week">week</option>
          </select>
        </label>
        <label>cutover_date<input type="date" name="cutover_date" value=""></label>
        <label>recon_window_days<input type="number" name="recon_window_days" min="0" value=""></label>
        <label>anchor_policy
          <select name="anchor_policy">
            <option value="">(未指定)</option>
            <option value="DET_near">DET_near</option>
            <option value="AGG_far">AGG_far</option>
            <option value="blend">blend</option>
          </select>
        </label>
        <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="既定=1e-6" value=""></label>
        <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="既定=1e-6" value=""></label>
        <label>calendar_mode
          <select name="calendar_mode">
            <option value="">(未指定)</option>
            <option value="simple">simple</option>
            <option value="iso">iso</option>
          </select>
        </label>
        <label>carryover
          <select name="carryover">
            <option value="">(未指定)</option>
            <option value="auto">auto</option>
            <option value="prev">prev</option>
            <option value="next">next</option>
            <option value="both">both</option>
          </select>
        </label>
        <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split" value=""></label>
        <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
      </div>
      <button type="submit" aria-label="新規Planを作成して実行">Run（作成）</button>
      <p class="mono">参考: 従来の実行は <a href="/ui/planning" target="_blank">/ui/planning</a></p>
    </form>
  </details>

  <div style="display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap;">
    <input id="q" type="search" placeholder="検索（version/status/policy）" aria-label="検索（version/status/policy）" />
    <small class="mono" id="meta"></small>
    <span class="mono" style="margin-left:8px;">並び: 
      <label style="margin:0 4px;">主
        <select id="sortPKey" aria-label="主キーの並び替え対象">
          <option value="created_at">created_at</option>
          <option value="status">status</option>
          <option value="violations">violations</option>
          <option value="policy">policy</option>
          <option value="cutover">cutover</option>
        </select>
      </label>
      <select id="sortPDir" aria-label="主キーの並び順">
        <option value="desc">desc</option>
        <option value="asc">asc</option>
      </select>
      ｜ <label style="margin:0 4px;">副
        <select id="sortSKey" aria-label="副キーの並び替え対象">
          <option value="">(なし)</option>
          <option value="created_at">created_at</option>
          <option value="status">status</option>
          <option value="violations">violations</option>
          <option value="policy">policy</option>
          <option value="cutover">cutover</option>
        </select>
      </label>
      <select id="sortSDir" aria-label="副キーの並び順">
        <option value="desc">desc</option>
        <option value="asc">asc</option>
      </select>
    </span>
    <small class="mono" id="sortBadge"></small>
  </div>
  {% if plans and plans|length > 0 %}
  <div style="overflow-x:auto;">
  <table id="tblPlans" style="table-layout:auto; min-width:960px;">
    <thead>
      <tr>
        <th>version_id</th>
        <th data-sort="status" title="クリックで並び替え">status</th>
        <th data-sort="cutover" title="クリックで並び替え">cutover</th>
        <th>window</th>
        <th data-sort="policy" title="クリックで並び替え">policy</th>
        <th data-sort="created_at" title="クリックで並び替え">created_at</th>
        <th data-sort="violations" title="クリックで並び替え">violations</th>
        <th>max|Δ| (d/s/b)</th>
        <th>API</th>
      </tr>
    </thead>
    <tbody>
      {% for p in plans %}
      <tr>
        <td class="mono"><a class="truncate" style="max-width:240px; display:inline-block;" href="/ui/plans/{{ p.version_id }}" title="{{ p.version_id }}">{{ p.version_id }}</a></td>
        <td>{{ p.status or '' }}</td>
        <td class="mono">{{ p.cutover_date or '' }}</td>
        <td class="mono">{{ p.recon_window_days if p.recon_window_days is not none else 0 }}</td>
        <td class="mono">{{ p.policy or '(none)' }}</td>
        <td class="mono ts-ms" data-ms="{{ p.created_at }}">{{ p.created_at }}</td>
        <td class="mono">{{ (p.recon_summary.violations or p.recon_summary.tol_violations) if p.recon_summary else '' }}</td>
        <td class="mono">
          {% if p.recon_summary and p.recon_summary.max_abs_delta %}
            ({{ p.recon_summary.max_abs_delta.demand }}, {{ p.recon_summary.max_abs_delta.supply }}, {{ p.recon_summary.max_abs_delta.backlog }})
          {% endif %}
        </td>
        <td>
          <a class="secondary" href="/plans/{{ p.version_id }}/summary" target="_blank">summary</a>
          <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/summary" title="URLをコピー" aria-label="URLをコピー">copy</button>
          <a class="secondary" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=100" target="_blank">compare</a>
          <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=100" title="URLをコピー" aria-label="URLをコピー">copy</button>
          <a class="secondary" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=abs_desc&limit=200" target="_blank">violations</a>
          <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=abs_desc&limit=200" title="URLをコピー" aria-label="URLをコピー">copy</button>
          <button type="button" class="secondary copy-all" data-version="{{ p.version_id }}" title="summary/compare/violations をまとめてコピー" aria-label="リンクを一括コピー">copy all</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  {% else %}
  <p>まだプランがありません。/ui/planning から実行するか、/plans/integrated/run を呼び出してください。</p>
  {% endif %}
</section>
{% endblock %}
{% block scripts %}
<script>
// JSTフォーマット（ms epoch → YYYY/MM/DD HH:mm:ss）
function fmtJst(ms){
  var n = Number(ms);
  if (!Number.isFinite(n)) return '';
  var t = new Date(n + 9*3600*1000); // JSTへシフトしUTC系getterで整形
  var y = t.getUTCFullYear();
  var mo = String(t.getUTCMonth()+1).padStart(2,'0');
  var d = String(t.getUTCDate()).padStart(2,'0');
  var h = String(t.getUTCHours()).padStart(2,'0');
  var mi = String(t.getUTCMinutes()).padStart(2,'0');
  var s = String(t.getUTCSeconds()).padStart(2,'0');
  return y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s;
}
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('td.ts-ms').forEach(function(td){
    var ms = td.getAttribute('data-ms');
    var txt = fmtJst(ms);
    if (txt) td.textContent = txt;
  });
  var q = document.getElementById('q');
  var meta = document.getElementById('meta');
  var rows = Array.from(document.querySelectorAll('tbody tr'));
  var sortBadge = document.getElementById('sortBadge');
  // 検索フィルタの永続化（localStorage）
  var KEY_Q = 'ui_plans_query';
  try {
    var saved = localStorage.getItem(KEY_Q);
    if (q && saved && typeof saved === 'string') { q.value = saved; }
  } catch(e) {}
  function apply(){
    var s = (q && q.value || '').toLowerCase().trim();
    var vis = 0;
    rows.forEach(function(tr){
      var txt = tr.textContent.toLowerCase();
      var ok = !s || txt.indexOf(s) >= 0;
      tr.style.display = ok ? '' : 'none';
      if (ok) vis++;
    });
    if (meta) meta.textContent = vis + ' / ' + rows.length;
    try { localStorage.setItem(KEY_Q, s); } catch(e) {}
  }
  if (q) {
    q.addEventListener('input', apply);
    apply();
  }
  // URLコピー（クリックでlocation.origin + data-href をコピー）
  function copyUrl(href){
    var abs = (location && location.origin ? location.origin : '') + href;
    if (navigator && navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(abs).catch(function(){});
    } else {
      var ta = document.createElement('textarea'); ta.value = abs; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
    }
  }
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if (t && t.classList && t.classList.contains('copy')){
      var href = t.getAttribute('data-href');
      if (href) { copyUrl(href); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy'; }, 1200); }
    }
  });

  // 簡易ソート（status/created_at/violations）
  var KEY_SORT = 'ui_plans_sort';
  var KEY_SORT2 = 'ui_plans_sort2';
  function updateSortBadge(pkey, pdir, skey, sdir){
    if (!sortBadge) return;
    var txt = 'Sort: ' + (pkey||'-') + ' ' + (pdir||'-');
    if (skey) txt += ' ｜ Secondary: ' + skey + ' ' + (sdir||'-');
    sortBadge.textContent = txt;
  }
  function getCellValue(tr, idx){ var el = tr.children[idx]; return el ? el.textContent.trim() : ''; }
  function toNum(s){ var n = parseFloat(s.replace(/[^0-9.\-]/g,'')); return isNaN(n)? null : n; }
  function cmp(a,b){ return a<b ? -1 : a>b ? 1 : 0; }
  function applySort(key, dir){
    var table = document.getElementById('tblPlans');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    var rowsArr = Array.from(tbody.querySelectorAll('tr'));
    // 列インデックス: 0:id 1:status 2:cutover 3:window 4:policy 5:created_at 6:violations 7:maxΔ 8:API
    var colIdx = {status:1, cutover:2, policy:4, created_at:5, violations:6}[key];
    if (colIdx == null) return;
    rowsArr.sort(function(ra, rb){
      var va = getCellValue(ra, colIdx);
      var vb = getCellValue(rb, colIdx);
      if (key === 'created_at' || key === 'cutover'){
        // 日付文字列はDateに
        var da = Date.parse(va.replace(/\//g,'-')) || 0;
        var db = Date.parse(vb.replace(/\//g,'-')) || 0;
        return dir==='asc'? (da-db):(db-da);
      }
      var na = toNum(va); var nb = toNum(vb);
      if (na!=null && nb!=null) return dir==='asc'? (na-nb):(nb-na);
      return dir==='asc'? cmp(va,vb): cmp(vb,va);
    });
    rowsArr.forEach(function(r){ tbody.appendChild(r); });
    // ヘッダ装飾
    document.querySelectorAll('th[data-sort]').forEach(function(th){ th.classList.remove('active-sort'); });
    var th = document.querySelector('th[data-sort="'+key+'"]'); if (th) th.classList.add('active-sort');
    try { localStorage.setItem(KEY_SORT, JSON.stringify({key:key, dir:dir})); } catch(e) {}
  }
  function compareByKey(ra, rb, key, dir){
    var colIdx = {status:1, cutover:2, policy:4, created_at:5, violations:6}[key];
    if (colIdx == null) return 0;
    var va = getCellValue(ra, colIdx);
    var vb = getCellValue(rb, colIdx);
    if (key === 'created_at' || key === 'cutover'){
      var da = Date.parse(va.replace(/\//g,'-')) || 0;
      var db = Date.parse(vb.replace(/\//g,'-')) || 0;
      return dir==='asc'? (da-db):(db-da);
    }
    var na = toNum(va); var nb = toNum(vb);
    if (na!=null && nb!=null) return dir==='asc'? (na-nb):(nb-na);
    return dir==='asc'? cmp(va,vb): cmp(vb,va);
  }
  function applySort2(pkey, pdir, skey, sdir){
    var table = document.getElementById('tblPlans');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    var rowsArr = Array.from(tbody.querySelectorAll('tr'));
    rowsArr.sort(function(ra, rb){
      var c1 = compareByKey(ra, rb, pkey, pdir);
      if (c1 !== 0) return c1;
      if (skey){
        var c2 = compareByKey(ra, rb, skey, sdir);
        if (c2 !== 0) return c2;
      }
      // 最終tie-breaker: version_id（文字列）
      var aId = getCellValue(ra, 0), bId = getCellValue(rb, 0);
      return cmp(aId, bId);
    });
    rowsArr.forEach(function(r){ tbody.appendChild(r); });
    try { localStorage.setItem(KEY_SORT2, JSON.stringify({pkey, pdir, skey, sdir})); } catch(e) {}
  }
  function initSort(){
    var s2 = null; try { s2 = JSON.parse(localStorage.getItem(KEY_SORT2)||'null'); }catch(e){}
    var saved = null; try { saved = JSON.parse(localStorage.getItem(KEY_SORT)||'null'); }catch(e){}
    var pkey = (s2 && s2.pkey) || (saved && saved.key) || 'created_at';
    var pdir = (s2 && s2.pdir) || (saved && saved.dir) || 'desc';
    var skey = (s2 && s2.skey) || '';
    var sdir = (s2 && s2.sdir) || 'desc';
    // UI反映
    var pk = document.getElementById('sortPKey'); if (pk) pk.value = pkey;
    var pd = document.getElementById('sortPDir'); if (pd) pd.value = pdir;
    var sk = document.getElementById('sortSKey'); if (sk) sk.value = skey || '';
    var sd = document.getElementById('sortSDir'); if (sd) sd.value = sdir;
    applySort2(pkey, pdir, skey, sdir);
    updateSortBadge(pkey, pdir, skey, sdir);
  }
  document.querySelectorAll('th[data-sort]').forEach(function(th){
    th.style.cursor = 'pointer';
    th.addEventListener('click', function(){
      var key = th.getAttribute('data-sort');
      var saved = null; try { saved = JSON.parse(localStorage.getItem(KEY_SORT)||'null'); }catch(e){}
      var dir = (saved && saved.key===key && saved.dir==='asc') ? 'desc' : 'asc';
      applySort(key, dir);
    });
  });
  initSort();

  // 複合ソートUIのイベント
  function onSort2Change(){
    var pk = document.getElementById('sortPKey');
    var pd = document.getElementById('sortPDir');
    var sk = document.getElementById('sortSKey');
    var sd = document.getElementById('sortSDir');
    var pkey = pk ? pk.value : 'created_at';
    var pdir = pd ? pd.value : 'desc';
    var skey = sk ? sk.value : '';
    var sdir = sd ? sd.value : 'desc';
    applySort2(pkey, pdir, skey, sdir);
    updateSortBadge(pkey, pdir, skey, sdir);
  }
  ['sortPKey','sortPDir','sortSKey','sortSDir'].forEach(function(id){ var el = document.getElementById(id); if (el) el.addEventListener('change', onSort2Change); });

  // 一括コピー: summary/compare(rel)/violations(abs)
  function copyAllLinks(ver){
    var origin = (location && location.origin) ? location.origin : '';
    var urls = [
      origin + '/plans/' + ver + '/summary',
      origin + '/plans/' + ver + '/compare?violations_only=true&sort=rel_desc&limit=100',
      origin + '/plans/' + ver + '/compare?violations_only=true&sort=abs_desc&limit=200'
    ];
    var txt = urls.join('\n');
    if (navigator && navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).catch(function(){});
    } else {
      var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
    }
  }
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if (t && t.classList && t.classList.contains('copy-all')){
      var ver = t.getAttribute('data-version');
      if (ver){ copyAllLinks(ver); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy all'; }, 1200); }
    }
  });
});
</script>
{% endblock %}