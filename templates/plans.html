{% extends "base.html" %}
{% block page_header %}
  <h2>Planning Hub</h2>
  <p>Create, review, and reconcile plan versions generated by the integrated pipeline.</p>
{% endblock %}
{% block content %}
<section class="page-section">
  <div class="section-header">
    <h3>Integrated Planning Run</h3>
    <p>Launch an end-to-end planning cycle using the configured pipeline defaults.</p>
  </div>
  <details open>
    <summary>Create Plan Version (Integrated Run)</summary>
    <form method="post" action="/ui/plans/run">
      <div class="form-grid">
        <label>
          <span class="label-title">Input Directory</span>
          <input type="text" name="input_dir" value="samples/planning" />
        </label>
        <label>
          <span class="label-title">Weeks</span>
          <input type="number" name="weeks" min="1" value="4" />
        </label>
        <label>
          <span class="label-title">Lead Time Unit</span>
          <select name="lt_unit">
            <option value="day" selected>Day</option>
            <option value="week">Week</option>
          </select>
        </label>
        <label>
          <span class="label-title">Cutover Date</span>
          <input type="date" name="cutover_date" value="" />
        </label>
        <label>
          <span class="label-title">Reconciliation Window (days)</span>
          <input type="number" name="recon_window_days" min="0" value="" />
        </label>
        <label>
          <span class="label-title">Anchor Policy</span>
          <select name="anchor_policy">
            <option value="">Unspecified</option>
            <option value="DET_near">DET_near</option>
            <option value="AGG_far">AGG_far</option>
            <option value="blend">Blend</option>
          </select>
        </label>
        <label>
          <span class="label-title">Tol Abs</span>
          <input type="number" step="0.000001" name="tol_abs" placeholder="default 1e-6" value="" />
        </label>
        <label>
          <span class="label-title">Tol Rel</span>
          <input type="number" step="0.000001" name="tol_rel" placeholder="default 1e-6" value="" />
        </label>
        <label>
          <span class="label-title">Calendar Mode</span>
          <select name="calendar_mode">
            <option value="">Unspecified</option>
            <option value="simple">Simple</option>
            <option value="iso">ISO Week</option>
          </select>
        </label>
        <label>
          <span class="label-title">Carryover Mode</span>
          <select name="carryover">
            <option value="">Unspecified</option>
            <option value="auto">Auto</option>
            <option value="prev">Use Previous</option>
            <option value="next">Use Next</option>
            <option value="both">Blend</option>
          </select>
        </label>
        <label>
          <span class="label-title">Carryover Split</span>
          <input type="number" min="0" max="1" step="0.05" name="carryover_split" value="" />
        </label>
        <label>
          <span class="label-title">Apply Adjusted Output</span>
          <select name="apply_adjusted">
            <option value="">No</option>
            <option value="1">Yes</option>
          </select>
        </label>
      </div>
      <div class="toolbar justify-end gap-top-sm">
        <button type="submit" class="btn-primary" aria-label="Run integrated pipeline">Run Integrated Pipeline</button>
      </div>
    </form>
  </details>
</section>

<section class="page-section">
  <div class="section-header">
    <h3>Plan Versions</h3>
    <p>Filter, inspect, and compare generated versions to reconcile PSI outcomes.</p>
  </div>
  <div class="toolbar gap-bottom-sm">
    <input id="q" type="search" placeholder="Search by version, status, policy" aria-label="Search plan versions" />
    <small class="mono pill" id="meta"></small>
    <div class="toolbar">
      <label class="mono">
        <span class="label-title label-title-inline">Primary Sort</span>
        <select id="sortPKey" aria-label="Primary sort key">
          <option value="created_at">created_at</option>
          <option value="status">status</option>
          <option value="violations">violations</option>
          <option value="policy">policy</option>
          <option value="cutover">cutover</option>
        </select>
      </label>
      <select id="sortPDir" aria-label="Primary sort direction">
        <option value="desc">desc</option>
        <option value="asc">asc</option>
      </select>
      <label class="mono">
        <span class="label-title label-title-inline">Secondary Sort</span>
        <select id="sortSKey" aria-label="Secondary sort key">
          <option value="">(none)</option>
          <option value="created_at">created_at</option>
          <option value="status">status</option>
          <option value="violations">violations</option>
          <option value="policy">policy</option>
          <option value="cutover">cutover</option>
        </select>
      </label>
      <select id="sortSDir" aria-label="Secondary sort direction">
        <option value="desc">desc</option>
        <option value="asc">asc</option>
      </select>
    </div>
    <small class="mono pill" id="sortBadge"></small>
  </div>

  {% if plans and plans|length > 0 %}
  <div class="table-wrapper">
    <table id="tblPlans">
        <thead>
          <tr>
            <th>Version</th>
            <th data-sort="status" title="Sort by status">Status</th>
            <th data-sort="cutover" title="Sort by cutover">Cutover</th>
            <th>Window (days)</th>
            <th data-sort="policy" title="Sort by policy">Policy</th>
            <th data-sort="created_at" title="Sort by created at">Created</th>
            <th data-sort="violations" title="Sort by violations">Violations</th>
            <th>Max Δ (d/s/b)</th>
            <th>Shortcuts</th>
          </tr>
        </thead>
        <tbody>
          {% for p in plans %}
          <tr>
            <td class="mono"><a class="truncate link-truncate" href="/ui/plans/{{ p.version_id }}" title="{{ p.version_id }}">{{ p.version_id }}</a></td>
            <td>{{ p.status or '' }}</td>
            <td class="mono">{{ p.cutover_date or '' }}</td>
            <td class="mono">{{ p.recon_window_days if p.recon_window_days is not none else 0 }}</td>
            <td class="mono">{{ p.policy or '(none)' }}</td>
            <td class="mono ts-ms" data-ms="{{ p.created_at }}">{{ p.created_at }}</td>
            <td class="mono">{{ (p.recon_summary.violations or p.recon_summary.tol_violations) if p.recon_summary else '' }}</td>
            <td class="mono">
              {% if p.recon_summary and p.recon_summary.max_abs_delta %}
                ({{ p.recon_summary.max_abs_delta.demand }}, {{ p.recon_summary.max_abs_delta.supply }}, {{ p.recon_summary.max_abs_delta.backlog }})
              {% endif %}
            </td>
            <td class="table-actions">
              <div class="shortcut-group">
                <a class="btn-link" href="/plans/{{ p.version_id }}/summary" target="_blank">Summary</a>
                <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/summary" aria-label="Copy summary URL">Copy</button>
              </div>
              <div class="shortcut-group">
                <a class="btn-link" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=100" target="_blank">Compare</a>
                <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=100" aria-label="Copy compare URL">Copy</button>
              </div>
              <div class="shortcut-group">
                <a class="btn-link" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=abs_desc&limit=200" target="_blank">Violations</a>
                <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=abs_desc&limit=200" aria-label="Copy violations URL">Copy</button>
              </div>
              <button type="button" class="secondary copy-all" data-version="{{ p.version_id }}" aria-label="Copy all URLs">Copy All</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
    </table>
  </div>
  {% else %}
  <p class="section-description">No plans yet. Run the integrated pipeline above or call <code>POST /plans/integrated/run</code> via API.</p>
  {% endif %}
</section>
{% endblock %}
{% block scripts %}
<script>
// Format created_at timestamp (ms epoch → YYYY/MM/DD HH:mm:ss JST)
function fmtJst(ms){
  var n = Number(ms);
  if (!Number.isFinite(n)) return '';
  if (n < 1e12) n = n * 1000;
  var t = new Date(n + 9*3600*1000); // Shift to JST before formatting via UTC getters
  var y = t.getUTCFullYear();
  var mo = String(t.getUTCMonth()+1).padStart(2,'0');
  var d = String(t.getUTCDate()).padStart(2,'0');
  var h = String(t.getUTCHours()).padStart(2,'0');
  var mi = String(t.getUTCMinutes()).padStart(2,'0');
  var s = String(t.getUTCSeconds()).padStart(2,'0');
  return y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s+' JST';
}
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('td.ts-ms').forEach(function(td){
    var ms = td.getAttribute('data-ms');
    var txt = fmtJst(ms);
    if (txt) td.textContent = txt;
  });
  var q = document.getElementById('q');
  var meta = document.getElementById('meta');
  var rows = Array.from(document.querySelectorAll('tbody tr'));
  var sortBadge = document.getElementById('sortBadge');
  // Persist search filter in localStorage
  var KEY_Q = 'ui_plans_query';
  try {
    var saved = localStorage.getItem(KEY_Q);
    if (q && saved && typeof saved === 'string') { q.value = saved; }
  } catch(e) {}
  function apply(){
    var s = (q && q.value || '').toLowerCase().trim();
    var vis = 0;
    rows.forEach(function(tr){
      var txt = tr.textContent.toLowerCase();
      var ok = !s || txt.indexOf(s) >= 0;
      tr.style.display = ok ? '' : 'none';
      if (ok) vis++;
    });
    if (meta) meta.textContent = vis + ' / ' + rows.length;
    try { localStorage.setItem(KEY_Q, s); } catch(e) {}
  }
  if (q) {
    q.addEventListener('input', apply);
    apply();
  }
  // Copy plan links to the clipboard using location.origin + data-href
  function copyUrl(href){
    var abs = (location && location.origin ? location.origin : '') + href;
    if (navigator && navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(abs).catch(function(){});
    } else {
      var ta = document.createElement('textarea'); ta.value = abs; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
    }
  }
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if (t && t.classList && t.classList.contains('copy')){
      var href = t.getAttribute('data-href');
      if (href) { copyUrl(href); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy'; }, 1200); }
    }
  });

  // Quick sort for common columns (status/created_at/violations)
  var KEY_SORT = 'ui_plans_sort';
  var KEY_SORT2 = 'ui_plans_sort2';
  function updateSortBadge(pkey, pdir, skey, sdir){
    if (!sortBadge) return;
    var txt = 'Sort: ' + (pkey||'-') + ' ' + (pdir||'-');
    if (skey) txt += ' | Secondary: ' + skey + ' ' + (sdir||'-');
    sortBadge.textContent = txt;
  }
  function getCellValue(tr, idx){ var el = tr.children[idx]; return el ? el.textContent.trim() : ''; }
  function toNum(s){ var n = parseFloat(s.replace(/[^0-9.\-]/g,'')); return isNaN(n)? null : n; }
  function cmp(a,b){ return a<b ? -1 : a>b ? 1 : 0; }
  function applySort(key, dir){
    var table = document.getElementById('tblPlans');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    var rowsArr = Array.from(tbody.querySelectorAll('tr'));
    // Column index map: 0:version 1:status 2:cutover 3:window 4:policy 5:created_at 6:violations 7:maxΔ 8:shortcuts
    var colIdx = {status:1, cutover:2, policy:4, created_at:5, violations:6}[key];
    if (colIdx == null) return;
    rowsArr.sort(function(ra, rb){
      var va = getCellValue(ra, colIdx);
      var vb = getCellValue(rb, colIdx);
      if (key === 'created_at' || key === 'cutover'){
        // Parse date-like strings before comparing
        var da = Date.parse(va.replace(/\//g,'-')) || 0;
        var db = Date.parse(vb.replace(/\//g,'-')) || 0;
        return dir==='asc'? (da-db):(db-da);
      }
      var na = toNum(va); var nb = toNum(vb);
      if (na!=null && nb!=null) return dir==='asc'? (na-nb):(nb-na);
      return dir==='asc'? cmp(va,vb): cmp(vb,va);
    });
    rowsArr.forEach(function(r){ tbody.appendChild(r); });
    // Highlight active sort header
    document.querySelectorAll('th[data-sort]').forEach(function(th){ th.classList.remove('active-sort'); });
    var th = document.querySelector('th[data-sort="'+key+'"]'); if (th) th.classList.add('active-sort');
    try { localStorage.setItem(KEY_SORT, JSON.stringify({key:key, dir:dir})); } catch(e) {}
  }
  function compareByKey(ra, rb, key, dir){
    var colIdx = {status:1, cutover:2, policy:4, created_at:5, violations:6}[key];
    if (colIdx == null) return 0;
    var va = getCellValue(ra, colIdx);
    var vb = getCellValue(rb, colIdx);
    if (key === 'created_at' || key === 'cutover'){
      var da = Date.parse(va.replace(/\//g,'-')) || 0;
      var db = Date.parse(vb.replace(/\//g,'-')) || 0;
      return dir==='asc'? (da-db):(db-da);
    }
    var na = toNum(va); var nb = toNum(vb);
    if (na!=null && nb!=null) return dir==='asc'? (na-nb):(nb-na);
    return dir==='asc'? cmp(va,vb): cmp(vb,va);
  }
  function applySort2(pkey, pdir, skey, sdir){
    var table = document.getElementById('tblPlans');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    var rowsArr = Array.from(tbody.querySelectorAll('tr'));
    rowsArr.sort(function(ra, rb){
      var c1 = compareByKey(ra, rb, pkey, pdir);
      if (c1 !== 0) return c1;
      if (skey){
        var c2 = compareByKey(ra, rb, skey, sdir);
        if (c2 !== 0) return c2;
      }
      // Final tie-breaker: version_id (string)
      var aId = getCellValue(ra, 0), bId = getCellValue(rb, 0);
      return cmp(aId, bId);
    });
    rowsArr.forEach(function(r){ tbody.appendChild(r); });
    try { localStorage.setItem(KEY_SORT2, JSON.stringify({pkey, pdir, skey, sdir})); } catch(e) {}
  }
  function initSort(){
    var s2 = null; try { s2 = JSON.parse(localStorage.getItem(KEY_SORT2)||'null'); }catch(e){}
    var saved = null; try { saved = JSON.parse(localStorage.getItem(KEY_SORT)||'null'); }catch(e){}
    var pkey = (s2 && s2.pkey) || (saved && saved.key) || 'created_at';
    var pdir = (s2 && s2.pdir) || (saved && saved.dir) || 'desc';
    var skey = (s2 && s2.skey) || '';
    var sdir = (s2 && s2.sdir) || 'desc';
    // Reflect saved state in the UI
    var pk = document.getElementById('sortPKey'); if (pk) pk.value = pkey;
    var pd = document.getElementById('sortPDir'); if (pd) pd.value = pdir;
    var sk = document.getElementById('sortSKey'); if (sk) sk.value = skey || '';
    var sd = document.getElementById('sortSDir'); if (sd) sd.value = sdir;
    applySort2(pkey, pdir, skey, sdir);
    updateSortBadge(pkey, pdir, skey, sdir);
  }
  document.querySelectorAll('th[data-sort]').forEach(function(th){
    th.style.cursor = 'pointer';
    th.addEventListener('click', function(){
      var key = th.getAttribute('data-sort');
      var saved = null; try { saved = JSON.parse(localStorage.getItem(KEY_SORT)||'null'); }catch(e){}
      var dir = (saved && saved.key===key && saved.dir==='asc') ? 'desc' : 'asc';
      applySort(key, dir);
    });
  });
  initSort();

  // Wire up advanced sort controls
  function onSort2Change(){
    var pk = document.getElementById('sortPKey');
    var pd = document.getElementById('sortPDir');
    var sk = document.getElementById('sortSKey');
    var sd = document.getElementById('sortSDir');
    var pkey = pk ? pk.value : 'created_at';
    var pdir = pd ? pd.value : 'desc';
    var skey = sk ? sk.value : '';
    var sdir = sd ? sd.value : 'desc';
    applySort2(pkey, pdir, skey, sdir);
    updateSortBadge(pkey, pdir, skey, sdir);
  }
  ['sortPKey','sortPDir','sortSKey','sortSDir'].forEach(function(id){ var el = document.getElementById(id); if (el) el.addEventListener('change', onSort2Change); });

  // Support bulk copy actions for summary/compare/violations links
  function copyAllLinks(ver){
    var origin = (location && location.origin) ? location.origin : '';
    var urls = [
      origin + '/plans/' + ver + '/summary',
      origin + '/plans/' + ver + '/compare?violations_only=true&sort=rel_desc&limit=100',
      origin + '/plans/' + ver + '/compare?violations_only=true&sort=abs_desc&limit=200'
    ];
    var txt = urls.join('\n');
    if (navigator && navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).catch(function(){});
    } else {
      var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
    }
  }
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if (t && t.classList && t.classList.contains('copy-all')){
      var ver = t.getAttribute('data-version');
      if (ver){ copyAllLinks(ver); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy all'; }, 1200); }
    }
  });
});
</script>
{% endblock %}
