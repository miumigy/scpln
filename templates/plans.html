{% extends "base.html" %}
{% block content %}
<section>
  <h2>プランバージョン一覧</h2>
  {% if plans and plans|length > 0 %}
  <table>
    <thead>
      <tr>
        <th>version_id</th>
        <th>status</th>
        <th>cutover</th>
        <th>window</th>
        <th>policy</th>
        <th>created_at</th>
        <th>violations</th>
        <th>max|Δ| (d/s/b)</th>
        <th>API</th>
      </tr>
    </thead>
    <tbody>
      {% for p in plans %}
      <tr>
        <td class="mono"><a href="/ui/plans/{{ p.version_id }}">{{ p.version_id }}</a></td>
        <td>{{ p.status or '' }}</td>
        <td class="mono">{{ p.cutover_date or '' }}</td>
        <td class="mono">{{ p.recon_window_days if p.recon_window_days is not none else '' }}</td>
        <td class="mono">{{ p.policy if p.policy is not none else '' }}</td>
        <td class="mono ts-ms" data-ms="{{ p.created_at }}">{{ p.created_at }}</td>
        <td class="mono">{{ (p.recon_summary.violations or p.recon_summary.tol_violations) if p.recon_summary else '' }}</td>
        <td class="mono">
          {% if p.recon_summary and p.recon_summary.max_abs_delta %}
            ({{ p.recon_summary.max_abs_delta.demand }}, {{ p.recon_summary.max_abs_delta.supply }}, {{ p.recon_summary.max_abs_delta.backlog }})
          {% endif %}
        </td>
        <td>
          <a class="secondary" href="/plans/{{ p.version_id }}/summary" target="_blank">summary</a>
          <a class="secondary" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=100" target="_blank">compare</a>
          <a class="secondary" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=abs_desc&limit=200" target="_blank">violations</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>まだプランがありません。/ui/planning から実行するか、/plans/integrated/run を呼び出してください。</p>
  {% endif %}
</section>
{% endblock %}
{% block scripts %}
<script>
// JSTフォーマット（ms epoch → YYYY/MM/DD HH:mm:ss）
function fmtJst(ms){
  var n = Number(ms);
  if (!Number.isFinite(n)) return '';
  var t = new Date(n + 9*3600*1000); // JSTへシフトしUTC系getterで整形
  var y = t.getUTCFullYear();
  var mo = String(t.getUTCMonth()+1).padStart(2,'0');
  var d = String(t.getUTCDate()).padStart(2,'0');
  var h = String(t.getUTCHours()).padStart(2,'0');
  var mi = String(t.getUTCMinutes()).padStart(2,'0');
  var s = String(t.getUTCSeconds()).padStart(2,'0');
  return y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s;
}
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('td.ts-ms').forEach(function(td){
    var ms = td.getAttribute('data-ms');
    var txt = fmtJst(ms);
    if (txt) td.textContent = txt;
  });
});
</script>
{% endblock %}
