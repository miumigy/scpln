{% extends "base.html" %}
{% block content %}
<section>
  <h2>プランバージョン一覧</h2>
  <details open>
    <summary>新規Plan作成（統合Run）</summary>
    <form method="post" action="/ui/plans/run">
      <div class="grid" style="align-items:end;">
        <label>input_dir<input type="text" name="input_dir" value="samples/planning"></label>
        <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
        <label>lt_unit
          <select name="lt_unit">
            <option value="day" selected>day</option>
            <option value="week">week</option>
          </select>
        </label>
        <label>cutover_date<input type="date" name="cutover_date"></label>
        <label>recon_window_days<input type="number" name="recon_window_days" min="0"></label>
        <label>anchor_policy
          <select name="anchor_policy">
            <option value="">(未指定)</option>
            <option value="DET_near">DET_near</option>
            <option value="AGG_far">AGG_far</option>
            <option value="blend">blend</option>
          </select>
        </label>
        <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="既定=1e-6"></label>
        <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="既定=1e-6"></label>
        <label>calendar_mode
          <select name="calendar_mode">
            <option value="">(未指定)</option>
            <option value="simple">simple</option>
            <option value="iso">iso</option>
          </select>
        </label>
        <label>carryover
          <select name="carryover">
            <option value="">(未指定)</option>
            <option value="auto">auto</option>
            <option value="prev">prev</option>
            <option value="next">next</option>
            <option value="both">both</option>
          </select>
        </label>
        <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split"></label>
        <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
      </div>
      <button type="submit">Run（作成）</button>
      <p class="mono">参考: 従来の実行は <a href="/ui/planning" target="_blank">/ui/planning</a></p>
    </form>
  </details>

  <div style="display:flex; gap:8px; align-items:center; margin:8px 0;">
    <input id="q" type="search" placeholder="検索（version/status/policy）" />
    <small class="mono" id="meta"></small>
  </div>
  {% if plans and plans|length > 0 %}
  <table id="tblPlans">
    <thead>
      <tr>
        <th>version_id</th>
        <th data-sort="status" title="クリックで並び替え">status</th>
        <th>cutover</th>
        <th>window</th>
        <th>policy</th>
        <th data-sort="created_at" title="クリックで並び替え">created_at</th>
        <th data-sort="violations" title="クリックで並び替え">violations</th>
        <th>max|Δ| (d/s/b)</th>
        <th>API</th>
      </tr>
    </thead>
    <tbody>
      {% for p in plans %}
      <tr>
        <td class="mono"><a href="/ui/plans/{{ p.version_id }}">{{ p.version_id }}</a></td>
        <td>{{ p.status or '' }}</td>
        <td class="mono">{{ p.cutover_date or '' }}</td>
        <td class="mono">{{ p.recon_window_days if p.recon_window_days is not none else 0 }}</td>
        <td class="mono">{{ p.policy or '(none)' }}</td>
        <td class="mono ts-ms" data-ms="{{ p.created_at }}">{{ p.created_at }}</td>
        <td class="mono">{{ (p.recon_summary.violations or p.recon_summary.tol_violations) if p.recon_summary else '' }}</td>
        <td class="mono">
          {% if p.recon_summary and p.recon_summary.max_abs_delta %}
            ({{ p.recon_summary.max_abs_delta.demand }}, {{ p.recon_summary.max_abs_delta.supply }}, {{ p.recon_summary.max_abs_delta.backlog }})
          {% endif %}
        </td>
        <td>
          <a class="secondary" href="/plans/{{ p.version_id }}/summary" target="_blank">summary</a>
          <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/summary" title="URLをコピー">copy</button>
          <a class="secondary" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=100" target="_blank">compare</a>
          <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=100" title="URLをコピー">copy</button>
          <a class="secondary" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=abs_desc&limit=200" target="_blank">violations</a>
          <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=abs_desc&limit=200" title="URLをコピー">copy</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>まだプランがありません。/ui/planning から実行するか、/plans/integrated/run を呼び出してください。</p>
  {% endif %}
</section>
{% endblock %}
{% block scripts %}
<script>
// JSTフォーマット（ms epoch → YYYY/MM/DD HH:mm:ss）
function fmtJst(ms){
  var n = Number(ms);
  if (!Number.isFinite(n)) return '';
  var t = new Date(n + 9*3600*1000); // JSTへシフトしUTC系getterで整形
  var y = t.getUTCFullYear();
  var mo = String(t.getUTCMonth()+1).padStart(2,'0');
  var d = String(t.getUTCDate()).padStart(2,'0');
  var h = String(t.getUTCHours()).padStart(2,'0');
  var mi = String(t.getUTCMinutes()).padStart(2,'0');
  var s = String(t.getUTCSeconds()).padStart(2,'0');
  return y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s;
}
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('td.ts-ms').forEach(function(td){
    var ms = td.getAttribute('data-ms');
    var txt = fmtJst(ms);
    if (txt) td.textContent = txt;
  });
  var q = document.getElementById('q');
  var meta = document.getElementById('meta');
  var rows = Array.from(document.querySelectorAll('tbody tr'));
  // 検索フィルタの永続化（localStorage）
  var KEY_Q = 'ui_plans_query';
  try {
    var saved = localStorage.getItem(KEY_Q);
    if (q && saved && typeof saved === 'string') { q.value = saved; }
  } catch(e) {}
  function apply(){
    var s = (q && q.value || '').toLowerCase().trim();
    var vis = 0;
    rows.forEach(function(tr){
      var txt = tr.textContent.toLowerCase();
      var ok = !s || txt.indexOf(s) >= 0;
      tr.style.display = ok ? '' : 'none';
      if (ok) vis++;
    });
    if (meta) meta.textContent = vis + ' / ' + rows.length;
    try { localStorage.setItem(KEY_Q, s); } catch(e) {}
  }
  if (q) {
    q.addEventListener('input', apply);
    apply();
  }
  // URLコピー（クリックでlocation.origin + data-href をコピー）
  function copyUrl(href){
    var abs = (location && location.origin ? location.origin : '') + href;
    if (navigator && navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(abs).catch(function(){});
    } else {
      var ta = document.createElement('textarea'); ta.value = abs; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
    }
  }
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if (t && t.classList && t.classList.contains('copy')){
      var href = t.getAttribute('data-href');
      if (href) { copyUrl(href); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy'; }, 1200); }
    }
  });

  // 簡易ソート（status/created_at/violations）
  var KEY_SORT = 'ui_plans_sort';
  function getCellValue(tr, idx){ var el = tr.children[idx]; return el ? el.textContent.trim() : ''; }
  function toNum(s){ var n = parseFloat(s.replace(/[^0-9.\-]/g,'')); return isNaN(n)? null : n; }
  function cmp(a,b){ return a<b ? -1 : a>b ? 1 : 0; }
  function applySort(key, dir){
    var table = document.getElementById('tblPlans');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    var rowsArr = Array.from(tbody.querySelectorAll('tr'));
    var colIdx = {status:1, created_at:6, violations:7}[key];
    if (colIdx == null) return;
    rowsArr.sort(function(ra, rb){
      var va = getCellValue(ra, colIdx);
      var vb = getCellValue(rb, colIdx);
      if (key === 'created_at'){
        // 日付文字列はDateに
        var da = Date.parse(va.replace(/\//g,'-')) || 0;
        var db = Date.parse(vb.replace(/\//g,'-')) || 0;
        return dir==='asc'? (da-db):(db-da);
      }
      var na = toNum(va); var nb = toNum(vb);
      if (na!=null && nb!=null) return dir==='asc'? (na-nb):(nb-na);
      return dir==='asc'? cmp(va,vb): cmp(vb,va);
    });
    rowsArr.forEach(function(r){ tbody.appendChild(r); });
    // ヘッダ装飾
    document.querySelectorAll('th[data-sort]').forEach(function(th){ th.classList.remove('active-sort'); });
    var th = document.querySelector('th[data-sort="'+key+'"]'); if (th) th.classList.add('active-sort');
    try { localStorage.setItem(KEY_SORT, JSON.stringify({key:key, dir:dir})); } catch(e) {}
  }
  function initSort(){
    var saved = null; try { saved = JSON.parse(localStorage.getItem(KEY_SORT)||'null'); }catch(e){}
    var key = saved && saved.key || 'created_at';
    var dir = saved && saved.dir || 'desc';
    applySort(key, dir);
  }
  document.querySelectorAll('th[data-sort]').forEach(function(th){
    th.style.cursor = 'pointer';
    th.addEventListener('click', function(){
      var key = th.getAttribute('data-sort');
      var saved = null; try { saved = JSON.parse(localStorage.getItem(KEY_SORT)||'null'); }catch(e){}
      var dir = (saved && saved.key===key && saved.dir==='asc') ? 'desc' : 'asc';
      applySort(key, dir);
    });
  });
  initSort();
});
</script>
{% endblock %}
