{% extends "base.html" %}
{% block page_header %}
  <h2>Planning Hub</h2>
  <p>Create, review, and reconcile plan versions generated by the integrated pipeline.</p>
{% endblock %}
{% block content %}
<section class="page-section">
  <div class="section-header">
    <h3>Integrated Planning Execution</h3>
    <p>Execute an end-to-end planning cycle using the configured pipeline defaults.</p>
  </div>
  <details open>
    <summary>Create and Execute Plan (Integrated Pipeline)</summary>
    <form method="post" action="/ui/plans/create_and_execute">
      {% if error %}
      <p class="mono warn-text">{{ error }}</p>
      {% endif %}
      <div class="form-grid">
        <label>
          <span class="label-title">Canonical Config Version</span>
          {% set selected_config = (form_defaults.config_version_id or '')|string %}
          <select name="config_version_id">
            <option value="">-- Select --</option>
            {% for opt in canonical_options %}
              <option value="{{ opt.id }}" {% if opt.id|string == selected_config %}selected{% endif %}>{{ opt.label }}</option>
            {% endfor %}
          </select>
          {% if canonical_options|length == 0 %}
            <small class="mono warn-text">No canonical configuration found. Create one in /ui/configs first.</small>
          {% endif %}
        </label>
        <label>
          <span class="label-title">Base Scenario</span>
          {% set selected_scenario = (form_defaults.base_scenario_id or '')|string %}
          <select name="base_scenario_id">
            <option value="">-- Optional --</option>
            {% for opt in scenario_options %}
              <option value="{{ opt.id }}" {% if opt.id|string == selected_scenario %}selected{% endif %}>{{ opt.label }}</option>
            {% endfor %}
          </select>
          {% if scenario_options|length == 0 %}
            <small class="mono warn-text">No scenarios registered. <a href="/ui/scenarios">Create a scenario</a> and reload.</small>
          {% endif %}
        </label>
        <label>
          <span class="label-title">Weeks</span>
          <input type="number" name="weeks" min="1" value="{{ form_defaults.weeks or 4 }}" />
        </label>
        <label>
          <span class="label-title">Lead Time Unit</span>
          <select name="lt_unit">
            {% set lt_unit = form_defaults.lt_unit or 'day' %}
            <option value="day" {% if lt_unit == 'day' %}selected{% endif %}>Day</option>
            <option value="week" {% if lt_unit == 'week' %}selected{% endif %}>Week</option>
          </select>
        </label>
        <label>
          <span class="label-title">Cutover Date</span>
          <input type="date" name="cutover_date" value="{{ form_defaults.cutover_date or '' }}" />
        </label>
        <label>
          <span class="label-title">Reconciliation Window (days)</span>
          <input type="number" name="recon_window_days" min="0" value="{{ form_defaults.recon_window_days or '' }}" />
        </label>
        <label>
          <span class="label-title">Anchor Policy</span>
          <select name="anchor_policy">
            {% set anchor_policy = form_defaults.anchor_policy or '' %}
            <option value="" {% if anchor_policy == '' %}selected{% endif %}>Unspecified</option>
            <option value="DET_near" {% if anchor_policy == 'DET_near' %}selected{% endif %}>DET_near</option>
            <option value="AGG_far" {% if anchor_policy == 'AGG_far' %}selected{% endif %}>AGG_far</option>
            <option value="blend" {% if anchor_policy == 'blend' %}selected{% endif %}>Blend</option>
          </select>
        </label>
        <label>
          <span class="label-title">Tol Abs</span>
          <input type="number" step="0.000001" name="tol_abs" placeholder="default 1e-6" value="{{ form_defaults.tol_abs or '' }}" />
        </label>
        <label>
          <span class="label-title">Tol Rel</span>
          <input type="number" step="0.000001" name="tol_rel" placeholder="default 1e-6" value="{{ form_defaults.tol_rel or '' }}" />
        </label>
        <label>
          <span class="label-title">Calendar Mode</span>
          <select name="calendar_mode">
            {% set calendar_mode = form_defaults.calendar_mode or '' %}
            <option value="" {% if calendar_mode == '' %}selected{% endif %}>Unspecified</option>
            <option value="simple" {% if calendar_mode == 'simple' %}selected{% endif %}>Simple</option>
            <option value="iso" {% if calendar_mode == 'iso' %}selected{% endif %}>ISO Week</option>
          </select>
        </label>
        <label>
          <span class="label-title">Carryover Mode</span>
          <select name="carryover">
            {% set carryover = form_defaults.carryover or '' %}
            <option value="" {% if carryover == '' %}selected{% endif %}>Unspecified</option>
            <option value="auto" {% if carryover == 'auto' %}selected{% endif %}>Auto</option>
            <option value="prev" {% if carryover == 'prev' %}selected{% endif %}>Use Previous</option>
            <option value="next" {% if carryover == 'next' %}selected{% endif %}>Use Next</option>
            <option value="both" {% if carryover == 'both' %}selected{% endif %}>Blend</option>
          </select>
        </label>
        <label>
          <span class="label-title">Carryover Split</span>
          <input type="number" min="0" max="1" step="0.05" name="carryover_split" value="{{ form_defaults.carryover_split or '' }}" />
        </label>
        <label>
          <span class="label-title">Apply Adjusted Output</span>
          <select name="apply_adjusted">
            {% set apply_adjusted = form_defaults.apply_adjusted or '' %}
            <option value="" {% if apply_adjusted == '' %}selected{% endif %}>No</option>
            <option value="1" {% if apply_adjusted == '1' %}selected{% endif %}>Yes</option>
          </select>
        </label>
      </div>
      <div class="toolbar justify-end gap-top-sm">
        <button type="submit" class="btn-primary" aria-label="Create and Execute Plan">Create and Execute Plan</button>
      </div>
    </form>
  </details>
</section>

<section class="page-section">
  <div class="section-header">
    <h3>Plan Versions</h3>
    <p>Filter, inspect, and compare generated versions to reconcile PSI outcomes.</p>
  </div>
  <div class="toolbar gap-bottom-sm">
    <input id="q" type="search" placeholder="Search by version, status, policy" aria-label="Search plan versions" />
    <small class="mono pill" id="meta"></small>
    <div class="toolbar">
      <label class="mono">
        <span class="label-title label-title-inline">Primary Sort</span>
        <select id="sortPKey" aria-label="Primary sort key">
          <option value="created_at">created_at</option>
          <option value="status">status</option>
          <option value="violations">violations</option>
          <option value="policy">policy</option>
          <option value="cutover">cutover</option>
        </select>
      </label>
      <select id="sortPDir" aria-label="Primary sort direction">
        <option value="desc">desc</option>
        <option value="asc">asc</option>
      </select>
      <label class="mono">
        <span class="label-title label-title-inline">Secondary Sort</span>
        <select id="sortSKey" aria-label="Secondary sort key">
          <option value="">(none)</option>
          <option value="created_at">created_at</option>
          <option value="status">status</option>
          <option value="violations">violations</option>
          <option value="policy">policy</option>
          <option value="cutover">cutover</option>
        </select>
      </label>
      <select id="sortSDir" aria-label="Secondary sort direction">
        <option value="desc">desc</option>
        <option value="asc">asc</option>
      </select>
    </div>
    <small class="mono pill" id="sortBadge"></small>
  </div>

  {% if has_data %}
  <div class="table-wrapper">
    <table id="tblPlans">
        <thead>
          <tr>
            <th scope="col">Version</th>
            <th scope="col">
              <button type="button" class="link sort-trigger" data-sort="status" data-label="Status" title="Sort by status" aria-label="Sort by status">Status</button>
            </th>
            <th scope="col">
              <button type="button" class="link sort-trigger" data-sort="config_version" data-label="Config Ver" title="Sort by config version" aria-label="Sort by config version">Config Ver</button>
            </th>
            <th scope="col">
              <button type="button" class="link sort-trigger" data-sort="cutover" data-label="Cutover" title="Sort by cutover" aria-label="Sort by cutover">Cutover</button>
            </th>
            <th scope="col"><button type="button" class="link sort-trigger" data-sort="db_rows" data-label="DB Rows">DB Rows</button></th>
            <th scope="col"><button type="button" class="link sort-trigger" data-sort="fill_rate" data-label="Fill Rate">Fill Rate</button></th>
            <th scope="col"><button type="button" class="link sort-trigger" data-sort="backlog_days" data-label="Backlog Days">Backlog Days</button></th>
            <th scope="col">
              <button type="button" class="link sort-trigger" data-sort="created_at" data-label="Created" title="Sort by created at" aria-label="Sort by created at">Created</button>
            </th>
            <th scope="col"><button type="button" class="link sort-trigger" data-sort="last_job" data-label="Last Job">Last Job</button></th>
            <th scope="col">Shortcuts</th>
          </tr>
        </thead>
        <tbody>
          {% for p in plans %}
          <tr>
            <td class="mono"><a class="truncate link-truncate" href="/ui/plans/{{ p.version_id }}" title="{{ p.version_id }}">{{ p.version_id }}</a></td>
            <td>{{ p.status or '' }}</td>
            <td class="mono">
              {% if p.config_version_id %}
                <a href="/ui/configs/canonical/{{ p.config_version_id }}">{{ p.config_version_id }}</a>
              {% else %}-{% endif %}
            </td>
            <td class="mono">{{ p.cutover_date or '' }}</td>
            <td class="mono">{{ p.summary.series_rows if p.summary and p.summary.series_rows is not none else '' }}</td>
            <td class="mono">{{ "%.2f"|format(p.summary.kpi.fill_rate * 100) if p.summary and p.summary.kpi and 'fill_rate' in p.summary.kpi and p.summary.kpi.fill_rate is not none else '' }}%</td>
            <td class="mono">{{ "%.2f"|format(p.summary.kpi.backlog_days) if p.summary and p.summary.kpi and 'backlog_days' in p.summary.kpi and p.summary.kpi.backlog_days is not none else '' }}</td>
            <td class="mono ts-ms" data-ms="{{ p.created_at }}">{{ p.created_at }}</td>
            <td class="mono">{{ p.jobs.last.status if p.jobs and p.jobs.last else '' }}</td>
            <td class="table-actions">
              <div class="shortcut-group">
                <a class="btn-link" href="/plans/{{ p.version_id }}/summary" target="_blank">Summary</a>
                <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/summary" aria-label="Copy summary URL">Copy</button>
              </div>
              <div class="shortcut-group">
                <a class="btn-link" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=100" target="_blank">Compare</a>
                <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=100" aria-label="Copy compare URL">Copy</button>
              </div>
              <div class="shortcut-group">
                <a class="btn-link" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=abs_desc&limit=200" target="_blank">Violations</a>
                <button type="button" class="secondary copy" data-href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=abs_desc&limit=200" aria-label="Copy violations URL">Copy</button>
              </div>
              <button type="button" class="secondary copy-all" data-version="{{ p.version_id }}" aria-label="Copy all URLs">Copy All</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
    </table>
  </div>
  {% if pagination and pagination.total is defined and pagination.limit is defined and pagination.total > pagination.limit %}
  <div class="pagination-footer">
    <small>Showing {{ pagination.count }} of {{ pagination.total }} plans</small>
    <div class="pagination-nav">
      {% if pagination.offset > 0 %}
        {% set prev_offset = pagination.offset - pagination.limit %}
        {% if prev_offset < 0 %}{% set prev_offset = 0 %}{% endif %}
        <a href="/ui/plans?limit={{ pagination.limit }}&offset={{ prev_offset }}" class="btn">Previous</a>
      {% endif %}
      {% if pagination.next_offset %}
        <a href="/ui/plans?limit={{ pagination.limit }}&offset={{ pagination.next_offset }}" class="btn">Next</a>
      {% endif %}
    </div>
  </div>
  {% endif %}
  {% else %}
  <p class="section-description">初期データがありません。<a href="/ui/configs">サンプルをインポート</a>を実行してください。</p>
  {% endif %}
</section>
{% endblock %}
{% block scripts %}
<script>
// Format created_at timestamp (ms epoch → YYYY/MM/DD HH:mm:ss JST)
function fmtJst(ms){
  var n = Number(ms);
  if (!Number.isFinite(n)) return '';
  if (n < 1e12) n = n * 1000;
  var t = new Date(n + 9*3600*1000); // Shift to JST before formatting via UTC getters
  var y = t.getUTCFullYear();
  var mo = String(t.getUTCMonth()+1).padStart(2,'0');
  var d = String(t.getUTCDate()).padStart(2,'0');
  var h = String(t.getUTCHours()).padStart(2,'0');
  var mi = String(t.getUTCMinutes()).padStart(2,'0');
  var s = String(t.getUTCSeconds()).padStart(2,'0');
  return y+'/'+mo+'/'+d+' '+h+':'+mi+':'+s+' JST';
}
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('td.ts-ms').forEach(function(td){
    var ms = td.getAttribute('data-ms');
    var txt = fmtJst(ms);
    if (txt) td.textContent = txt;
  });
  var q = document.getElementById('q');
  var meta = document.getElementById('meta');
  var rows = Array.from(document.querySelectorAll('tbody tr'));
  var sortBadge = document.getElementById('sortBadge');
  var sortButtons = Array.from(document.querySelectorAll('button.sort-trigger[data-sort]'));
  // Persist search filter in localStorage
  var KEY_Q = 'ui_plans_query';
  try {
    var saved = localStorage.getItem(KEY_Q);
    if (q && saved && typeof saved === 'string') { q.value = saved; }
  } catch(e) {}
  function apply(){
    var s = (q && q.value || '').toLowerCase().trim();
    var vis = 0;
    rows.forEach(function(tr){
      var txt = tr.textContent.toLowerCase();
      var ok = !s || txt.indexOf(s) >= 0;
      tr.style.display = ok ? '' : 'none';
      if (ok) vis++;
    });
    if (meta) meta.textContent = vis + ' / ' + rows.length;
    try { localStorage.setItem(KEY_Q, s); } catch(e) {}
  }
  if (q) {
    q.addEventListener('input', apply);
    apply();
  }
  // Copy plan links to the clipboard using location.origin + data-href
  function copyUrl(href){
    var abs = (location && location.origin ? location.origin : '') + href;
    if (navigator && navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(abs).catch(function(){});
    } else {
      var ta = document.createElement('textarea'); ta.value = abs; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
    }
  }
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if (t && t.classList && t.classList.contains('copy')){
      var href = t.getAttribute('data-href');
      if (href) { copyUrl(href); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy'; }, 1200); }
    }
  });

  // Quick sort for common columns (status/created_at/violations)
  var KEY_SORT = 'ui_plans_sort';
  var KEY_SORT2 = 'ui_plans_sort2';
  var SORT_LABELS = {
    status: 'Status',
    config_version: 'Config Ver',
    cutover: 'Cutover',
    created_at: 'Created',
    db_rows: 'DB Rows',
    fill_rate: 'Fill Rate',
    backlog_days: 'Backlog Days',
    last_job: 'Last Job',
  };
  function updateSortBadge(pkey, pdir, skey, sdir){
    if (!sortBadge) return;
    var txt = 'Sort: ' + (pkey||'-') + ' ' + (pdir||'-');
    if (skey) txt += ' | Secondary: ' + skey + ' ' + (sdir||'-');
    sortBadge.textContent = txt;
  }
  function getCell(tr, idx){ return tr && Number.isInteger(idx) ? tr.children[idx] : null; }
  function getCellValue(tr, idx){ var el = getCell(tr, idx); return el ? el.textContent.trim() : ''; }
  function toNum(s){ var n = parseFloat(s.replace(/[^0-9.\-]/g,'')); return Number.isFinite(n)? n : null; }
  function cmp(a,b){ return a<b ? -1 : a>b ? 1 : 0; }
  var COL_INDEX = {
    status:1,
    config_version:2,
    cutover:3,
    db_rows: 4,
    fill_rate: 5,
    backlog_days: 6,
    created_at:7,
    last_job: 8,
  };
  function normalizeMs(n){
    if (!Number.isFinite(n)) return null;
    if (n < 1e12) n = n * 1000;
    return n;
  }
  function getSortDatum(tr, key){
    var idx = COL_INDEX[key];
    var cell = getCell(tr, idx);
    if (!cell) return {text:'', num:null};
    if (key === 'created_at'){
      var attr = cell.getAttribute('data-ms');
      if (attr){
        var n = normalizeMs(Number(attr));
        if (n !== null) return {text: cell.textContent.trim(), num: n};
      }
    }
    if (key === 'cutover'){
      var raw = cell.textContent.trim();
      var ts = Date.parse(raw.replace(/\//g,'-'));
      if (Number.isFinite(ts)) return {text: raw, num: ts};
      return {text: raw, num: null};
    }
    var txt = cell.textContent.trim();
    var num = toNum(txt);
    return {text: txt, num: num !== null ? num : null};
  }
  function compareByKey(ra, rb, key, dir){
    if (!key) return 0;
    var a = getSortDatum(ra, key);
    var b = getSortDatum(rb, key);
    var diff = 0;
    if (a.num !== null && b.num !== null){
      diff = a.num - b.num;
    } else {
      diff = cmp(a.text, b.text);
    }
    if (diff === 0) return 0;
    return dir === 'asc' ? diff : -diff;
  }
  function renderSortIndicators(activeKey, activeDir){
    var arrow = activeDir === 'asc' ? '↑' : '↓';
    sortButtons.forEach(function(btn){
      var key = btn.getAttribute('data-sort');
      var base = btn.getAttribute('data-label') || SORT_LABELS[key] || btn.textContent.trim();
      if (key === activeKey){
        btn.textContent = base + ' ' + arrow;
        btn.classList.add('active-sort');
        var th = btn.closest('th');
        if (th) th.setAttribute('aria-sort', activeDir === 'asc' ? 'ascending' : 'descending');
      } else {
        btn.textContent = base;
        btn.classList.remove('active-sort');
        var thClear = btn.closest('th');
        if (thClear) thClear.setAttribute('aria-sort', 'none');
      }
    });
  }

  function applySort(key, dir){
    var table = document.getElementById('tblPlans');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    var rowsArr = Array.from(tbody.querySelectorAll('tr'));
    if (!COL_INDEX.hasOwnProperty(key)) return;
    rowsArr.sort(function(ra, rb){
      return compareByKey(ra, rb, key, dir);
    });
    rowsArr.forEach(function(r){ tbody.appendChild(r); });
    renderSortIndicators(key, dir);
    try { localStorage.setItem(KEY_SORT, JSON.stringify({key:key, dir:dir})); } catch(e) {}
    try { localStorage.setItem(KEY_SORT2, JSON.stringify({pkey:key, pdir:dir, skey:'', sdir:'desc'})); } catch(e) {}
    var pk = document.getElementById('sortPKey'); if (pk) pk.value = key;
    var pd = document.getElementById('sortPDir'); if (pd) pd.value = dir;
    var sk = document.getElementById('sortSKey'); if (sk) sk.value = '';
    var sd = document.getElementById('sortSDir'); if (sd) sd.value = 'desc';
    updateSortBadge(key, dir, '', 'desc');
  }
  function applySort2(pkey, pdir, skey, sdir){
    var table = document.getElementById('tblPlans');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    var rowsArr = Array.from(tbody.querySelectorAll('tr'));
    rowsArr.sort(function(ra, rb){
      var c1 = compareByKey(ra, rb, pkey, pdir);
      if (c1 !== 0) return c1;
      if (skey){
        var c2 = compareByKey(ra, rb, skey, sdir);
        if (c2 !== 0) return c2;
      }
      // Final tie-breaker: version_id (string)
      var aId = getCellValue(ra, 0), bId = getCellValue(rb, 0);
      return cmp(aId, bId);
    });
    rowsArr.forEach(function(r){ tbody.appendChild(r); });
    try { localStorage.setItem(KEY_SORT2, JSON.stringify({pkey, pdir, skey, sdir})); } catch(e) {}
    try { localStorage.setItem(KEY_SORT, JSON.stringify({key:pkey, dir:pdir})); } catch(e) {}
    renderSortIndicators(pkey, pdir);
  }
  function initSort(){
    var s2 = null; try { s2 = JSON.parse(localStorage.getItem(KEY_SORT2)||'null'); }catch(e){}
    var saved = null; try { saved = JSON.parse(localStorage.getItem(KEY_SORT)||'null'); }catch(e){}
    var pkey = (s2 && s2.pkey) || (saved && saved.key) || 'created_at';
    var pdir = (s2 && s2.pdir) || (saved && saved.dir) || 'desc';
    var skey = (s2 && s2.skey) || '';
    var sdir = (s2 && s2.sdir) || 'desc';
    // Reflect saved state in the UI
    var pk = document.getElementById('sortPKey'); if (pk) pk.value = pkey;
    var pd = document.getElementById('sortPDir'); if (pd) pd.value = pdir;
    var sk = document.getElementById('sortSKey'); if (sk) sk.value = skey || '';
    var sd = document.getElementById('sortSDir'); if (sd) sd.value = sdir;
    applySort2(pkey, pdir, skey, sdir);
    updateSortBadge(pkey, pdir, skey, sdir);
    renderSortIndicators(pkey, pdir);
  }
  sortButtons.forEach(function(btn){
    btn.addEventListener('click', function(){
      var key = btn.getAttribute('data-sort');
      var saved = null; try { saved = JSON.parse(localStorage.getItem(KEY_SORT)||'null'); }catch(e){}
      var dir = (saved && saved.key === key && saved.dir === 'asc') ? 'desc' : 'asc';
      applySort(key, dir);
    });
  });
  initSort();

  // Wire up advanced sort controls
  function onSort2Change(){
    var pk = document.getElementById('sortPKey');
    var pd = document.getElementById('sortPDir');
    var sk = document.getElementById('sortSKey');
    var sd = document.getElementById('sortSDir');
    var pkey = pk ? pk.value : 'created_at';
    var pdir = pd ? pd.value : 'desc';
    var skey = sk ? sk.value : '';
    var sdir = sd ? sd.value : 'desc';
    applySort2(pkey, pdir, skey, sdir);
    updateSortBadge(pkey, pdir, skey, sdir);
  }
  ['sortPKey','sortPDir','sortSKey','sortSDir'].forEach(function(id){ var el = document.getElementById(id); if (el) el.addEventListener('change', onSort2Change); });

  // Support bulk copy actions for summary/compare/violations links
  function copyAllLinks(ver){
    var origin = (location && location.origin) ? location.origin : '';
    var urls = [
      origin + '/plans/' + ver + '/summary',
      origin + '/plans/' + ver + '/compare?violations_only=true&sort=rel_desc&limit=100',
      origin + '/plans/' + ver + '/compare?violations_only=true&sort=abs_desc&limit=200'
    ];
    var txt = urls.join('\n');
    if (navigator && navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).catch(function(){});
    } else {
      var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
    }
  }
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if (t && t.classList && t.classList.contains('copy-all')){
      var ver = t.getAttribute('data-version');
      if (ver){ copyAllLinks(ver); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy all'; }, 1200); }
    }
  });
});
</script>
{% endblock %}
