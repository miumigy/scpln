{% extends "base.html" %}
{% block page_header %}
  <h2>Scenarios</h2>
  <p>Catalog scenario variations, apply filters, and launch targeted planning runs.</p>
{% endblock %}
{% block content %}
<section class="page-section">
  <div class="section-header">
    <h3>Scenario Library</h3>
    <p>Filter saved scenarios and add new variations for experiment tracking.</p>
  </div>
  {% include "partials/_scenario_run_notice.html" with context %}
  <form id="scn-filter" class="toolbar gap-bottom-sm" onsubmit="return false;">
    <label>Search (name/desc)
      <input type="text" id="f-q" placeholder="keyword" aria-label="Search scenarios" />
    </label>
    <label>Tag
      <input type="text" id="f-tag" list="tag-list" placeholder="tag" aria-label="Filter by tag" />
      <datalist id="tag-list"></datalist>
    </label>
    <label>Locked
      <select id="f-locked" aria-label="Filter by lock state">
        <option value="">(all)</option>
        <option value="1">locked</option>
        <option value="0">unlocked</option>
      </select>
    </label>
    <button type="button" class="secondary" id="f-apply" aria-label="Apply filters">Apply</button>
    <button type="button" class="secondary" id="f-clear" aria-label="Clear filters">Clear</button>
  </form>
  <form method="post" action="/ui/scenarios" class="grid-form gap-bottom-sm">
    <label>Name
      <input type="text" name="name" placeholder="Scenario name" required />
    </label>
    <label>Parent ID
      <input type="number" name="parent_id" min="1" />
    </label>
    <label>Tag
      <input type="text" name="tag" />
    </label>
    <label class="span-full">Description
      <textarea name="description" rows="3"></textarea>
    </label>
    <div>
      <button type="submit" aria-label="Add scenario">Add</button>
    </div>
  </form>
  {% if rows %}
  <div class="table-wrapper">
  <table role="grid">
    <thead>
      <tr>
        <th>id</th>
        <th>name</th>
        <th>tag</th>
        <th>parent_id</th>
        <th>locked</th>
        <th>updated_at</th>
        <th class="col-wide">description</th>
        <th>Plan &amp; Run</th>
        <th>Edit/Delete</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr data-name="{{ (r.name or '')|e }}" data-tag="{{ (r.tag or '')|e }}" data-locked="{{ 1 if r.locked else 0 }}" data-desc="{{ (r.description or '')|e }}">
        <td>{{ r.id }}</td>
        <td>{{ r.name }}</td>
        <td>{{ r.tag or '' }}</td>
        <td>{{ r.parent_id or '' }}</td>
        <td>{{ r.locked }}</td>
        <td class="format-datetime">{{ r.updated_at }}</td>
        <td title="{{ r.description or '' }}" class="truncate-text">{{ r.description or '' }}</td>
        <td>
          <a class="secondary" href="/ui/plans?base_scenario_id={{ r.id }}" title="Open Plan &amp; Run with this scenario">Open in Plan &amp; Run</a>
        </td>
        <td>
          <details>
            <summary>Edit</summary>
            <form method="post" action="/ui/scenarios/{{ r.id }}/edit" class="grid-form grid-2 gap-top-sm">
              <label>Name
                <input type="text" name="name" value="{{ r.name }}" required />
              </label>
              <label>Parent ID
                <input type="number" name="parent_id" value="{{ r.parent_id or '' }}" min="1" />
              </label>
              <label>Tag
                <input type="text" name="tag" value="{{ r.tag or '' }}" />
              </label>
              <label>Locked
                <input type="checkbox" name="locked" {% if r.locked %}checked{% endif %} />
              </label>
              <label class="span-full">Description
                <textarea name="description" rows="3">{{ r.description or '' }}</textarea>
              </label>
              <div class="toolbar span-full">
                <button type="submit" aria-label="Update scenario">Update</button>
              </div>
            </form>
            <form method="post" action="/ui/scenarios/{{ r.id }}/delete" class="gap-top-sm" onsubmit="return confirm('Delete scenario #{{ r.id }}?');">
              <button type="submit" class="contrast" aria-label="Delete scenario">Delete</button>
            </form>
          </details>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  {% else %}
  <p>No scenarios.</p>
  {% endif %}
</section>
{% endblock %}
{% block scripts %}
<script>
(function(){
  const form = document.getElementById('scn-filter'); if(!form) return;
  const q = document.getElementById('f-q');
  const tag = document.getElementById('f-tag');
  const locked = document.getElementById('f-locked');
  const applyBtn = document.getElementById('f-apply');
  const clearBtn = document.getElementById('f-clear');
  const table = document.querySelector('table[role="grid"] tbody');
  function norm(s){ return String(s||'').toLowerCase(); }
  function apply(){
    const qv = norm(q && q.value);
    const tv = norm(tag && tag.value);
    const lv = locked && locked.value;
    if(!table) return;
    Array.from(table.querySelectorAll('tr')).forEach(tr=>{
      const name = norm(tr.getAttribute('data-name'));
      const desc = norm(tr.getAttribute('data-desc'));
      const tg = norm(tr.getAttribute('data-tag'));
      const lk = tr.getAttribute('data-locked');
      let ok = true;
      if(qv){ ok = ok && (name.includes(qv) || desc.includes(qv)); }
      if(tv){ ok = ok && tg === tv; }
      if(lv!=='' && lv!=null){ ok = ok && lk === lv; }
      tr.style.display = ok ? '' : 'none';
    });
  }
  function clear(){ if(q) q.value=''; if(tag) tag.value=''; if(locked) locked.value=''; apply(); }
  if(applyBtn) applyBtn.addEventListener('click', apply);
  if(clearBtn) clearBtn.addEventListener('click', clear);
  // populate tag datalist from current rows
  try{
    const set = new Set();
    document.querySelectorAll('tr[data-tag]').forEach(tr=>{ const v = (tr.getAttribute('data-tag')||'').trim(); if(v) set.add(v); });
    const dl = document.getElementById('tag-list'); if(dl){ dl.innerHTML=''; Array.from(set).sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; dl.appendChild(o); }); }
  }catch{}

  try {
    const fmtJst = (value) => {
      let n = Number(value);
      if (!Number.isFinite(n)) return '';
      if (n < 1e12) n *= 1000; // accept epoch seconds as fallback
      const t = new Date(n + 9 * 3600 * 1000);
      const y = t.getUTCFullYear();
      const m = String(t.getUTCMonth() + 1).padStart(2, '0');
      const d = String(t.getUTCDate()).padStart(2, '0');
      const h = String(t.getUTCHours()).padStart(2, '0');
      const mi = String(t.getUTCMinutes()).padStart(2, '0');
      const s = String(t.getUTCSeconds()).padStart(2, '0');
      return `${y}/${m}/${d} ${h}:${mi}:${s} JST`;
    };
    document.querySelectorAll('.format-datetime').forEach(el => {
      const raw = (el.textContent || '').trim();
      const txt = fmtJst(raw);
      if (txt) el.textContent = txt;
    });
  } catch (e) {}

})();
</script>
{% endblock %}
