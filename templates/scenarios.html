{% extends "base.html" %}
{% block content %}
<section>
  <h2>Scenarios</h2>
  <form id="scn-filter" onsubmit="return false;" style="display:flex; flex-wrap:wrap; gap:8px; align-items:end; margin:8px 0;">
    <label>Search (name/desc)
      <input type="text" id="f-q" placeholder="keyword" />
    </label>
    <label>Tag
      <input type="text" id="f-tag" list="tag-list" placeholder="tag" />
      <datalist id="tag-list"></datalist>
    </label>
    <label>Locked
      <select id="f-locked">
        <option value="">(all)</option>
        <option value="1">locked</option>
        <option value="0">unlocked</option>
      </select>
    </label>
    <button type="button" class="secondary" id="f-apply">Apply</button>
    <button type="button" class="secondary" id="f-clear">Clear</button>
  </form>
  <form method="post" action="/ui/scenarios" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:8px; align-items:end; margin:8px 0;">
    <label>Name
      <input type="text" name="name" placeholder="Scenario name" required />
    </label>
    <label>Parent ID
      <input type="number" name="parent_id" min="1" />
    </label>
    <label>Tag
      <input type="text" name="tag" />
    </label>
    <label style="grid-column:1 / -1;">Description
      <textarea name="description" rows="3" style="width:100%"></textarea>
    </label>
    <div><button type="submit">Add</button></div>
  </form>
  {% if rows %}
  <table role="grid">
    <thead>
      <tr>
        <th>id</th>
        <th>name</th>
        <th>tag</th>
        <th>parent_id</th>
        <th>locked</th>
        <th>updated_at</th>
        <th style="min-width:240px;">description</th>
        <th>Run</th>
        <th>Edit/Delete</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr data-name="{{ (r.name or '')|e }}" data-tag="{{ (r.tag or '')|e }}" data-locked="{{ 1 if r.locked else 0 }}" data-desc="{{ (r.description or '')|e }}">
        <td>{{ r.id }}</td>
        <td>{{ r.name }}</td>
        <td>{{ r.tag or '' }}</td>
        <td>{{ r.parent_id or '' }}</td>
        <td>{{ r.locked }}</td>
        <td>{{ r.updated_at }}</td>
        <td title="{{ r.description or '' }}" style="text-align:left; max-width:320px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ r.description or '' }}</td>
        <td>
          <form method="post" action="/ui/scenarios/{{ r.id }}/run" style="display:flex; gap:6px; align-items:center;">
            <label>
              <select name="config_id" required>
                <option value="" disabled selected>Select config</option>
                {% for c in configs %}
                <option value="{{ c.id }}">{{ c.id }} - {{ c.name }}</option>
                {% endfor %}
              </select>
            </label>
            <button type="submit">Run</button>
          </form>
        </td>
        <td>
          <details>
            <summary>Edit</summary>
            <form method="post" action="/ui/scenarios/{{ r.id }}/edit" style="display:grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap:6px; align-items:end; margin-top:6px;">
              <label>Name
                <input type="text" name="name" value="{{ r.name }}" required />
              </label>
              <label>Parent ID
                <input type="number" name="parent_id" value="{{ r.parent_id or '' }}" min="1" />
              </label>
              <label>Tag
                <input type="text" name="tag" value="{{ r.tag or '' }}" />
              </label>
              <label>Locked
                <input type="checkbox" name="locked" {% if r.locked %}checked{% endif %} />
              </label>
              <label style="grid-column:1 / -1;">Description
                <textarea name="description" rows="3" style="width:100%">{{ r.description or '' }}</textarea>
              </label>
              <div style="grid-column:1 / -1; display:flex; gap:6px;">
                <button type="submit">Update</button>
              </div>
            </form>
            <form method="post" action="/ui/scenarios/{{ r.id }}/delete" onsubmit="return confirm('Delete scenario #{{ r.id }}?');" style="margin-top:6px;">
              <button type="submit" class="contrast">Delete</button>
            </form>
          </details>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No scenarios.</p>
  {% endif %}
</section>
{% endblock %}
{% block scripts %}
<script>
(function(){
  const form = document.getElementById('scn-filter'); if(!form) return;
  const q = document.getElementById('f-q');
  const tag = document.getElementById('f-tag');
  const locked = document.getElementById('f-locked');
  const applyBtn = document.getElementById('f-apply');
  const clearBtn = document.getElementById('f-clear');
  const table = document.querySelector('table[role="grid"] tbody');
  function norm(s){ return String(s||'').toLowerCase(); }
  function apply(){
    const qv = norm(q && q.value);
    const tv = norm(tag && tag.value);
    const lv = locked && locked.value;
    if(!table) return;
    Array.from(table.querySelectorAll('tr')).forEach(tr=>{
      const name = norm(tr.getAttribute('data-name'));
      const desc = norm(tr.getAttribute('data-desc'));
      const tg = norm(tr.getAttribute('data-tag'));
      const lk = tr.getAttribute('data-locked');
      let ok = true;
      if(qv){ ok = ok && (name.includes(qv) || desc.includes(qv)); }
      if(tv){ ok = ok && tg === tv; }
      if(lv!=='' && lv!=null){ ok = ok && lk === lv; }
      tr.style.display = ok ? '' : 'none';
    });
  }
  function clear(){ if(q) q.value=''; if(tag) tag.value=''; if(locked) locked.value=''; apply(); }
  if(applyBtn) applyBtn.addEventListener('click', apply);
  if(clearBtn) clearBtn.addEventListener('click', clear);
  // populate tag datalist from current rows
  try{
    const set = new Set();
    document.querySelectorAll('tr[data-tag]').forEach(tr=>{ const v = (tr.getAttribute('data-tag')||'').trim(); if(v) set.add(v); });
    const dl = document.getElementById('tag-list'); if(dl){ dl.innerHTML=''; Array.from(set).sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; dl.appendChild(o); }); }
  }catch{}
})();
</script>
{% endblock %}
{% endblock %}
