{% extends "base.html" %}
{% block head %}
  <style>
    /* Highlight editable PSI cells */
    #tblPSI td[contenteditable],
    #tblPSI td.editable {
      background-color: #fffdf5;
      border: 1px dashed #c7c7c7;
      cursor: text;
      position: relative;
    }
    #tblPSI td.editable::after {
      content: "✎";
      position: absolute;
      top: 2px;
      right: 6px;
      font-size: 0.8em;
      opacity: 0.55;
      pointer-events: none;
    }
    #tblPSI td[contenteditable]:hover,
    #tblPSI td.editable:hover { background-color: #fff8e6; }
    #tblPSI td[contenteditable]:focus,
    #tblPSI td.editable:focus { outline: 2px solid #2563eb; background-color: #ffffff; }
    #tblPSI td.ro { background-color: #f2f4f7; color: #475569; }
    #tblPSI td.dirty { background-color: #fff3bf; border-color: #f08c00; }
    .tab-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin: 0.75rem 0 1rem;
    }
    .tab-nav a {
      min-width: 120px;
      text-align: center;
    }
    .tab-pane details summary {
      text-transform: none;
    }
    .tab-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
      margin: 0.75rem 0;
    }
    .tab-scroll {
      overflow: auto;
    }
    .warn-text {
      color: #b45309;
    }
  </style>
{% endblock %}
{% block page_header %}
  <h2>Plan Detail</h2>
  <p>Inspect reconciliation outputs, edit PSI tables, and execute follow-up actions.</p>
{% endblock %}
{% block content %}
<section class="page-section">
  <p class="mono">Help: <a href="https://github.com/miumigy/scpln/blob/main/docs/AGG_DET_RECONCILIATION_JA.md" target="_blank" rel="noopener">Reconciliation guide (GitHub)</a></p>
  {% if error %}
    <article><mark>Error</mark><pre class="mono">{{ error }}</pre></article>
  {% else %}
    <p class="mono">version_id={{ version_id }}</p>
    <nav class="tab-nav">
      <a role="button" class="secondary" data-tab="overview" title="Overview" aria-label="Overview tab">Overview</a>
      <a role="button" class="secondary" data-tab="aggregate" title="Aggregate" aria-label="Aggregate tab">Aggregate</a>
      <a role="button" class="secondary" data-tab="disaggregate" title="Disaggregate" aria-label="Disaggregate tab">Disaggregate</a>
      <a role="button" class="secondary" data-tab="schedule" title="Schedule" aria-label="Schedule tab">Schedule</a>
      <a role="button" class="secondary" data-tab="validate" title="Validate" aria-label="Validate tab">Validate</a>
      <a role="button" class="secondary" data-tab="psi" title="PSI" aria-label="PSI tab">PSI</a>
      <a role="button" class="secondary" data-tab="execute" title="Execute" aria-label="Execute tab">Execute</a>
      <a role="button" class="secondary" data-tab="results" title="Results" aria-label="Results tab">Results</a>
      <a role="button" class="secondary" data-tab="diff" title="Diff" aria-label="Diff tab">Diff</a>
    </nav>
    <div id="tab-aggregate" class="tab-pane" style="display:none;">
    <details open>
      <summary>Aggregate (family × period)</summary>
      {% if aggregate and aggregate.rows %}
      <table>
        <thead><tr><th>period</th><th>family</th><th>demand</th><th>supply</th><th>backlog</th><th>capacity_total</th></tr></thead>
        <tbody>
          {% for r in aggregate.rows %}
          <tr>
            <td>{{ r.period }}</td>
            <td>{{ r.family }}</td>
            <td class="mono">{{ r.demand }}</td>
            <td class="mono">{{ r.supply }}</td>
            <td class="mono">{{ r.backlog }}</td>
            <td class="mono">{{ r.capacity_total }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No aggregate records yet. Run reconciliation or execution to populate this section.</p>
      {% endif %}
    </details>
    <script>
    (function(){
      function getHeaders(){
        const h = {};
        try { const k = localStorage.getItem('api_key') || ''; if (k) h['X-API-Key'] = k; } catch {}
        return h;
      }
      function applyDiffLinks(){
        try {
          const sort = document.getElementById('diff-sort')?.value || 'rel_desc';
          const viol = document.getElementById('diff-viol')?.checked ? 'true':'false';
          document.querySelectorAll('#rel-list a').forEach(a => {
            if (a && a.getAttribute('href') && a.textContent === 'diff'){
              const href = new URL(a.getAttribute('href'), location.origin);
              href.searchParams.set('violations_only', viol);
              href.searchParams.set('sort', sort);
              a.setAttribute('href', href.pathname + href.search);
            }
          });
        } catch {}
      }
      async function loadRelated(){
        try {
          const sort = document.getElementById('rel-sort')?.value || 'created_desc';
          const limitEl = document.getElementById('rel-limit');
          const limit = Math.max(1, parseInt(limitEl && limitEl.value || '5', 10));
          const base = {{ (version.base_scenario_id or 'null') | tojson | safe }};
          if (!base) return;
          const qs = new URLSearchParams({ base_scenario_id: String(base), limit: String(limit), sort });
          const res = await fetch('/plans/by_base?'+qs.toString(), { headers: getHeaders() });
          if (!res.ok) return;
          const js = await res.json();
          const rows = (js && js.plans) || [];
          const ul = document.getElementById('rel-list');
          if (!ul) return;
          const cur = {{ version_id | tojson | safe }};
          const items = rows.filter(p => p.version_id !== cur).map(p => `<li><a href="/ui/plans/${p.version_id}">${p.version_id}</a> <small>(${p.status||''})</small></li>`);
          ul.innerHTML = items.join('');
        } catch(e) { /* noop */ }
      }
      document.getElementById('rel-apply')?.addEventListener('click', async function(){ await loadRelated(); applyDiffLinks(); });
      document.getElementById('diff-apply')?.addEventListener('click', applyDiffLinks);
      // Initial load
      loadRelated().then(applyDiffLinks).catch(()=>{});
    })();
    </script>
    </div>
    <div id="tab-psi" class="tab-pane" style="display:none;">
    <details open>
      <summary>PSI (view & edit)</summary>
      <div class="tab-toolbar">
        <label>Level
          <select id="psiLevel">
            <option value="aggregate">aggregate (family × period)</option>
            <option value="det">detail (sku × week)</option>
          </select>
        </label>
        <label>Filter<input id="psiQ" type="search" placeholder="Search text"></label>
        <label>Limit<input id="psiLimit" type="number" min="10" value="200"></label>
        <button id="psiReload" type="button">Reload</button>
        <button id="psiSave" type="button" class="secondary">Save changes</button>
        <button id="psiRecon" type="button">Apply &amp; reconcile</button>
        <a id="psiCsvExport" class="secondary" href="#" download>Export CSV</a>
        <label>Lock mode
          <select id="psiLockMode">
            <option value="">(none)</option>
            <option value="lock">lock</option>
            <option value="unlock">unlock</option>
            <option value="toggle">toggle</option>
          </select>
        </label>
        <button id="psiLockCell" type="button" class="secondary">Lock cell</button>
        <button id="psiUnlockCell" type="button" class="secondary">Unlock cell</button>
        <button id="psiUnlockAll" type="button" class="secondary">Unlock all</button>
        <small class="mono" id="psiMeta"></small>
        <small class="mono" id="psiLegend">Legend: ✎ editable / gray = read-only / yellow = unsaved edits</small>
      </div>
      <div class="tab-scroll">
        <table id="tblPSI" style="min-width:960px;"></table>
      </div>
      <details>
        <summary>Reconciliation options (adjusted / MRP)</summary>
        <div class="grid" style="align-items:end;">
          <label><input type="checkbox" id="psiAdj"> apply_adjusted</label>
          <label><input type="checkbox" id="psiMRP"> recalc_mrp</label>
          <label>lt_unit
            <select id="psiLtUnit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
          <label>weeks<input type="number" id="psiWeeks" min="1" value="4"></label>
          <label>cutover_date<input type="date" id="psiCutover"></label>
          <label>recon_window_days<input type="number" id="psiRwd" min="0"></label>
          <label>anchor_policy
            <select id="psiAnchor">
              <option value="">(unspecified)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>tol_abs<input type="number" step="0.000001" id="psiTolAbs" placeholder="1e-6"></label>
          <label>tol_rel<input type="number" step="0.000001" id="psiTolRel" placeholder="1e-6"></label>
          <label>calendar_mode
            <select id="psiCal">
              <option value="">(unspecified)</option>
              <option value="simple">simple</option>
              <option value="iso">iso</option>
            </select>
          </label>
          <label>carryover
            <select id="psiCarry">
              <option value="">(unspecified)</option>
              <option value="auto">auto</option>
              <option value="prev">prev</option>
              <option value="next">next</option>
              <option value="both">both</option>
            </select>
          </label>
          <label>carryover_split<input type="number" min="0" max="1" step="0.05" id="psiCarrySplit"></label>
          <label>input_dir<input type="text" id="psiInputDir" value="samples/planning"></label>
        </div>
        <p class="mono warn-text">Note: set anchor_policy and cutover_date when running adjusted mode. Combine recalc_mrp with apply_adjusted.</p>
      </details>
      <details>
        <summary>Weights (CSV import)</summary>
        <p class="mono">Headers: key,weight (or week,sku,weight). Example key: det:week=2025-W01,sku=SKU1</p>
        <textarea id="psiWeightsCsv" rows="4" placeholder="key,weight\ndet:week=2025-W01,sku=SKU1,1\ndet:week=2025-W01,sku=SKU2,2"></textarea>
        <div class="tab-toolbar">
          <button id="psiWeightsApply" type="button">Apply weights</button>
        </div>
      </details>
      <details>
        <summary>Distribution options (Aggregate → Detail)</summary>
        <div class="grid" style="align-items:end;">
          <label>weight_mode
            <select id="psiWeight">
              <option value="current" selected>current (proportional to current)</option>
              <option value="equal">equal</option>
              <option value="demand">proportional to demand</option>
              <option value="supply_plan">proportional to supply_plan</option>
            </select>
          </label>
          <label>round demand
            <input type="number" id="psiRoundDemand" placeholder="step (e.g. 1)">
          </label>
          <label>round supply_plan
            <input type="number" id="psiRoundSupply" placeholder="step (e.g. 1)">
          </label>
          <label>round backlog
            <input type="number" id="psiRoundBacklog" placeholder="step (e.g. 1)">
          </label>
        </div>
        <p class="mono warn-text">Note: applied when aggregate rows are saved. Step values round to nearest multiples with totals rescaled.</p>
      </details>
      <details>
        <summary>CSV import (with headers, default columns)</summary>
        <p class="mono">aggregate: period,family,demand,supply,backlog | det: week,sku,demand,supply_plan,backlog,on_hand_start,on_hand_end</p>
        <textarea id="psiCsvText" rows="6" placeholder="Paste CSV"></textarea>
        <div class="tab-toolbar">
          <button id="psiCsvApply" type="button">Apply CSV (save)</button>
        </div>
      </details>
      <details>
        <summary>Audit log (recent)</summary>
        <div class="tab-toolbar">
          <label>Level
            <select id="psiAuditLevel">
              <option value="">(all)</option>
              <option value="aggregate">aggregate</option>
              <option value="det">det</option>
            </select>
          </label>
          <label>Filter<input id="psiAuditQ" type="search" placeholder="Search text"></label>
          <label>Limit<input id="psiAuditLimit" type="number" min="10" value="200"></label>
          <button id="psiAuditReload" type="button">Reload</button>
        </div>
        <div class="tab-scroll" style="max-height:320px;">
          <table id="tblPSIAudit" style="min-width:960px;"></table>
        </div>
      </details>
      <details>
        <summary>Lock manager</summary>
        <div class="tab-toolbar">
          <label>family<input id="lmFamily" type="text" placeholder="family"></label>
          <label>week_prefix<input id="lmWeek" type="text" placeholder="YYYY-W"></label>
          <label>field
            <select id="lmField">
              <option value="">(any)</option>
              <option value="demand">demand</option>
              <option value="supply_plan">supply_plan</option>
              <option value="backlog">backlog</option>
              <option value="on_hand_start">on_hand_start</option>
              <option value="on_hand_end">on_hand_end</option>
            </select>
          </label>
          <button id="lmLoad" type="button">Load locks</button>
          <button id="lmLockFiltered" type="button" class="secondary">Lock filtered</button>
          <button id="lmUnlockFiltered" type="button" class="secondary">Unlock filtered</button>
          <button id="lmUnlockSelected" type="button">Unlock selected</button>
        </div>
        <div class="tab-scroll" style="max-height:260px;">
          <table id="tblLocks" style="min-width:960px;"></table>
        </div>
      </details>
      <details>
        <summary>Approval workflow</summary>
        <div class="tab-toolbar">
          <label>note<input id="psiSubmitNote" type="text" placeholder="Submission note"></label>
          <button id="psiSubmit" type="button">Submit</button>
          <label><input type="checkbox" id="psiApproveRecon"> Run reconciliation after approval</label>
          <button id="psiApprove" type="button" class="secondary">Approve</button>
          <small class="mono warn-text">API key (localStorage.api_key) is required to approve.</small>
        </div>
        <div class="tab-toolbar">
          <button id="psiShowDiff" type="button" class="secondary">Show diff</button>
          <div id="psiDiff" class="mono" style="margin-top:6px;"></div>
        </div>
      </details>
      <p class="mono warn-text" id="psiNote">PSI edits are stored as an overlay until you run "Apply &amp; reconcile". API keys are required when executing reconciliation.</p>
    </details>
    <script>
    (function(){
      const ver = {{ version_id | tojson | safe }};
      const tbl = document.getElementById('tblPSI');
      function getHeaders(){
        const h = {'Content-Type':'application/json'};
        try { const k = localStorage.getItem('api_key') || ''; if (k) h['X-API-Key'] = k; } catch {}
        return h;
      }
      const levelEl = document.getElementById('psiLevel');
      const qEl = document.getElementById('psiQ');
      const limEl = document.getElementById('psiLimit');
      const metaEl = document.getElementById('psiMeta');
      const lockEl = document.getElementById('psiLockMode');
      const pending = new Map(); // key+field -> value
      let locks = new Set();
      function mkKey(level, r){ return level==='aggregate' ? `agg:period=${r.period},family=${r.family}` : `det:week=${r.week},sku=${r.sku}`; }
      function colSpec(level){
        if (level==='aggregate'){
          return [
            {k:'period', ro:true}, {k:'family', ro:true},
            {k:'demand'}, {k:'supply'}, {k:'backlog'}
          ];
        }
        return [
          {k:'week', ro:true}, {k:'sku', ro:true},
          {k:'demand'}, {k:'supply_plan'}, {k:'backlog'}, {k:'on_hand_start'}, {k:'on_hand_end'}
        ];
      }
      function fmt(n){ if(n===null||n===undefined||n==='') return ''; const x=Number(n); return Number.isFinite(x)? String(x): String(n); }
      function render(level, rows){
        const cols = colSpec(level);
        const thead = '<thead><tr>'+cols.map(c=>`<th>${c.k}</th>`).join('')+`<th>lock</th></tr></thead>`;
        const body = rows.map(r=>{
          const k = mkKey(level,r);
          const rowLocked = locks.has(k);
      const tds = cols.map(c=>{
          const val = r[c.k];
          const ro = c.ro || rowLocked || locks.has(`${k}:field=${c.k}`);
          const dv = fmt(val);
          if (ro) {
            const title = 'Read-only (locked or excluded)';
            return `<td data-ro="1" class="ro" data-field="${c.k}" data-key="${k}" data-value="${dv}" title="${title}" aria-label="${title}">${dv}</td>`;
          } else {
            const title = `Editable: ${c.k}`;
            return `<td contenteditable tabindex="0" class="editable" data-field="${c.k}" data-key="${k}" data-value="${dv}" title="${title}" aria-label="${title}">${dv}</td>`;
          }
          }).join('');
          const lk = rowLocked? 'checked' : '';
          return `<tr>${tds}<td><input type="checkbox" class="psi-lock" data-key="${k}" ${lk}></td></tr>`;
        }).join('');
        tbl.innerHTML = thead + '<tbody>'+body+'</tbody>';
        // Track dirty cells
        tbl.querySelectorAll('td[contenteditable]').forEach(td=>{
          td.addEventListener('focus', ev=>{ window.__psiLastCell = ev.currentTarget; });
          td.addEventListener('blur', ev=>{
            const el = ev.currentTarget; const key = el.getAttribute('data-key'); const f = el.getAttribute('data-field');
            const before = el.getAttribute('data-value')||''; const after = el.textContent.trim();
            if (after===before){ el.classList.remove('dirty'); pending.delete(key+"::"+f); return; }
            el.classList.add('dirty'); pending.set(key+"::"+f, after);
          });
        });
      }
      async function load(){
        const level = levelEl.value; const q = (qEl.value||'').trim(); const limit = parseInt(limEl.value||'200',10);
        const url = new URL(`/plans/${ver}/psi`, location.origin);
        url.searchParams.set('level', level); if(q) url.searchParams.set('q', q); url.searchParams.set('limit', String(limit)); url.searchParams.set('offset', '0');
        const res = await fetch(url.toString()); if(!res.ok) return;
        const js = await res.json(); locks = new Set(js.locks||[]);
        metaEl.textContent = `rows=${js.total}`;
        render(js.level, js.rows||[]);
        const a = document.getElementById('psiCsvExport');
        if (a){ const u = new URL(`/plans/${ver}/psi.csv`, location.origin); u.searchParams.set('level', level); a.setAttribute('href', u.toString()); a.setAttribute('download', `psi_${level}_${ver}.csv`); }
      }
      async function save(){
        const level = levelEl.value;
        // Aggregate changes per key
        const grouped = new Map();
        for (const [kf, val] of pending.entries()){
          const [key, field] = kf.split('::');
          const g = grouped.get(key) || { key: {}, fields: {} };
          // Restore key fields
          if (key.startsWith('agg:')){
            const m = /period=([^,]+),family=(.+)$/.exec(key); if (m){ g.key.period=m[1]; g.key.family=m[2]; }
          } else {
            const m = /week=([^,]+),sku=(.+)$/.exec(key); if (m){ g.key.week=m[1]; g.key.sku=m[2]; }
          }
          g.fields[field] = (val==='')? null : Number(val);
          grouped.set(key, g);
        }
        const edits = Array.from(grouped.values());
        const lock = lockEl.value || undefined;
        // Distribution options (aggregate only)
        let distribute = undefined;
        if (level === 'aggregate'){
          const wm = document.getElementById('psiWeight');
          const rd = document.getElementById('psiRoundDemand');
          const rs = document.getElementById('psiRoundSupply');
          const rb = document.getElementById('psiRoundBacklog');
          const round = {};
          if (rd && rd.value) round['demand'] = { mode:'nearest', step: Number(rd.value) };
          if (rs && rs.value) round['supply_plan'] = { mode:'nearest', step: Number(rs.value) };
          if (rb && rb.value) round['backlog'] = { mode:'nearest', step: Number(rb.value) };
          distribute = { weight_mode: (wm && wm.value)||'current', round };
        }
        if (edits.length===0 && !lock){ return; }
        const body = { level, edits, lock };
        if (distribute) body['distribute'] = distribute;
        const res = await fetch(`/plans/${ver}/psi`, { method:'PATCH', headers:getHeaders(), body: JSON.stringify(body) });
        if (!res.ok){ alert('save failed'); return; }
        pending.clear(); await load();
      }
      async function recon(){
        const body = {};
        const adj = document.getElementById('psiAdj');
        const mrp = document.getElementById('psiMRP');
        const lt = document.getElementById('psiLtUnit');
        const w = document.getElementById('psiWeeks');
        const cut = document.getElementById('psiCutover');
        const rwd = document.getElementById('psiRwd');
        const anc = document.getElementById('psiAnchor');
        const ta = document.getElementById('psiTolAbs');
        const tr = document.getElementById('psiTolRel');
        const cal = document.getElementById('psiCal');
        const cov = document.getElementById('psiCarry');
        const csv = document.getElementById('psiCarrySplit');
        const idir = document.getElementById('psiInputDir');
        body.apply_adjusted = !!(adj && adj.checked);
        body.recalc_mrp = !!(mrp && mrp.checked);
        body.lt_unit = lt ? lt.value : 'day';
        body.weeks = w ? Number(w.value||4) : 4;
        body.cutover_date = cut && cut.value ? cut.value : undefined;
        body.recon_window_days = rwd && rwd.value!=='' ? Number(rwd.value) : undefined;
        body.anchor_policy = anc && anc.value ? anc.value : undefined;
        body.tol_abs = ta && ta.value!=='' ? Number(ta.value) : undefined;
        body.tol_rel = tr && tr.value!=='' ? Number(tr.value) : undefined;
        body.calendar_mode = cal && cal.value ? cal.value : undefined;
        body.carryover = cov && cov.value ? cov.value : undefined;
        body.carryover_split = csv && csv.value!=='' ? Number(csv.value) : undefined;
        body.input_dir = idir && idir.value ? idir.value : 'samples/planning';
        const res = await fetch(`/plans/${ver}/psi/reconcile`, { method:'POST', headers:getHeaders(), body: JSON.stringify(body) });
        if (!res.ok){
          let msg = '';
          try { msg = await res.text(); } catch(e) { msg = ''; }
          alert(`reconcile failed: ${res.status} ${msg?.slice(0,300) || ''}`);
          return;
        }
        const js = await res.json();
        alert('reconciled: violations='+(js.summary && (js.summary.violations||js.summary.tol_violations||0)));
      }
      document.getElementById('psiReload')?.addEventListener('click', load);
      document.getElementById('psiSave')?.addEventListener('click', save);
      document.getElementById('psiRecon')?.addEventListener('click', recon);
      function lockCell(mode){
        const el = window.__psiLastCell; if (!el){ alert('Select a cell first.'); return; }
        const key = el.getAttribute('data-key'); const f = el.getAttribute('data-field');
        if (!key || !f){ return; }
        const lock_keys = [`${key}:field=${f}`];
        fetch(`/plans/${ver}/psi`, { method:'PATCH', headers:getHeaders(), body: JSON.stringify({ level: levelEl.value, edits: [], lock: mode, lock_keys }) })
          .then(()=> load());
      }
      document.getElementById('psiLockCell')?.addEventListener('click', ()=> lockCell('lock'));
      document.getElementById('psiUnlockCell')?.addEventListener('click', ()=> lockCell('unlock'));
      document.getElementById('psiUnlockAll')?.addEventListener('click', async ()=>{
        const keys = Array.from(locks);
        if (!keys.length) return;
        await fetch(`/plans/${ver}/psi`, { method:'PATCH', headers:getHeaders(), body: JSON.stringify({ level: levelEl.value, edits: [], lock: 'unlock', lock_keys: keys }) });
        await load();
      });
      document.getElementById('psiCsvApply')?.addEventListener('click', async function(){
        const level = levelEl.value;
        const ta = document.getElementById('psiCsvText'); const txt = (ta && ta.value)||''; if(!txt.trim()) return;
        const lines = txt.trim().split(/\r?\n/);
        if(lines.length<2){ alert('Header plus at least one row is required.'); return; }
        const header = lines[0].split(',').map(s=>s.trim());
        const idx = (name)=> header.indexOf(name);
        const edits = [];
        for (let i=1;i<lines.length;i++){
          const cols = lines[i].split(',');
          if (level==='aggregate'){
            const key = { period: cols[idx('period')], family: cols[idx('family')] };
            const fields = {};
            ['demand','supply','backlog'].forEach(k=>{ const j = idx(k); if(j>=0){ const v = cols[j].trim(); fields[k] = v===''? null: Number(v); }});
            edits.push({ key, fields });
          } else {
            const key = { week: cols[idx('week')], sku: cols[idx('sku')] };
            const fields = {};
            ['demand','supply_plan','backlog','on_hand_start','on_hand_end'].forEach(k=>{ const j = idx(k); if(j>=0){ const v = cols[j].trim(); fields[k] = v===''? null: Number(v); }});
            edits.push({ key, fields });
          }
        }
        const res = await fetch(`/plans/${ver}/psi`, { method:'PATCH', headers:getHeaders(), body: JSON.stringify({ level, edits }) });
        if (!res.ok){ alert('Failed to apply CSV.'); return; }
        ta.value=''; await load();
      });
      async function loadAudit(){
        const level = document.getElementById('psiAuditLevel')?.value || '';
        const q = (document.getElementById('psiAuditQ')?.value||'').trim();
        const limit = Number(document.getElementById('psiAuditLimit')?.value||'200');
        const url = new URL(`/plans/${ver}/psi/audit`, location.origin);
        if (level) url.searchParams.set('level', level); if (q) url.searchParams.set('q', q); url.searchParams.set('limit', String(limit));
        const res = await fetch(url.toString()); if (!res.ok) return;
        const js = await res.json();
        const rows = js.events||[];
        const tblA = document.getElementById('tblPSIAudit'); if(!tblA) return;
        const head = '<thead><tr><th>ts</th><th>level</th><th>type</th><th>key(s)</th><th>fields/lock</th></tr></thead>';
        const body = rows.map(r=>{
          const ts = r.ts? new Date(Number(r.ts)).toISOString(): '';
          const typ = r.lock ? 'lock' : 'edit';
          const keys = r.keys? JSON.stringify(r.keys): JSON.stringify(r.key);
          const meta = r.lock? r.lock : JSON.stringify(r.fields);
          return `<tr><td class="mono">${ts}</td><td class="mono">${r.level||''}</td><td class="mono">${typ}</td><td class="mono">${keys||''}</td><td class="mono">${meta||''}</td></tr>`;
        }).join('');
        tblA.innerHTML = head + '<tbody>'+body+'</tbody>';
      }
      document.getElementById('psiAuditReload')?.addEventListener('click', loadAudit);
      document.getElementById('psiSubmit')?.addEventListener('click', async function(){
        const note = (document.getElementById('psiSubmitNote')?.value)||'';
        const res = await fetch(`/plans/${ver}/psi/submit`, { method:'POST', headers:getHeaders(), body: JSON.stringify({ note }) });
        if (!res.ok){ alert('Submission failed.'); return; }
        alert('Submitted.');
      });
      document.getElementById('psiApprove')?.addEventListener('click', async function(){
        const auto = !!(document.getElementById('psiApproveRecon')?.checked);
        const res = await fetch(`/plans/${ver}/psi/approve`, { method:'POST', headers:getHeaders(), body: JSON.stringify({ auto_reconcile: auto }) });
        if (!res.ok){ alert('Approval failed.'); return; }
        alert('Approved.');
      });
      document.getElementById('psiWeightsApply')?.addEventListener('click', async function(){
        const ta = document.getElementById('psiWeightsCsv'); const txt = (ta && ta.value) || '';
        if (!txt.trim()) return;
        const res = await fetch(`/plans/${ver}/psi/weights`, { method:'POST', headers:getHeaders(), body: JSON.stringify({ csv: txt }) });
        if (!res.ok){ alert('Weights application failed.'); return; }
        alert('Weights applied.');
      });
      // Toggle lock state using checkboxes (applies when lockMode is provided)
      tbl.addEventListener('change', ev=>{
        const t = ev.target; if (!t || !t.classList || !t.classList.contains('psi-lock')) return;
        // Default lock mode to toggle when unset so changes are applied
        if (!lockEl.value) lockEl.value = 'toggle';
      });
      // Initial load
      load().catch(()=>{});
    })();
    </script>
    </div>

    <div id="tab-disaggregate" class="tab-pane" style="display:none;">
    <details open>
      <summary>Disaggregate (SKU × week)</summary>
      <div class="tab-toolbar">
        <input id="skuFilter" type="search" placeholder="SKU filter" aria-label="SKU filter">
        <input id="weekFilter" type="search" placeholder="Week filter (e.g. 2025-W01)" aria-label="Week filter">
        <small class="mono" id="disaggMeta"></small>
        <small class="mono">Showing first 200 rows ({{ disagg_total or 0 }} total)</small>
      </div>
      {% if disagg_rows %}
      <table id="tblDisagg">
        <thead><tr><th>week</th><th>sku</th><th>demand</th><th>supply_plan</th><th>backlog</th><th>on_hand_start</th><th>on_hand_end</th></tr></thead>
        <tbody>
          {% for r in disagg_rows %}
          <tr>
            <td class="mono">{{ r.week }}</td>
            <td class="mono">{{ r.sku }}</td>
            <td class="mono">{{ r.demand }}</td>
            <td class="mono">{{ r.supply_plan }}</td>
            <td class="mono">{{ r.backlog }}</td>
            <td class="mono">{{ r.on_hand_start }}</td>
            <td class="mono">{{ r.on_hand_end }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No detail rows yet. Execute the plan to populate this table.</p>
      {% endif %}
    </details>
    </div>

    <div id="tab-schedule" class="tab-pane" style="display:none;">
    <details open>
      <summary>Scheduled receipts</summary>
      <div class="tab-toolbar mono">
        <input id="schedSku" type="search" placeholder="SKU filter" aria-label="SKU filter">
        <input id="schedWeek" type="search" placeholder="Week filter (e.g. 2025-W01)" aria-label="Week filter">
        <small id="schedMeta"></small>
        <a class="secondary" href="/plans/{{ version_id }}/schedule.csv" target="_blank">schedule.csv</a>
        <button type="button" class="secondary copy" data-href="/plans/{{ version_id }}/schedule.csv" title="Copy URL" aria-label="Copy schedule.csv URL">copy</button>
        <small>Showing first 200 rows ({{ schedule_total or 0 }} total)</small>
      </div>
      {% if schedule_rows %}
      <table id="tblSchedule">
        <thead><tr><th>week</th><th>sku</th><th>scheduled_receipts</th><th>on_hand_start</th><th>on_hand_end</th></tr></thead>
        <tbody>
          {% for r in schedule_rows %}
          <tr>
            <td class="mono">{{ r.week }}</td>
            <td class="mono">{{ r.sku }}</td>
            <td class="mono">{{ r.scheduled_receipts }}</td>
            <td class="mono">{{ r.on_hand_start }}</td>
            <td class="mono">{{ r.on_hand_end }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No schedule rows yet. Execute the plan to populate this table.</p>
      {% endif %}
    </details>
    </div>

    <div id="tab-validate" class="tab-pane" style="display:none;">
    <details open>
      <summary>Validation (MVP)</summary>
      {% if validate %}
      <div class="grid" style="grid-template-columns: repeat(3, minmax(180px, 1fr)); gap:8px;">
        <article>
          <header>Tolerance violations (before/after)</header>
          <strong class="mono">{{ validate.tol_violations_before if validate.tol_violations_before is not none else '-' }} → {{ validate.tol_violations_after if validate.tol_violations_after is not none else '-' }}</strong>
          <footer><a class="secondary" href="/plans/{{ version_id }}/compare?violations_only=true&sort=rel_desc&limit=200" target="_blank">compare (violations)</a></footer>
        </article>
        <article>
          <header>Negative inventory rows</header>
          <strong class="mono">{{ validate.neg_inventory_rows or 0 }}</strong>
          <footer><em class="mono">mrp rows={{ validate.mrp_total_rows or 0 }}</em></footer>
        </article>
        <article>
          <header>Fractional scheduled receipts</header>
          <strong class="mono">{{ validate.fractional_receipts_rows or 0 }}</strong>
        </article>
        <article>
          <header>Capacity over-utilization (weeks)</header>
          <strong class="mono">{{ validate.capacity_over_weeks or 0 }}</strong>
          <footer><em class="mono">weekly rows={{ validate.weekly_total_rows or 0 }}</em></footer>
        </article>
      </div>
      {% else %}
      <p>No validation metrics yet. Run the plan to populate these figures.</p>
      {% endif %}
    </details>
    </div>
    <div id="tab-execute" class="tab-pane" style="display:none;">
    <details open>
      <summary>Reconcile (parameter overrides)</summary>
      <form method="post" action="/ui/plans/{{ version_id }}/reconcile">
        <div class="grid">
          <label>cutover_date<input type="date" name="cutover_date" value="{{ version.cutover_date or '' }}"></label>
          <label>recon_window_days<input type="number" name="recon_window_days" min="0" value="{{ version.recon_window_days or '' }}"></label>
          <label>anchor_policy
            <select name="anchor_policy">
              <option value="">(unspecified)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="default 1e-6"></label>
          <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="default 1e-6"></label>
          <label>calendar_mode
            <select name="calendar_mode">
              <option value="">(unspecified)</option>
              <option value="simple">simple</option>
              <option value="iso">iso</option>
            </select>
          </label>
          <label>carryover
            <select name="carryover">
              <option value="">(unspecified)</option>
              <option value="auto">auto</option>
              <option value="prev">prev</option>
              <option value="next">next</option>
              <option value="both">both</option>
            </select>
          </label>
          <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split"></label>
          <label>input_dir<input type="text" name="input_dir" value="samples/planning"></label>
          <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
          <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
          <label>lt_unit
            <select name="lt_unit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
        </div>
        <button type="submit" aria-label="Run reconciliation">Run reconciliation</button>
      </form>
    </details>

    <details>
      <summary>Integrated run (new plan version)</summary>
      <form method="post" action="/ui/plans/run">
        <div class="grid" style="align-items:end;">
          <label>input_dir<input type="text" name="input_dir" value="samples/planning"></label>
          <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
          <label>lt_unit
            <select name="lt_unit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
          <label>cutover_date<input type="date" name="cutover_date"></label>
          <label>recon_window_days<input type="number" name="recon_window_days" min="0"></label>
          <label>anchor_policy
            <select name="anchor_policy">
              <option value="">(unspecified)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="default 1e-6"></label>
          <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="default 1e-6"></label>
          <label>calendar_mode
            <select name="calendar_mode">
              <option value="">(unspecified)</option>
              <option value="simple">simple</option>
              <option value="iso">iso</option>
            </select>
          </label>
          <label>carryover
            <select name="carryover">
              <option value="">(unspecified)</option>
              <option value="auto">auto</option>
              <option value="prev">prev</option>
              <option value="next">next</option>
              <option value="both">both</option>
            </select>
          </label>
          <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split"></label>
          <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
        </div>
        <button type="submit" aria-label="Run immediately">Run now</button>
      </form>
      <form id="queue-run-form" class="grid-form gap-top-sm" onsubmit="return queueRunViaRunsApi(event)">
        <div class="grid" style="align-items:end;">
          <label>input_dir<input type="text" name="input_dir" value="samples/planning"></label>
          <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
          <label>lt_unit
            <select name="lt_unit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
          <label>cutover_date<input type="date" name="cutover_date"></label>
          <label>recon_window_days<input type="number" name="recon_window_days" min="0"></label>
          <label>anchor_policy
            <select name="anchor_policy">
              <option value="">(unspecified)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
        </div>
        <button type="submit" class="secondary" aria-label="Queue job">Queue job</button>
        <p class="mono">After queuing, monitor progress via <a href="/ui/jobs" target="_blank" rel="noopener">/ui/jobs</a>.</p>
      </form>
      <script>
      async function queueRunViaRunsApi(ev){
        ev.preventDefault();
        try{
          const f = document.getElementById('queue-run-form');
          const fd = new FormData(f);
          function val(name){ const v = fd.get(name); return (v===null||v==='')?undefined:String(v); }
          function valNum(name){ const v = val(name); return v===undefined?undefined:Number(v); }
          function valBool(name){ return fd.get(name) ? true : false; }
          const body = {
            pipeline: 'integrated',
            async: true,
            options: {
              input_dir: val('input_dir') || 'samples/planning',
              weeks: valNum('weeks')||4,
              lt_unit: val('lt_unit')||'day',
              cutover_date: val('cutover_date')||undefined,
              recon_window_days: valNum('recon_window_days'),
              anchor_policy: val('anchor_policy')||undefined,
              apply_adjusted: valBool('apply_adjusted')
            }
          };
          const res = await fetch('/runs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
          if (!res.ok){
            const txt = await res.text();
            alert('Queue failed: '+txt);
            return false;
          }
          const data = await res.json();
          if (data && data.location){ window.location.href = data.location; }
          else { alert('Queued.'); }
        }catch(e){ alert('Queue failed.'); }
        return false;
      }
      </script>
    </details>

    <details>
      <summary>Plan &amp; Run (auto completion)</summary>
      <form method="post" action="/ui/plans/{{ version_id }}/plan_run_auto" class="toolbar gap-top-sm">
        <label>input_dir<input type="text" name="input_dir" value="samples/planning"></label>
        <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
        <label>lt_unit
          <select name="lt_unit">
            <option value="day" selected>day</option>
            <option value="week">week</option>
          </select>
        </label>
        <label>cutover_date<input type="date" name="cutover_date"></label>
        <label>recon_window_days<input type="number" name="recon_window_days" min="0"></label>
        <label>anchor_policy
          <select name="anchor_policy">
            <option value="">(unspecified)</option>
            <option value="DET_near">DET_near</option>
            <option value="AGG_far">AGG_far</option>
            <option value="blend">blend</option>
          </select>
        </label>
        <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="default 1e-6"></label>
        <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="default 1e-6"></label>
        <label>calendar_mode
          <select name="calendar_mode">
            <option value="">(unspecified)</option>
            <option value="simple">simple</option>
            <option value="iso">iso</option>
          </select>
        </label>
        <label>carryover
          <select name="carryover">
            <option value="">(unspecified)</option>
            <option value="auto">auto</option>
            <option value="prev">prev</option>
            <option value="next">next</option>
            <option value="both">both</option>
          </select>
        </label>
        <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split"></label>
        <label><input type="checkbox" name="apply_adjusted" value="1"> Include adjusted detail</label>
        <label><input type="checkbox" name="queue_job" value="1"> Execute as job (async)</label>
        <button type="submit" class="contrast" aria-label="Run Plan & Run">Run Plan &amp; Run</button>
        <small class="mono">Note: inherits cutover/window/policy from the current plan when possible.</small>
      </form>
    </details>
    </div>

    <div id="tab-overview" class="tab-pane">
    <details open>
      <summary>Summary</summary>
      <table>
        <thead><tr><th>Item</th><th>Value</th></tr></thead>
        <tbody>
          <tr><td>status</td><td>{{ version.status or '' }}</td></tr>
          <tr><td>config_version_id</td><td class="mono">{% if config_version_id %}<a href="/ui/configs/canonical/{{ config_version_id }}">{{ config_version_id }}</a>{% else %}-{% endif %}</td></tr>
          <tr><td>base_scenario_id</td><td class="mono">{% if version.base_scenario_id %}<a href="/ui/scenarios?highlight={{ version.base_scenario_id }}">{{ version.base_scenario_id }}</a>{% else %}-{% endif %}</td></tr>
          {% if created_from_run_id %}
            <tr><td>created_from_run</td><td class="mono"><a href="/ui/runs/{{ created_from_run_id }}">{{ created_from_run_id }}</a></td></tr>
          {% endif %}
          <tr><td>cutover_date</td><td class="mono">{{ version.cutover_date or '' }}</td></tr>
          <tr><td>recon_window_days</td><td class="mono">{{ version.recon_window_days or '' }}</td></tr>
          {% if recon and recon.summary %}
            <tr><td>violations(before)</td><td class="mono">{{ recon.summary.tol_violations }}</td></tr>
            <tr><td>max|Δ| (before)</td><td class="mono">({{ recon.summary.max_abs_delta.demand }}, {{ recon.summary.max_abs_delta.supply }}, {{ recon.summary.max_abs_delta.backlog }})</td></tr>
          {% endif %}
          {% if recon_adj and recon_adj.summary %}
            <tr><td>violations(after)</td><td class="mono">{{ recon_adj.summary.tol_violations }}</td></tr>
            <tr><td>max|Δ| (after)</td><td class="mono">({{ recon_adj.summary.max_abs_delta.demand }}, {{ recon_adj.summary.max_abs_delta.supply }}, {{ recon_adj.summary.max_abs_delta.backlog }})</td></tr>
          {% endif %}
          <tr><td>state</td><td class="mono">{{ plan_state.state if plan_state and plan_state.state else (version.status or 'draft') }}{% if plan_state and plan_state.invalid and plan_state.invalid|length>0 %} | invalid: {{ plan_state.invalid|join(', ') }}{% endif %}</td></tr>
        </tbody>
      </table>
      {% if related_plans and related_plans|length > 0 %}
      <div class="gap-top-sm">
        <strong>Related plans (same base_scenario, latest):</strong>
        <ul>
          {% for p in related_plans %}
          <li class="mono"><a href="/ui/plans/{{ p.version_id }}">{{ p.version_id }}</a> <small>({{ p.status or '' }})</small>
            | <a class="secondary" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=200" target="_blank" title="Diff against current plan (violations only, rel_desc)">diff</a>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if plan_runs and plan_runs|length > 0 %}
      <div class="gap-top-sm">
        <strong>Runs created from this plan</strong>
        <table>
          <thead><tr><th>run_id</th><th>started_at</th><th>fill_rate</th><th>profit_total</th><th>link</th></tr></thead>
          <tbody>
            {% for r in plan_runs %}
            <tr>
              <td class="mono">{{ r.run_id }}</td>
              <td class="mono ts-ms" data-ms="{{ r.started_at or '' }}">{{ r.started_at_str or r.started_at or '' }}</td>
              <td class="mono">{{ r.fill_rate if r.fill_rate is not none else '' }}</td>
              <td class="mono">{{ r.profit_total if r.profit_total is not none else '' }}</td>
              <td><a class="secondary" href="/ui/runs/{{ r.run_id }}" target="_blank">open</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if plan_run_ids and plan_run_ids|length >= 2 %}
        <form method="post" action="/ui/compare" class="tab-toolbar">
          <input type="hidden" name="run_ids" value="{{ plan_run_ids[0] }},{{ plan_run_ids[1] }}">
          <button type="submit" aria-label="Compare latest plan runs">Compare latest plan runs</button>
          <label><input type="checkbox" class="sel-copy" data-href="/ui/compare/metrics.csv?run_ids={{ plan_run_ids[0] }},{{ plan_run_ids[1] }}"> metrics.csv</label>
          <button type="button" class="secondary copy" data-href="/ui/compare/metrics.csv?run_ids={{ plan_run_ids[0] }},{{ plan_run_ids[1] }}" title="Copy URL" aria-label="Copy URL">copy</button>
          <label><input type="checkbox" class="sel-copy" data-href="/ui/compare/diffs.csv?run_ids={{ plan_run_ids[0] }},{{ plan_run_ids[1] }}&threshold=5"> diffs.csv (±5%)</label>
          <button type="button" class="secondary copy" data-href="/ui/compare/diffs.csv?run_ids={{ plan_run_ids[0] }},{{ plan_run_ids[1] }}&threshold=5" title="Copy URL" aria-label="Copy URL">copy</button>
          <button type="button" class="secondary copy-runs-all" data-run-ids="{{ plan_run_ids[0] }},{{ plan_run_ids[1] }}" title="Copy both links" aria-label="Copy both links">copy all</button>
          <button type="button" class="secondary copy-selected" title="Copy selected links" aria-label="Copy selected links">copy selected</button>
        </form>
        {% endif %}
      </div>
      {% endif %}
      {% if canonical_meta %}
      <div class="gap-top-sm">
        <strong>Canonical configuration</strong>
        <table>
          <tbody>
            <tr><td>schema_version</td><td class="mono">{{ canonical_meta.get('schema_version', '') }}</td></tr>
            <tr><td>name</td><td class="mono">{{ canonical_meta.get('name', '') }}</td></tr>
            <tr><td>status</td><td class="mono">{{ canonical_meta.get('status', '') }}</td></tr>
            <tr><td>description</td><td>{{ canonical_meta.get('description', '') }}</td></tr>
            {% if canonical_counts %}
              <tr><td colspan="2">
                <small class="mono">counts: items={{ canonical_counts.get('items', 0) }}, nodes={{ canonical_counts.get('nodes', 0) }}, arcs={{ canonical_counts.get('arcs', 0) }}, bom={{ canonical_counts.get('bom', 0) }}, demands={{ canonical_counts.get('demands', 0) }}, capacities={{ canonical_counts.get('capacities', 0) }}</small>
              </td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% endif %}
      {% if planning_summary %}
      <div class="gap-top-sm">
        <strong>Planning inputs (aggregate)</strong>
        <table>
          <tbody>
            <tr><td>schema_version</td><td class="mono">{{ planning_summary.get('schema_version', '') }}</td></tr>
            <tr><td>demand_family</td><td class="mono">{{ planning_summary.get('demand_family', 0) }}</td></tr>
            <tr><td>capacity</td><td class="mono">{{ planning_summary.get('capacity', 0) }}</td></tr>
            <tr><td>mix_share</td><td class="mono">{{ planning_summary.get('mix_share', 0) }}</td></tr>
            <tr><td>item_master</td><td class="mono">{{ planning_summary.get('item_master', 0) }}</td></tr>
            <tr><td>inventory</td><td class="mono">{{ planning_summary.get('inventory', 0) }}</td></tr>
            <tr><td>open_po</td><td class="mono">{{ planning_summary.get('open_po', 0) }}</td></tr>
          </tbody>
        </table>
      </div>
      {% endif %}
      {% if config_runs and config_runs|length > 0 %}
      <div class="gap-top-sm">
        <strong>Recent runs using this config version</strong>
        <ul>
          {% for r in config_runs %}
          <li class="mono"><a href="/ui/runs/{{ r.run_id }}">{{ r.run_id }}</a> <small>({{ r.started_at_str or r.started_at or '' }})</small></li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      <div class="tab-toolbar">
        <label>Sort related plans
          <select id="rel-sort">
            <option value="created_desc" selected>created_desc</option>
            <option value="created_asc">created_asc</option>
            <option value="status">status</option>
          </select>
        </label>
        <label>Limit
          <input id="rel-limit" class="input-compact-sm" type="number" min="1" max="50" value="5" />
        </label>
        <button id="rel-apply" type="button" class="secondary">Apply</button>
      </div>
      <ul id="rel-list" class="mono gap-top-sm"></ul>
      <div class="tab-toolbar">
        <label>Diff sort
          <select id="diff-sort">
            <option value="rel_desc" selected>rel_desc</option>
            <option value="abs_desc">abs_desc</option>
            <option value="rel_asc">rel_asc</option>
            <option value="abs_asc">abs_asc</option>
          </select>
        </label>
        <label><input type="checkbox" id="diff-viol" checked> violations_only</label>
        <button id="diff-apply" type="button" class="secondary">Update links</button>
      </div>
    </details>
    <details>
      <summary>State management (MVP)</summary>
      <form method="post" action="/ui/plans/{{ version_id }}/state/advance" class="tab-toolbar">
        <label>Advance to
          <select name="to">
            <option value="draft">draft</option>
            <option value="aggregated">aggregated</option>
            <option value="disaggregated">disaggregated</option>
            <option value="scheduled">scheduled</option>
            <option value="executed">executed</option>
          </select>
        </label>
        <button type="submit">Advance</button>
      </form>
      <form method="post" action="/ui/plans/{{ version_id }}/state/invalidate" class="tab-toolbar">
        <label>Invalidate from
          <select name="from_step">
            <option value="draft">draft</option>
            <option value="aggregated">aggregated</option>
            <option value="disaggregated">disaggregated</option>
            <option value="scheduled">scheduled</option>
            <option value="executed">executed</option>
          </select>
        </label>
        <button type="submit" class="secondary">Invalidate</button>
      </form>
    </details>
    {% if kpi_preview %}
    <section class="gap-top-sm">
      <h4>MVP: KPI preview</h4>
      <div class="grid" style="grid-template-columns: repeat(3, minmax(180px, 1fr)); gap:8px;">
        <article>
          <header>Total capacity</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.capacity_total or 0) }}</strong>
        </article>
        <article>
          <header>Total load (adjusted)</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.adjusted_total or 0) }}</strong>
        </article>
        <article>
          <header>Capacity utilization</header>
          <strong class="mono">{{ ('%.1f%%'|format(kpi_preview.util_pct)) if kpi_preview.util_pct is not none else '-' }}</strong>
        </article>
        <article>
          <header>Total spill_in</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.spill_in_total or 0) }}</strong>
        </article>
        <article>
          <header>Total spill_out</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.spill_out_total or 0) }}</strong>
        </article>
        <article>
          <header>Violations before / after</header>
          <strong class="mono">{{ kpi_preview.viol_before or 0 }} → {{ kpi_preview.viol_after if kpi_preview.viol_after is not none else '-' }}</strong>
        </article>
        <article>
          <header>Total demand (DET)</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.det_demand_total or 0) }}</strong>
        </article>
        <article>
          <header>Total supply (DET)</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.det_supply_total or 0) }}</strong>
        </article>
        <article>
          <header>Service level (DET, est.)</header>
          <strong class="mono">{{ ('%.1f%%'|format(kpi_preview.sl_pct)) if kpi_preview.sl_pct is not none else '-' }}</strong>
        </article>
        <article>
          <header>Total backlog (DET)</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.det_backlog_total or 0) }}</strong>
        </article>
        <article>
          <header>Total inventory (MRP opening)</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.inv_initial_total if kpi_preview.inv_initial_total is not none else 0) }}</strong>
        </article>
      </div>
      {% if kpi_preview.window_days %}
        <p class="mono">window_days={{ kpi_preview.window_days }} | policy={{ kpi_preview.anchor_policy or '(none)' }}</p>
      {% endif %}
    </section>
    {% endif %}
    <div class="mono" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <span>Exports:</span>
      <label><input type="checkbox" class="sel-copy" data-href="/plans/{{ version_id }}/summary"> summary.json</label>
      <button type="button" class="secondary copy" data-href="/plans/{{ version_id }}/summary" title="Copy URL" aria-label="Copy URL">copy</button>
      |
      <label><input type="checkbox" class="sel-copy" data-href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=rel_desc&limit=1000"> compare.csv</label>
      <button type="button" class="secondary copy" data-href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=rel_desc&limit=1000" title="Copy URL" aria-label="Copy URL">copy</button>
      |
      <label><input type="checkbox" class="sel-copy" data-href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=abs_desc&limit=1000"> violations.csv</label>
      <button type="button" class="secondary copy" data-href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=abs_desc&limit=1000" title="Copy URL" aria-label="Copy URL">copy</button>
      |
      <label><input type="checkbox" class="sel-copy" data-href="/plans/{{ version_id }}/carryover.csv"> carryover.csv</label>
      <button type="button" class="secondary copy" data-href="/plans/{{ version_id }}/carryover.csv" title="Copy URL" aria-label="Copy URL">copy</button>
      |
      <button type="button" class="secondary copy-all" data-version="{{ version_id }}" title="Copy all primary links" aria-label="Copy all primary links">copy all</button>
      <button type="button" class="secondary copy-selected" title="Copy selected links" aria-label="Copy selected links">copy selected</button>
    </div>
    </div>

    <div id="tab-results" class="tab-pane" style="display:none;">
    <details open>
      <summary>Latest runs (base_scenario)</summary>
      {% if version.base_scenario_id %}
        {% if latest_runs and latest_runs|length > 0 %}
          <table>
            <thead><tr><th>run_id</th><th>started_at</th><th>fill_rate</th><th>profit_total</th><th>link</th></tr></thead>
            <tbody>
              {% for r in latest_runs %}
              <tr>
                <td class="mono">{{ r.run_id }}</td>
                <td class="mono ts-ms" data-ms="{{ r.started_at or '' }}">{{ r.started_at or '' }}</td>
                <td class="mono">{{ r.fill_rate }}</td>
                <td class="mono">{{ r.profit_total }}</td>
                <td><a class="secondary" href="/ui/runs/{{ r.run_id }}" target="_blank">open</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% if latest_run_ids and latest_run_ids|length >= 2 %}
          <form method="post" action="/ui/compare" class="tab-toolbar">
            <input type="hidden" name="run_ids" value="{{ latest_run_ids[0] }},{{ latest_run_ids[1] }}">
            <button type="submit" aria-label="Compare latest two runs">Compare latest two runs</button>
            <label><input type="checkbox" class="sel-copy" data-href="/ui/compare/metrics.csv?run_ids={{ latest_run_ids[0] }},{{ latest_run_ids[1] }}"> metrics.csv</label>
            <button type="button" class="secondary copy" data-href="/ui/compare/metrics.csv?run_ids={{ latest_run_ids[0] }},{{ latest_run_ids[1] }}" title="Copy URL" aria-label="Copy URL">copy</button>
            <label><input type="checkbox" class="sel-copy" data-href="/ui/compare/diffs.csv?run_ids={{ latest_run_ids[0] }},{{ latest_run_ids[1] }}&threshold=5"> diffs.csv (±5%)</label>
            <button type="button" class="secondary copy" data-href="/ui/compare/diffs.csv?run_ids={{ latest_run_ids[0] }},{{ latest_run_ids[1] }}&threshold=5" title="Copy URL" aria-label="Copy URL">copy</button>
            <button type="button" class="secondary copy-runs-all" data-run-ids="{{ latest_run_ids[0] }},{{ latest_run_ids[1] }}" title="Copy both links" aria-label="Copy both links">copy all</button>
            <button type="button" class="secondary copy-selected" title="Copy selected links" aria-label="Copy selected links">copy selected</button>
          </form>
          {% endif %}
        {% else %}
          <p>No runs found for this scenario. Visit <a href="/ui/runs" target="_blank" rel="noopener">/ui/runs</a>.</p>
        {% endif %}
      {% else %}
        <p>This plan has no base_scenario_id.</p>
      {% endif %}
    </details>
    {% if weekly_summary %}
    <details>
      <summary>Capacity summary (weekly_summary)</summary>
      {% if boundary_summary %}
        <p class="mono">boundary: period={{ boundary_summary.period }} ｜ weeks={{ boundary_summary.weeks }} ｜ pre={{ boundary_summary.pre_weeks }} ｜ post={{ boundary_summary.post_weeks }} ｜ policy={{ boundary_summary.anchor_policy or '(none)' }} ｜ window={{ boundary_summary.window_days or 0 }} days</p>
      {% endif %}
      <table>
        <thead><tr><th>week</th><th>zone</th><th>b_idx</th><th>b_size</th><th>in_pre</th><th>in_post</th><th>capacity</th><th>original_load</th><th>adjusted_load</th><th>spill_in</th><th>spill_out</th></tr></thead>
        <tbody>
          {% for r in weekly_summary %}
          <tr>
            <td>{{ r.week }}</td>
            <td class="mono">{{ r.zone or '' }}</td>
            <td class="mono">{{ r.boundary_index or '' }}</td>
            <td class="mono">{{ r.boundary_size or '' }}</td>
            <td class="mono">{{ r.in_window_pre or '' }}</td>
            <td class="mono">{{ r.in_window_post or '' }}</td>
            <td class="mono">{{ r.capacity }}</td>
            <td class="mono">{{ r.original_load }}</td>
            <td class="mono">{{ r.adjusted_load }}</td>
            <td class="mono">{{ r.spill_in }}</td>
            <td class="mono">{{ r.spill_out }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </details>
    {% endif %}
    </div>

    {% if deltas %}
    <details open>
      <summary>Before diff (top 50)</summary>
      <p class="mono"><a href="/plans/{{ version_id }}/compare.csv?sort=rel_desc&limit=1000" download>compare.csv</a> | <a href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=rel_desc&limit=1000" download>violations_only.csv</a></p>
      <div class="grid" style="align-items:end;">
        <label>tol_abs<input id="tolAbsB" type="number" step="0.000001" value="{{ recon.tolerance.abs if recon and recon.tolerance else 0.000001 }}"></label>
        <label>tol_rel<input id="tolRelB" type="number" step="0.000001" value="{{ recon.tolerance.rel if recon and recon.tolerance else 0.000001 }}"></label>
        <label><input type="checkbox" id="violOnlyB"> Show violations only</label>
      </div>
      <table id="tblBefore">
        <thead><tr><th>period</th><th>family</th><th>Δdemand</th><th>Δsupply</th><th>Δbacklog</th><th>ok</th></tr></thead>
        <tbody>
          {% for r in deltas %}
          <tr data-ok="{{ '1' if r.ok else '0' }}" data-reld="{{ r.rel_demand if r.rel_demand is defined else 0 }}" data-rels="{{ r.rel_supply if r.rel_supply is defined else 0 }}" data-relb="{{ r.rel_backlog if r.rel_backlog is defined else 0 }}">
            <td>{{ r.period }}</td>
            <td>{{ r.family }}</td>
            <td class="mono">{{ r.delta_demand }}</td>
            <td class="mono">{{ r.delta_supply }}</td>
            <td class="mono">{{ r.delta_backlog }}</td>
            <td class="mono">{{ r.ok }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <script>
      (function(){
        function num(x){ var v = parseFloat(x); return isNaN(v)?0:v; }
        var ta = document.getElementById('tolAbsB');
        var tr = document.getElementById('tolRelB');
        var cb = document.getElementById('violOnlyB');
        function apply(){
          var _ta = num(ta && ta.value);
          var _tr = num(tr && tr.value);
          document.querySelectorAll('#tblBefore tbody tr').forEach(function(trEl){
            var tds = trEl.querySelectorAll('td');
            var d = Math.abs(num(tds[2] && tds[2].textContent));
            var s = Math.abs(num(tds[3] && tds[3].textContent));
            var b = Math.abs(num(tds[4] && tds[4].textContent));
            var rd = Math.abs(num(trEl.getAttribute('data-reld')));
            var rs = Math.abs(num(trEl.getAttribute('data-rels')));
            var rb = Math.abs(num(trEl.getAttribute('data-relb')));
            var okd = (d <= _ta) || (rd <= _tr);
            var oks = (s <= _ta) || (rs <= _tr);
            var okb = (b <= _ta) || (rb <= _tr);
            [okd,oks,okb].forEach(function(ok,i){ var td = tds[2+i]; if(td) td.style.background = ok? '': '#fff0f0'; });
            var rowOk = okd && oks && okb;
            trEl.setAttribute('data-ok', rowOk ? '1':'0');
            trEl.style.display = (cb && cb.checked && rowOk) ? 'none' : '';
          });
        }
        if (ta) ta.addEventListener('change', apply);
        if (tr) tr.addEventListener('change', apply);
        if (cb) cb.addEventListener('change', apply);
        apply();
      })();
      </script>
    </details>
    {% endif %}

    <div id="tab-diff" class="tab-pane" style="display:none;">
    {% if deltas_adj %}
    <details>
      <summary>After diff (top 50)</summary>
      <p class="mono"><a href="/plans/{{ version_id }}/carryover.csv" download>carryover.csv</a></p>
      <div class="grid" style="align-items:end;">
        <label>tol_abs<input id="tolAbsA" type="number" step="0.000001" value="{{ recon_adj.tolerance.abs if recon_adj and recon_adj.tolerance else 0.000001 }}"></label>
        <label>tol_rel<input id="tolRelA" type="number" step="0.000001" value="{{ recon_adj.tolerance.rel if recon_adj and recon_adj.tolerance else 0.000001 }}"></label>
        <label><input type="checkbox" id="violOnlyA"> Show violations only</label>
      </div>
      <table id="tblAfter">
        <thead><tr><th>period</th><th>family</th><th>Δdemand</th><th>Δsupply</th><th>Δbacklog</th><th>ok</th></tr></thead>
        <tbody>
          {% for r in deltas_adj %}
          <tr data-ok="{{ '1' if r.ok else '0' }}" data-reld="{{ r.rel_demand if r.rel_demand is defined else 0 }}" data-rels="{{ r.rel_supply if r.rel_supply is defined else 0 }}" data-relb="{{ r.rel_backlog if r.rel_backlog is defined else 0 }}">
            <td>{{ r.period }}</td>
            <td>{{ r.family }}</td>
            <td class="mono">{{ r.delta_demand }}</td>
            <td class="mono">{{ r.delta_supply }}</td>
            <td class="mono">{{ r.delta_backlog }}</td>
            <td class="mono">{{ r.ok }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <script>
      (function(){
        function num(x){ var v = parseFloat(x); return isNaN(v)?0:v; }
        var ta = document.getElementById('tolAbsA');
        var tr = document.getElementById('tolRelA');
        var cb = document.getElementById('violOnlyA');
        function apply(){
          var _ta = num(ta && ta.value);
          var _tr = num(tr && tr.value);
          document.querySelectorAll('#tblAfter tbody tr').forEach(function(trEl){
            var tds = trEl.querySelectorAll('td');
            var d = Math.abs(num(tds[2] && tds[2].textContent));
            var s = Math.abs(num(tds[3] && tds[3].textContent));
            var b = Math.abs(num(tds[4] && tds[4].textContent));
            var rd = Math.abs(num(trEl.getAttribute('data-reld')));
            var rs = Math.abs(num(trEl.getAttribute('data-rels')));
            var rb = Math.abs(num(trEl.getAttribute('data-relb')));
            var okd = (d <= _ta) || (rd <= _tr);
            var oks = (s <= _ta) || (rs <= _tr);
            var okb = (b <= _ta) || (rb <= _tr);
            [okd,oks,okb].forEach(function(ok,i){ var td = tds[2+i]; if(td) td.style.background = ok? '': '#fff0f0'; });
            var rowOk = okd && oks && okb;
            trEl.setAttribute('data-ok', rowOk ? '1':'0');
            trEl.style.display = (cb && cb.checked && rowOk) ? 'none' : '';
          });
        }
        if (ta) ta.addEventListener('change', apply);
        if (tr) tr.addEventListener('change', apply);
        if (cb) cb.addEventListener('change', apply);
        apply();
      })();
      </script>
    </details>
    {% endif %}
    </div>
  {% endif %}
</section>
<section id="chart-section" style="display:none;">
  <h3>Visualization</h3>
  <canvas id="chartSpillZonePlan" height="100"></canvas>
  <canvas id="chartCapacityPlan" height="100" style="margin-top:16px"></canvas>
</section>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    const weekly = {{ weekly_summary | tojson | safe if weekly_summary else 'null' }};
    if(!weekly) return;
    function sumByZone(rows){
      const zones = ['pre','at','post'];
      const sums = {pre:{in:0,out:0}, at:{in:0,out:0}, post:{in:0,out:0}};
      rows.forEach(r=>{
        const z = (r.zone||'').toLowerCase();
        if(!sums[z]) return;
        sums[z].in += Number(r.spill_in||0);
        sums[z].out += Number(r.spill_out||0);
      });
      return {labels: zones, inData: zones.map(z=>sums[z].in), outData: zones.map(z=>sums[z].out)};
    }
    function makeSpill(){
      const ctx = document.getElementById('chartSpillZonePlan');
      const agg = sumByZone(weekly);
      if (typeof Chart !== 'undefined'){
        new Chart(ctx, {type:'bar', data:{labels:agg.labels, datasets:[
          {label:'spill_in', data:agg.inData, backgroundColor:'rgba(99,102,241,0.6)'},
          {label:'spill_out', data:agg.outData, backgroundColor:'rgba(239,68,68,0.6)'}
        ]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
      } else {
        // fallback: simple bars
        const c = ctx.getContext('2d'); c.fillText('Chart.js not loaded',10,20);
      }
    }
    function makeCapacity(){
      const ctx = document.getElementById('chartCapacityPlan');
      const weeks = weekly.map(r=>r.week);
      const cap = weekly.map(r=>r.capacity);
      const adj = weekly.map(r=>r.adjusted_load);
      if (typeof Chart !== 'undefined'){
        new Chart(ctx, {type:'bar', data:{labels:weeks, datasets:[
          {label:'capacity', data:cap, backgroundColor:'rgba(54,162,235,0.5)'},
          {label:'adjusted_load', data:adj, backgroundColor:'rgba(255,159,64,0.5)'}
        ]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
      } else {
        const c = ctx.getContext('2d'); c.fillText('Chart.js not loaded',10,20);
      }
    }
    // Lazy rendering: draw charts when the Results tab is active
    window.__renderCharts = function(){ try{ makeSpill(); makeCapacity(); }catch(e){} };
  })();
  // Format millisecond timestamps as JST
  (function(){
    function fmtJst(ms){
      var n = Number(ms);
      if (!Number.isFinite(n)) return '';
      if (n < 1e12) n = n * 1000; // accept epoch seconds as fallback
      var t = new Date(n + 9*3600*1000);
      var y = t.getUTCFullYear();
      var mo = String(t.getUTCMonth()+1).padStart(2,'0');
      var d = String(t.getUTCDate()).padStart(2,'0');
      var h = String(t.getUTCHours()).padStart(2,'0');
      var mi = String(t.getUTCMinutes()).padStart(2,'0');
      var s = String(t.getUTCSeconds()).padStart(2,'0');
      return y + '/' + mo + '/' + d + ' ' + h + ':' + mi + ':' + s + ' JST';
    }
    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.ts-ms').forEach(function(el){
        var txt = fmtJst(el.getAttribute('data-ms'));
        if (txt) el.textContent = txt;
      });
    });
  })();
</script>
<script>
  // Tab switching
  (function(){
    function activate(tab){
      ['overview','aggregate','disaggregate','schedule','validate','psi','execute','results','diff'].forEach(function(k){
        var el = document.getElementById('tab-'+k);
        if (el) el.style.display = (k===tab)?'':'none';
      });
      var chartSec = document.getElementById('chart-section');
      if (chartSec) chartSec.style.display = (tab==='results')? '' : 'none';
      if (tab==='results' && typeof window.__renderCharts==='function') { window.__renderCharts(); }
      document.querySelectorAll('nav [data-tab]').forEach(function(a){
        a.classList.toggle('contrast', a.getAttribute('data-tab')===tab);
      });
      try { localStorage.setItem('plan_detail_tab', tab); } catch(e){}
    }
    document.addEventListener('DOMContentLoaded', function(){
      var saved = null;
      try { saved = localStorage.getItem('plan_detail_tab'); } catch(e){}
      var init = saved || 'overview';
      activate(init);
      document.querySelectorAll('nav [data-tab]').forEach(function(a){
        a.addEventListener('click', function(){ activate(a.getAttribute('data-tab')); });
      });
    });
  })();
</script>
<script>
  // Disaggregate quick filter
  (function(){
    function val(el){ return (el && el.value || '').toLowerCase().trim(); }
    function apply(){
      var sku = val(document.getElementById('skuFilter'));
      var wk = val(document.getElementById('weekFilter'));
      var rows = document.querySelectorAll('#tblDisagg tbody tr');
      var vis=0, all=0;
      rows.forEach(function(tr){
        all++;
        var tds = tr.querySelectorAll('td');
        var w = (tds[0] && tds[0].textContent || '').toLowerCase();
        var s = (tds[1] && tds[1].textContent || '').toLowerCase();
        var ok = (!wk || w.indexOf(wk)>=0) && (!sku || s.indexOf(sku)>=0);
        tr.style.display = ok ? '' : 'none';
        if (ok) vis++;
      });
      var meta = document.getElementById('disaggMeta');
      if (meta) meta.textContent = vis + ' / ' + all;
    }
    document.addEventListener('DOMContentLoaded', function(){
      var sf = document.getElementById('skuFilter');
      var wf = document.getElementById('weekFilter');
      if (sf) sf.addEventListener('input', apply);
      if (wf) wf.addEventListener('input', apply);
      apply();
    });
  })();
</script>
<script>
  // Schedule quick filter
  (function(){
    function val(el){ return (el && el.value || '').toLowerCase().trim(); }
    function apply(){
      var sku = val(document.getElementById('schedSku'));
      var wk = val(document.getElementById('schedWeek'));
      var rows = document.querySelectorAll('#tblSchedule tbody tr');
      var vis=0, all=0;
      rows.forEach(function(tr){
        all++;
        var tds = tr.querySelectorAll('td');
        var w = (tds[0] && tds[0].textContent || '').toLowerCase();
        var s = (tds[1] && tds[1].textContent || '').toLowerCase();
        var ok = (!wk || w.indexOf(wk)>=0) && (!sku || s.indexOf(sku)>=0);
        tr.style.display = ok ? '' : 'none';
        if (ok) vis++;
      });
      var meta = document.getElementById('schedMeta');
      if (meta) meta.textContent = vis + ' / ' + all;
    }
    document.addEventListener('DOMContentLoaded', function(){
      var sf = document.getElementById('schedSku');
      var wf = document.getElementById('schedWeek');
      if (sf) sf.addEventListener('input', apply);
      if (wf) wf.addEventListener('input', apply);
      apply();
    });
  })();
</script>
<script>
  // Link copy helpers (same behavior as list view)
  (function(){
    function copyUrl(href){
      var abs = (location && location.origin ? location.origin : '') + href;
      if (navigator && navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(abs).catch(function(){});
      } else {
        var ta = document.createElement('textarea'); ta.value = abs; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
      }
    }
    function copyAllLinks(ver){
      var origin = (location && location.origin) ? location.origin : '';
      var urls = [
        origin + '/plans/' + ver + '/summary',
        origin + '/plans/' + ver + '/compare.csv?violations_only=true&sort=rel_desc&limit=1000',
        origin + '/plans/' + ver + '/compare.csv?violations_only=true&sort=abs_desc&limit=1000',
        origin + '/plans/' + ver + '/carryover.csv'
      ];
      var txt = urls.join('\n');
      if (navigator && navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).catch(function(){});
      } else {
        var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
      }
    }
    function copyRunCompareAll(runIdsCsv){
      if (!runIdsCsv) return;
      var origin = (location && location.origin) ? location.origin : '';
      var m = origin + '/ui/compare/metrics.csv?run_ids=' + runIdsCsv;
      var d = origin + '/ui/compare/diffs.csv?run_ids=' + runIdsCsv + '&threshold=5';
      var txt = m + '\n' + d;
      if (navigator && navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).catch(function(){});
      } else {
        var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
      }
    }
    document.addEventListener('click', function(ev){
      var t = ev.target;
      if (t && t.classList && t.classList.contains('copy')){
        var href = t.getAttribute('data-href');
        if (href) { copyUrl(href); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy'; }, 1200); }
      }
      if (t && t.classList && t.classList.contains('copy-all')){
        var ver = t.getAttribute('data-version');
        if (ver){ copyAllLinks(ver); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy all'; }, 1200); }
      }
      if (t && t.classList && t.classList.contains('copy-runs-all')){
        var ids = t.getAttribute('data-run-ids');
        if (ids){ copyRunCompareAll(ids); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy all'; }, 1200); }
      }
      if (t && t.classList && t.classList.contains('copy-selected')){
        var checks = Array.from(document.querySelectorAll('.sel-copy:checked'));
        var origin = (location && location.origin) ? location.origin : '';
        var urls = checks.map(function(c){ return origin + (c.getAttribute('data-href')||''); }).filter(Boolean);
        if (urls.length){
          var txt = urls.join('\n');
          if (navigator && navigator.clipboard && navigator.clipboard.writeText){
            navigator.clipboard.writeText(txt).catch(function(){});
          } else {
            var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
          }
          t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy selected'; }, 1200);
        }
      }
    });
  })();
\n</script>
{% endblock %}
