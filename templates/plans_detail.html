{% extends "base.html" %}
{% block content %}
<section>
  <h2>プラン詳細</h2>
  <p class="mono">ヘルプ: <a href="https://github.com/miumigy/scpln/blob/main/docs/AGG_DET_RECONCILIATION_JA.md" target="_blank">整合ガイド（GitHub）</a></p>
  {% if error %}
    <article><mark>エラー</mark><pre class="mono">{{ error }}</pre></article>
  {% else %}
    <p class="mono">version_id={{ version_id }}</p>
    <nav style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0;">
      <a role="button" class="secondary" data-tab="overview" title="概要" aria-label="概要タブ">Overview</a>
      <a role="button" class="secondary" data-tab="aggregate" title="集約" aria-label="集約タブ">Aggregate</a>
      <a role="button" class="secondary" data-tab="disaggregate" title="詳細展開" aria-label="詳細展開タブ">Disaggregate</a>
      <a role="button" class="secondary" data-tab="schedule" title="予定オーダ" aria-label="予定オーダタブ">Schedule</a>
      <a role="button" class="secondary" data-tab="validate" title="検証" aria-label="検証タブ">Validate</a>
      <a role="button" class="secondary" data-tab="execute" title="実行" aria-label="実行タブ">Execute</a>
      <a role="button" class="secondary" data-tab="results" title="結果" aria-label="結果タブ">Results</a>
      <a role="button" class="secondary" data-tab="diff" title="差分" aria-label="差分タブ">Diff</a>
    </nav>
    <div id="tab-aggregate" class="tab-pane" style="display:none;">
    <details open>
      <summary>Aggregate（family×period）</summary>
      {% if aggregate and aggregate.rows %}
      <table>
        <thead><tr><th>period</th><th>family</th><th>demand</th><th>supply</th><th>backlog</th><th>capacity_total</th></tr></thead>
        <tbody>
          {% for r in aggregate.rows %}
          <tr>
            <td>{{ r.period }}</td>
            <td>{{ r.family }}</td>
            <td class="mono">{{ r.demand }}</td>
            <td class="mono">{{ r.supply }}</td>
            <td class="mono">{{ r.backlog }}</td>
            <td class="mono">{{ r.capacity_total }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>データなし（このPlanの再整合や実行で生成されます）</p>
      {% endif %}
    </details>
    </div>

    <div id="tab-disaggregate" class="tab-pane" style="display:none;">
    <details open>
      <summary>Disaggregate（SKU×week）</summary>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0;">
        <input id="skuFilter" type="search" placeholder="SKUフィルタ（部分一致）" aria-label="SKUフィルタ（部分一致）">
        <input id="weekFilter" type="search" placeholder="週フィルタ（例: 2025-W01）" aria-label="週フィルタ（例: 2025-W01）">
        <small class="mono" id="disaggMeta"></small>
        <small class="mono">表示は先頭200件（全{{ disagg_total or 0 }}件）</small>
      </div>
      {% if disagg_rows %}
      <table id="tblDisagg">
        <thead><tr><th>week</th><th>sku</th><th>demand</th><th>supply_plan</th><th>backlog</th><th>on_hand_start</th><th>on_hand_end</th></tr></thead>
        <tbody>
          {% for r in disagg_rows %}
          <tr>
            <td class="mono">{{ r.week }}</td>
            <td class="mono">{{ r.sku }}</td>
            <td class="mono">{{ r.demand }}</td>
            <td class="mono">{{ r.supply_plan }}</td>
            <td class="mono">{{ r.backlog }}</td>
            <td class="mono">{{ r.on_hand_start }}</td>
            <td class="mono">{{ r.on_hand_end }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>データなし（このPlanの実行で生成されます）</p>
      {% endif %}
    </details>
    </div>

    <div id="tab-schedule" class="tab-pane" style="display:none;">
    <details open>
      <summary>予定オーダ（Scheduled Receipts）</summary>
      <div class="mono" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0;">
        <input id="schedSku" type="search" placeholder="SKUフィルタ（部分一致）" aria-label="SKUフィルタ（部分一致）">
        <input id="schedWeek" type="search" placeholder="週フィルタ（例: 2025-W01）" aria-label="週フィルタ（例: 2025-W01）">
        <small id="schedMeta"></small>
        <a class="secondary" href="/plans/{{ version_id }}/schedule.csv" target="_blank">schedule.csv</a>
        <button type="button" class="secondary copy" data-href="/plans/{{ version_id }}/schedule.csv" title="URLをコピー" aria-label="schedule.csv のURLをコピー">copy</button>
        <small>表示は先頭200件（全{{ schedule_total or 0 }}件）</small>
      </div>
      {% if schedule_rows %}
      <table id="tblSchedule">
        <thead><tr><th>week</th><th>sku</th><th>scheduled_receipts</th><th>on_hand_start</th><th>on_hand_end</th></tr></thead>
        <tbody>
          {% for r in schedule_rows %}
          <tr>
            <td class="mono">{{ r.week }}</td>
            <td class="mono">{{ r.sku }}</td>
            <td class="mono">{{ r.scheduled_receipts }}</td>
            <td class="mono">{{ r.on_hand_start }}</td>
            <td class="mono">{{ r.on_hand_end }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>データなし（このPlanの実行で生成されます）</p>
      {% endif %}
    </details>
    </div>

    <div id="tab-validate" class="tab-pane" style="display:none;">
    <details open>
      <summary>検証（MVP）</summary>
      {% if validate %}
      <div class="grid" style="grid-template-columns: repeat(3, minmax(180px, 1fr)); gap:8px;">
        <article>
          <header>Tol違反（before/after）</header>
          <strong class="mono">{{ validate.tol_violations_before if validate.tol_violations_before is not none else '-' }} → {{ validate.tol_violations_after if validate.tol_violations_after is not none else '-' }}</strong>
          <footer><a class="secondary" href="/plans/{{ version_id }}/compare?violations_only=true&sort=rel_desc&limit=200" target="_blank">compare (violations)</a></footer>
        </article>
        <article>
          <header>負在庫行数</header>
          <strong class="mono">{{ validate.neg_inventory_rows or 0 }}</strong>
          <footer><em class="mono">mrp rows={{ validate.mrp_total_rows or 0 }}</em></footer>
        </article>
        <article>
          <header>予定受入の小数行</header>
          <strong class="mono">{{ validate.fractional_receipts_rows or 0 }}</strong>
        </article>
        <article>
          <header>能力超過（週）</header>
          <strong class="mono">{{ validate.capacity_over_weeks or 0 }}</strong>
          <footer><em class="mono">weekly rows={{ validate.weekly_total_rows or 0 }}</em></footer>
        </article>
      </div>
      {% else %}
      <p>データなし（Planの実行後に検証が有効になります）</p>
      {% endif %}
    </details>
    </div>
    <div id="tab-execute" class="tab-pane" style="display:none;">
    <details open>
      <summary>再整合（パラメータ指定）</summary>
      <form method="post" action="/ui/plans/{{ version_id }}/reconcile">
        <div class="grid">
          <label>cutover_date<input type="date" name="cutover_date" value="{{ version.cutover_date or '' }}"></label>
          <label>recon_window_days<input type="number" name="recon_window_days" min="0" value="{{ version.recon_window_days or '' }}"></label>
          <label>anchor_policy
            <select name="anchor_policy">
              <option value="">(未指定)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="既定=1e-6"></label>
          <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="既定=1e-6"></label>
          <label>calendar_mode
            <select name="calendar_mode">
              <option value="">(未指定)</option>
              <option value="simple">simple</option>
              <option value="iso">iso</option>
            </select>
          </label>
          <label>carryover
            <select name="carryover">
              <option value="">(未指定)</option>
              <option value="auto">auto</option>
              <option value="prev">prev</option>
              <option value="next">next</option>
              <option value="both">both</option>
            </select>
          </label>
          <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split"></label>
          <label>input_dir<input type="text" name="input_dir" value="samples/planning"></label>
          <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
          <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
          <label>lt_unit
            <select name="lt_unit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
        </div>
        <button type="submit" aria-label="再整合を実行">再整合を実行</button>
      </form>
    </details>

    <details>
      <summary>統合Run（新規バージョン作成）</summary>
      <form method="post" action="/ui/plans/run">
        <div class="grid" style="align-items:end;">
          <label>input_dir<input type="text" name="input_dir" value="samples/planning"></label>
          <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
          <label>lt_unit
            <select name="lt_unit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
          <label>cutover_date<input type="date" name="cutover_date"></label>
          <label>recon_window_days<input type="number" name="recon_window_days" min="0"></label>
          <label>anchor_policy
            <select name="anchor_policy">
              <option value="">(未指定)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="既定=1e-6"></label>
          <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="既定=1e-6"></label>
          <label>calendar_mode
            <select name="calendar_mode">
              <option value="">(未指定)</option>
              <option value="simple">simple</option>
              <option value="iso">iso</option>
            </select>
          </label>
          <label>carryover
            <select name="carryover">
              <option value="">(未指定)</option>
              <option value="auto">auto</option>
              <option value="prev">prev</option>
              <option value="next">next</option>
              <option value="both">both</option>
            </select>
          </label>
          <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split"></label>
          <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
        </div>
        <button type="submit" aria-label="即時実行">Run Now（即時実行）</button>
      </form>
      <form id="queue-run-form" style="margin-top:8px;" onsubmit="return queueRunViaRunsApi(event)">
        <div class="grid" style="align-items:end;">
          <label>input_dir<input type="text" name="input_dir" value="samples/planning"></label>
          <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
          <label>lt_unit
            <select name="lt_unit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
          <label>cutover_date<input type="date" name="cutover_date"></label>
          <label>recon_window_days<input type="number" name="recon_window_days" min="0"></label>
          <label>anchor_policy
            <select name="anchor_policy">
              <option value="">(未指定)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
        </div>
        <button type="submit" class="secondary" aria-label="ジョブ投入">Queue Job（ジョブ投入）</button>
        <p class="mono">ジョブ投入後は <a href="/ui/jobs" target="_blank">/ui/jobs</a> で進捗を確認できます。</p>
      </form>
      <script>
      async function queueRunViaRunsApi(ev){
        ev.preventDefault();
        try{
          const f = document.getElementById('queue-run-form');
          const fd = new FormData(f);
          function val(name){ const v = fd.get(name); return (v===null||v==='')?undefined:String(v); }
          function valNum(name){ const v = val(name); return v===undefined?undefined:Number(v); }
          function valBool(name){ return fd.get(name) ? true : false; }
          const body = {
            pipeline: 'integrated',
            async: true,
            options: {
              input_dir: val('input_dir') || 'samples/planning',
              weeks: valNum('weeks')||4,
              lt_unit: val('lt_unit')||'day',
              cutover_date: val('cutover_date')||undefined,
              recon_window_days: valNum('recon_window_days'),
              anchor_policy: val('anchor_policy')||undefined,
              apply_adjusted: valBool('apply_adjusted')
            }
          };
          const res = await fetch('/runs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
          if (!res.ok){
            const txt = await res.text();
            alert('queue failed: '+txt);
            return false;
          }
          const data = await res.json();
          if (data && data.location){ window.location.href = data.location; }
          else { alert('queued'); }
        }catch(e){ alert('queue failed'); }
        return false;
      }
      </script>
    </details>

    <details>
      <summary>Plan & Run（自動補完・新規バージョン作成）</summary>
      <form method="post" action="/ui/plans/{{ version_id }}/plan_run_auto" style="display:flex; gap:8px; align-items:end; flex-wrap:wrap;">
        <label>input_dir<input type="text" name="input_dir" value="samples/planning"></label>
        <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
        <label>lt_unit
          <select name="lt_unit">
            <option value="day" selected>day</option>
            <option value="week">week</option>
          </select>
        </label>
        <label>cutover_date<input type="date" name="cutover_date"></label>
        <label>recon_window_days<input type="number" name="recon_window_days" min="0"></label>
        <label>anchor_policy
          <select name="anchor_policy">
            <option value="">(未指定)</option>
            <option value="DET_near">DET_near</option>
            <option value="AGG_far">AGG_far</option>
            <option value="blend">blend</option>
          </select>
        </label>
        <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="既定=1e-6"></label>
        <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="既定=1e-6"></label>
        <label>calendar_mode
          <select name="calendar_mode">
            <option value="">(未指定)</option>
            <option value="simple">simple</option>
            <option value="iso">iso</option>
          </select>
        </label>
        <label>carryover
          <select name="carryover">
            <option value="">(未指定)</option>
            <option value="auto">auto</option>
            <option value="prev">prev</option>
            <option value="next">next</option>
            <option value="both">both</option>
          </select>
        </label>
        <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split"></label>
        <label><input type="checkbox" name="apply_adjusted" value="1"> 調整後DETも計算</label>
        <label><input type="checkbox" name="queue_job" value="1"> ジョブとして実行（非同期）</label>
        <button type="submit" class="contrast" aria-label="Plan & Run を実行">Plan & Run を実行</button>
        <small class="mono">注: 既存Planの cutover/window/policy を可能な範囲で引き継ぎます。</small>
      </form>
    </details>
    </div>

    <div id="tab-overview" class="tab-pane">
    <details open>
      <summary>要約</summary>
      <table>
        <thead><tr><th>項目</th><th>値</th></tr></thead>
        <tbody>
          <tr><td>status</td><td>{{ version.status or '' }}</td></tr>
          <tr><td>cutover_date</td><td class="mono">{{ version.cutover_date or '' }}</td></tr>
          <tr><td>recon_window_days</td><td class="mono">{{ version.recon_window_days or '' }}</td></tr>
          {% if recon and recon.summary %}
            <tr><td>violations(before)</td><td class="mono">{{ recon.summary.tol_violations }}</td></tr>
            <tr><td>max|Δ| (before)</td><td class="mono">({{ recon.summary.max_abs_delta.demand }}, {{ recon.summary.max_abs_delta.supply }}, {{ recon.summary.max_abs_delta.backlog }})</td></tr>
          {% endif %}
          {% if recon_adj and recon_adj.summary %}
            <tr><td>violations(after)</td><td class="mono">{{ recon_adj.summary.tol_violations }}</td></tr>
            <tr><td>max|Δ| (after)</td><td class="mono">({{ recon_adj.summary.max_abs_delta.demand }}, {{ recon_adj.summary.max_abs_delta.supply }}, {{ recon_adj.summary.max_abs_delta.backlog }})</td></tr>
          {% endif %}
          <tr><td>state</td><td class="mono">{{ plan_state.state if plan_state and plan_state.state else (version.status or 'draft') }}{% if plan_state and plan_state.invalid and plan_state.invalid|length>0 %} ｜ invalid: {{ plan_state.invalid|join(', ') }}{% endif %}</td></tr>
        </tbody>
      </table>
    </details>
    <details>
      <summary>State 管理（MVP）</summary>
      <form method="post" action="/ui/plans/{{ version_id }}/state/advance" style="display:flex; gap:8px; align-items:end; flex-wrap:wrap;">
        <label>advance to
          <select name="to">
            <option value="draft">draft</option>
            <option value="aggregated">aggregated</option>
            <option value="disaggregated">disaggregated</option>
            <option value="scheduled">scheduled</option>
            <option value="executed">executed</option>
          </select>
        </label>
        <button type="submit">Advance</button>
      </form>
      <form method="post" action="/ui/plans/{{ version_id }}/state/invalidate" style="display:flex; gap:8px; align-items:end; flex-wrap:wrap; margin-top:6px;">
        <label>invalidate from
          <select name="from_step">
            <option value="draft">draft</option>
            <option value="aggregated">aggregated</option>
            <option value="disaggregated">disaggregated</option>
            <option value="scheduled">scheduled</option>
            <option value="executed">executed</option>
          </select>
        </label>
        <button type="submit" class="secondary">Invalidate</button>
      </form>
    </details>
    {% if kpi_preview %}
    <section style="margin-top:8px;">
      <h4>MVP: KPIプレビュー</h4>
      <div class="grid" style="grid-template-columns: repeat(3, minmax(180px, 1fr)); gap:8px;">
        <article>
          <header>能力合計</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.capacity_total or 0) }}</strong>
        </article>
        <article>
          <header>負荷合計（adjusted）</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.adjusted_total or 0) }}</strong>
        </article>
        <article>
          <header>能力利用率</header>
          <strong class="mono">{{ ('%.1f%%'|format(kpi_preview.util_pct)) if kpi_preview.util_pct is not none else '-' }}</strong>
        </article>
        <article>
          <header>spill_in 合計</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.spill_in_total or 0) }}</strong>
        </article>
        <article>
          <header>spill_out 合計</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.spill_out_total or 0) }}</strong>
        </article>
        <article>
          <header>違反件数 before/after</header>
          <strong class="mono">{{ kpi_preview.viol_before or 0 }} → {{ kpi_preview.viol_after if kpi_preview.viol_after is not none else '-' }}</strong>
        </article>
        <article>
          <header>需要合計（DET）</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.det_demand_total or 0) }}</strong>
        </article>
        <article>
          <header>発注合計（DET supply）</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.det_supply_total or 0) }}</strong>
        </article>
        <article>
          <header>サービスレベル（DET, 推定）</header>
          <strong class="mono">{{ ('%.1f%%'|format(kpi_preview.sl_pct)) if kpi_preview.sl_pct is not none else '-' }}</strong>
        </article>
        <article>
          <header>欠品合計（DET backlog）</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.det_backlog_total or 0) }}</strong>
        </article>
        <article>
          <header>在庫合計（初期, MRP）</header>
          <strong class="mono">{{ '%.0f'|format(kpi_preview.inv_initial_total if kpi_preview.inv_initial_total is not none else 0) }}</strong>
        </article>
      </div>
      {% if kpi_preview.window_days %}
        <p class="mono">window_days={{ kpi_preview.window_days }} ｜ policy={{ kpi_preview.anchor_policy or '(none)' }}</p>
      {% endif %}
    </section>
    {% endif %}
    <div class="mono" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <span>エクスポート:</span>
      <label><input type="checkbox" class="sel-copy" data-href="/plans/{{ version_id }}/summary"> summary.json</label>
      <button type="button" class="secondary copy" data-href="/plans/{{ version_id }}/summary" title="URLをコピー" aria-label="URLをコピー">copy</button>
      |
      <label><input type="checkbox" class="sel-copy" data-href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=rel_desc&limit=1000"> compare.csv</label>
      <button type="button" class="secondary copy" data-href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=rel_desc&limit=1000" title="URLをコピー" aria-label="URLをコピー">copy</button>
      |
      <label><input type="checkbox" class="sel-copy" data-href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=abs_desc&limit=1000"> violations.csv</label>
      <button type="button" class="secondary copy" data-href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=abs_desc&limit=1000" title="URLをコピー" aria-label="URLをコピー">copy</button>
      |
      <label><input type="checkbox" class="sel-copy" data-href="/plans/{{ version_id }}/carryover.csv"> carryover.csv</label>
      <button type="button" class="secondary copy" data-href="/plans/{{ version_id }}/carryover.csv" title="URLをコピー" aria-label="URLをコピー">copy</button>
      |
      <button type="button" class="secondary copy-all" data-version="{{ version_id }}" title="主要リンクを一括コピー">copy all</button>
      <button type="button" class="secondary copy-selected" title="チェックしたリンクを一括コピー">copy selected</button>
    </div>
    </div>

    <div id="tab-results" class="tab-pane" style="display:none;">
    <details open>
      <summary>最新Run（base_scenario）</summary>
      {% if version.base_scenario_id %}
        {% if latest_runs and latest_runs|length > 0 %}
          <table>
            <thead><tr><th>run_id</th><th>started_at</th><th>fill_rate</th><th>profit_total</th><th>リンク</th></tr></thead>
            <tbody>
              {% for r in latest_runs %}
              <tr>
                <td class="mono">{{ r.run_id }}</td>
                <td class="mono">{{ r.started_at }}</td>
                <td class="mono">{{ r.fill_rate }}</td>
                <td class="mono">{{ r.profit_total }}</td>
                <td><a class="secondary" href="/ui/runs/{{ r.run_id }}" target="_blank">open</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% if latest_run_ids and latest_run_ids|length >= 2 %}
          <form method="post" action="/ui/compare" style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input type="hidden" name="run_ids" value="{{ latest_run_ids[0] }},{{ latest_run_ids[1] }}">
            <button type="submit" aria-label="最新2件を比較">最新2件を比較</button>
            <label><input type="checkbox" class="sel-copy" data-href="/ui/compare/metrics.csv?run_ids={{ latest_run_ids[0] }},{{ latest_run_ids[1] }}"> metrics.csv</label>
            <button type="button" class="secondary copy" data-href="/ui/compare/metrics.csv?run_ids={{ latest_run_ids[0] }},{{ latest_run_ids[1] }}" title="URLをコピー" aria-label="URLをコピー">copy</button>
            <label><input type="checkbox" class="sel-copy" data-href="/ui/compare/diffs.csv?run_ids={{ latest_run_ids[0] }},{{ latest_run_ids[1] }}&threshold=5"> diffs.csv (±5%)</label>
            <button type="button" class="secondary copy" data-href="/ui/compare/diffs.csv?run_ids={{ latest_run_ids[0] }},{{ latest_run_ids[1] }}&threshold=5" title="URLをコピー" aria-label="URLをコピー">copy</button>
            <button type="button" class="secondary copy-runs-all" data-run-ids="{{ latest_run_ids[0] }},{{ latest_run_ids[1] }}" title="metrics/diffs の2リンクを一括コピー" aria-label="リンクを一括コピー">copy all</button>
            <button type="button" class="secondary copy-selected" title="チェックしたリンクを一括コピー" aria-label="チェックしたリンクを一括コピー">copy selected</button>
          </form>
          {% endif %}
        {% else %}
          <p>該当シナリオのRunが見つかりません。<a href="/ui/runs" target="_blank">/ui/runs</a> を参照してください。</p>
        {% endif %}
      {% else %}
        <p>プランに base_scenario_id が未設定です。</p>
      {% endif %}
    </details>
    {% if weekly_summary %}
    <details>
      <summary>能力サマリ（weekly_summary）</summary>
      {% if boundary_summary %}
        <p class="mono">boundary: period={{ boundary_summary.period }} ｜ weeks={{ boundary_summary.weeks }} ｜ pre={{ boundary_summary.pre_weeks }} ｜ post={{ boundary_summary.post_weeks }} ｜ policy={{ boundary_summary.anchor_policy or '(none)' }} ｜ window={{ boundary_summary.window_days or 0 }} days</p>
      {% endif %}
      <table>
        <thead><tr><th>week</th><th>zone</th><th>b_idx</th><th>b_size</th><th>in_pre</th><th>in_post</th><th>capacity</th><th>original_load</th><th>adjusted_load</th><th>spill_in</th><th>spill_out</th></tr></thead>
        <tbody>
          {% for r in weekly_summary %}
          <tr>
            <td>{{ r.week }}</td>
            <td class="mono">{{ r.zone or '' }}</td>
            <td class="mono">{{ r.boundary_index or '' }}</td>
            <td class="mono">{{ r.boundary_size or '' }}</td>
            <td class="mono">{{ r.in_window_pre or '' }}</td>
            <td class="mono">{{ r.in_window_post or '' }}</td>
            <td class="mono">{{ r.capacity }}</td>
            <td class="mono">{{ r.original_load }}</td>
            <td class="mono">{{ r.adjusted_load }}</td>
            <td class="mono">{{ r.spill_in }}</td>
            <td class="mono">{{ r.spill_out }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </details>
    {% endif %}
    </div>

    {% if deltas %}
    <details open>
      <summary>before 差分（先頭50件）</summary>
      <p class="mono"><a href="/plans/{{ version_id }}/compare.csv?sort=rel_desc&limit=1000" download>compare.csv</a> ｜ <a href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=rel_desc&limit=1000" download>violations_only.csv</a></p>
      <div class="grid" style="align-items:end;">
        <label>tol_abs<input id="tolAbsB" type="number" step="0.000001" value="{{ recon.tolerance.abs if recon and recon.tolerance else 0.000001 }}"></label>
        <label>tol_rel<input id="tolRelB" type="number" step="0.000001" value="{{ recon.tolerance.rel if recon and recon.tolerance else 0.000001 }}"></label>
        <label><input type="checkbox" id="violOnlyB"> 違反のみ表示</label>
      </div>
      <table id="tblBefore">
        <thead><tr><th>period</th><th>family</th><th>Δdemand</th><th>Δsupply</th><th>Δbacklog</th><th>ok</th></tr></thead>
        <tbody>
          {% for r in deltas %}
          <tr data-ok="{{ '1' if r.ok else '0' }}" data-reld="{{ r.rel_demand if r.rel_demand is defined else 0 }}" data-rels="{{ r.rel_supply if r.rel_supply is defined else 0 }}" data-relb="{{ r.rel_backlog if r.rel_backlog is defined else 0 }}">
            <td>{{ r.period }}</td>
            <td>{{ r.family }}</td>
            <td class="mono">{{ r.delta_demand }}</td>
            <td class="mono">{{ r.delta_supply }}</td>
            <td class="mono">{{ r.delta_backlog }}</td>
            <td class="mono">{{ r.ok }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <script>
      (function(){
        function num(x){ var v = parseFloat(x); return isNaN(v)?0:v; }
        var ta = document.getElementById('tolAbsB');
        var tr = document.getElementById('tolRelB');
        var cb = document.getElementById('violOnlyB');
        function apply(){
          var _ta = num(ta && ta.value);
          var _tr = num(tr && tr.value);
          document.querySelectorAll('#tblBefore tbody tr').forEach(function(trEl){
            var tds = trEl.querySelectorAll('td');
            var d = Math.abs(num(tds[2] && tds[2].textContent));
            var s = Math.abs(num(tds[3] && tds[3].textContent));
            var b = Math.abs(num(tds[4] && tds[4].textContent));
            var rd = Math.abs(num(trEl.getAttribute('data-reld')));
            var rs = Math.abs(num(trEl.getAttribute('data-rels')));
            var rb = Math.abs(num(trEl.getAttribute('data-relb')));
            var okd = (d <= _ta) || (rd <= _tr);
            var oks = (s <= _ta) || (rs <= _tr);
            var okb = (b <= _ta) || (rb <= _tr);
            [okd,oks,okb].forEach(function(ok,i){ var td = tds[2+i]; if(td) td.style.background = ok? '': '#fff0f0'; });
            var rowOk = okd && oks && okb;
            trEl.setAttribute('data-ok', rowOk ? '1':'0');
            trEl.style.display = (cb && cb.checked && rowOk) ? 'none' : '';
          });
        }
        if (ta) ta.addEventListener('change', apply);
        if (tr) tr.addEventListener('change', apply);
        if (cb) cb.addEventListener('change', apply);
        apply();
      })();
      </script>
    </details>
    {% endif %}

    <div id="tab-diff" class="tab-pane" style="display:none;">
    {% if deltas_adj %}
    <details>
      <summary>after 差分（先頭50件）</summary>
      <p class="mono"><a href="/plans/{{ version_id }}/carryover.csv" download>carryover.csv</a></p>
      <div class="grid" style="align-items:end;">
        <label>tol_abs<input id="tolAbsA" type="number" step="0.000001" value="{{ recon_adj.tolerance.abs if recon_adj and recon_adj.tolerance else 0.000001 }}"></label>
        <label>tol_rel<input id="tolRelA" type="number" step="0.000001" value="{{ recon_adj.tolerance.rel if recon_adj and recon_adj.tolerance else 0.000001 }}"></label>
        <label><input type="checkbox" id="violOnlyA"> 違反のみ表示</label>
      </div>
      <table id="tblAfter">
        <thead><tr><th>period</th><th>family</th><th>Δdemand</th><th>Δsupply</th><th>Δbacklog</th><th>ok</th></tr></thead>
        <tbody>
          {% for r in deltas_adj %}
          <tr data-ok="{{ '1' if r.ok else '0' }}" data-reld="{{ r.rel_demand if r.rel_demand is defined else 0 }}" data-rels="{{ r.rel_supply if r.rel_supply is defined else 0 }}" data-relb="{{ r.rel_backlog if r.rel_backlog is defined else 0 }}">
            <td>{{ r.period }}</td>
            <td>{{ r.family }}</td>
            <td class="mono">{{ r.delta_demand }}</td>
            <td class="mono">{{ r.delta_supply }}</td>
            <td class="mono">{{ r.delta_backlog }}</td>
            <td class="mono">{{ r.ok }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <script>
      (function(){
        function num(x){ var v = parseFloat(x); return isNaN(v)?0:v; }
        var ta = document.getElementById('tolAbsA');
        var tr = document.getElementById('tolRelA');
        var cb = document.getElementById('violOnlyA');
        function apply(){
          var _ta = num(ta && ta.value);
          var _tr = num(tr && tr.value);
          document.querySelectorAll('#tblAfter tbody tr').forEach(function(trEl){
            var tds = trEl.querySelectorAll('td');
            var d = Math.abs(num(tds[2] && tds[2].textContent));
            var s = Math.abs(num(tds[3] && tds[3].textContent));
            var b = Math.abs(num(tds[4] && tds[4].textContent));
            var rd = Math.abs(num(trEl.getAttribute('data-reld')));
            var rs = Math.abs(num(trEl.getAttribute('data-rels')));
            var rb = Math.abs(num(trEl.getAttribute('data-relb')));
            var okd = (d <= _ta) || (rd <= _tr);
            var oks = (s <= _ta) || (rs <= _tr);
            var okb = (b <= _ta) || (rb <= _tr);
            [okd,oks,okb].forEach(function(ok,i){ var td = tds[2+i]; if(td) td.style.background = ok? '': '#fff0f0'; });
            var rowOk = okd && oks && okb;
            trEl.setAttribute('data-ok', rowOk ? '1':'0');
            trEl.style.display = (cb && cb.checked && rowOk) ? 'none' : '';
          });
        }
        if (ta) ta.addEventListener('change', apply);
        if (tr) tr.addEventListener('change', apply);
        if (cb) cb.addEventListener('change', apply);
        apply();
      })();
      </script>
    </details>
    {% endif %}
    </div>
  {% endif %}
</section>
<section id="chart-section" style="display:none;">
  <h3>可視化</h3>
  <canvas id="chartSpillZonePlan" height="100"></canvas>
  <canvas id="chartCapacityPlan" height="100" style="margin-top:16px"></canvas>
</section>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    const weekly = {{ weekly_summary | tojson | safe if weekly_summary else 'null' }};
    if(!weekly) return;
    function sumByZone(rows){
      const zones = ['pre','at','post'];
      const sums = {pre:{in:0,out:0}, at:{in:0,out:0}, post:{in:0,out:0}};
      rows.forEach(r=>{
        const z = (r.zone||'').toLowerCase();
        if(!sums[z]) return;
        sums[z].in += Number(r.spill_in||0);
        sums[z].out += Number(r.spill_out||0);
      });
      return {labels: zones, inData: zones.map(z=>sums[z].in), outData: zones.map(z=>sums[z].out)};
    }
    function makeSpill(){
      const ctx = document.getElementById('chartSpillZonePlan');
      const agg = sumByZone(weekly);
      if (typeof Chart !== 'undefined'){
        new Chart(ctx, {type:'bar', data:{labels:agg.labels, datasets:[
          {label:'spill_in', data:agg.inData, backgroundColor:'rgba(99,102,241,0.6)'},
          {label:'spill_out', data:agg.outData, backgroundColor:'rgba(239,68,68,0.6)'}
        ]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
      } else {
        // fallback: simple bars
        const c = ctx.getContext('2d'); c.fillText('Chart.js not loaded',10,20);
      }
    }
    function makeCapacity(){
      const ctx = document.getElementById('chartCapacityPlan');
      const weeks = weekly.map(r=>r.week);
      const cap = weekly.map(r=>r.capacity);
      const adj = weekly.map(r=>r.adjusted_load);
      if (typeof Chart !== 'undefined'){
        new Chart(ctx, {type:'bar', data:{labels:weeks, datasets:[
          {label:'capacity', data:cap, backgroundColor:'rgba(54,162,235,0.5)'},
          {label:'adjusted_load', data:adj, backgroundColor:'rgba(255,159,64,0.5)'}
        ]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
      } else {
        const c = ctx.getContext('2d'); c.fillText('Chart.js not loaded',10,20);
      }
    }
    // 遅延描画: Resultsタブで描画
    window.__renderCharts = function(){ try{ makeSpill(); makeCapacity(); }catch(e){} };
  })();
</script>
<script>
  // タブ切替
  (function(){
    function activate(tab){
      ['overview','aggregate','disaggregate','schedule','validate','execute','results','diff'].forEach(function(k){
        var el = document.getElementById('tab-'+k);
        if (el) el.style.display = (k===tab)?'':'none';
      });
      var chartSec = document.getElementById('chart-section');
      if (chartSec) chartSec.style.display = (tab==='results')? '' : 'none';
      if (tab==='results' && typeof window.__renderCharts==='function') { window.__renderCharts(); }
      document.querySelectorAll('nav [data-tab]').forEach(function(a){
        a.classList.toggle('contrast', a.getAttribute('data-tab')===tab);
      });
      try { localStorage.setItem('plan_detail_tab', tab); } catch(e){}
    }
    document.addEventListener('DOMContentLoaded', function(){
      var saved = null;
      try { saved = localStorage.getItem('plan_detail_tab'); } catch(e){}
      var init = saved || 'overview';
      activate(init);
      document.querySelectorAll('nav [data-tab]').forEach(function(a){
        a.addEventListener('click', function(){ activate(a.getAttribute('data-tab')); });
      });
    });
  })();
</script>
<script>
  // Disaggregate簡易フィルタ
  (function(){
    function val(el){ return (el && el.value || '').toLowerCase().trim(); }
    function apply(){
      var sku = val(document.getElementById('skuFilter'));
      var wk = val(document.getElementById('weekFilter'));
      var rows = document.querySelectorAll('#tblDisagg tbody tr');
      var vis=0, all=0;
      rows.forEach(function(tr){
        all++;
        var tds = tr.querySelectorAll('td');
        var w = (tds[0] && tds[0].textContent || '').toLowerCase();
        var s = (tds[1] && tds[1].textContent || '').toLowerCase();
        var ok = (!wk || w.indexOf(wk)>=0) && (!sku || s.indexOf(sku)>=0);
        tr.style.display = ok ? '' : 'none';
        if (ok) vis++;
      });
      var meta = document.getElementById('disaggMeta');
      if (meta) meta.textContent = vis + ' / ' + all;
    }
    document.addEventListener('DOMContentLoaded', function(){
      var sf = document.getElementById('skuFilter');
      var wf = document.getElementById('weekFilter');
      if (sf) sf.addEventListener('input', apply);
      if (wf) wf.addEventListener('input', apply);
      apply();
    });
  })();
</script>
<script>
  // Schedule 簡易フィルタ
  (function(){
    function val(el){ return (el && el.value || '').toLowerCase().trim(); }
    function apply(){
      var sku = val(document.getElementById('schedSku'));
      var wk = val(document.getElementById('schedWeek'));
      var rows = document.querySelectorAll('#tblSchedule tbody tr');
      var vis=0, all=0;
      rows.forEach(function(tr){
        all++;
        var tds = tr.querySelectorAll('td');
        var w = (tds[0] && tds[0].textContent || '').toLowerCase();
        var s = (tds[1] && tds[1].textContent || '').toLowerCase();
        var ok = (!wk || w.indexOf(wk)>=0) && (!sku || s.indexOf(sku)>=0);
        tr.style.display = ok ? '' : 'none';
        if (ok) vis++;
      });
      var meta = document.getElementById('schedMeta');
      if (meta) meta.textContent = vis + ' / ' + all;
    }
    document.addEventListener('DOMContentLoaded', function(){
      var sf = document.getElementById('schedSku');
      var wf = document.getElementById('schedWeek');
      if (sf) sf.addEventListener('input', apply);
      if (wf) wf.addEventListener('input', apply);
      apply();
    });
  })();
</script>
<script>
  // 固定リンクのコピー機能（一覧と同仕様）
  (function(){
    function copyUrl(href){
      var abs = (location && location.origin ? location.origin : '') + href;
      if (navigator && navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(abs).catch(function(){});
      } else {
        var ta = document.createElement('textarea'); ta.value = abs; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
      }
    }
    function copyAllLinks(ver){
      var origin = (location && location.origin) ? location.origin : '';
      var urls = [
        origin + '/plans/' + ver + '/summary',
        origin + '/plans/' + ver + '/compare.csv?violations_only=true&sort=rel_desc&limit=1000',
        origin + '/plans/' + ver + '/compare.csv?violations_only=true&sort=abs_desc&limit=1000',
        origin + '/plans/' + ver + '/carryover.csv'
      ];
      var txt = urls.join('\n');
      if (navigator && navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).catch(function(){});
      } else {
        var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
      }
    }
    function copyRunCompareAll(runIdsCsv){
      if (!runIdsCsv) return;
      var origin = (location && location.origin) ? location.origin : '';
      var m = origin + '/ui/compare/metrics.csv?run_ids=' + runIdsCsv;
      var d = origin + '/ui/compare/diffs.csv?run_ids=' + runIdsCsv + '&threshold=5';
      var txt = m + '\n' + d;
      if (navigator && navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).catch(function(){});
      } else {
        var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
      }
    }
    document.addEventListener('click', function(ev){
      var t = ev.target;
      if (t && t.classList && t.classList.contains('copy')){
        var href = t.getAttribute('data-href');
        if (href) { copyUrl(href); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy'; }, 1200); }
      }
      if (t && t.classList && t.classList.contains('copy-all')){
        var ver = t.getAttribute('data-version');
        if (ver){ copyAllLinks(ver); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy all'; }, 1200); }
      }
      if (t && t.classList && t.classList.contains('copy-runs-all')){
        var ids = t.getAttribute('data-run-ids');
        if (ids){ copyRunCompareAll(ids); t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy all'; }, 1200); }
      }
      if (t && t.classList && t.classList.contains('copy-selected')){
        var checks = Array.from(document.querySelectorAll('.sel-copy:checked'));
        var origin = (location && location.origin) ? location.origin : '';
        var urls = checks.map(function(c){ return origin + (c.getAttribute('data-href')||''); }).filter(Boolean);
        if (urls.length){
          var txt = urls.join('\n');
          if (navigator && navigator.clipboard && navigator.clipboard.writeText){
            navigator.clipboard.writeText(txt).catch(function(){});
          } else {
            var ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta);
          }
          t.textContent = 'copied'; setTimeout(function(){ t.textContent = 'copy selected'; }, 1200);
        }
      }
    });
  })();
</script>
{% endblock %}
