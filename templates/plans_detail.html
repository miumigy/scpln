{% extends "base.html" %}
{% block head %}
  <style>
    /* Highlight editable PSI cells */
    #tblPSI td[contenteditable],
    #tblPSI td.editable {
      background-color: #fffdf5;
      border: 1px dashed #c7c7c7;
      cursor: text;
      position: relative;
    }
    #tblPSI td.editable::after {
      content: "✎";
      position: absolute;
      top: 2px;
      right: 6px;
      font-size: 0.8em;
      opacity: 0.55;
      pointer-events: none;
    }
    #tblPSI td[contenteditable]:hover,
    #tblPSI td.editable:hover { background-color: #fff8e6; }
    #tblPSI td[contenteditable]:focus,
    #tblPSI td.editable:focus { outline: 2px solid #2563eb; background-color: #ffffff; }
    #tblPSI td.ro { background-color: #f2f4f7; color: #475569; }
    #tblPSI td.dirty { background-color: #fff3bf; border-color: #f08c00; }
    .tab-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin: 0.75rem 0 1rem;
    }
    .tab-nav a {
      min-width: 120px;
      text-align: center;
    }
    .tab-pane details summary {
      text-transform: none;
    }
    .tab-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
      margin: 0.75rem 0;
    }
    .tab-scroll {
      overflow: auto;
    }
    .warn-text {
      color: #b45309;
    }
    .inputset-card {
      border-left: 4px solid #2563eb;
      background-color: #f8fafc;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      margin: 1rem 0;
    }
    .inputset-card.warn {
      border-color: #b45309;
      background-color: #fff7ed;
    }
    .inputset-card h4 {
      margin: 0;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .inputset-card .pill {
      font-size: 0.8em;
    }
    .inputset-card p {
      margin: 0.25rem 0;
    }
    .inputset-card .mini-list {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 0;
      margin: 0.5rem 0 0;
      font-size: 0.9em;
    }
    .inputset-card .mini-list li {
      font-family: var(--font-mono, "SFMono-Regular", Consolas, monospace);
    }
    .inputset-card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .inputset-card-actions a {
      flex: 0 0 auto;
    }
    .pill-muted {
      background-color: #e2e8f0;
      color: #334155;
    }
    .pill-warn {
      background-color: #f97316;
      color: #ffffff;
    }
    @media (max-width: 1024px) {
      .tab-nav {
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 0.35rem;
      }
      .tab-nav a {
        flex: 0 0 auto;
      }
    }
    @media (max-width: 768px) {
      .tab-toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      .tab-toolbar label,
      .tab-toolbar button,
      .tab-toolbar a[role="button"],
      .tab-toolbar select,
      .tab-toolbar input {
        width: 100%;
      }
      .tab-scroll {
        margin: 0 -0.75rem;
        padding: 0 0.75rem 0.75rem;
      }
    }
  </style>
{% endblock %}
{% block page_header %}
  <h2>Plan Detail</h2>
  <p>Inspect reconciliation outputs, edit PSI tables, and execute follow-up actions.</p>
{% endblock %}
{% block content %}
<section class="page-section">
  <p class="mono">Help: <a href="https://github.com/miumigy/scpln/blob/main/docs/AGG_DET_RECONCILIATION_JA.md" target="_blank" rel="noopener">Reconciliation guide (GitHub)</a></p>
  {% if error %}
    <article><mark>Error</mark><pre class="mono">{{ error }}</pre></article>
  {% else %}
    <p class="mono">version_id={{ version_id }}</p>
    {% if ui_error %}
    <p class="mono warn-text">{{ ui_error }}</p>
    {% endif %}
    <form method="post" action="/ui/plans/{{ version_id }}/delete" class="gap-top-sm" onsubmit="return confirm('Delete plan {{ version_id }}?');">
      <button type="submit" class="contrast" aria-label="Delete plan {{ version_id }}">Delete Plan</button>
    </form>
    {% set isi = input_set_info or {} %}
    {% if isi.legacy %}
      <section class="inputset-card warn" aria-label="Planning input set warning">
        <h4>Planning Input Set</h4>
        <p class="mono">Input set label not recorded (legacy CSV mode).</p>
        <p>Re-run this plan with <code>input_set_label</code> to enable traceability and diff/export links.</p>
      </section>
    {% elif isi.missing %}
      <section class="inputset-card warn" aria-label="Planning input set missing warning">
        <h4>Planning Input Set</h4>
        <p class="mono">Input set label <code>{{ isi.label }}</code> was recorded, but the canonical InputSet record was not found.</p>
        <p>The UI is showing artifacts reconstructed from the plan archive. Re-import or restore the InputSet to regain diff/export accuracy.</p>
        <p>
          Suggested CLI:<br>
          <code>PYTHONPATH=. python scripts/export_planning_inputs.py --label {{ isi.label | default('UNKNOWN', true) }}</code>
        </p>
      </section>
    {% else %}
      <section class="inputset-card" aria-label="Planning input set summary">
        <h4>
          Planning Input Set
          {% if isi.status %}<span class="pill">{{ isi.status }}</span>{% endif %}
          {% if isi.source %}<span class="pill pill-muted">{{ isi.source }}</span>{% endif %}
        </h4>
        {% if isi.label %}
        <p>label: <span class="mono">{{ isi.label }}</span></p>
        {% endif %}
        <p>
          config_version_id:
          {% if isi.config_version_id %}
            <a class="mono" href="/ui/configs/canonical/{{ isi.config_version_id }}">{{ isi.config_version_id }}</a>
          {% else %}
            <span class="mono">-</span>
          {% endif %}
          {% if isi.id %} | input_set_id=<span class="mono">{{ isi.id }}</span>{% endif %}
        </p>
        <p>
          updated_at:
          <span class="mono">{{ isi.updated_at_str or 'unknown' }}</span>
          {% if isi.missing %}
            <span class="pill pill-warn">not found in storage</span>
          {% endif %}
        </p>
        {% if planning_summary %}
        <ul class="mini-list">
          <li>demand={{ planning_summary.demand_family|default('-', true) }}</li>
          <li>capacity={{ planning_summary.capacity|default('-', true) }}</li>
          <li>mix={{ planning_summary.mix_share|default('-', true) }}</li>
          <li>inventory={{ planning_summary.inventory|default('-', true) }}</li>
          <li>open_po={{ planning_summary.open_po|default('-', true) }}</li>
        </ul>
        {% endif %}
        {% if isi.label %}
        <p class="mono">
          Export via:
          <code>PYTHONPATH=. python scripts/export_planning_inputs.py --label {{ isi.label }}</code>
        </p>
        <div class="inputset-card-actions">
          <a role="button" href="/api/plans/input_sets/{{ isi.label | urlencode }}/export?format=zip" download>Export (Zip)</a>
          <a role="button" class="secondary" href="/ui/plans/input_sets/{{ isi.label | urlencode }}/diff">Diff (vs latest)</a>
          <a class="secondary" href="/ui/plans?input_set_label={{ isi.label | urlencode }}">Plans with this input set</a>
          <a class="secondary" href="/ui/runs?input_set_label={{ isi.label | urlencode }}">Runs with this input set</a>
        </div>
        {% endif %}
      </section>
    {% endif %}
    <nav class="tab-nav">
      <a role="button" class="secondary" data-tab="overview" title="Overview" aria-label="Overview tab">Overview</a>
      <a role="button" class="secondary" data-tab="aggregate" title="Aggregate" aria-label="Aggregate tab">Aggregate</a>
      <a role="button" class="secondary" data-tab="disaggregate" title="Disaggregate" aria-label="Disaggregate tab">Disaggregate</a>
      <a role="button" class="secondary" data-tab="schedule" title="Schedule" aria-label="Schedule tab">Schedule</a>
      <a role="button" class="secondary" data-tab="validate" title="Validate" aria-label="Validate tab">Validate</a>
      <a role="button" class="secondary" data-tab="psi" title="PSI" aria-label="PSI tab">PSI</a>
      <a role="button" class="secondary" data-tab="execute" title="Reconciliation & Execution" aria-label="Reconciliation & Execution tab">Reconciliation & Execution</a>
      <a role="button" class="secondary" data-tab="results" title="Results" aria-label="Results tab">Results</a>
      <a role="button" class="secondary" data-tab="diff" title="Diff" aria-label="Diff tab">Diff</a>
    </nav>
    <div id="tab-aggregate" class="tab-pane" style="display:none;">
    <details open>
      <summary>Aggregate (family × period)</summary>
      {% if aggregate and aggregate.rows %}
      <div class="table-wrapper">
        <table>
          <thead><tr><th>period</th><th>family</th><th class="numeric">demand</th><th class="numeric">supply</th><th class="numeric">backlog</th><th class="numeric">capacity_total</th></tr></thead>
          <tbody>
            {% for r in aggregate.rows %}
            <tr>
              <td>{{ r.period }}</td>
              <td>{{ r.family }}</td>
              <td class="mono numeric">{{ r.demand|fmt_number }}</td>
              <td class="mono numeric">{{ r.supply|fmt_number }}</td>
              <td class="mono numeric">{{ r.backlog|fmt_number }}</td>
              <td class="mono numeric">{{ r.capacity_total|fmt_number }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p>No aggregate records yet. Run reconciliation or execution to populate this section.</p>
      {% endif %}
    </details>
    <script>
    (function(){
      function getHeaders(){
        const h = {};
        try { const k = localStorage.getItem('api_key') || ''; if (k) h['X-API-Key'] = k; } catch {}
        return h;
      }
      function applyDiffLinks(){
        try {
          const sort = document.getElementById('diff-sort')?.value || 'rel_desc';
          const viol = document.getElementById('diff-viol')?.checked ? 'true':'false';
          document.querySelectorAll('#rel-list a').forEach(a => {
            if (a && a.getAttribute('href') && a.textContent === 'diff'){
              const href = new URL(a.getAttribute('href'), location.origin);
              href.searchParams.set('violations_only', viol);
              href.searchParams.set('sort', sort);
              a.setAttribute('href', href.pathname + href.search);
            }
          });
        } catch {}
      }
      async function loadRelated(){
        try {
          const sort = document.getElementById('rel-sort')?.value || 'created_desc';
          const limitEl = document.getElementById('rel-limit');
          const limit = Math.max(1, parseInt(limitEl && limitEl.value || '5', 10));
          const base = {{ (version.base_scenario_id or 'null') | tojson | safe }};
          if (!base) return;
          const qs = new URLSearchParams({ base_scenario_id: String(base), limit: String(limit), sort });
          const res = await fetch('/plans/by_base?'+qs.toString(), { headers: getHeaders() });
          if (!res.ok) return;
          const js = await res.json();
          const rows = (js && js.plans) || [];
          const ul = document.getElementById('rel-list');
          if (!ul) return;
          const cur = {{ version_id | tojson | safe }};
          const items = rows.filter(p => p.version_id !== cur).map(p => `<li><a href="/ui/plans/${p.version_id}">${p.version_id}</a> <small>(${p.status||''})</small></li>`);
          ul.innerHTML = items.join('');
        } catch(e) { /* noop */ }
      }
      document.getElementById('rel-apply')?.addEventListener('click', async function(){ await loadRelated(); applyDiffLinks(); });
      document.getElementById('diff-apply')?.addEventListener('click', applyDiffLinks);
      // Initial load
      loadRelated().then(applyDiffLinks).catch(()=>{});
    })();
    </script>
    </div>
    <div id="tab-psi" class="tab-pane" style="display:none;">
    <details open>
      <summary>PSI (view & edit)</summary>
      {% if plan_state %}
      <p class="mono">PSI state: {{ plan_state.display_status or plan_state.status or plan_state.state }}{% if plan_state.actor %} | actor={{ plan_state.actor }}{% endif %}{% if plan_state.display_time %} | at {{ plan_state.display_time }}{% endif %}{% if plan_state.notes %} | note={{ plan_state.notes }}{% endif %}</p>
      {% endif %}
      <div class="tab-toolbar">
        <label>Level
          <select id="psiLevel">
            <option value="aggregate">aggregate (family × period)</option>
            <option value="det">detail (sku × week)</option>
          </select>
        </label>
        <label>Filter<input id="psiQ" type="search" placeholder="Search text"></label>
        <label>Limit<input id="psiLimit" type="number" min="10" value="200"></label>
        <button id="psiReload" type="button">Reload</button>
        <button id="psiSave" type="button" class="secondary">Save changes</button>
        <button id="psiRecon" type="button">Apply &amp; reconcile</button>
        <a id="psiCsvExport" class="secondary" href="#" download>Export CSV</a>
        <label>Lock mode
          <select id="psiLockMode">
            <option value="">(none)</option>
            <option value="lock">lock</option>
            <option value="unlock">unlock</option>
            <option value="toggle">toggle</option>
          </select>
        </label>
        <button id="psiLockCell" type="button" class="secondary">Lock cell</button>
        <button id="psiUnlockCell" type="button" class="secondary">Unlock cell</button>
        <button id="psiUnlockAll" type="button" class="secondary">Unlock all</button>
        <small class="mono" id="psiMeta"></small>
        <small class="mono" id="psiLegend">Legend: ✎ editable / gray = read-only / yellow = unsaved edits</small>
      </div>
      <div class="tab-scroll table-wrapper">
        <table id="tblPSI" style="min-width:960px;"></table>
      </div>
      <details>
        <summary>Reconciliation options (adjusted / MRP)</summary>
        <div class="grid" style="align-items:end;">
          <label><input type="checkbox" id="psiAdj"> apply_adjusted</label>
          <label><input type="checkbox" id="psiMRP"> recalc_mrp</label>
          <label>lt_unit
            <select id="psiLtUnit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
          <label>weeks<input type="number" id="psiWeeks" min="1" value="4"></label>
          <label>cutover_date<input type="date" id="psiCutover"></label>
          <label>recon_window_days<input type="number" id="psiRwd" min="0"></label>
          <label>anchor_policy
            <select id="psiAnchor">
              <option value="">(unspecified)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>tol_abs<input type="number" step="0.000001" id="psiTolAbs" placeholder="1e-6"></label>
          <label>tol_rel<input type="number" step="0.000001" id="psiTolRel" placeholder="1e-6"></label>
          <label>calendar_mode
            <select id="psiCal">
              <option value="">(unspecified)</option>
              <option value="simple">simple</option>
              <option value="iso">iso</option>
            </select>
          </label>
          <label>carryover
            <select id="psiCarry">
              <option value="">(unspecified)</option>
              <option value="auto">auto</option>
              <option value="prev">prev</option>
              <option value="next">next</option>
              <option value="both">both</option>
            </select>
          </label>
          <label>carryover_split<input type="number" min="0" max="1" step="0.05" id="psiCarrySplit"></label>
        </div>
        <p class="mono warn-text">Note: set anchor_policy and cutover_date when running adjusted mode. Combine recalc_mrp with apply_adjusted.</p>
      </details>
      <details>
        <summary>Weights (CSV import)</summary>
        <p class="mono">Headers: key,weight (or week,sku,weight). Example key: det:week=2025-W01,sku=SKU1</p>
        <textarea id="psiWeightsCsv" rows="4" placeholder="key,weight\ndet:week=2025-W01,sku=SKU1,1\ndet:week=2025-W01,sku=SKU2,2"></textarea>
        <div class="tab-toolbar">
          <button id="psiWeightsApply" type="button">Apply weights</button>
        </div>
      </details>
      <details>
        <summary>Distribution options (Aggregate → Detail)</summary>
        <div class="grid" style="align-items:end;">
          <label>weight_mode
            <select id="psiWeight">
              <option value="current" selected>current (proportional to current)</option>
              <option value="equal">equal</option>
              <option value="demand">proportional to demand</option>
              <option value="supply_plan">proportional to supply_plan</option>
            </select>
          </label>
          <label>round demand
            <input type="number" id="psiRoundDemand" placeholder="step (e.g. 1)">
          </label>
          <label>round supply_plan
            <input type="number" id="psiRoundSupply" placeholder="step (e.g. 1)">
          </label>
          <label>round backlog
            <input type="number" id="psiRoundBacklog" placeholder="step (e.g. 1)">
          </label>
        </div>
        <p class="mono warn-text">Note: applied when aggregate rows are saved. Step values round to nearest multiples with totals rescaled.</p>
      </details>
      <details>
        <summary>CSV import (with headers, default columns)</summary>
        <p class="mono">aggregate: period,family,demand,supply,backlog | det: week,sku,demand,supply_plan,backlog,on_hand_start,on_hand_end</p>
        <textarea id="psiCsvText" rows="6" placeholder="Paste CSV"></textarea>
        <div class="tab-toolbar">
          <button id="psiCsvApply" type="button">Apply CSV (save)</button>
        </div>
      </details>
      <details>
        <summary>Audit log (recent)</summary>
        <div class="tab-toolbar">
          <label>Level
            <select id="psiAuditLevel">
              <option value="">(all)</option>
              <option value="aggregate">aggregate</option>
              <option value="det">det</option>
            </select>
          </label>
          <label>Filter<input id="psiAuditQ" type="search" placeholder="Search text"></label>
          <label>Limit<input id="psiAuditLimit" type="number" min="10" value="200"></label>
          <button id="psiAuditReload" type="button">Reload</button>
        </div>
        <div class="tab-scroll table-wrapper" style="max-height:320px;">
          <table id="tblPSIAudit" style="min-width:960px;">
            <thead>
              <tr>
                <th>time</th>
                <th>event</th>
                <th>level</th>
                <th>key</th>
                <th>actor</th>
                <th>notes</th>
                <th>details</th>
              </tr>
            </thead>
            <tbody>
              {% if audit_events %}
                {% for r in audit_events %}
                  <tr>
                    <td class="mono">{{ r.display_time or '' }}</td>
                    <td class="mono">{{ r.display_event or r.event_type or '' }}</td>
                    <td class="mono">{{ r.level or '' }}</td>
                    <td class="mono">{{ r.key_display or r.key_hash or r.key or '' }}</td>
                    <td class="mono">{{ r.actor or '' }}</td>
                    <td>{{ r.notes or '' }}</td>
                    <td class="mono">{{ r.payload_preview or '' }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="7">No audit events yet.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </details>
      <details>
        <summary>Lock manager</summary>
        <div class="tab-toolbar">
          <label>family<input id="lmFamily" type="text" placeholder="family"></label>
          <label>week_prefix<input id="lmWeek" type="text" placeholder="YYYY-W"></label>
          <label>field
            <select id="lmField">
              <option value="">(any)</option>
              <option value="demand">demand</option>
              <option value="supply_plan">supply_plan</option>
              <option value="backlog">backlog</option>
              <option value="on_hand_start">on_hand_start</option>
              <option value="on_hand_end">on_hand_end</option>
            </select>
          </label>
          <button id="lmLoad" type="button">Load locks</button>
          <button id="lmLockFiltered" type="button" class="secondary">Lock filtered</button>
          <button id="lmUnlockFiltered" type="button" class="secondary">Unlock filtered</button>
          <button id="lmUnlockSelected" type="button">Unlock selected</button>
        </div>
        <div class="tab-scroll table-wrapper" style="max-height:260px;">
          <table id="tblLocks" style="min-width:960px;"></table>
        </div>
      </details>
      <details>
        <summary>Approval workflow</summary>
        <div class="tab-toolbar">
          <label>note<input id="psiSubmitNote" type="text" placeholder="Submission note"></label>
          <button id="psiSubmit" type="button">Submit</button>
          <label><input type="checkbox" id="psiApproveRecon"> Run reconciliation after approval</label>
          <button id="psiApprove" type="button" class="secondary">Approve</button>
          <small class="mono warn-text">API key (localStorage.api_key) is required to approve.</small>
        </div>
        <div class="tab-toolbar">
          <button id="psiShowDiff" type="button" class="secondary">Show diff</button>
          <div id="psiDiff" class="mono" style="margin-top:6px;"></div>
        </div>
      </details>
      <p class="mono warn-text" id="psiNote">PSI edits are stored as an overlay until you run "Apply &amp; reconcile". API keys are required when executing reconciliation.</p>
    </details>
    <script>
    (function(){
      const ver = {{ version_id | tojson | safe }};
      const tbl = document.getElementById('tblPSI');
      const fmtLib = window.ScpFormat;
      function formatCountLabel(value){
        if (fmtLib && typeof fmtLib.formatNumber === 'function') {
          const formatted = fmtLib.formatNumber(value, 2);
          return formatted || '';
        }
        const num = Number(value);
        if (!Number.isFinite(num)) return value ?? '';
        return num.toLocaleString('en-US');
      }
      function getHeaders(){
        const h = {'Content-Type':'application/json'};
        try { const k = localStorage.getItem('api_key') || ''; if (k) h['X-API-Key'] = k; } catch {}
        return h;
      }
      const levelEl = document.getElementById('psiLevel');
      const qEl = document.getElementById('psiQ');
      const limEl = document.getElementById('psiLimit');
      const metaEl = document.getElementById('psiMeta');
      const lockEl = document.getElementById('psiLockMode');
      const pending = new Map(); // key+field -> value
      let locks = new Set();
      function mkKey(level, r){ return level==='aggregate' ? `agg:period=${r.period},family=${r.family}` : `det:week=${r.week},sku=${r.sku}`; }
      function colSpec(level){
        if (level==='aggregate'){
          return [
            {k:'period', ro:true}, {k:'family', ro:true},
            {k:'demand', numeric:true}, {k:'supply', numeric:true}, {k:'backlog', numeric:true}
          ];
        }
        return [
          {k:'week', ro:true}, {k:'sku', ro:true},
          {k:'demand', numeric:true}, {k:'supply_plan', numeric:true}, {k:'backlog', numeric:true}, {k:'on_hand_start', numeric:true}, {k:'on_hand_end', numeric:true}
        ];
      }
      function fmt(n){ if(n===null||n===undefined||n==='') return ''; const x=Number(n); return Number.isFinite(x)? String(x): String(n); }
      function render(level, rows){
        const cols = colSpec(level);
        const theadCells = cols.map(c=>{
          const cls = c.numeric ? ' class="numeric"' : '';
          return `<th${cls}>${c.k}</th>`;
        }).join('');
        const thead = `<thead><tr>${theadCells}<th>lock</th></tr></thead>`;
        const body = rows.map(r=>{
          const k = mkKey(level,r);
          const rowLocked = locks.has(k);
      const tds = cols.map(c=>{
          const val = r[c.k];
          const ro = c.ro || rowLocked || locks.has(`${k}:field=${c.k}`);
          const dv = fmt(val);
          const numericClass = c.numeric ? ' mono numeric' : '';
          if (ro) {
            const title = 'Read-only (locked or excluded)';
            return `<td data-ro="1" class="ro${numericClass}" data-field="${c.k}" data-key="${k}" data-value="${dv}" title="${title}" aria-label="${title}">${dv}</td>`;
          } else {
            const title = `Editable: ${c.k}`;
            return `<td contenteditable tabindex="0" class="editable${numericClass}" data-field="${c.k}" data-key="${k}" data-value="${dv}" title="${title}" aria-label="${title}">${dv}</td>`;
          }
          }).join('');
          const lk = rowLocked? 'checked' : '';
          return `<tr>${tds}<td><input type="checkbox" class="psi-lock" data-key="${k}" ${lk}></td></tr>`;
        }).join('');
        tbl.innerHTML = thead + '<tbody>'+body+'</tbody>';
        // Track dirty cells
        tbl.querySelectorAll('td[contenteditable]').forEach(td=>{
          td.addEventListener('focus', ev=>{ window.__psiLastCell = ev.currentTarget; });
          td.addEventListener('blur', ev=>{
            const el = ev.currentTarget; const key = el.getAttribute('data-key'); const f = el.getAttribute('data-field');
            const before = el.getAttribute('data-value')||''; const after = el.textContent.trim();
            if (after===before){ el.classList.remove('dirty'); pending.delete(key+"::"+f); return; }
            el.classList.add('dirty'); pending.set(key+"::"+f, after);
          });
        });
      }
      async function load(){
        const level = levelEl.value; const q = (qEl.value||'').trim(); const limit = parseInt(limEl.value||'200',10);
        const url = new URL(`/plans/${ver}/psi`, location.origin);
        url.searchParams.set('level', level); if(q) url.searchParams.set('q', q); url.searchParams.set('limit', String(limit)); url.searchParams.set('offset', '0');
        const res = await fetch(url.toString()); if(!res.ok) return;
        const js = await res.json(); locks = new Set(js.locks||[]);
        metaEl.textContent = `rows=${formatCountLabel(js.total)}`;
        render(js.level, js.rows||[]);
        const a = document.getElementById('psiCsvExport');
        if (a){ const u = new URL(`/plans/${ver}/psi.csv`, location.origin); u.searchParams.set('level', level); a.setAttribute('href', u.toString()); a.setAttribute('download', `psi_${level}_${ver}.csv`); }
      }
      async function save(){
        const level = levelEl.value;
        // Aggregate changes per key
        const grouped = new Map();
        for (const [kf, val] of pending.entries()){
          const [key, field] = kf.split('::');
          const g = grouped.get(key) || { key: {}, fields: {} };
          // Restore key fields
          if (key.startsWith('agg:')){
            const m = /period=([^,]+),family=(.+)$/.exec(key); if (m){ g.key.period=m[1]; g.key.family=m[2]; }
          } else {
            const m = /week=([^,]+),sku=(.+)$/.exec(key); if (m){ g.key.week=m[1]; g.key.sku=m[2]; }
          }
          g.fields[field] = (val==='')? null : Number(val);
          grouped.set(key, g);
        }
        const edits = Array.from(grouped.values());
        const lock = lockEl.value || undefined;
        // Distribution options (aggregate only)
        let distribute = undefined;
        if (level === 'aggregate'){
          const wm = document.getElementById('psiWeight');
          const rd = document.getElementById('psiRoundDemand');
          const rs = document.getElementById('psiRoundSupply');
          const rb = document.getElementById('psiRoundBacklog');
          const round = {};
          if (rd && rd.value) round['demand'] = { mode:'nearest', step: Number(rd.value) };
          if (rs && rs.value) round['supply_plan'] = { mode:'nearest', step: Number(rs.value) };
          if (rb && rb.value) round['backlog'] = { mode:'nearest', step: Number(rb.value) };
          distribute = { weight_mode: (wm && wm.value)||'current', round };
        }
        if (edits.length===0 && !lock){ return; }
        const body = { level, edits, lock };
        if (distribute) body['distribute'] = distribute;
        const res = await fetch(`/plans/${ver}/psi`, { method:'PATCH', headers:getHeaders(), body: JSON.stringify(body) });
        if (!res.ok){ alert('save failed'); return; }
        pending.clear(); await load();
      }
      async function recon(){
        const body = {};
        const adj = document.getElementById('psiAdj');
        const mrp = document.getElementById('psiMRP');
        const lt = document.getElementById('psiLtUnit');
        const w = document.getElementById('psiWeeks');
        const cut = document.getElementById('psiCutover');
        const rwd = document.getElementById('psiRwd');
        const anc = document.getElementById('psiAnchor');
        const ta = document.getElementById('psiTolAbs');
        const tr = document.getElementById('psiTolRel');
        const cal = document.getElementById('psiCal');
        const cov = document.getElementById('psiCarry');
        const csv = document.getElementById('psiCarrySplit');
        body.apply_adjusted = !!(adj && adj.checked);
        body.recalc_mrp = !!(mrp && mrp.checked);
        body.lt_unit = lt ? lt.value : 'day';
        body.weeks = w ? Number(w.value||4) : 4;
        body.cutover_date = cut && cut.value ? cut.value : undefined;
        body.recon_window_days = rwd && rwd.value!=='' ? Number(rwd.value) : undefined;
        body.anchor_policy = anc && anc.value ? anc.value : undefined;
        body.tol_abs = ta && ta.value!=='' ? Number(ta.value) : undefined;
        body.tol_rel = tr && tr.value!=='' ? Number(tr.value) : undefined;
        body.calendar_mode = cal && cal.value ? cal.value : undefined;
        body.carryover = cov && cov.value ? cov.value : undefined;
        body.carryover_split = csv && csv.value!=='' ? Number(csv.value) : undefined;
        const res = await fetch(`/plans/${ver}/psi/reconcile`, { method:'POST', headers:getHeaders(), body: JSON.stringify(body) });
        if (!res.ok){
          let msg = '';
          try { msg = await res.text(); } catch(e) { msg = ''; }
          alert(`reconcile failed: ${res.status} ${msg?.slice(0,300) || ''}`);
          return;
        }
        const js = await res.json();
        alert('reconciled: violations='+(js.summary && (js.summary.violations||js.summary.tol_violations||0)));
      }
      document.getElementById('psiReload')?.addEventListener('click', load);
      document.getElementById('psiSave')?.addEventListener('click', save);
      document.getElementById('psiRecon')?.addEventListener('click', recon);
      function lockCell(mode){
        const el = window.__psiLastCell; if (!el){ alert('Select a cell first.'); return; }
        const key = el.getAttribute('data-key'); const f = el.getAttribute('data-field');
        if (!key || !f){ return; }
        const lock_keys = [`${key}:field=${f}`];
        fetch(`/plans/${ver}/psi`, { method:'PATCH', headers:getHeaders(), body: JSON.stringify({ level: levelEl.value, edits: [], lock: mode, lock_keys }) })
          .then(()=> load());
      }
      document.getElementById('psiLockCell')?.addEventListener('click', ()=> lockCell('lock'));
      document.getElementById('psiUnlockCell')?.addEventListener('click', ()=> lockCell('unlock'));
      document.getElementById('psiUnlockAll')?.addEventListener('click', async ()=>{
        const keys = Array.from(locks);
        if (!keys.length) return;
        await fetch(`/plans/${ver}/psi`, { method:'PATCH', headers:getHeaders(), body: JSON.stringify({ level: levelEl.value, edits: [], lock: 'unlock', lock_keys: keys }) });
        await load();
      });
      document.getElementById('psiCsvApply')?.addEventListener('click', async function(){
        const level = levelEl.value;
        const ta = document.getElementById('psiCsvText'); const txt = (ta && ta.value)||''; if(!txt.trim()) return;
        const lines = txt.trim().split(/\r?\n/);
        if(lines.length<2){ alert('Header plus at least one row is required.'); return; }
        const header = lines[0].split(',').map(s=>s.trim());
        const idx = (name)=> header.indexOf(name);
        const edits = [];
        for (let i=1;i<lines.length;i++){
          const cols = lines[i].split(',');
          if (level==='aggregate'){
            const key = { period: cols[idx('period')], family: cols[idx('family')] };
            const fields = {};
            ['demand','supply','backlog'].forEach(k=>{ const j = idx(k); if(j>=0){ const v = cols[j].trim(); fields[k] = v===''? null: Number(v); }});
            edits.push({ key, fields });
          } else {
            const key = { week: cols[idx('week')], sku: cols[idx('sku')] };
            const fields = {};
            ['demand','supply_plan','backlog','on_hand_start','on_hand_end'].forEach(k=>{ const j = idx(k); if(j>=0){ const v = cols[j].trim(); fields[k] = v===''? null: Number(v); }});
            edits.push({ key, fields });
          }
        }
        const res = await fetch(`/plans/${ver}/psi`, { method:'PATCH', headers:getHeaders(), body: JSON.stringify({ level, edits }) });
        if (!res.ok){ alert('Failed to apply CSV.'); return; }
        ta.value=''; await load();
      });
      async function loadAudit(){
        const level = document.getElementById('psiAuditLevel')?.value || '';
        const q = (document.getElementById('psiAuditQ')?.value||'').trim();
        const limit = Number(document.getElementById('psiAuditLimit')?.value||'200');
        const url = new URL(`/plans/${ver}/psi/audit`, location.origin);
        if (level) url.searchParams.set('level', level);
        if (q) url.searchParams.set('q', q);
        url.searchParams.set('limit', String(limit));
        const res = await fetch(url.toString());
        if (!res.ok) return;
        const js = await res.json();
        const rows = Array.isArray(js.events) ? js.events : [];
        const tblA = document.getElementById('tblPSIAudit');
        if (!tblA) return;
        const esc = (val)=>{
          if (val === null || val === undefined) return '';
          const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
          return String(val).replace(/[&<>"']/g, ch => map[ch] || ch);
        };
        const head = '<thead><tr><th>time</th><th>event</th><th>level</th><th>key</th><th>actor</th><th>notes</th><th>details</th></tr></thead>';
        if (!rows.length){
          tblA.innerHTML = head + '<tbody><tr><td colspan="7">No audit events yet.</td></tr></tbody>';
          return;
        }
        const body = rows.map(r=>{
          const ts = r.display_time || (r.timestamp ? new Date(Number(r.timestamp)).toISOString() : '');
          const evt = r.display_event || r.event_type || '';
          const levelVal = r.level || '';
          const key = r.key_display || r.key_hash || r.key || '';
          const actor = r.actor || '';
          const notes = r.notes || '';
          let detail = r.payload_preview || '';
          if (!detail && r.payload){
            try {
              detail = JSON.stringify(r.payload);
            } catch (e) {
              detail = String(r.payload);
            }
          }
          return `<tr><td class="mono">${esc(ts)}</td><td class="mono">${esc(evt)}</td><td class="mono">${esc(levelVal)}</td><td class="mono">${esc(key)}</td><td class="mono">${esc(actor)}</td><td>${esc(notes)}</td><td class="mono">${esc(detail)}</td></tr>`;
        }).join('');
        tblA.innerHTML = head + '<tbody>'+body+'</tbody>';
      }
      document.getElementById('psiAuditReload')?.addEventListener('click', loadAudit);
      document.getElementById('psiSubmit')?.addEventListener('click', async function(){
        const note = (document.getElementById('psiSubmitNote')?.value)||'';
        const res = await fetch(`/plans/${ver}/psi/submit`, { method:'POST', headers:getHeaders(), body: JSON.stringify({ note }) });
        if (!res.ok){ alert('Submission failed.'); return; }
        alert('Submitted.');
      });
      document.getElementById('psiApprove')?.addEventListener('click', async function(){
        const auto = !!(document.getElementById('psiApproveRecon')?.checked);
        const res = await fetch(`/plans/${ver}/psi/approve`, { method:'POST', headers:getHeaders(), body: JSON.stringify({ auto_reconcile: auto }) });
        if (!res.ok){ alert('Approval failed.'); return; }
        alert('Approved.');
      });
      document.getElementById('psiWeightsApply')?.addEventListener('click', async function(){
        const ta = document.getElementById('psiWeightsCsv'); const txt = (ta && ta.value) || '';
        if (!txt.trim()) return;
        const res = await fetch(`/plans/${ver}/psi/weights`, { method:'POST', headers:getHeaders(), body: JSON.stringify({ csv: txt }) });
        if (!res.ok){ alert('Weights application failed.'); return; }
        alert('Weights applied.');
      });
      // Toggle lock state using checkboxes (applies when lockMode is provided)
      tbl.addEventListener('change', ev=>{
        const t = ev.target; if (!t || !t.classList || !t.classList.contains('psi-lock')) return;
        // Default lock mode to toggle when unset so changes are applied
        if (!lockEl.value) lockEl.value = 'toggle';
      });
      // Initial load
      load().catch(()=>{});
    })();
    </script>
    </div>

    <div id="tab-disaggregate" class="tab-pane" style="display:none;">
    <details open>
      <summary>Disaggregate (SKU × week)</summary>
      <div class="tab-toolbar">
        <input id="skuFilter" type="search" placeholder="SKU filter" aria-label="SKU filter">
        <input id="weekFilter" type="search" placeholder="Week filter (e.g. 2025-W01)" aria-label="Week filter">
        <small class="mono" id="disaggMeta"></small>
        <small class="mono">Showing first 200 rows ({{ (disagg_total or 0)|fmt_number }} total)</small>
      </div>
      {% if disagg_rows %}
      <div class="table-wrapper">
        <table id="tblDisagg">
          <thead><tr><th>week</th><th>sku</th><th class="numeric">demand</th><th class="numeric">supply_plan</th><th class="numeric">backlog</th><th class="numeric">on_hand_start</th><th class="numeric">on_hand_end</th><th class="numeric">lt_weeks</th><th class="numeric">planned_release</th><th class="numeric">planned_release_adj</th><th class="numeric">planned_receipt_adj</th></tr></thead>
          <tbody>
            {% for r in disagg_rows %}
            <tr>
              <td class="mono">{{ r.week }}</td>
              <td class="mono">{{ r.sku }}</td>
              <td class="mono numeric">{{ r.demand|fmt_number }}</td>
              <td class="mono numeric">{{ r.supply_plan|fmt_number }}</td>
              <td class="mono numeric">{{ r.backlog|fmt_number }}</td>
              <td class="mono numeric">{{ r.on_hand_start|fmt_number }}</td>
              <td class="mono numeric">{{ r.on_hand_end|fmt_number }}</td>
              <td class="mono numeric">{{ r.lt_weeks|fmt_number }}</td>
              <td class="mono numeric">{{ r.planned_release|fmt_number }}</td>
              <td class="mono numeric">{{ r.planned_release_adj|fmt_number }}</td>
              <td class="mono numeric">{{ r.planned_receipt_adj|fmt_number }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p>No detail rows yet. Execute the plan to populate this table.</p>
      {% endif %}
    </details>
    </div>

    <div id="tab-schedule" class="tab-pane" style="display:none;">
    <details open>
      <summary>Scheduled receipts / MRP</summary>
      <div class="tab-toolbar mono">
        <input id="schedSku" type="search" placeholder="SKU filter" aria-label="SKU filter">
        <input id="schedWeek" type="search" placeholder="Week filter (e.g. 2025-W01)" aria-label="Week filter">
        <small id="schedMeta"></small>
        <a class="secondary" href="/plans/{{ version_id }}/schedule.csv" target="_blank" rel="noopener">schedule.csv</a>
        <small>MRP rows (first 200 shown): {{ (schedule_rows_mrp_total or 0)|fmt_number }}</small>
        <small>MRP Final rows (first 200 shown): {{ (schedule_rows_mrp_final_total or 0)|fmt_number }}</small>
      </div>
      {% if schedule_rows_mrp or schedule_rows_mrp_final %}
        {% if schedule_rows_mrp %}
        <h4>MRP (before reconcile)</h4>
        <div class="table-wrapper">
          <table id="tblScheduleMrp" data-schedule-table="mrp">
            <thead>
              <tr>
                <th>week</th>
                <th>sku</th>
                <th class="numeric">gross_req</th>
                <th class="numeric">planned_receipt</th>
                <th class="numeric">scheduled_receipts</th>
                <th class="numeric">net_req</th>
                <th class="numeric">planned_release</th>
                <th class="numeric">on_hand_start</th>
                <th class="numeric">on_hand_end</th>
                <th class="numeric">lt_weeks</th>
              </tr>
            </thead>
            <tbody>
              {% for r in schedule_rows_mrp %}
              <tr>
                <td class="mono">{{ r.week }}</td>
                <td class="mono">{{ r.sku }}</td>
                <td class="mono numeric">{{ r.gross_req|fmt_number }}</td>
                <td class="mono numeric">{{ r.planned_receipt|fmt_number }}</td>
                <td class="mono numeric">{{ r.scheduled_receipts|fmt_number }}</td>
                <td class="mono numeric">{{ r.net_req|fmt_number }}</td>
                <td class="mono numeric">{{ r.planned_release|fmt_number }}</td>
                <td class="mono numeric">{{ r.on_hand_start|fmt_number }}</td>
                <td class="mono numeric">{{ r.on_hand_end|fmt_number }}</td>
                <td class="mono numeric">{{ r.lt_weeks|fmt_number }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
        {% if schedule_rows_mrp_final %}
        <h4>MRP Final (after reconcile)</h4>
        <div class="table-wrapper">
          <table id="tblScheduleMrpFinal" data-schedule-table="mrp-final">
            <thead>
              <tr>
                <th>week</th>
                <th>sku</th>
                <th class="numeric">gross_req</th>
                <th class="numeric">planned_receipt_adj</th>
                <th class="numeric">planned_release_adj</th>
                <th class="numeric">scheduled_receipts</th>
                <th class="numeric">net_req</th>
                <th class="numeric">on_hand_start</th>
                <th class="numeric">on_hand_end</th>
                <th class="numeric">lt_weeks</th>
              </tr>
            </thead>
            <tbody>
              {% for r in schedule_rows_mrp_final %}
              <tr>
                <td class="mono">{{ r.week }}</td>
                <td class="mono">{{ r.sku }}</td>
                <td class="mono numeric">{{ r.gross_req|fmt_number }}</td>
                <td class="mono numeric">{{ r.planned_receipt_adj|fmt_number }}</td>
                <td class="mono numeric">{{ r.planned_release_adj|fmt_number }}</td>
                <td class="mono numeric">{{ r.scheduled_receipts|fmt_number }}</td>
                <td class="mono numeric">{{ r.net_req|fmt_number }}</td>
                <td class="mono numeric">{{ r.on_hand_start|fmt_number }}</td>
                <td class="mono numeric">{{ r.on_hand_end|fmt_number }}</td>
                <td class="mono numeric">{{ r.lt_weeks|fmt_number }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      {% else %}
      <p>No schedule rows yet. Execute the plan to populate this table.</p>
      {% endif %}
    </details>
    </div>

    <div id="tab-validate" class="tab-pane" style="display:none;">
    <details open>
      <summary>Validation</summary>
      {% if validate %}
      <div class="grid" style="grid-template-columns: repeat(3, minmax(180px, 1fr)); gap:8px;">
        {% set tol_before = validate.tol_violations_before if validate.tol_violations_before is not none else None %}
        {% set tol_after = validate.tol_violations_after if validate.tol_violations_after is not none else None %}
        <article>
          <header>Tolerance violations (before/after)</header>
          <strong class="mono">{{ tol_before|fmt_number if tol_before is not none else '-' }} → {{ tol_after|fmt_number if tol_after is not none else '-' }}</strong>
          <footer><a class="secondary" href="/plans/{{ version_id }}/compare?violations_only=true&sort=rel_desc&limit=200" target="_blank">compare (violations)</a></footer>
        </article>
        <article>
          <header>Negative inventory rows</header>
          <strong class="mono">{{ (validate.neg_inventory_rows or 0)|fmt_number }}</strong>
          <footer><em class="mono">mrp rows={{ (validate.mrp_total_rows or 0)|fmt_number }}</em></footer>
        </article>
        <article>
          <header>Fractional scheduled receipts</header>
          <strong class="mono">{{ (validate.fractional_receipts_rows or 0)|fmt_number }}</strong>
        </article>
        <article>
          <header>Capacity over-utilization (weeks)</header>
          <strong class="mono">{{ (validate.capacity_over_weeks or 0)|fmt_number }}</strong>
          <footer><em class="mono">weekly rows={{ (validate.weekly_total_rows or 0)|fmt_number }}</em></footer>
        </article>
      </div>
      {% else %}
      <p>No validation metrics yet. Run the plan to populate these figures.</p>
      {% endif %}
    </details>
    </div>
    <div id="tab-execute" class="tab-pane" style="display:none;">
    <details open>
      <summary>Reconcile (parameter overrides)</summary>
      <form method="post" action="/ui/plans/{{ version_id }}/reconcile">
        <div class="grid">
          <label>cutover_date<input type="date" name="cutover_date" value="{{ version.cutover_date or '' }}"></label>
          <label>recon_window_days<input type="number" name="recon_window_days" min="0" value="{{ version.recon_window_days or '' }}"></label>
          <label>anchor_policy
            <select name="anchor_policy">
              <option value="">(unspecified)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="default 1e-6"></label>
          <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="default 1e-6"></label>
          <label>calendar_mode
            <select name="calendar_mode">
              <option value="">(unspecified)</option>
              <option value="simple">simple</option>
              <option value="iso">iso</option>
            </select>
          </label>
          <label>carryover
            <select name="carryover">
              <option value="">(unspecified)</option>
              <option value="auto">auto</option>
              <option value="prev">prev</option>
              <option value="next">next</option>
              <option value="both">both</option>
            </select>
          </label>
          <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split"></label>
          <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
          <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
          <label>lt_unit
            <select name="lt_unit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
        </div>
        <button type="submit" aria-label="Run reconciliation">Run reconciliation</button>
      </form>
    </details>

    <details>
      <summary>Create and Execute (new plan version)</summary>
      <form method="post" action="/ui/plans/create_and_execute">
        <div class="grid" style="align-items:end;">
          <input type="hidden" name="config_version_id" value="{{ config_version_id or '' }}">
          <input type="hidden" name="base_scenario_id" value="{{ version.base_scenario_id or '' }}">
          <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
          <label>lt_unit
            <select name="lt_unit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
          <label>cutover_date<input type="date" name="cutover_date"></label>
          <label>recon_window_days<input type="number" name="recon_window_days" min="0"></label>
          <label>anchor_policy
            <select name="anchor_policy">
              <option value="">(unspecified)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="default 1e-6"></label>
          <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="default 1e-6"></label>
          <label>calendar_mode
            <select name="calendar_mode">
              <option value="">(unspecified)</option>
              <option value="simple">simple</option>
              <option value="iso">iso</option>
            </select>
          </label>
          <label>carryover
            <select name="carryover">
              <option value="">(unspecified)</option>
              <option value="auto">auto</option>
              <option value="prev">prev</option>
              <option value="next">next</option>
              <option value="both">both</option>
            </select>
          </label>
          <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split"></label>
          <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
        </div>
        <button type="submit" aria-label="Create and Execute now">Create and Execute</button>
      </form>
      <form id="queue-run-form" class="grid-form gap-top-sm" onsubmit="return queueRunViaRunsApi(event)">
        <div class="grid" style="align-items:end;">
          <input type="hidden" name="config_version_id" value="{{ config_version_id or '' }}">
          <input type="hidden" name="base_scenario_id" value="{{ version.base_scenario_id or '' }}">
          <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
          <label>lt_unit
            <select name="lt_unit">
              <option value="day" selected>day</option>
              <option value="week">week</option>
            </select>
          </label>
          <label>cutover_date<input type="date" name="cutover_date"></label>
          <label>recon_window_days<input type="number" name="recon_window_days" min="0"></label>
          <label>anchor_policy
            <select name="anchor_policy">
              <option value="">(unspecified)</option>
              <option value="DET_near">DET_near</option>
              <option value="AGG_far">AGG_far</option>
              <option value="blend">blend</option>
            </select>
          </label>
          <label>apply_adjusted<input type="checkbox" name="apply_adjusted" value="1"></label>
        </div>
        <button type="submit" class="secondary" aria-label="Queue job">Queue job</button>
        <p class="mono">After queuing, monitor progress via <a href="/ui/jobs" target="_blank" rel="noopener">/ui/jobs</a>.</p>
      </form>
      <script>
      async function queueRunViaRunsApi(ev){
        ev.preventDefault();
        try{
          const f = document.getElementById('queue-run-form');
          const fd = new FormData(f);
          function val(name){ const v = fd.get(name); return (v===null||v==='')?undefined:String(v); }
          function valNum(name){ const v = val(name); return v===undefined?undefined:Number(v); }
          function valBool(name){ return fd.get(name) ? true : false; }
          const configVersionId = {{ config_version_id if config_version_id is not none else 'null' }};
          if (!configVersionId){
            alert('config_version_id が未設定のPlanです。Plan & Runを実行するにはCanonical設定が必要です。');
            return false;
          }
          const body = {
            pipeline: 'integrated',
            async: true,
            options: {
              weeks: valNum('weeks')||4,
              lt_unit: val('lt_unit')||'day',
              cutover_date: val('cutover_date')||undefined,
              recon_window_days: valNum('recon_window_days'),
              anchor_policy: val('anchor_policy')||undefined,
              apply_adjusted: valBool('apply_adjusted'),
              config_version_id: configVersionId,
              base_scenario_id: {{ version.base_scenario_id if version.base_scenario_id is not none else 'null' }},
              source_run_id: {{ created_from_run_id|tojson if created_from_run_id else 'null' }}
            }
          };
          const res = await fetch('/runs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
          if (!res.ok){
            const txt = await res.text();
            alert('Queue failed: '+txt);
            return false;
          }
          const data = await res.json();
          if (data && data.location){ window.location.href = data.location; }
          else { alert('Queued.'); }
        }catch(e){ alert('Queue failed.'); }
        return false;
      }
      </script>
    </details>

    <details>
      <summary>Execute from Current Plan (auto-completion)</summary>
      <form method="post" action="/ui/plans/{{ version_id }}/execute_auto" class="toolbar gap-top-sm">
        <label>weeks<input type="number" name="weeks" min="1" value="4"></label>
        <label>lt_unit
          <select name="lt_unit">
            <option value="day" selected>day</option>
            <option value="week">week</option>
          </select>
        </label>
        <label>cutover_date<input type="date" name="cutover_date"></label>
        <label>recon_window_days<input type="number" name="recon_window_days" min="0"></label>
        <label>anchor_policy
          <select name="anchor_policy">
            <option value="">(unspecified)</option>
            <option value="DET_near">DET_near</option>
            <option value="AGG_far">AGG_far</option>
            <option value="blend">blend</option>
          </select>
        </label>
        <label>tol_abs<input type="number" step="0.000001" name="tol_abs" placeholder="default 1e-6"></label>
        <label>tol_rel<input type="number" step="0.000001" name="tol_rel" placeholder="default 1e-6"></label>
        <label>calendar_mode
          <select name="calendar_mode">
            <option value="">(unspecified)</option>
            <option value="simple">simple</option>
            <option value="iso">iso</option>
          </select>
        </label>
        <label>carryover
          <select name="carryover">
            <option value="">(unspecified)</option>
            <option value="auto">auto</option>
            <option value="prev">prev</option>
            <option value="next">next</option>
            <option value="both">both</option>
          </select>
        </label>
        <label>carryover_split<input type="number" min="0" max="1" step="0.05" name="carryover_split"></label>
        <label><input type="checkbox" name="apply_adjusted" value="1"> Include adjusted detail</label>
        <label><input type="checkbox" name="queue_job" value="1"> Execute as job (async)</label>
        <button type="submit" class="contrast" aria-label="Execute from Current Plan">Execute from Current</button>
        <small class="mono">Note: inherits cutover/window/policy from the current plan when possible.</small>
      </form>
    </details>
    </div>

    <div id="tab-overview" class="tab-pane">
    <details open>
      <summary>Summary</summary>
      <table>
        <thead><tr><th>Item</th><th>Value</th></tr></thead>
        <tbody>
          <tr><td>status</td><td>{{ version.status or '' }}</td></tr>
          <tr><td>config_version_id</td><td class="mono">{% if config_version_id %}<a href="/ui/configs/canonical/{{ config_version_id }}">{{ config_version_id }}</a>{% else %}-{% endif %}</td></tr>
          <tr><td>base_scenario_id</td><td class="mono">{% if version.base_scenario_id %}<a href="/ui/scenarios?highlight={{ version.base_scenario_id }}">{{ version.base_scenario_id }}</a>{% else %}-{% endif %}</td></tr>
          <tr><td>cutover_date</td><td class="mono">{{ version.cutover_date or '' }}</td></tr>
          <tr><td>recon_window_days</td><td class="mono">{{ version.recon_window_days|fmt_number }}</td></tr>
          {% if recon and recon.summary %}
            <tr><td>violations(before)</td><td class="mono">{{ recon.summary.tol_violations|fmt_number }}</td></tr>
            <tr><td>max|Δ| (before)</td><td class="mono">({{ recon.summary.max_abs_delta.demand|fmt_number }}, {{ recon.summary.max_abs_delta.supply|fmt_number }}, {{ recon.summary.max_abs_delta.backlog|fmt_number }})</td></tr>
          {% endif %}
          {% if recon_adj and recon_adj.summary %}
            <tr><td>violations(after)</td><td class="mono">{{ recon_adj.summary.tol_violations|fmt_number }}</td></tr>
            <tr><td>max|Δ| (after)</td><td class="mono">({{ recon_adj.summary.max_abs_delta.demand|fmt_number }}, {{ recon_adj.summary.max_abs_delta.supply|fmt_number }}, {{ recon_adj.summary.max_abs_delta.backlog|fmt_number }})</td></tr>
          {% endif %}
          {% if plan_state %}
          <tr><td>psi_state</td><td class="mono">{{ plan_state.display_status or plan_state.status or plan_state.state or (version.status or 'draft') }}{% if plan_state.actor %} | actor={{ plan_state.actor }}{% endif %}{% if plan_state.display_time %} | at {{ plan_state.display_time }}{% endif %}{% if plan_state.notes %} | note={{ plan_state.notes }}{% endif %}{% if plan_state.invalid and plan_state.invalid|length>0 %} | invalid: {{ plan_state.invalid|join(', ') }}{% endif %}{% if plan_state.source %} | source={{ plan_state.source }}{% endif %}</td></tr>
          {% else %}
          <tr><td>psi_state</td><td class="mono">{{ version.status or 'draft' }}</td></tr>
          {% endif %}
        </tbody>
      </table>
      {% if related_plans and related_plans|length > 0 %}
      <div class="gap-top-sm">
        <strong>Related plans (same base_scenario, latest):</strong>
        <ul>
          {% for p in related_plans %}
          <li class="mono"><a href="/ui/plans/{{ p.version_id }}">{{ p.version_id }}</a> <small>({{ p.status or '' }})</small>
            | <a class="secondary" href="/plans/{{ p.version_id }}/compare?violations_only=true&sort=rel_desc&limit=200" target="_blank" title="Diff against current plan (violations only, rel_desc)">diff</a>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if plan_runs and plan_runs|length > 0 %}
      <div class="gap-top-sm">
        <strong>Run created from this plan</strong>
        <div class="table-wrapper">
          <table>
            <thead><tr><th>run_id</th><th>started_at</th><th class="numeric">fill_rate</th><th class="numeric">profit_total</th></tr></thead>
            <tbody>
              {% for r in plan_runs %}
              <tr>
                <td class="mono"><a href="/ui/runs/{{ r.run_id }}">{{ r.run_id }}</a></td>
                <td class="mono ts-ms" data-ms="{{ r.started_at or '' }}">{{ r.started_at_str or r.started_at or '' }}</td>
                <td class="mono numeric">{{ (r.fill_rate if r.fill_rate is not none else None)|fmt_percent }}</td>
                <td class="mono numeric">{{ (r.profit_total if r.profit_total is not none else None)|fmt_number }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if plan_run_ids and plan_run_ids|length >= 2 %}
        <form method="post" action="/ui/compare" class="tab-toolbar">
          <input type="hidden" name="run_ids" value="{{ plan_run_ids[0] }},{{ plan_run_ids[1] }}">
          <button type="submit" aria-label="Compare latest plan runs">Compare latest plan runs</button>
          <span class="mono" style="margin-left:8px;">
            <a href="/ui/compare/metrics.csv?run_ids={{ plan_run_ids[0] }},{{ plan_run_ids[1] }}" target="_blank" rel="noopener">metrics.csv</a>
            |
            <a href="/ui/compare/diffs.csv?run_ids={{ plan_run_ids[0] }},{{ plan_run_ids[1] }}&threshold=5" target="_blank" rel="noopener">diffs.csv (±5%)</a>
          </span>
        </form>
        {% endif %}
      </div>
      {% endif %}
      {% if canonical_meta %}
      <div class="gap-top-sm">
        <strong>Canonical configuration</strong>
        <table>
          <tbody>
            <tr><td>schema_version</td><td class="mono">{{ canonical_meta.get('schema_version', '') }}</td></tr>
            <tr><td>name</td><td class="mono">{{ canonical_meta.get('name', '') }}</td></tr>
            <tr><td>status</td><td class="mono">{{ canonical_meta.get('status', '') }}</td></tr>
            <tr><td>description</td><td>{{ canonical_meta.get('description', '') }}</td></tr>
            {% if canonical_counts %}
              <tr><td colspan="2">
                <small class="mono">
                  counts:
                  items={{ canonical_counts.get('items', 0)|fmt_number }},
                  nodes={{ canonical_counts.get('nodes', 0)|fmt_number }},
                  arcs={{ canonical_counts.get('arcs', 0)|fmt_number }},
                  bom={{ canonical_counts.get('bom', 0)|fmt_number }},
                  demands={{ canonical_counts.get('demands', 0)|fmt_number }},
                  capacities={{ canonical_counts.get('capacities', 0)|fmt_number }}
                </small>
              </td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% endif %}
      {% if planning_summary %}
      <div class="gap-top-sm">
        <strong>Planning inputs (aggregate)</strong>
        <table>
          <tbody>
            <tr><td>schema_version</td><td class="mono">{{ planning_summary.get('schema_version', '') }}</td></tr>
            <tr><td>demand_family</td><td class="mono">{{ planning_summary.get('demand_family', 0)|fmt_number }}</td></tr>
            <tr><td>capacity</td><td class="mono">{{ planning_summary.get('capacity', 0)|fmt_number }}</td></tr>
            <tr><td>mix_share</td><td class="mono">{{ planning_summary.get('mix_share', 0)|fmt_number }}</td></tr>
            <tr><td>item_master</td><td class="mono">{{ planning_summary.get('item_master', 0)|fmt_number }}</td></tr>
            <tr><td>inventory</td><td class="mono">{{ planning_summary.get('inventory', 0)|fmt_number }}</td></tr>
            <tr><td>open_po</td><td class="mono">{{ planning_summary.get('open_po', 0)|fmt_number }}</td></tr>
          </tbody>
        </table>
      </div>
      {% endif %}
      <div class="tab-toolbar">
        <label>Sort related plans
          <select id="rel-sort">
            <option value="created_desc" selected>created_desc</option>
            <option value="created_asc">created_asc</option>
            <option value="status">status</option>
          </select>
        </label>
        <label>Limit
          <input id="rel-limit" class="input-compact-sm" type="number" min="1" max="50" value="5" />
        </label>
        <button id="rel-apply" type="button" class="secondary">Apply</button>
      </div>
      <ul id="rel-list" class="mono gap-top-sm"></ul>
      <div class="tab-toolbar">
        <label>Diff sort
          <select id="diff-sort">
            <option value="rel_desc" selected>rel_desc</option>
            <option value="abs_desc">abs_desc</option>
            <option value="rel_asc">rel_asc</option>
            <option value="abs_asc">abs_asc</option>
          </select>
        </label>
        <label><input type="checkbox" id="diff-viol" checked> violations_only</label>
        <button id="diff-apply" type="button" class="secondary">Update links</button>
      </div>
    </details>
    <details>
      <summary>State management</summary>
      <div class="mt-2">
        <p>Current state: <strong>{{ plan_state.display_status }}</strong> (source: {{ plan_state.source }})</p>
        <form method="post" action="/ui/plans/{{ version_id }}/state/advance" class="tab-toolbar">
      </form>
    </details>
    {% if kpi_preview %}
    <details class="gap-top-sm" open>
      <summary>KPI preview</summary>
      <div class="grid" style="grid-template-columns: repeat(3, minmax(180px, 1fr)); gap:8px;">
        {% for card in kpi_cards %}
        {% set metric = kpi_preview.get(card.key) %}
        <article>
          <header>{{ card.label }}</header>
          {% if metric and metric.value is not none %}
            {% if card.fmt == 'percent' %}
              <strong class="mono">{{ metric.value|fmt_percent(card.precision) }}</strong>
            {% elif card.fmt == 'number' %}
              <strong class="mono">{{ metric.value|fmt_number(card.precision) }}</strong>
            {% else %}
              <strong class="mono">{{ metric.value|fmt_metric(card.key) }}</strong>
            {% endif %}
          {% else %}
            <strong class="mono">-</strong>
          {% endif %}
        </article>
        {% endfor %}
      </div>
      {% set window_meta = kpi_preview.get('window_days') %}
      {% set policy_meta = kpi_preview.get('anchor_policy') %}
      {% if window_meta or policy_meta %}
        {% set window_value = window_meta.value if window_meta and window_meta.value is not none else None %}
        {% set policy_value = policy_meta.value if policy_meta and policy_meta.value else None %}
        <p class="mono">
          window_days={{ window_value|fmt_number if window_value is not none else '(n/a)' }}
          | policy={{ policy_value if policy_value else '(none)' }}
        </p>
      {% endif %}
    </details>
    {% endif %}
    <div class="mono" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <span>Exports:</span>
      <a href="/plans/{{ version_id }}/summary" target="_blank" rel="noopener">summary.json</a>
      |
      <a href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=rel_desc&limit=1000" target="_blank" rel="noopener">compare.csv</a>
      |
      <a href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=abs_desc&limit=1000" target="_blank" rel="noopener">violations.csv</a>
      |
      <a href="/plans/{{ version_id }}/carryover.csv" target="_blank" rel="noopener">carryover.csv</a>
    </div>
    </div>

    <div id="tab-results" class="tab-pane" style="display:none;">
    <details open>
      <summary>Latest runs (base_scenario)</summary>
      {% if version.base_scenario_id %}
        {% if latest_runs and latest_runs|length > 0 %}
          <div class="table-wrapper">
            <table>
              <thead><tr><th>run_id</th><th>started_at</th><th class="numeric">fill_rate</th><th class="numeric">profit_total</th><th>link</th></tr></thead>
              <tbody>
                {% for r in latest_runs %}
                <tr>
                  <td class="mono">{{ r.run_id }}</td>
                  <td class="mono ts-ms" data-ms="{{ r.started_at or '' }}">{{ r.started_at or '' }}</td>
                  <td class="mono numeric">{{ r.fill_rate|fmt_percent }}</td>
                  <td class="mono numeric">{{ r.profit_total|fmt_number }}</td>
                  <td><a class="secondary" href="/ui/runs/{{ r.run_id }}" target="_blank">open</a></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if latest_run_ids and latest_run_ids|length >= 2 %}
          <form method="post" action="/ui/compare" class="tab-toolbar">
            <input type="hidden" name="run_ids" value="{{ latest_run_ids[0] }},{{ latest_run_ids[1] }}">
            <button type="submit" aria-label="Compare latest two runs">Compare latest two runs</button>
            <span class="mono" style="margin-left:8px;">
              <a href="/ui/compare/metrics.csv?run_ids={{ latest_run_ids[0] }},{{ latest_run_ids[1] }}" target="_blank" rel="noopener">metrics.csv</a>
              |
              <a href="/ui/compare/diffs.csv?run_ids={{ latest_run_ids[0] }},{{ latest_run_ids[1] }}&threshold=5" target="_blank" rel="noopener">diffs.csv (±5%)</a>
            </span>
          </form>
          {% endif %}
        {% else %}
          <p>No runs found for this scenario. Visit <a href="/ui/runs" target="_blank" rel="noopener">/ui/runs</a>.</p>
        {% endif %}
      {% else %}
        <p>This plan has no base_scenario_id.</p>
      {% endif %}
    </details>
    {% if weekly_summary %}
    <details>
      <summary>Capacity summary (weekly_summary)</summary>
      {% if boundary_summary %}
        <p class="mono">boundary: period={{ boundary_summary.period }} ｜ weeks={{ boundary_summary.weeks|fmt_number }} ｜ pre={{ boundary_summary.pre_weeks|fmt_number }} ｜ post={{ boundary_summary.post_weeks|fmt_number }} ｜ policy={{ boundary_summary.anchor_policy or '(none)' }} ｜ window={{ (boundary_summary.window_days or 0)|fmt_number }} days</p>
      {% endif %}
      <div class="table-wrapper">
        <table>
          <thead><tr><th>week</th><th>zone</th><th class="numeric">b_idx</th><th class="numeric">b_size</th><th class="numeric">in_pre</th><th class="numeric">in_post</th><th class="numeric">capacity</th><th class="numeric">original_load</th><th class="numeric">adjusted_load</th><th class="numeric">spill_in</th><th class="numeric">spill_out</th></tr></thead>
          <tbody>
            {% for r in weekly_summary %}
            <tr>
              <td>{{ r.week }}</td>
              <td class="mono">{{ r.zone or '' }}</td>
              <td class="mono numeric">{{ r.boundary_index|fmt_number }}</td>
              <td class="mono numeric">{{ r.boundary_size|fmt_number }}</td>
              <td class="mono numeric">{{ r.in_window_pre|fmt_number }}</td>
              <td class="mono numeric">{{ r.in_window_post|fmt_number }}</td>
              <td class="mono numeric">{{ r.capacity|fmt_number }}</td>
              <td class="mono numeric">{{ r.original_load|fmt_number }}</td>
              <td class="mono numeric">{{ r.adjusted_load|fmt_number }}</td>
              <td class="mono numeric">{{ r.spill_in|fmt_number }}</td>
              <td class="mono numeric">{{ r.spill_out|fmt_number }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>
    {% endif %}
    </div>

    {% if deltas %}
    <details open>
      <summary>Before diff (top 50)</summary>
      <p class="mono"><a href="/plans/{{ version_id }}/compare.csv?sort=rel_desc&limit=1000" download>compare.csv</a> | <a href="/plans/{{ version_id }}/compare.csv?violations_only=true&sort=rel_desc&limit=1000" download>violations_only.csv</a></p>
      <div class="grid" style="align-items:end;">
        <label>tol_abs<input id="tolAbsB" type="number" step="0.000001" value="{{ recon.tolerance.abs if recon and recon.tolerance else 0.000001 }}"></label>
        <label>tol_rel<input id="tolRelB" type="number" step="0.000001" value="{{ recon.tolerance.rel if recon and recon.tolerance else 0.000001 }}"></label>
        <label><input type="checkbox" id="violOnlyB"> Show violations only</label>
      </div>
      <div class="table-wrapper">
        <table id="tblBefore">
          <thead><tr><th>period</th><th>family</th><th class="numeric">Δdemand</th><th class="numeric">Δsupply</th><th class="numeric">Δbacklog</th><th>ok</th></tr></thead>
          <tbody>
            {% for r in deltas %}
            <tr data-ok="{{ '1' if r.ok else '0' }}" data-reld="{{ r.rel_demand if r.rel_demand is defined else 0 }}" data-rels="{{ r.rel_supply if r.rel_supply is defined else 0 }}" data-relb="{{ r.rel_backlog if r.rel_backlog is defined else 0 }}">
              <td>{{ r.period }}</td>
              <td>{{ r.family }}</td>
              <td class="mono numeric">{{ r.delta_demand|fmt_number }}</td>
              <td class="mono numeric">{{ r.delta_supply|fmt_number }}</td>
              <td class="mono numeric">{{ r.delta_backlog|fmt_number }}</td>
              <td class="mono">{{ r.ok }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <script>
      (function(){
        function num(x){ var v = parseFloat(x); return isNaN(v)?0:v; }
        var ta = document.getElementById('tolAbsB');
        var tr = document.getElementById('tolRelB');
        var cb = document.getElementById('violOnlyB');
        function apply(){
          var _ta = num(ta && ta.value);
          var _tr = num(tr && tr.value);
          document.querySelectorAll('#tblBefore tbody tr').forEach(function(trEl){
            var tds = trEl.querySelectorAll('td');
            var d = Math.abs(num(tds[2] && tds[2].textContent));
            var s = Math.abs(num(tds[3] && tds[3].textContent));
            var b = Math.abs(num(tds[4] && tds[4].textContent));
            var rd = Math.abs(num(trEl.getAttribute('data-reld')));
            var rs = Math.abs(num(trEl.getAttribute('data-rels')));
            var rb = Math.abs(num(trEl.getAttribute('data-relb')));
            var okd = (d <= _ta) || (rd <= _tr);
            var oks = (s <= _ta) || (rs <= _tr);
            var okb = (b <= _ta) || (rb <= _tr);
            [okd,oks,okb].forEach(function(ok,i){ var td = tds[2+i]; if(td) td.style.background = ok? '': '#fff0f0'; });
            var rowOk = okd && oks && okb;
            trEl.setAttribute('data-ok', rowOk ? '1':'0');
            trEl.style.display = (cb && cb.checked && rowOk) ? 'none' : '';
          });
        }
        if (ta) ta.addEventListener('change', apply);
        if (tr) tr.addEventListener('change', apply);
        if (cb) cb.addEventListener('change', apply);
        apply();
      })();
      </script>
    </details>
    {% endif %}

    <div id="tab-diff" class="tab-pane" style="display:none;">
    {% if deltas_adj %}
    <details>
      <summary>After diff (top 50)</summary>
      <p class="mono"><a href="/plans/{{ version_id }}/carryover.csv" download>carryover.csv</a></p>
      <div class="grid" style="align-items:end;">
        <label>tol_abs<input id="tolAbsA" type="number" step="0.000001" value="{{ recon_adj.tolerance.abs if recon_adj and recon_adj.tolerance else 0.000001 }}"></label>
        <label>tol_rel<input id="tolRelA" type="number" step="0.000001" value="{{ recon_adj.tolerance.rel if recon_adj and recon_adj.tolerance else 0.000001 }}"></label>
        <label><input type="checkbox" id="violOnlyA"> Show violations only</label>
      </div>
      <div class="table-wrapper">
        <table id="tblAfter">
          <thead><tr><th>period</th><th>family</th><th class="numeric">Δdemand</th><th class="numeric">Δsupply</th><th class="numeric">Δbacklog</th><th>ok</th></tr></thead>
          <tbody>
            {% for r in deltas_adj %}
            <tr data-ok="{{ '1' if r.ok else '0' }}" data-reld="{{ r.rel_demand if r.rel_demand is defined else 0 }}" data-rels="{{ r.rel_supply if r.rel_supply is defined else 0 }}" data-relb="{{ r.rel_backlog if r.rel_backlog is defined else 0 }}">
              <td>{{ r.period }}</td>
              <td>{{ r.family }}</td>
              <td class="mono numeric">{{ r.delta_demand|fmt_number }}</td>
              <td class="mono numeric">{{ r.delta_supply|fmt_number }}</td>
              <td class="mono numeric">{{ r.delta_backlog|fmt_number }}</td>
              <td class="mono">{{ r.ok }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <script>
      (function(){
        function num(x){ var v = parseFloat(x); return isNaN(v)?0:v; }
        var ta = document.getElementById('tolAbsA');
        var tr = document.getElementById('tolRelA');
        var cb = document.getElementById('violOnlyA');
        function apply(){
          var _ta = num(ta && ta.value);
          var _tr = num(tr && tr.value);
          document.querySelectorAll('#tblAfter tbody tr').forEach(function(trEl){
            var tds = trEl.querySelectorAll('td');
            var d = Math.abs(num(tds[2] && tds[2].textContent));
            var s = Math.abs(num(tds[3] && tds[3].textContent));
            var b = Math.abs(num(tds[4] && tds[4].textContent));
            var rd = Math.abs(num(trEl.getAttribute('data-reld')));
            var rs = Math.abs(num(trEl.getAttribute('data-rels')));
            var rb = Math.abs(num(trEl.getAttribute('data-relb')));
            var okd = (d <= _ta) || (rd <= _tr);
            var oks = (s <= _ta) || (rs <= _tr);
            var okb = (b <= _ta) || (rb <= _tr);
            [okd,oks,okb].forEach(function(ok,i){ var td = tds[2+i]; if(td) td.style.background = ok? '': '#fff0f0'; });
            var rowOk = okd && oks && okb;
            trEl.setAttribute('data-ok', rowOk ? '1':'0');
            trEl.style.display = (cb && cb.checked && rowOk) ? 'none' : '';
          });
        }
        if (ta) ta.addEventListener('change', apply);
        if (tr) tr.addEventListener('change', apply);
        if (cb) cb.addEventListener('change', apply);
        apply();
      })();
      </script>
    </details>
    {% endif %}
    </div>
  {% endif %}
</section>
<section id="chart-section" style="display:none;">
  <h3>Visualization</h3>
  <div class="chart-block">
    <h4>Spill Volume by Zone</h4>
    <canvas id="chartSpillZonePlan" height="100"></canvas>
    <p id="chartSpillZoneNote" class="chart-note"></p>
  </div>
  <div class="chart-block" style="margin-top:16px">
    <h4>Capacity vs Adjusted Load</h4>
    <canvas id="chartCapacityPlan" height="100"></canvas>
    <p id="chartCapacityNote" class="chart-note"></p>
  </div>
</section>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    const weekly = {{ (weekly_summary or []) | tojson | safe }};
    const formatLib = window.ScpFormat;
    function formatAxisValue(value){
      if (formatLib && typeof formatLib.formatNumber === 'function') {
        const out = formatLib.formatNumber(value, 0);
        return out || '';
      }
      const num = Number(value);
      if (!Number.isFinite(num)) return '';
      return num.toLocaleString('en-US');
    }
    function ensureCanvas(ctx){
      if (!ctx) return null;
      const canvas = ctx.canvas;
      if (!canvas) return null;
      const width = canvas.clientWidth || canvas.width || 560;
      const height = canvas.clientHeight || canvas.height || 180;
      canvas.width = width;
      canvas.height = height;
      return {ctx, width, height};
    }
    function setNote(id, text){
      const note = document.getElementById(id);
      if (note) note.textContent = text || '';
    }
    function drawEmptyState(ctx, noteId, message){
      if (!ctx) return;
      const info = ensureCanvas(ctx);
      if (!info) return;
      const {ctx: c, width, height} = info;
      c.clearRect(0,0,width,height);
      c.fillStyle = '#666';
      c.font = '12px sans-serif';
      const baseY = Math.max(32, height / 2);
      const text = message || "No data to display (all values are zero).";
      c.fillText(text, 24, baseY);
      setNote(noteId, text);
    }
    function drawFallbackBars(ctx, labels, datasets){
      const canvas = ctx.canvas;
      const width = canvas.clientWidth || 560;
      const height = canvas.clientHeight || 180;
      canvas.width = width;
      canvas.height = height;
      ctx.clearRect(0,0,width,height);
      const padding = {left:48,right:16,top:16,bottom:32};
      const availW = Math.max(1, width - padding.left - padding.right);
      const availH = Math.max(1, height - padding.top - padding.bottom);
      const values = [];
      datasets.forEach(ds => (ds.data || []).forEach(v => values.push(Number(v)||0)));
      const maxVal = values.length ? Math.max(...values.map(v=>Math.abs(v))) : 0;
      if (maxVal <= 0){
        return false;
      }
      const yTicks = 4;
      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 1;
      for (let i=0;i<=yTicks;i++){
        const ratio = i / yTicks;
        const y = padding.top + availH - ratio * availH;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(width - padding.right, y);
        ctx.stroke();
        ctx.fillStyle = '#666';
        ctx.font = '10px sans-serif';
        const tickValue = maxVal * ratio;
        ctx.fillText(formatAxisValue(tickValue), 2, y + 3);
      }
      const groupCount = labels.length || 1;
      const dsCount = datasets.length || 1;
      const groupWidth = availW / groupCount;
      const barWidth = Math.max(6, (groupWidth * 0.7) / dsCount);
      labels.forEach((label, idx)=>{
        const baseX = padding.left + groupWidth * idx + (groupWidth - barWidth * dsCount) / 2;
        ctx.fillStyle = '#333';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(label || '', padding.left + groupWidth * idx + groupWidth / 2, height - 8);
        datasets.forEach((ds, dsIdx)=>{
          const val = Number((ds.data || [])[idx]) || 0;
          const h = availH * (Math.abs(val) / maxVal);
          const x = baseX + dsIdx * barWidth;
          const y = padding.top + availH - h;
          ctx.fillStyle = ds.color || 'rgba(99,102,241,0.6)';
          ctx.fillRect(x, y, barWidth - 2, h);
        });
      });
      // legend
      let legendX = padding.left;
      datasets.forEach(ds=>{
        const lbl = ds.label || '';
        const boxSize = 10;
        ctx.fillStyle = ds.color || '#666';
        ctx.fillRect(legendX, padding.top - 12, boxSize, boxSize);
        ctx.fillStyle = '#444';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(lbl, legendX + boxSize + 4, padding.top - 3);
        legendX += ctx.measureText(lbl).width + boxSize + 28;
      });
      ctx.textAlign = 'left';
      return true;
    }
    function sumByZone(rows){
      const zones = ['pre','at','post','unknown'];
      const sums = {
        pre:{in:0,out:0},
        at:{in:0,out:0},
        post:{in:0,out:0},
        unknown:{in:0,out:0}
      };
      rows.forEach(r=>{
        const zoneRaw = r.zone || r.boundary_zone;
        const z = zoneRaw ? String(zoneRaw).toLowerCase() : 'unknown';
        if(!sums[z]) {
          sums[z] = {in:0,out:0};
        }
        sums[z].in += Number(r.spill_in||0);
        sums[z].out += Number(r.spill_out||0);
      });
      const labels = zones.filter(z=>Math.abs(sums[z].in)+Math.abs(sums[z].out) > 1e-6);
      if (!labels.length) labels.push('unknown');
      return {labels, inData: labels.map(z=>sums[z].in), outData: labels.map(z=>sums[z].out)};
    }
    function makeSpill(){
      const canvas = document.getElementById('chartSpillZonePlan');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const agg = sumByZone(weekly);
      const hasData = agg.inData.concat(agg.outData).some(v => Math.abs(v) > 1e-6);
      if (!hasData){
        drawEmptyState(ctx, 'chartSpillZoneNote', 'No spill volume to display (all values are zero).');
        return;
      }
      if (typeof Chart !== 'undefined' && Chart){
        new Chart(ctx, {type:'bar', data:{labels:agg.labels, datasets:[
          {label:'spill_in', data:agg.inData, backgroundColor:'rgba(99,102,241,0.6)'},
          {label:'spill_out', data:agg.outData, backgroundColor:'rgba(239,68,68,0.6)'}
        ]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
      } else {
        const ok = drawFallbackBars(ctx, agg.labels, [
          {label:'spill_in', data:agg.inData, color:'rgba(99,102,241,0.6)'},
          {label:'spill_out', data:agg.outData, color:'rgba(239,68,68,0.6)'}
        ]);
        if (!ok){
          drawEmptyState(ctx, 'chartSpillZoneNote', 'No spill volume to display (all values are zero).');
          return;
        }
      }
      setNote('chartSpillZoneNote', '');
    }
    function makeCapacity(){
      const canvas = document.getElementById('chartCapacityPlan');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const weeks = weekly.map(r=>r.week);
      const cap = weekly.map(r=>r.capacity);
      const adj = weekly.map(r=>r.adjusted_load);
      const hasData = cap.concat(adj).some(v => Math.abs(v) > 1e-6);
      if (!hasData){
        drawEmptyState(ctx, 'chartCapacityNote', 'No capacity or adjusted load to display (all values are zero).');
        return;
      }
      if (typeof Chart !== 'undefined' && Chart){
        new Chart(ctx, {type:'bar', data:{labels:weeks, datasets:[
          {label:'capacity', data:cap, backgroundColor:'rgba(54,162,235,0.5)'},
          {label:'adjusted_load', data:adj, backgroundColor:'rgba(255,159,64,0.5)'}
        ]}, options:{responsive:true, scales:{y:{beginAtZero:true}}}});
      } else {
        const ok = drawFallbackBars(ctx, weeks, [
          {label:'capacity', data:cap, color:'rgba(54,162,235,0.5)'},
          {label:'adjusted_load', data:adj, color:'rgba(255,159,64,0.5)'}
        ]);
        if (!ok){
          drawEmptyState(ctx, 'chartCapacityNote', 'No capacity or adjusted load to display (all values are zero).');
          return;
        }
      }
      setNote('chartCapacityNote', '');
    }
    // Lazy rendering: draw charts when the Results tab is active
    window.__renderCharts = function(){
      if (!Array.isArray(weekly) || weekly.length === 0){
        const ctx1 = document.getElementById('chartSpillZonePlan')?.getContext('2d');
        const ctx2 = document.getElementById('chartCapacityPlan')?.getContext('2d');
        drawEmptyState(ctx1, 'chartSpillZoneNote', 'Visualization data is not available.');
        drawEmptyState(ctx2, 'chartCapacityNote', 'Visualization data is not available.');
        return;
      }
      try { makeSpill(); } catch(e){ /* ignore */ }
      try { makeCapacity(); } catch(e){ /* ignore */ }
    };
    if (!Array.isArray(weekly) || weekly.length === 0){
      // 初期描画で空データの案内を出す
      const ctx1 = document.getElementById('chartSpillZonePlan')?.getContext('2d');
      const ctx2 = document.getElementById('chartCapacityPlan')?.getContext('2d');
      drawEmptyState(ctx1, 'chartSpillZoneNote', 'Visualization data is not available.');
      drawEmptyState(ctx2, 'chartCapacityNote', 'Visualization data is not available.');
    }
  })();
  // Format millisecond timestamps as JST
  (function(){
    function fmtJst(ms){
      var n = Number(ms);
      if (!Number.isFinite(n)) return '';
      if (n < 1e12) n = n * 1000; // accept epoch seconds as fallback
      var t = new Date(n + 9*3600*1000);
      var y = t.getUTCFullYear();
      var mo = String(t.getUTCMonth()+1).padStart(2,'0');
      var d = String(t.getUTCDate()).padStart(2,'0');
      var h = String(t.getUTCHours()).padStart(2,'0');
      var mi = String(t.getUTCMinutes()).padStart(2,'0');
      var s = String(t.getUTCSeconds()).padStart(2,'0');
      return y + '/' + mo + '/' + d + ' ' + h + ':' + mi + ':' + s + ' JST';
    }
    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.ts-ms').forEach(function(el){
        var txt = fmtJst(el.getAttribute('data-ms'));
        if (txt) el.textContent = txt;
      });
    });
  })();
</script>
<script>
  // Tab switching
  (function(){
    function activate(tab){
      ['overview','aggregate','disaggregate','schedule','validate','psi','execute','results','diff'].forEach(function(k){
        var el = document.getElementById('tab-'+k);
        if (el) el.style.display = (k===tab)?'':'none';
      });
      var chartSec = document.getElementById('chart-section');
      if (chartSec) chartSec.style.display = (tab==='results')? '' : 'none';
      if (tab==='results' && typeof window.__renderCharts==='function') { window.__renderCharts(); }
      document.querySelectorAll('nav [data-tab]').forEach(function(a){
        a.classList.toggle('contrast', a.getAttribute('data-tab')===tab);
      });
      try { localStorage.setItem('plan_detail_tab', tab); } catch(e){}
    }
    document.addEventListener('DOMContentLoaded', function(){
      var saved = null;
      try { saved = localStorage.getItem('plan_detail_tab'); } catch(e){}
      var init = saved || 'overview';
      activate(init);
      document.querySelectorAll('nav [data-tab]').forEach(function(a){
        a.addEventListener('click', function(){ activate(a.getAttribute('data-tab')); });
      });
    });
  })();
</script>
<script>
  // Disaggregate quick filter
  (function(){
    function val(el){ return (el && el.value || '').toLowerCase().trim(); }
    function apply(){
      var sku = val(document.getElementById('skuFilter'));
      var wk = val(document.getElementById('weekFilter'));
      var rows = document.querySelectorAll('#tblDisagg tbody tr');
      var vis=0, all=0;
      rows.forEach(function(tr){
        all++;
        var tds = tr.querySelectorAll('td');
        var w = (tds[0] && tds[0].textContent || '').toLowerCase();
        var s = (tds[1] && tds[1].textContent || '').toLowerCase();
        var ok = (!wk || w.indexOf(wk)>=0) && (!sku || s.indexOf(sku)>=0);
        tr.style.display = ok ? '' : 'none';
        if (ok) vis++;
      });
      var meta = document.getElementById('disaggMeta');
      if (meta) meta.textContent = vis + ' / ' + all;
    }
    document.addEventListener('DOMContentLoaded', function(){
      var sf = document.getElementById('skuFilter');
      var wf = document.getElementById('weekFilter');
      if (sf) sf.addEventListener('input', apply);
      if (wf) wf.addEventListener('input', apply);
      apply();
    });
  })();
</script>
<script>
  // Schedule quick filter
  (function(){
    function val(el){ return (el && el.value || '').toLowerCase().trim(); }
    function apply(){
      var sku = val(document.getElementById('schedSku'));
      var wk = val(document.getElementById('schedWeek'));
      var vis=0, all=0;
      var tables = document.querySelectorAll('[data-schedule-table]');
      tables.forEach(function(tbl){
        var rows = tbl.querySelectorAll('tbody tr');
        rows.forEach(function(tr){
          all++;
          var tds = tr.querySelectorAll('td');
          var w = (tds[0] && tds[0].textContent || '').toLowerCase();
          var s = (tds[1] && tds[1].textContent || '').toLowerCase();
          var ok = (!wk || w.indexOf(wk)>=0) && (!sku || s.indexOf(sku)>=0);
          tr.style.display = ok ? '' : 'none';
          if (ok) vis++;
        });
      });
      var meta = document.getElementById('schedMeta');
      if (meta) meta.textContent = vis + ' / ' + all;
    }
    document.addEventListener('DOMContentLoaded', function(){
      var sf = document.getElementById('schedSku');
      var wf = document.getElementById('schedWeek');
      if (sf) sf.addEventListener('input', apply);
      if (wf) wf.addEventListener('input', apply);
      apply();
    });
  })();
</script>
<!-- copy helpers removed -->
{% endblock %}
